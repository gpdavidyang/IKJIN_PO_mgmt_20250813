# 엑셀 업로드 발주서 생성 프로세스 수정 계획

## 📊 **현재 상황 분석**

### 🔍 **사용자 테스트 결과 (배포 화면: 발주서 작성 - 엑셀 업로드 입력)**
1. **PDF 파일 생성 실패** - 엑셀 업로드 시 PDF가 자동 생성되지 않음
2. **엑셀 파일명 문제** - '압출발주서_품목리스트.xlsx' 대신 'IKJIN_[PO번호]_[날짜].xlsx' 형식이어야 함
3. **이메일 발송 성공하지만 내용 불일치** - 모달에서 작성한 내용과 실제 발송된 내용이 다름
4. **상태 업데이트 불일치**:
   - 발주서 관리 목록: 여전히 '발주생성' (→ '발주완료'로 변경되어야 함)
   - 발주서 상세: '발주완료' 표시되나 '이메일발송' 버튼 존재 (→ '이메일기록'으로 변경되어야 함)

## 🎯 **예상되었어야 할 올바른 흐름**

### **Step 1: 엑셀 업로드 시**
- 파일 업로드 및 데이터 파싱만 수행
- 원본 파일명 그대로 임시 저장

### **Step 2: '발주서 생성' 버튼 클릭 시**
1. **파일명 자동 변경**: `압출발주서_품목리스트.xlsx` → `IKJIN_PO-2025-XXXXX_20250907.xlsx`
2. **PDF 자동 생성 및 저장** ← **핵심 수정 사항**
3. **데이터베이스에 두 파일 모두 저장**
4. **발주서 상태: '발주생성'으로 설정**

### **Step 3: 이메일 발송 시**
1. 모달에서 작성한 내용이 실제 이메일에 정확히 반영
2. 엑셀 + PDF 파일 모두 첨부
3. 발송 후 상태 변경: '발주생성' → '발주완료'
4. 이메일 발송 기록을 email_sending_history 테이블에 저장

### **Step 4: UI 상태 반영**
1. **발주서 관리 목록**: '발주완료' 상태 표시
2. **발주서 상세페이지**: 
   - 상태: '발주완료'
   - 버튼: '이메일발송' → '이메일기록'으로 변경
   - 이메일기록 클릭 시 발송 이력 모달 표시

## 🔧 **문제 원인 분석**

### 1. **PDF 생성 누락**
- **원인**: '발주서 생성' 단계에서 PDF 생성 로직이 실행되지 않음
- **위치**: `server/routes/orders.ts`의 발주서 생성 API 엔드포인트

### 2. **파일명 표준화 미적용**
- **원인**: 업로드된 원본 파일명 그대로 사용
- **위치**: `server/services/excel-attachment-service.ts`

### 3. **이메일 내용 불일치**
- **원인**: 모달 데이터와 실제 발송 데이터 간 연결 문제
- **위치**: `server/services/email-service.ts` 및 관련 이메일 발송 로직

### 4. **상태 동기화 문제**
- **원인**: 
  - 백엔드에서 상태는 업데이트되나 프론트엔드 캐시 무효화 안됨
  - 또는 일부 API 호출에서 상태 업데이트 로직 누락
- **위치**: React Query 캐시 관리 및 상태 업데이트 로직

## 📋 **수정 계획**

### **Phase 1: 발주서 생성 시 PDF 자동 생성**
1. **수정 파일**: `server/routes/orders.ts`
2. **작업 내용**:
   - '발주서 생성' API에서 PDF 생성 서비스 호출 추가
   - `ProfessionalPDFGenerationService.generateOrderPDF()` 실행
   - 생성된 PDF 파일을 attachments 테이블에 저장
3. **검증**: 발주서 생성 완료 후 PDF 파일 존재 확인

### **Phase 2: 엑셀 파일명 표준화**
1. **수정 파일**: `server/services/excel-attachment-service.ts`
2. **작업 내용**:
   - `saveProcessedExcelFile()` 메서드에서 파일명 생성 로직 개선
   - `IKJIN_${orderNumber}_${YYYYMMDD}.xlsx` 형식으로 변경
   - 발주서 생성 시점에 파일명 업데이트
3. **검증**: 생성된 엑셀 파일명이 표준 형식인지 확인

### **Phase 3: 이메일 발송 프로세스 개선**
1. **수정 파일**: `server/services/email-service.ts`
2. **작업 내용**:
   - 모달에서 전달된 이메일 데이터 정확히 사용
   - 첨부파일 목록에 엑셀 + PDF 모두 포함
   - 이메일 발송 성공 후 orderStatus 업데이트 로직 강화
3. **검증**: 발송된 이메일 내용과 첨부파일 확인

### **Phase 4: UI 상태 관리 수정**
1. **수정 파일들**:
   - `client/src/pages/orders-professional-fast.tsx` (목록 페이지)
   - `client/src/pages/order-detail-professional.tsx` (상세 페이지)
2. **작업 내용**:
   - React Query 캐시 무효화 로직 추가
   - 발주서 상태에 따른 버튼 표시 로직 개선
   - '이메일기록' 버튼 클릭 시 발송 이력 표시 기능
3. **검증**: 상태 변경 시 UI 즉시 반영 확인

## 🔧 **예상 수정 파일 목록**

### **Backend Files**
```
server/routes/orders.ts
├── 발주서 생성 시 PDF 자동 생성 로직 추가
└── 상태 업데이트 확인

server/services/professional-pdf-generation-service.ts  
├── PDF 생성 서비스 (기존 활용)
└── 한글 폰트 지원 확인

server/services/excel-attachment-service.ts
├── saveProcessedExcelFile() 메서드 개선
└── 파일명 표준화 로직 강화

server/services/email-service.ts
├── 이메일 내용 동기화 로직
├── 첨부파일 처리 개선
└── 발송 후 상태 업데이트 로직
```

### **Frontend Files**
```
client/src/pages/orders-professional-fast.tsx
├── React Query 캐시 무효화
└── 목록 상태 실시간 업데이트

client/src/pages/order-detail-professional.tsx
├── 이메일 발송 후 버튼 상태 변경
├── '이메일기록' 기능 구현
└── 상태별 UI 조건부 렌더링

client/src/components/email-send-dialog.tsx
├── 이메일 발송 후 캐시 무효화
└── 성공 피드백 개선
```

## ✅ **완료 기준 및 테스트 시나리오**

### **1. PDF 자동 생성 검증**
- [ ] 엑셀 업로드 후 '발주서 생성' 클릭
- [ ] PDF 파일이 자동 생성되어 데이터베이스에 저장됨
- [ ] 발주서 상세페이지에서 PDF 파일 다운로드 가능

### **2. 파일명 표준화 검증**  
- [ ] 생성된 엑셀 파일명이 `IKJIN_PO-2025-XXXXX_20250907.xlsx` 형식
- [ ] PDF 파일명도 동일한 패턴으로 생성됨
- [ ] 다운로드 시 표준화된 파일명 사용

### **3. 이메일 발송 검증**
- [ ] 모달에서 작성한 제목, 내용이 실제 이메일에 정확히 반영
- [ ] 엑셀 + PDF 파일 모두 첨부되어 발송
- [ ] 수신자가 올바른 내용과 첨부파일 수신 확인

### **4. 상태 동기화 검증**
- [ ] 이메일 발송 후 발주서 관리 목록에서 '발주완료' 상태 표시
- [ ] 발주서 상세페이지에서 '이메일발송' 버튼이 '이메일기록'으로 변경
- [ ] '이메일기록' 클릭 시 발송 이력 모달 표시
- [ ] 페이지 새로고침 없이 실시간 상태 반영

### **5. 통합 플로우 테스트**
```
1. 엑셀 파일 업로드
2. '발주서 생성' 버튼 클릭
3. PDF 자동 생성 확인
4. 파일명 표준화 확인  
5. 이메일 발송 모달 열기
6. 첨부파일 목록에 엑셀+PDF 표시 확인
7. 이메일 작성 후 발송
8. 실제 이메일 수신 및 내용 확인
9. 발주서 목록에서 '발주완료' 상태 확인
10. 발주서 상세에서 '이메일기록' 버튼 확인
```

## 📈 **우선순위 및 일정**

### **High Priority (즉시 수정 필요)**
1. PDF 자동 생성 로직 추가 
2. 파일명 표준화 적용
3. 이메일 내용 동기화 수정

### **Medium Priority (UI 개선)**
1. 상태 동기화 및 캐시 무효화
2. 버튼 상태 변경 로직
3. 이메일 기록 기능 구현

### **Low Priority (사용자 경험 개선)**
1. 로딩 상태 표시
2. 에러 처리 개선
3. 성공 피드백 강화

## 📞 **추가 확인 사항**

1. **PDF 생성 시점 재확인**: '발주서 생성' 버튼 클릭 시 PDF 생성이 맞는지 확인
2. **파일명 형식 확정**: `IKJIN_[PO번호]_[날짜]` 형식이 최종 요구사항인지 확인  
3. **이메일 템플릿**: 이메일 내용 템플릿이 별도로 정의되어 있는지 확인
4. **성능 고려사항**: PDF 생성 시간이 UX에 미치는 영향 검토

---

**작성일**: 2025-01-27  
**작성자**: Claude Code Assistant  
**문서 버전**: 1.0