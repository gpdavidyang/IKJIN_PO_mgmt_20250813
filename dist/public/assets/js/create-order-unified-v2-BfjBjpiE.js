import{v as qe,r as u,j as e,ah as G,a as te,p as ee,s as se,w as V,a8 as Y,B as N,X as ae,G as Be,h as he,m as de,L as f,I as J,P as le,A as Pe,D as Fe,E as ye,F as re,ak as Ve,c as Ke,b as Je}from"./index-DjAfYDOA.js";import{A as oe,a as ce}from"./alert-Dughf68L.js";import{P as He}from"./progress-CXJhfd_5.js";import{D as Te,a as Ae,b as Oe,c as De,e as Le}from"./dialog-BbIdk7IQ.js";import{S as X,a as W,b as Q,c as Z,d as T}from"./select-3-ceTvVr.js";import{T as Ge}from"./target-pX7Tbt3T.js";import{T as ue}from"./triangle-alert-CB72zIVM.js";import{T as Me}from"./trending-up-BQKaxzD5.js";import{A as $e}from"./arrow-right-BW-gA8XK.js";import{S as Xe}from"./search-DoLqPHmd.js";import{U as Ne}from"./upload-BrKilRYz.js";import{T as ie}from"./textarea-Bid3wNRg.js";import{C as be}from"./calendar-DcqLnfd-.js";import{P as we,a as Ce,b as Se}from"./popover-BKa2o2yA.js";import{C as ke}from"./calendar-BOggCMoY.js";import{T as Re}from"./trash-2-DuVwuAEc.js";import{f as Ee}from"./format-BqlaHE6C.js";import{k as Ie}from"./ko-DHTEdlBI.js";import{T as We,a as Qe,b as me,c as xe}from"./tabs-CLRv4ZU1.js";import{C as ne}from"./checkbox-Bu8iSM2P.js";import{M as ge}from"./mail-DsVvMP7e.js";import{R as ze}from"./refresh-cw-DMG6DAzo.js";import{D as ve}from"./download-Dw9zfdH9.js";import{P as pe}from"./paperclip-9veGhoHR.js";import{S as Ze}from"./save-BP2imVWy.js";import{S as Ye}from"./send-DebVCMhb.js";import{L as es}from"./list-Nmc--0ny.js";import{I as je}from"./info-DcTrNH2h.js";import"./index-DwE-nMEg.js";import"./index-BdQq_4o_.js";import"./index-0R4TikJ-.js";import"./chevron-down-ErttL176.js";import"./chevron-up-pENLZV2w.js";import"./chevron-left-D1JQpx-R.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=qe("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]),ss=({isOpen:a,onClose:A,mappingItems:m,onApplyMappings:y})=>{const[E,d]=u.useState([]),[b,O]=u.useState(0),[p,k]=u.useState(!1),[M,L]=u.useState([]),[I,x]=u.useState([]),[j,P]=u.useState([]),[_,R]=u.useState([]),[w,z]=u.useState(!1);u.useEffect(()=>{d([...m]),O(0)},[m]),u.useEffect(()=>{a&&M.length===0&&K()},[a]);const K=async()=>{z(!0);try{const n=await fetch("/api/categories");if(n.ok){const $=(await n.json()).flatCategories||[];L($),x($.filter(D=>D.categoryType==="major")),P($.filter(D=>D.categoryType==="middle")),R($.filter(D=>D.categoryType==="minor")),console.log("ğŸ“‹ ì „ì²´ ë¶„ë¥˜ ë¡œë“œ ì™„ë£Œ:",{total:$.length,major:$.filter(D=>D.categoryType==="major").length,middle:$.filter(D=>D.categoryType==="middle").length,minor:$.filter(D=>D.categoryType==="minor").length})}else console.error("âŒ ë¶„ë¥˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:",n.status)}catch(n){console.error("âŒ ë¶„ë¥˜ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:",n)}finally{z(!1)}},g=E[b];console.log("ğŸ” Current item data:",g),console.log("ğŸ” Mapping result DB data:",g?.mappingResult?.db);const B={total:E.length,resolved:E.filter(n=>n.userSelection||n.mappingResult.status==="exact_match").length,needsAttention:E.filter(n=>!n.userSelection&&n.mappingResult.status!=="exact_match").length},U=(n,S)=>{const $=[...E],D=$[b];D.userSelection||(D.userSelection={}),D.userSelection[`${n}Id`]=S,n==="major"?(D.userSelection.middleId=void 0,D.userSelection.minorId=void 0):n==="middle"&&(D.userSelection.minorId=void 0),d($)},q=()=>{const n=g?.userSelection?.majorId,S=g?.mappingResult?.db?.majorId;return console.log("ğŸ” getCurrentMajorId:",{userMajorId:n,autoMajorId:S,result:n||S}),n||S},i=()=>{const n=g?.userSelection?.middleId,S=g?.mappingResult?.db?.middleId;return console.log("ğŸ” getCurrentMiddleId:",{userMiddleId:n,autoMiddleId:S,result:n||S}),n||S},s=n=>n?j.filter(S=>S.parentId===n):[],t=n=>n?_.filter(S=>S.parentId===n):[],o=(n,S)=>{const $=g?.mappingResult?.suggestions?.filter(H=>H.type===n)||[];let D=[];n==="major"?D=I:n==="middle"?D=s(S):n==="minor"&&(D=t(S));const _e=$.map(H=>H.id),Ue=D.filter(H=>!_e.includes(H.id));return[...$.map(H=>({...H,isSuggestion:!0})),...Ue.map(H=>({...H,name:H.categoryName,type:H.categoryType,similarity:0,isSuggestion:!1}))]},c=()=>{b<E.length-1?O(b+1):h()},r=()=>{b<E.length-1?O(b+1):h()},l=()=>{b>0&&O(b-1)},h=async()=>{k(!0);try{await y(E),A()}catch(n){console.error("ë§¤í•‘ ì ìš© ì‹¤íŒ¨:",n)}finally{k(!1)}},v=n=>{switch(n){case"exact_match":return e.jsx(te,{className:"w-4 h-4 text-green-600"});case"partial_match":return e.jsx(ue,{className:"w-4 h-4 text-yellow-600"});case"no_match":return e.jsx(ae,{className:"w-4 h-4 text-red-600"});default:return e.jsx(Xe,{className:"w-4 h-4 text-gray-600"})}},F=n=>{switch(n){case"exact_match":return"bg-green-100 text-green-800 border-green-200";case"partial_match":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"no_match":return"bg-red-100 text-red-800 border-red-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},C=n=>n>=80?"text-green-600":n>=60?"text-yellow-600":"text-red-600";return!g&&!w?null:e.jsx(Te,{open:a,onOpenChange:A,children:e.jsxs(Ae,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Oe,{children:e.jsxs(De,{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"w-5 h-5 text-blue-600"}),"ë¶„ë¥˜ ë§¤í•‘ ê²€ì¦ ë° ìˆ˜ì •",w&&e.jsx(G,{className:"w-4 h-4 animate-spin text-blue-600"})]})}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["ì§„í–‰ë¥ : ",b+1," / ",E.length]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"w-3 h-3 text-green-600"}),e.jsxs("span",{children:["í•´ê²°ë¨: ",B.resolved]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ue,{className:"w-3 h-3 text-yellow-600"}),e.jsxs("span",{children:["ê²€í†  í•„ìš”: ",B.needsAttention]})]})]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${(b+1)/E.length*100}%`}})})]}),w&&!g?e.jsx(ee,{className:"mb-6",children:e.jsx(se,{className:"p-4",children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(G,{className:"w-8 h-8 mx-auto mb-2 animate-spin text-blue-600"}),e.jsx("p",{className:"text-sm text-gray-600",children:"ë¶„ë¥˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."})]})})})}):g?e.jsx(ee,{className:"mb-6",children:e.jsxs(se,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-900",children:g.itemName}),e.jsxs("div",{className:"flex items-center gap-2",children:[v(g.mappingResult.status),e.jsxs(V,{className:F(g.mappingResult.status),children:[g.mappingResult.status==="exact_match"&&"ì™„ì „ ë§¤ì¹­",g.mappingResult.status==="partial_match"&&"ë¶€ë¶„ ë§¤ì¹­",g.mappingResult.status==="no_match"&&"ë§¤ì¹­ ì—†ìŒ",g.mappingResult.status==="invalid_hierarchy"&&"ê³„ì¸µ ì˜¤ë¥˜"]}),e.jsxs(V,{variant:"outline",className:Y("text-xs",C(g.mappingResult.confidence)),children:[e.jsx(Me,{className:"w-3 h-3 mr-1"}),"ì‹ ë¢°ë„: ",g.mappingResult.confidence,"%"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"ì—‘ì…€ ëŒ€ë¶„ë¥˜"}),e.jsx("div",{className:"p-2 bg-blue-50 rounded text-sm text-blue-800 min-h-[32px] flex items-center",children:g.originalCategories.major||"ì—†ìŒ"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"ì—‘ì…€ ì¤‘ë¶„ë¥˜"}),e.jsx("div",{className:"p-2 bg-blue-50 rounded text-sm text-blue-800 min-h-[32px] flex items-center",children:g.originalCategories.middle||"ì—†ìŒ"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"ì—‘ì…€ ì†Œë¶„ë¥˜"}),e.jsx("div",{className:"p-2 bg-blue-50 rounded text-sm text-blue-800 min-h-[32px] flex items-center",children:g.originalCategories.minor||"ì—†ìŒ"})]})]}),e.jsx("div",{className:"flex items-center justify-center py-2",children:e.jsx($e,{className:"w-5 h-5 text-gray-400"})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"ì‹œìŠ¤í…œ ëŒ€ë¶„ë¥˜"}),e.jsxs(X,{value:g.userSelection?.majorId?.toString()||g.mappingResult.db.majorId?.toString()||"",onValueChange:n=>U("major",parseInt(n)),disabled:w,children:[e.jsx(W,{className:"h-8",children:e.jsx(Q,{placeholder:w?"ë¡œë”© ì¤‘...":"ëŒ€ë¶„ë¥˜ ì„ íƒ"})}),e.jsx(Z,{children:o("major").map(n=>e.jsx(T,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:n.isSuggestion?"font-medium text-blue-600":"",children:n.name}),n.isSuggestion&&n.similarity>0&&e.jsxs(V,{variant:"outline",className:"ml-2 text-xs bg-blue-50 text-blue-600 border-blue-200",children:[n.similarity,"%"]})]})},n.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"ì‹œìŠ¤í…œ ì¤‘ë¶„ë¥˜"}),e.jsxs(X,{value:g.userSelection?.middleId?.toString()||g.mappingResult.db.middleId?.toString()||"",onValueChange:n=>U("middle",parseInt(n)),disabled:w||!q(),children:[e.jsx(W,{className:"h-8",children:e.jsx(Q,{placeholder:w?"ë¡œë”© ì¤‘...":q()?"ì¤‘ë¶„ë¥˜ ì„ íƒ":"ë¨¼ì € ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”"})}),e.jsx(Z,{children:o("middle",q()).map(n=>e.jsx(T,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:n.isSuggestion?"font-medium text-blue-600":"",children:n.name}),n.isSuggestion&&n.similarity>0&&e.jsxs(V,{variant:"outline",className:"ml-2 text-xs bg-blue-50 text-blue-600 border-blue-200",children:[n.similarity,"%"]})]})},n.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"ì‹œìŠ¤í…œ ì†Œë¶„ë¥˜"}),e.jsxs(X,{value:g.userSelection?.minorId?.toString()||g.mappingResult.db.minorId?.toString()||"",onValueChange:n=>U("minor",parseInt(n)),disabled:w||!i(),children:[e.jsx(W,{className:"h-8",children:e.jsx(Q,{placeholder:w?"ë¡œë”© ì¤‘...":i()?"ì†Œë¶„ë¥˜ ì„ íƒ":"ë¨¼ì € ì¤‘ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”"})}),e.jsx(Z,{children:o("minor",i()).map(n=>e.jsx(T,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:n.isSuggestion?"font-medium text-blue-600":"",children:n.name}),n.isSuggestion&&n.similarity>0&&e.jsxs(V,{variant:"outline",className:"ml-2 text-xs bg-blue-50 text-blue-600 border-blue-200",children:[n.similarity,"%"]})]})},n.id))})]})]})]})]})}):null,g&&g.mappingResult.suggestions.length>0&&e.jsxs(oe,{className:"mb-6",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsxs(ce,{children:[e.jsx("div",{className:"font-medium mb-2",children:"ğŸ’¡ ì¶”ì²œ ë§¤í•‘:"}),e.jsx("div",{className:"text-sm space-y-1",children:g.mappingResult.suggestions.slice(0,3).map((n,S)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{children:[n.type==="major"&&"ëŒ€ë¶„ë¥˜: ",n.type==="middle"&&"ì¤‘ë¶„ë¥˜: ",n.type==="minor"&&"ì†Œë¶„ë¥˜: ",n.name]}),e.jsxs(V,{variant:"outline",className:"text-xs",children:["ìœ ì‚¬ë„ ",n.similarity,"%"]})]},S))})]})]}),e.jsxs(Le,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"outline",onClick:l,disabled:b===0||w,size:"sm",children:"ì´ì „"}),e.jsx(N,{variant:"outline",onClick:c,disabled:w,size:"sm",children:"ê±´ë„ˆë›°ê¸°"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"outline",onClick:A,disabled:p,children:"ì·¨ì†Œ"}),!w&&g&&(b<E.length-1?e.jsx(N,{onClick:r,disabled:p,children:"ë‹¤ìŒ"}):e.jsx(N,{onClick:h,disabled:p,className:"bg-blue-600 hover:bg-blue-700",children:p?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-4 h-4 mr-2 animate-spin"}),"ì ìš© ì¤‘..."]}):"ë§¤í•‘ ì ìš©"}))]})]})]})})},ts=({onDataExtracted:a,onProcessedFileReady:A})=>{const[m,y]=u.useState(!1),[E,d]=u.useState(!1),[b,O]=u.useState(null),[p,k]=u.useState("idle"),[M,L]=u.useState(""),[I,x]=u.useState([]),[j,P]=u.useState(0),[_,R]=u.useState(!1),[w,z]=u.useState([]),[K,g]=u.useState(null),B=u.useCallback(r=>{r.preventDefault(),y(!0)},[]),U=u.useCallback(r=>{r.preventDefault(),y(!1)},[]),q=u.useCallback(r=>{r.preventDefault(),y(!1);const h=Array.from(r.dataTransfer.files).find(v=>v.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||v.name.endsWith(".xlsx"));h?s(h):(L("ì—‘ì…€ íŒŒì¼(.xlsx)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤."),k("error"))},[]),i=r=>{const l=r.target.files?.[0];l&&s(l)},s=async r=>{O(r),d(!0),k("processing"),L("");const l=new FormData;l.append("file",r);try{const h=await fetch("/api/po-template/upload",{method:"POST",body:l});if(!h.ok)throw new Error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");const v=await h.json();if(v.success&&v.data.orders.length>0){x(v.data.orders),k("success");try{const F=await fetch("/api/po-template/extract-sheets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:v.data.filePath,sheetNames:["ê°‘ì§€","ì„ì§€"]})});if(F.ok){const C=await F.json();if(C.success&&C.data.extractedPath){const S=`/uploads/${C.data.extractedPath.split("/").pop()}`,$=`${r.name.replace(".xlsx","")}_Inputì œê±°.xlsx`;console.log("ğŸ”· ì²˜ë¦¬ëœ Excel íŒŒì¼ ì •ë³´:",{processedFileUrl:S,processedFileName:$}),A?.({url:S,name:$})}}else{console.warn("âš ï¸ Extract sheets API ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©");const n=`/uploads/extracted-${Date.now()}.xlsx`,S=`${r.name.replace(".xlsx","")}_Inputì œê±°.xlsx`;A?.({url:n,name:S})}}catch(F){console.error("Extract sheets í˜¸ì¶œ ì‹¤íŒ¨:",F);const n=`/uploads/extracted-${Date.now()}.xlsx`,S=`${r.name.replace(".xlsx","")}_Inputì œê±°.xlsx`;A?.({url:n,name:S})}if(v.data.orders.length===1){const F=v.data.orders[0],C={...F,projectName:F.siteName||F.projectName,orderDate:F.orderDate,deliveryDate:F.dueDate||F.deliveryDate,items:(F.items||[]).map(n=>({...n,name:n.itemName||n.name,unit:n.unit||"EA"}))};await t(C)}}else throw new Error(v.error||"ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨")}catch(h){L(h.message||"íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."),k("error")}finally{d(!1)}},t=async r=>{if(console.log("ğŸ” ë¶„ë¥˜ ë§¤í•‘ ê²€ì¦ ì‹œì‘:",r),console.log("ğŸ” ì²« ë²ˆì§¸ ì•„ì´í…œ ìƒì„¸:",r.items?.[0]),!r.items||r.items.length===0){a(r);return}try{const l=r.items.map(C=>({majorCategory:C.majorCategory||C.categoryLv1||C.ëŒ€ë¶„ë¥˜,middleCategory:C.middleCategory||C.categoryLv2||C.ì¤‘ë¶„ë¥˜,minorCategory:C.minorCategory||C.categoryLv3||C.ì†Œë¶„ë¥˜}));console.log("ğŸ” ë¶„ë¥˜ ê²€ì¦ ìš”ì²­ ë°ì´í„°:",l);const h=await fetch("/api/categories/validate-mapping-batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({categories:l})});if(!h.ok)throw new Error("ë¶„ë¥˜ ê²€ì¦ API í˜¸ì¶œ ì‹¤íŒ¨");const v=await h.json();console.log("ğŸ” ë¶„ë¥˜ ê²€ì¦ ê²°ê³¼:",v);const F=v.results.filter(C=>C.status==="no_match"||C.status==="partial_match"||C.status==="invalid_hierarchy");if(F.length>0){console.log(`âš ï¸ ${F.length}ê°œ í’ˆëª©ì— ë¶„ë¥˜ ë§¤í•‘ ë¬¸ì œ ë°œê²¬`);const C=[];v.results.forEach((n,S)=>{if(n.status==="no_match"||n.status==="partial_match"||n.status==="invalid_hierarchy"){const $=r.items[S];C.push({itemName:$.itemName||$.name||`í’ˆëª© ${S+1}`,rowIndex:S,originalCategories:{major:n.excel.major,middle:n.excel.middle,minor:n.excel.minor},mappingResult:n})}}),g(r),z(C),R(!0)}else{console.log("âœ… ëª¨ë“  ë¶„ë¥˜ê°€ ì„±ê³µì ìœ¼ë¡œ ë§¤í•‘ë¨");const C={...r};C.items=r.items.map(n=>({...n,majorCategory:n.majorCategory||n.categoryLv1||n.ëŒ€ë¶„ë¥˜||"",middleCategory:n.middleCategory||n.categoryLv2||n.ì¤‘ë¶„ë¥˜||"",minorCategory:n.minorCategory||n.categoryLv3||n.ì†Œë¶„ë¥˜||""})),console.log("ğŸ”§ ì¹´í…Œê³ ë¦¬ í•„ë“œ ë§¤í•‘ ì™„ë£Œ:",C.items[0]),a(C)}}catch(l){console.error("âŒ ë¶„ë¥˜ ê²€ì¦ ì‹¤íŒ¨:",l),console.warn("ë¶„ë¥˜ ê²€ì¦ì— ì‹¤íŒ¨í–ˆì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.");const h={...r};h.items=r.items.map(v=>({...v,majorCategory:v.majorCategory||v.categoryLv1||v.ëŒ€ë¶„ë¥˜||"",middleCategory:v.middleCategory||v.categoryLv2||v.ì¤‘ë¶„ë¥˜||"",minorCategory:v.minorCategory||v.categoryLv3||v.ì†Œë¶„ë¥˜||""})),console.log("ğŸ”§ ì¹´í…Œê³ ë¦¬ í•„ë“œ ë§¤í•‘ ì™„ë£Œ (ê²€ì¦ ì‹¤íŒ¨ ì‹œ):",h.items[0]),a(h)}},o=async r=>{if(console.log("ğŸ”§ ì‚¬ìš©ì ë¶„ë¥˜ ë§¤í•‘ ì ìš©:",r),!K){console.error("âŒ ëŒ€ê¸° ì¤‘ì¸ ë°œì£¼ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");return}const l={...K};r.forEach(h=>{const v=l.items.findIndex(F=>(F.itemName||F.name)===h.itemName);if(v!==-1&&h.userSelection){const F=l.items[v];h.userSelection.majorId&&(F.majorCategoryId=h.userSelection.majorId),h.userSelection.middleId&&(F.middleCategoryId=h.userSelection.middleId),h.userSelection.minorId&&(F.minorCategoryId=h.userSelection.minorId)}}),R(!1),z([]),g(null),console.log("âœ… ë¶„ë¥˜ ë§¤í•‘ì´ ì ìš©ëœ ë°œì£¼ì„œ ë°ì´í„°:",l),a(l)},c=async()=>{if(I[j]&&b){const r=I[j],l={...r,projectName:r.siteName||r.projectName,orderDate:r.orderDate,deliveryDate:r.dueDate||r.deliveryDate,items:(r.items||[]).map(h=>({...h,name:h.itemName||h.name,unit:h.unit||"EA"}))};await t(l)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{onDragOver:B,onDragLeave:U,onDrop:q,className:`
          border-2 border-dashed rounded-lg ${p==="success"?"p-4":"p-8"} text-center transition-all
          ${m?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}
          ${E?"opacity-50 pointer-events-none":""}
        `,children:E?e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{className:"w-8 h-8 mx-auto text-blue-600 animate-spin"}),e.jsx("p",{className:"text-sm text-gray-600",children:"íŒŒì¼ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤..."})]}):p==="success"?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(te,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-green-700",children:b?.name}),e.jsxs("p",{className:"text-xs text-gray-600",children:[I.length,"ê°œì˜ ë°œì£¼ì„œ ê°ì§€ë¨"]})]})]}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>{k("idle"),x([]),O(null)},children:"ë‹¤ì‹œ ì—…ë¡œë“œ"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Be,{className:"w-12 h-12 mx-auto text-gray-400 mb-4"}),e.jsx("p",{className:"text-lg font-medium text-gray-700 mb-2",children:"ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ë†“ìœ¼ì„¸ìš”"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"ë˜ëŠ”"}),e.jsx("input",{type:"file",accept:".xlsx",onChange:i,className:"hidden",id:"excel-upload"}),e.jsx("label",{htmlFor:"excel-upload",children:e.jsx(N,{variant:"outline",asChild:!0,children:e.jsxs("span",{className:"cursor-pointer",children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"íŒŒì¼ ì„ íƒ"]})})})]})}),p==="error"&&M&&e.jsxs(oe,{variant:"destructive",children:[e.jsx(he,{className:"h-4 w-4"}),e.jsx(ce,{children:M})]}),I.length>1&&p==="success"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:"ë°œì£¼ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”:"}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto border rounded-lg p-2 bg-gray-50",children:I.map((r,l)=>e.jsx("div",{onClick:()=>P(l),className:`
                  p-3 border rounded-lg cursor-pointer transition-colors
                  ${j===l?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300 bg-white"}
                `,children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:r.orderNumber}),e.jsxs("p",{className:"text-xs text-gray-600",children:[r.vendorName," | ",r.projectName]})]}),e.jsxs(V,{variant:"secondary",children:[r.items?.length||0,"ê°œ í’ˆëª©"]})]}),r.items&&r.items.length>0&&e.jsxs("div",{className:"pt-2 border-t border-gray-200",children:[e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-gray-500",children:[e.jsx("th",{className:"text-left font-normal",children:"í’ˆëª©"}),e.jsx("th",{className:"text-right font-normal",children:"ìˆ˜ëŸ‰"}),e.jsx("th",{className:"text-right font-normal",children:"ë‹¨ê°€"}),e.jsx("th",{className:"text-right font-normal",children:"ê¸ˆì•¡"})]})}),e.jsx("tbody",{children:r.items.slice(0,2).map((h,v)=>e.jsxs("tr",{children:[e.jsx("td",{className:"text-gray-600 truncate max-w-[150px] pr-2",children:h.itemName}),e.jsx("td",{className:"text-right text-gray-700",children:Math.floor(h.quantity||0).toLocaleString()}),e.jsx("td",{className:"text-right text-gray-700",children:Math.floor(h.unitPrice||0).toLocaleString()}),e.jsx("td",{className:"text-right font-medium",children:Math.floor(h.totalAmount||0).toLocaleString()})]},v))})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[r.items.length>2&&e.jsxs("p",{className:"text-xs text-gray-500 italic",children:["ì™¸ ",r.items.length-2,"ê°œ"]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-xs text-gray-600 mr-2",children:"ì´ì•¡"}),e.jsxs("span",{className:"text-sm font-semibold text-blue-600",children:[Math.floor(r.totalAmount||r.items.reduce((h,v)=>h+(v.totalAmount||0),0)).toLocaleString(),"ì›"]})]})]})]})]})},l))}),e.jsx(N,{onClick:c,className:"w-full",size:"sm",children:"ì„ íƒí•œ ë°œì£¼ì„œ ì‚¬ìš©"})]}),e.jsx(ss,{isOpen:_,onClose:()=>{R(!1),z([]),g(null)},mappingItems:w,onApplyMappings:o})]})},rs=({initialData:a={},onChange:A})=>{const[m,y]=u.useState({orderNumber:a.orderNumber||`PO-${new Date().getTime()}`,orderDate:a.orderDate||new Date,deliveryDate:a.deliveryDate||new Date(Date.now()+6048e5),projectId:a.projectId||"",projectName:a.projectName||"",vendorId:a.vendorId||"",vendorName:a.vendorName||"",vendorEmail:a.vendorEmail||"",items:a.items||[{itemName:"",specification:"",unit:"EA",quantity:1,unitPrice:0,totalAmount:0,majorCategory:"",middleCategory:"",minorCategory:"",notes:""}],notes:a.notes||"",totalAmount:a.totalAmount||0}),{data:E,isLoading:d,error:b}=de({queryKey:["projects"],queryFn:async()=>{console.log("ğŸ” í”„ë¡œì íŠ¸ ëª©ë¡ ì¡°íšŒ ì‹œì‘");const i=await fetch("/api/projects");if(!i.ok)throw new Error("í”„ë¡œì íŠ¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨");const s=await i.json();return console.log("âœ… í”„ë¡œì íŠ¸ ëª©ë¡ ì¡°íšŒ ì„±ê³µ:",s.length,"ê°œ"),s}}),{data:O,isLoading:p,error:k}=de({queryKey:["vendors"],queryFn:async()=>{console.log("ğŸ” ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ ì‹œì‘");const i=await fetch("/api/vendors");if(!i.ok)throw new Error("ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨");const s=await i.json();return console.log("âœ… ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ ì„±ê³µ:",s.length,"ê°œ"),s}}),{data:M,isLoading:L,error:I}=de({queryKey:["categories"],queryFn:async()=>{console.log("ğŸ” ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¡°íšŒ ì‹œì‘");const i=await fetch("/api/item-categories");if(!i.ok)throw new Error("ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨");const s=await i.json();return console.log("âœ… ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¡°íšŒ ì„±ê³µ:",s?.length,"ê°œ"),{categories:s}}}),x=u.useRef({}),j=u.useRef(!0);u.useEffect(()=>{if(a&&Object.keys(a).length>0){const i=x.current;(j.current||a.orderNumber!==i.orderNumber||a.projectName!==i.projectName||a.vendorName!==i.vendorName||a.items?.length!==i.items?.length)&&(console.log("ğŸ“ DirectInputForm: initialData ìœ ì˜ë¯¸í•œ ë³€ê²½ ê°ì§€",{isInitialLoad:j.current,orderNumber:a.orderNumber}),y({orderNumber:a.orderNumber||`PO-${new Date().getTime()}`,orderDate:a.orderDate?new Date(a.orderDate):new Date,deliveryDate:a.deliveryDate?new Date(a.deliveryDate):new Date(Date.now()+7*24*60*60*1e3),projectId:a.projectId||"",projectName:a.projectName||"",vendorId:a.vendorId||"",vendorName:a.vendorName||"",vendorEmail:a.vendorEmail||"",items:a.items||[{itemName:"",specification:"",unit:"EA",quantity:1,unitPrice:0,totalAmount:0,majorCategory:"",middleCategory:"",minorCategory:"",notes:""}],notes:a.notes||"",totalAmount:a.totalAmount||0}),x.current=a,j.current=!1)}},[a]),u.useEffect(()=>{const i=m.items.reduce((s,t)=>s+(t.totalAmount||0),0);i!==m.totalAmount&&y(s=>({...s,totalAmount:i}))},[m.items]),u.useEffect(()=>{const i=setTimeout(()=>{A(m)},100);return()=>clearTimeout(i)},[m.orderNumber,m.projectName,m.vendorName,m.vendorEmail,m.totalAmount,m.items.length]);const P=(i,s)=>{y(t=>({...t,[i]:s}))},_=i=>{const s=E?.find(t=>t.id.toString()===i);s&&y(t=>({...t,projectId:i,projectName:s.projectName}))},R=i=>{const s=O?.find(t=>t.id.toString()===i);s&&y(t=>({...t,vendorId:i,vendorName:s.name,vendorEmail:s.email||""}))},w=(i,s,t)=>{const o=[...m.items];o[i]={...o[i],[s]:t},(s==="quantity"||s==="unitPrice")&&(o[i].totalAmount=o[i].quantity*o[i].unitPrice),y(c=>({...c,items:o}))},z=()=>{y(i=>({...i,items:[...i.items,{itemName:"",specification:"",unit:"EA",quantity:1,unitPrice:0,totalAmount:0,majorCategory:"",middleCategory:"",minorCategory:"",notes:""}]}))},K=i=>{if(m.items.length>1){const s=m.items.filter((t,o)=>o!==i);y(t=>({...t,items:s}))}},g=()=>M?.categories?.filter(i=>i.categoryType==="major")||[],B=i=>{const s=M?.categories?.find(t=>t.categoryType==="major"&&t.categoryName===i);return s?M?.categories?.filter(t=>t.categoryType==="middle"&&t.parentId===s.id)||[]:[]},U=i=>{const s=M?.categories?.find(t=>t.categoryType==="middle"&&t.categoryName===i);return s?M?.categories?.filter(t=>t.categoryType==="minor"&&t.parentId===s.id)||[]:[]},q=(i,s,t)=>{const o=[...m.items],c=o[i];if(s==="major"){const r=g().find(l=>l.id.toString()===t);c.majorCategory=r?.categoryName||"",c.middleCategory="",c.minorCategory=""}else if(s==="middle"){const r=B(c.majorCategory).find(l=>l.id.toString()===t);c.middleCategory=r?.categoryName||"",c.minorCategory=""}else if(s==="minor"){const r=U(c.middleCategory).find(l=>l.id.toString()===t);c.minorCategory=r?.categoryName||""}y(r=>({...r,items:o}))};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ê¸°ë³¸ ì •ë³´"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"orderNumber",children:"ë°œì£¼ë²ˆí˜¸"}),e.jsx(J,{id:"orderNumber",value:m.orderNumber,onChange:i=>P("orderNumber",i.target.value),placeholder:"PO-20240101-001"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ë°œì£¼ì¼"}),e.jsxs(we,{children:[e.jsx(Ce,{asChild:!0,children:e.jsxs(N,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),Ee(m.orderDate,"PPP",{locale:Ie})]})}),e.jsx(Se,{className:"w-auto p-0",children:e.jsx(be,{mode:"single",selected:m.orderDate,onSelect:i=>i&&P("orderDate",i),initialFocus:!0})})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"í˜„ì¥"}),e.jsxs(X,{value:m.projectId,onValueChange:_,children:[e.jsx(W,{children:e.jsx(Q,{placeholder:d?"ë¡œë”© ì¤‘...":b?"ë¡œë”© ì‹¤íŒ¨":"í˜„ì¥ ì„ íƒ"})}),e.jsxs(Z,{children:[d&&e.jsx(T,{value:"loading",disabled:!0,children:"ë¡œë”© ì¤‘..."}),b&&e.jsx(T,{value:"error",disabled:!0,children:"ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"}),E?.map(i=>e.jsx(T,{value:i.id.toString(),children:i.projectName},i.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ë‚©ê¸°ì¼"}),e.jsxs(we,{children:[e.jsx(Ce,{asChild:!0,children:e.jsxs(N,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),Ee(m.deliveryDate,"PPP",{locale:Ie})]})}),e.jsx(Se,{className:"w-auto p-0",children:e.jsx(be,{mode:"single",selected:m.deliveryDate,onSelect:i=>i&&P("deliveryDate",i),initialFocus:!0})})]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ê±°ë˜ì²˜ ì •ë³´"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ê±°ë˜ì²˜"}),e.jsxs(X,{value:m.vendorId,onValueChange:R,children:[e.jsx(W,{children:e.jsx(Q,{placeholder:p?"ë¡œë”© ì¤‘...":k?"ë¡œë”© ì‹¤íŒ¨":"ê±°ë˜ì²˜ ì„ íƒ"})}),e.jsxs(Z,{children:[p&&e.jsx(T,{value:"loading",disabled:!0,children:"ë¡œë”© ì¤‘..."}),k&&e.jsx(T,{value:"error",disabled:!0,children:"ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"}),O?.map(i=>e.jsx(T,{value:i.id.toString(),children:i.name},i.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"vendorEmail",children:"ì´ë©”ì¼"}),e.jsx(J,{id:"vendorEmail",type:"email",value:m.vendorEmail,onChange:i=>P("vendorEmail",i.target.value),placeholder:"vendor@example.com"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"í’ˆëª© ì •ë³´"}),e.jsxs(N,{onClick:z,size:"sm",variant:"outline",children:[e.jsx(le,{className:"w-4 h-4 mr-1"}),"í’ˆëª© ì¶”ê°€"]})]}),e.jsx("div",{className:"space-y-4",children:m.items.map((i,s)=>e.jsxs("div",{className:"p-4 border rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"í’ˆëª©ëª…"}),e.jsx(J,{value:i.itemName,onChange:t=>w(s,"itemName",t.target.value),placeholder:"í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ê·œê²©"}),e.jsx(J,{value:i.specification,onChange:t=>w(s,"specification",t.target.value),placeholder:"ê·œê²©ì„ ì…ë ¥í•˜ì„¸ìš”"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ë‹¨ìœ„"}),e.jsxs(X,{value:i.unit,onValueChange:t=>w(s,"unit",t),children:[e.jsx(W,{children:e.jsx(Q,{placeholder:"ë‹¨ìœ„ ì„ íƒ"})}),e.jsxs(Z,{children:[e.jsx(T,{value:"EA",children:"EA"}),e.jsx(T,{value:"M",children:"M"}),e.jsx(T,{value:"M2",children:"MÂ²"}),e.jsx(T,{value:"M3",children:"MÂ³"}),e.jsx(T,{value:"KG",children:"KG"}),e.jsx(T,{value:"TON",children:"TON"}),e.jsx(T,{value:"SET",children:"SET"}),e.jsx(T,{value:"BOX",children:"BOX"}),e.jsx(T,{value:"ROLL",children:"ROLL"}),e.jsx(T,{value:"L",children:"L"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ëŒ€ë¶„ë¥˜"}),e.jsxs(X,{value:i.majorCategory?g().find(t=>t.categoryName===i.majorCategory)?.id.toString():"",onValueChange:t=>q(s,"major",t),children:[e.jsx(W,{children:e.jsx(Q,{placeholder:L?"ë¡œë”© ì¤‘...":I?"ë¡œë”© ì‹¤íŒ¨":"ëŒ€ë¶„ë¥˜ ì„ íƒ"})}),e.jsxs(Z,{children:[L&&e.jsx(T,{value:"loading",disabled:!0,children:"ë¡œë”© ì¤‘..."}),I&&e.jsx(T,{value:"error",disabled:!0,children:"ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"}),g().map(t=>e.jsx(T,{value:t.id.toString(),children:t.categoryName},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ì¤‘ë¶„ë¥˜"}),e.jsxs(X,{value:i.middleCategory?B(i.majorCategory).find(t=>t.categoryName===i.middleCategory)?.id.toString():"",onValueChange:t=>q(s,"middle",t),disabled:!i.majorCategory,children:[e.jsx(W,{children:e.jsx(Q,{placeholder:i.majorCategory?"ì¤‘ë¶„ë¥˜ ì„ íƒ":"ëŒ€ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"})}),e.jsx(Z,{children:B(i.majorCategory).map(t=>e.jsx(T,{value:t.id.toString(),children:t.categoryName},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ì†Œë¶„ë¥˜"}),e.jsxs(X,{value:i.minorCategory?U(i.middleCategory).find(t=>t.categoryName===i.minorCategory)?.id.toString():"",onValueChange:t=>q(s,"minor",t),disabled:!i.middleCategory,children:[e.jsx(W,{children:e.jsx(Q,{placeholder:i.middleCategory?"ì†Œë¶„ë¥˜ ì„ íƒ":"ì¤‘ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"})}),e.jsx(Z,{children:U(i.middleCategory).map(t=>e.jsx(T,{value:t.id.toString(),children:t.categoryName},t.id))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ìˆ˜ëŸ‰"}),e.jsx(J,{type:"number",value:i.quantity,onChange:t=>w(s,"quantity",Number(t.target.value)),min:"1",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ë‹¨ê°€"}),e.jsx(J,{type:"number",value:i.unitPrice,onChange:t=>w(s,"unitPrice",Number(t.target.value)),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ê¸ˆì•¡"}),e.jsxs("div",{className:"px-3 py-2 bg-muted border rounded-md text-sm font-medium text-foreground",children:[i.totalAmount.toLocaleString(),"ì›"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ì‘ì—…"}),e.jsxs(N,{onClick:()=>K(s),size:"sm",variant:"outline",className:"w-full text-red-600 border-red-200 hover:bg-red-50",disabled:m.items.length===1,children:[e.jsx(Re,{className:"w-4 h-4 mr-1"}),"ì‚­ì œ"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"í’ˆëª© ë¹„ê³ "}),e.jsx(ie,{value:i.notes,onChange:t=>w(s,"notes",t.target.value),placeholder:"ì´ í’ˆëª©ì— ëŒ€í•œ íŠ¹ë³„ ìš”ì²­ì‚¬í•­ì´ë‚˜ ì°¸ê³ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”",rows:2})]})]},s))}),e.jsx("div",{className:"flex justify-end p-3 bg-muted rounded-lg",children:e.jsxs("div",{className:"text-lg font-semibold text-foreground",children:["ì´ì•¡: ",m.totalAmount.toLocaleString(),"ì›"]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{htmlFor:"notes",children:"ë¹„ê³ "}),e.jsx(ie,{id:"notes",value:m.notes,onChange:i=>P("notes",i.target.value),placeholder:"ì¶”ê°€ ìš”ì²­ì‚¬í•­ì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”",rows:3})]})]})},as=({orderData:a,pdfUrl:A,processingStatus:m})=>{const[y,E]=u.useState([a.vendorEmail||""]),[d,b]=u.useState([]),[O,p]=u.useState(`ë°œì£¼ì„œ - ${a.orderNumber||""}`),[k,M]=u.useState("info");u.useState(!1);const[L,I]=u.useState([]),[x,j]=u.useState([]),[P,_]=u.useState(()=>`ì•ˆë…•í•˜ì„¸ìš”,

${a.vendorName||"ê±°ë˜ì²˜"} ë‹´ë‹¹ìë‹˜

ë°œì£¼ì„œë¥¼ ì²¨ë¶€í•˜ì—¬ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.

ë°œì£¼ë²ˆí˜¸: ${a.orderNumber||"-"}
í”„ë¡œì íŠ¸: ${a.projectName||"-"}
ë‚©ê¸°ì¼: ${a.deliveryDate?new Date(a.deliveryDate).toLocaleDateString("ko-KR"):"-"}

í™•ì¸ í›„ íšŒì‹  ë¶€íƒë“œë¦½ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`);u.useEffect(()=>{_(`ì•ˆë…•í•˜ì„¸ìš”,

${a.vendorName||"ê±°ë˜ì²˜"} ë‹´ë‹¹ìë‹˜

ë°œì£¼ì„œë¥¼ ì²¨ë¶€í•˜ì—¬ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.

ë°œì£¼ë²ˆí˜¸: ${a.orderNumber||"-"}
í”„ë¡œì íŠ¸: ${a.projectName||"-"}
ë‚©ê¸°ì¼: ${a.deliveryDate?new Date(a.deliveryDate).toLocaleDateString("ko-KR"):"-"}

í™•ì¸ í›„ íšŒì‹  ë¶€íƒë“œë¦½ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`)},[a.vendorName,a.orderNumber,a.projectName,a.deliveryDate]),u.useEffect(()=>{const s=[];a.processedExcelUrl&&s.push({id:"processed-excel",name:a.originalFileName||"ì²˜ë¦¬ëœ_Excel_íŒŒì¼.xlsx",size:0,type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",url:a.processedExcelUrl,isDefault:!0,isSelected:!0}),A&&m.pdf==="completed"&&s.push({id:"generated-pdf",name:`ë°œì£¼ì„œ_${a.orderNumber||"generated"}.pdf`,size:0,type:"application/pdf",url:A,isDefault:!0,isSelected:!0}),I(t=>{const o=t.filter(c=>!c.isDefault);return[...s,...o]})},[a.processedExcelUrl,A,m.pdf,a.orderNumber]);const R=s=>{s==="to"?E([...y,""]):b([...d,""])},w=(s,t)=>{s==="to"&&y.length>1?E(y.filter((o,c)=>c!==t)):s==="cc"&&b(d.filter((o,c)=>c!==t))},z=(s,t,o)=>{if(s==="to"){const c=[...y];c[t]=o,E(c)}else{const c=[...d];c[t]=o,b(c)}},K=async s=>{const t=Array.from(s);for(const o of t){const c=`custom-${Date.now()}-${Math.random()}`;j(r=>[...r,c]);try{const r={id:c,name:o.name,size:o.size,type:o.type,file:o,isDefault:!1,isSelected:!0};I(l=>[...l,r])}catch(r){console.error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:",r)}finally{j(r=>r.filter(l=>l!==c))}}},g=s=>{I(t=>t.map(o=>o.id===s?{...o,isSelected:!o.isSelected}:o))},B=s=>{I(t=>t.filter(o=>o.id!==s))},U=s=>{if(s===0)return"0 Bytes";const t=1024,o=["Bytes","KB","MB","GB"],c=Math.floor(Math.log(s)/Math.log(t));return parseFloat((s/Math.pow(t,c)).toFixed(2))+" "+o[c]},q=s=>s.includes("pdf")?e.jsx(re,{className:"w-4 h-4 text-red-600"}):s.includes("spreadsheet")||s.includes("excel")?e.jsx(re,{className:"w-4 h-4 text-green-600"}):e.jsx(pe,{className:"w-4 h-4 text-gray-600"}),i=s=>{switch(s){case"completed":return e.jsx(te,{className:"w-4 h-4 text-green-600"});case"processing":return e.jsx(G,{className:"w-4 h-4 text-blue-600 animate-spin"});case"error":return e.jsx(he,{className:"w-4 h-4 text-red-600"});default:return null}};return e.jsxs(ee,{className:"h-full",children:[e.jsx(Pe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Fe,{children:"ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(V,{variant:m.pdf==="completed"?"success":"secondary",children:[i(m.pdf),e.jsx("span",{className:"ml-1",children:"PDF"})]}),e.jsxs(V,{variant:m.vendor==="completed"?"success":"secondary",children:[i(m.vendor),e.jsx("span",{className:"ml-1",children:"ê±°ë˜ì²˜"})]}),e.jsxs(V,{variant:m.email==="completed"?"success":"secondary",children:[i(m.email),e.jsx("span",{className:"ml-1",children:"ì´ë©”ì¼"})]})]})]})}),e.jsx(se,{className:"h-[calc(100%-5rem)]",children:e.jsxs(We,{value:k,onValueChange:M,className:"h-full",children:[e.jsxs(Qe,{className:"grid w-full grid-cols-3",children:[e.jsxs(me,{value:"info",children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"ë°œì£¼ì„œ ì •ë³´"]}),e.jsxs(me,{value:"pdf",children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"PDF ë¯¸ë¦¬ë³´ê¸°"]}),e.jsxs(me,{value:"email",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"ì´ë©”ì¼ ì„¤ì •"]})]}),e.jsx(xe,{value:"pdf",className:"h-[calc(100%-3rem)]",children:m.pdf==="processing"?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(G,{className:"w-12 h-12 mx-auto text-blue-600 animate-spin"}),e.jsx("p",{className:"text-sm text-gray-600",children:"PDFë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."})]})}):m.pdf==="error"?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(he,{className:"w-12 h-12 mx-auto text-red-600"}),e.jsx("p",{className:"text-sm text-red-600",children:"PDF ìƒì„± ì‹¤íŒ¨"}),e.jsxs(N,{variant:"outline",size:"sm",children:[e.jsx(ze,{className:"w-4 h-4 mr-2"}),"ë‹¤ì‹œ ì‹œë„"]})]})}):A&&m.pdf==="completed"?e.jsx("div",{className:"w-full h-full flex flex-col",children:e.jsx("div",{className:"flex-1 bg-gray-50 rounded-lg p-8 flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(te,{className:"w-16 h-16 mx-auto text-green-600"}),e.jsx("h3",{className:"text-lg font-medium",children:"PDFê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"}),e.jsx("p",{className:"text-sm text-gray-600",children:"ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ PDFë¥¼ í™•ì¸í•˜ì„¸ìš”"}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-6",children:[e.jsxs(N,{variant:"default",onClick:()=>window.open(A,"_blank"),children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"PDF ë¯¸ë¦¬ë³´ê¸°"]}),e.jsxs(N,{variant:"outline",onClick:()=>window.open(`${A}?download=true`,"_blank"),children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"PDF ë‹¤ìš´ë¡œë“œ"]})]})]})})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(re,{className:"w-12 h-12 mx-auto text-gray-400"}),e.jsx("p",{className:"text-sm text-gray-600",children:"ë°œì£¼ì„œ ì •ë³´ê°€ ì™„ì„±ë˜ë©´ PDFê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤"}),e.jsx("p",{className:"text-xs text-gray-500",children:"ë¨¼ì € 'ë°œì£¼ì„œ ì •ë³´' íƒ­ì—ì„œ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”"})]})})}),e.jsxs(xe,{value:"info",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(f,{className:"text-xs text-gray-600",children:"ë°œì£¼ë²ˆí˜¸"}),e.jsx("p",{className:"font-medium",children:a.orderNumber||"-"})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-xs text-gray-600",children:"ë°œì£¼ì¼"}),e.jsx("p",{className:"font-medium",children:a.orderDate?new Date(a.orderDate).toLocaleDateString("ko-KR"):"-"})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-xs text-gray-600",children:"í”„ë¡œì íŠ¸"}),e.jsx("p",{className:"font-medium",children:a.projectName||"-"})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-xs text-gray-600",children:"ê±°ë˜ì²˜"}),e.jsx("p",{className:"font-medium",children:a.vendorName||"-"})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-xs text-gray-600",children:"ë‚©ê¸°ì¼"}),e.jsx("p",{className:"font-medium",children:a.deliveryDate?new Date(a.deliveryDate).toLocaleDateString("ko-KR"):"-"})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-xs text-gray-600",children:"ì´ì•¡"}),e.jsx("p",{className:"font-medium text-lg text-blue-600",children:a.totalAmount?`${Math.floor(a.totalAmount).toLocaleString()}ì›`:"-"})]})]}),a.items&&a.items.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"text-xs text-gray-600",children:"í’ˆëª© ëª©ë¡"}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left p-2",children:"í’ˆëª©ëª…"}),e.jsx("th",{className:"text-right p-2",children:"ìˆ˜ëŸ‰"}),e.jsx("th",{className:"text-right p-2",children:"ë‹¨ê°€"}),e.jsx("th",{className:"text-right p-2",children:"ê¸ˆì•¡"})]})}),e.jsx("tbody",{children:a.items.map((s,t)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:s.itemName||s.name}),e.jsx("td",{className:"text-right p-2",children:Math.floor(s.quantity||0).toLocaleString()}),e.jsxs("td",{className:"text-right p-2",children:[Math.floor(s.unitPrice||0).toLocaleString(),"ì›"]}),e.jsxs("td",{className:"text-right p-2",children:[Math.floor(s.totalAmount||s.quantity*s.unitPrice||0).toLocaleString(),"ì›"]})]},t))})]})})]})]}),e.jsx(xe,{value:"email",className:"space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{children:"ë°›ëŠ” ì‚¬ëŒ"}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>R("to"),children:e.jsx(le,{className:"w-4 h-4"})})]}),y.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{type:"email",value:s,onChange:o=>z("to",t,o.target.value),placeholder:"email@example.com"}),y.length>1&&e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>w("to",t),children:e.jsx(ae,{className:"w-4 h-4"})})]},t))]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{children:"ì°¸ì¡° (CC)"}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>R("cc"),children:e.jsx(le,{className:"w-4 h-4"})})]}),d.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{type:"email",value:s,onChange:o=>z("cc",t,o.target.value),placeholder:"cc@example.com"}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>w("cc",t),children:e.jsx(ae,{className:"w-4 h-4"})})]},t))]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ì œëª©"}),e.jsx(J,{value:O,onChange:s=>p(s.target.value),placeholder:"ì´ë©”ì¼ ì œëª©"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"ë©”ì¼ ë³¸ë¬¸"}),e.jsx(ie,{value:P,onChange:s=>_(s.target.value),placeholder:"ì´ë©”ì¼ ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”",className:"min-h-[200px] font-mono text-sm",rows:10})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{children:"ì²¨ë¶€íŒŒì¼"}),e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept=".pdf,.xlsx,.xls,.doc,.docx,.txt",s.onchange=t=>{const o=t.target;o.files&&o.files.length>0&&K(o.files)},s.click()},children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"íŒŒì¼ ì¶”ê°€"]})]}),e.jsx("div",{className:"space-y-3",children:L.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-center py-4",children:"ì²¨ë¶€í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"}):L.map(s=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg bg-gray-50",children:[e.jsx(ne,{checked:s.isSelected,onCheckedChange:()=>g(s.id)}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[q(s.type),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsx("span",{children:U(s.size)}),s.isDefault&&e.jsx(V,{variant:"secondary",className:"text-xs",children:"ê¸°ë³¸íŒŒì¼"})]})]})]}),x.includes(s.id)&&e.jsx(G,{className:"w-4 h-4 animate-spin text-blue-600"}),!s.isDefault&&!x.includes(s.id)&&e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>B(s.id),children:e.jsx(Re,{className:"w-4 h-4 text-red-600"})})]},s.id))}),L.length>0&&e.jsx("div",{className:"p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:["ì„ íƒëœ íŒŒì¼: ",L.filter(s=>s.isSelected).length,"/",L.length,"ê°œ"]})})]})]})})]})})]})},ls=({orderData:a,pdfUrl:A,processingStatus:m,onSave:y,onSend:E,onDownload:d,onCreateOrder:b,onCreateOrderWithEmail:O})=>{const{isCollapsed:p}=Ve(),[k,M]=u.useState(!0),[L,I]=u.useState(!1),[x,j]=u.useState({to:[a.vendorEmail||""].filter(Boolean),cc:[],subject:`ë°œì£¼ì„œ - ${a.orderNumber||""} (${new Date().toLocaleDateString("ko-KR")})`,message:`ì•ˆë…•í•˜ì„¸ìš”,

ì²¨ë¶€ëœ ë°œì£¼ì„œë¥¼ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`,attachments:{includeExcel:!0,includePdf:!0,additionalFiles:[]}}),[P,_]=u.useState(""),[R,w]=u.useState("");u.useEffect(()=>{const r=a.vendorEmail||"",l=r?[r]:[];console.log("ğŸ” orderData ë³€ê²½ ê°ì§€:",{vendorEmail:r,newToEmails:l}),j(h=>({...h,to:l,subject:`ë°œì£¼ì„œ - ${a.orderNumber||""} (${new Date().toLocaleDateString("ko-KR")})`}))},[a.vendorEmail,a.orderNumber]);const z=()=>{P.trim()&&!x.to.includes(P.trim())&&(j(r=>({...r,to:[...r.to,P.trim()]})),_(""))},K=r=>{j(l=>({...l,to:l.to.filter(h=>h!==r)}))},g=()=>{R.trim()&&!x.cc.includes(R.trim())&&(j(r=>({...r,cc:[...r.cc,R.trim()]})),w(""))},B=r=>{j(l=>({...l,cc:l.cc.filter(h=>h!==r)}))},U=r=>{const l=Array.from(r.target.files||[]);j(h=>({...h,attachments:{...h.attachments,additionalFiles:[...h.attachments.additionalFiles,...l]}}))},q=r=>{j(l=>({...l,attachments:{...l.attachments,additionalFiles:l.attachments.additionalFiles.filter((h,v)=>v!==r)}}))},i=m.pdf==="completed"&&m.vendor==="completed"&&x.to.length>0,s=a.orderNumber&&a.vendorName&&a.projectName&&a.items?.length>0,t=Object.values(m).some(r=>r==="processing"),o=()=>{k&&O?I(!0):b()},c=()=>{I(!1),O&&O(x)};return e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 bg-background border-t border-border shadow-lg z-30",children:[e.jsxs("div",{className:Y("container mx-auto px-6 py-4 transition-all duration-300",p?"xl:ml-16":"xl:ml-64"),children:[e.jsxs("div",{className:"flex flex-col gap-3 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-muted rounded-lg text-sm",children:[e.jsx(ne,{id:"send-email",checked:k,onCheckedChange:r=>M(!!r),className:"h-4 w-4"}),e.jsx("label",{htmlFor:"send-email",className:"font-medium cursor-pointer text-foreground whitespace-nowrap text-xs",children:"ë°œì£¼ì„œ ìƒì„± í›„ ì´ë©”ì¼ ìë™ ë°œì†¡"}),t&&e.jsxs("div",{className:"flex items-center gap-1 ml-2 text-xs text-muted-foreground",children:[e.jsx(G,{className:"w-3 h-3 animate-spin"}),"ì²˜ë¦¬ ì¤‘"]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[e.jsxs(N,{variant:"outline",onClick:y,disabled:t,size:"sm",className:"text-xs px-3 py-2 h-8",children:[e.jsx(Ze,{className:"w-3 h-3 mr-1"}),"ì„ì‹œì €ì¥"]}),e.jsxs(N,{variant:"outline",onClick:d,disabled:!A||m.pdf!=="completed",size:"sm",className:"text-xs px-3 py-2 h-8",children:[e.jsx(ve,{className:"w-3 h-3 mr-1"}),"ë‹¤ìš´ë¡œë“œ"]}),!k&&e.jsx(N,{onClick:E,disabled:!i||m.email==="processing",size:"sm",className:Y("text-xs px-3 py-2 h-8",i?"bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700":""),children:m.email==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-3 h-3 mr-1 animate-spin"}),"ë°œì†¡ì¤‘"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"w-3 h-3 mr-1"}),"ì´ë©”ì¼ ë°œì†¡"]})}),e.jsx(N,{variant:"default",onClick:o,disabled:!s||m.order==="processing",size:"sm",className:Y("text-xs px-4 py-2 h-8 font-medium",s?k?"bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700":"bg-green-600 hover:bg-green-700 dark:bg-green-600 dark:hover:bg-green-700":""),children:m.order==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-3 h-3 mr-1 animate-spin"}),k?"ìƒì„± ë° ë°œì†¡ ì¤‘":"ìƒì„± ì¤‘"]}):e.jsx(e.Fragment,{children:k?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-3 h-3 mr-1"}),"ë°œì£¼ì„œ ìƒì„± ë° ë°œì†¡"]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-3 h-3 mr-1"}),"ë°œì£¼ì„œ ìƒì„±"]})})}),e.jsxs(N,{variant:"ghost",onClick:()=>window.location.href="/orders",disabled:t,size:"sm",className:"text-xs px-3 py-2 h-8 text-muted-foreground hover:text-foreground",children:[e.jsx(es,{className:"w-3 h-3 mr-1"}),"ë°œì£¼ì„œ ê´€ë¦¬"]})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-center gap-6 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",m.pdf==="completed"?"bg-green-500":m.pdf==="processing"?"bg-blue-500 animate-pulse":m.pdf==="error"?"bg-red-500":"bg-muted-foreground")}),"PDF ìƒì„±"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",m.vendor==="completed"?"bg-green-500":m.vendor==="processing"?"bg-blue-500 animate-pulse":m.vendor==="error"?"bg-red-500":"bg-muted-foreground")}),"ê±°ë˜ì²˜ í™•ì¸"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",m.order==="completed"?"bg-green-500":m.order==="processing"?"bg-blue-500 animate-pulse":m.order==="error"?"bg-red-500":"bg-muted-foreground")}),"ë°œì£¼ì„œ ìƒì„±"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",m.email==="completed"?"bg-green-500":m.email==="processing"?"bg-blue-500 animate-pulse":m.email==="error"?"bg-red-500":"bg-muted-foreground")}),"ì´ë©”ì¼ ì¤€ë¹„"]})]})]}),e.jsx(Te,{open:L,onOpenChange:I,children:e.jsxs(Ae,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Oe,{children:e.jsx(De,{children:"ì´ë©”ì¼ ë°œì†¡ ì„¤ì •"})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(f,{className:"text-sm font-medium",children:"ë°›ëŠ” ì‚¬ëŒ *"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[x.to.map((r,l)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx("span",{className:"flex-1 text-sm text-foreground",children:r}),e.jsx(N,{type:"button",variant:"ghost",size:"sm",onClick:()=>K(r),className:"h-6 w-6 p-0 hover:bg-red-100 dark:hover:bg-red-900",children:e.jsx(ae,{className:"h-3 w-3"})})]},l)),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(J,{value:P,onChange:r=>_(r.target.value),placeholder:"example@company.com",onKeyPress:r=>r.key==="Enter"&&z(),className:"flex-1"}),e.jsx(N,{type:"button",variant:"outline",size:"sm",onClick:z,disabled:!P.trim(),children:e.jsx(le,{className:"h-4 w-4"})})]})]})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-sm font-medium",children:"ì°¸ì¡° (CC)"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[x.cc.map((r,l)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx("span",{className:"flex-1 text-sm text-foreground",children:r}),e.jsx(N,{type:"button",variant:"ghost",size:"sm",onClick:()=>B(r),className:"h-6 w-6 p-0 hover:bg-red-100 dark:hover:bg-red-900",children:e.jsx(ae,{className:"h-3 w-3"})})]},l)),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(J,{value:R,onChange:r=>w(r.target.value),placeholder:"manager@company.com (ì„ íƒì‚¬í•­)",onKeyPress:r=>r.key==="Enter"&&g(),className:"flex-1"}),e.jsx(N,{type:"button",variant:"outline",size:"sm",onClick:g,disabled:!R.trim(),children:e.jsx(le,{className:"h-4 w-4"})})]})]})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"email-subject",className:"text-sm font-medium",children:"ì œëª© *"}),e.jsx(J,{id:"email-subject",value:x.subject,onChange:r=>j(l=>({...l,subject:r.target.value})),className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"email-message",className:"text-sm font-medium",children:"ë©”ì‹œì§€"}),e.jsx(ie,{id:"email-message",value:x.message,onChange:r=>j(l=>({...l,message:r.target.value})),rows:4,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{className:"text-sm font-medium",children:"ì²¨ë¶€íŒŒì¼"}),e.jsxs("div",{className:"mt-2 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ne,{id:"include-excel",checked:x.attachments.includeExcel,onCheckedChange:r=>j(l=>({...l,attachments:{...l.attachments,includeExcel:!!r}}))}),e.jsx(f,{htmlFor:"include-excel",className:"text-sm",children:"Excel íŒŒì¼ ì²¨ë¶€"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ne,{id:"include-pdf",checked:x.attachments.includePdf,onCheckedChange:r=>j(l=>({...l,attachments:{...l.attachments,includePdf:!!r}}))}),e.jsx(f,{htmlFor:"include-pdf",className:"text-sm",children:"PDF íŒŒì¼ ì²¨ë¶€"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(f,{className:"text-sm",children:"ì¶”ê°€ íŒŒì¼"}),e.jsxs(N,{type:"button",variant:"outline",size:"sm",onClick:()=>document.getElementById("additional-files")?.click(),className:"h-8",children:[e.jsx(pe,{className:"h-3 w-3 mr-1"}),"íŒŒì¼ ì„ íƒ"]})]}),e.jsx("input",{id:"additional-files",type:"file",multiple:!0,onChange:U,className:"hidden"}),x.attachments.additionalFiles.length>0&&e.jsx("div",{className:"space-y-1",children:x.attachments.additionalFiles.map((r,l)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx(pe,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{className:"flex-1 text-sm text-foreground",children:r.name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[(r.size/1024).toFixed(1)," KB"]}),e.jsx(N,{type:"button",variant:"ghost",size:"sm",onClick:()=>q(l),className:"h-6 w-6 p-0 hover:bg-red-100 dark:hover:bg-red-900",children:e.jsx(ae,{className:"h-3 w-3"})})]},l))})]})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground bg-blue-50 dark:bg-blue-950 p-2 rounded",children:"ğŸ“ ì„ íƒí•œ ì²¨ë¶€íŒŒì¼ì´ ì´ë©”ì¼ê³¼ í•¨ê»˜ ë°œì†¡ë©ë‹ˆë‹¤."})]}),e.jsxs(Le,{className:"mt-6",children:[e.jsx(N,{variant:"outline",onClick:()=>I(!1),children:"ì·¨ì†Œ"}),e.jsxs(N,{onClick:c,disabled:x.to.length===0||!x.subject,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"ë°œì£¼ì„œ ìƒì„±"]})]}),e.jsxs("div",{className:"mt-2 p-2 bg-gray-100 text-xs text-gray-600 rounded",children:["ğŸ” Debug: to.length=",x.to.length,', subject="',x.subject,'", disabled=',x.to.length===0||!x.subject]})]})})]})},ns=({orderData:a,onSuggestionApply:A})=>{const[m,y]=u.useState([]),[E,d]=u.useState(new Set),[b,O]=u.useState(!1);u.useEffect(()=>{p()},[a]);const p=()=>{O(!0);const x=[];if(a.vendorName&&!a.vendorEmail&&x.push({id:"vendor-email",type:"autofill",title:"ê±°ë˜ì²˜ ì´ë©”ì¼ ìë™ ì™„ì„±",description:"ë“±ë¡ëœ ê±°ë˜ì²˜ ì •ë³´ì—ì„œ ì´ë©”ì¼ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",action:{label:"ì´ë©”ì¼ ìë™ ì…ë ¥",data:{vendorEmail:"vendor@example.com"}},priority:"high"}),a.deliveryDate){const j=new Date(a.deliveryDate),P=new Date,_=Math.ceil((j.getTime()-P.getTime())/(1e3*60*60*24));_<3&&x.push({id:"delivery-urgent",type:"warning",title:"ê¸´ê¸‰ ë‚©ê¸°",description:`ë‚©ê¸°ì¼ì´ ${_}ì¼ ë‚¨ì•˜ìŠµë‹ˆë‹¤. ê¸´ê¸‰ ì²˜ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.`,priority:"high"})}a.projectName&&!a.notes&&x.push({id:"project-defaults",type:"recommendation",title:"í”„ë¡œì íŠ¸ ê¸°ë³¸ ì„¤ì •",description:"ì´ì „ ë°œì£¼ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ìì£¼ ì‚¬ìš©í•˜ëŠ” ì„¤ì •ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",action:{label:"ê¸°ë³¸ê°’ ì ìš©",data:{notes:"ìƒì°¨ í›„ ì—°ë½ ìš”ë§",deliveryLocation:"í˜„ì¥ ì§ë‚©"}},priority:"medium"}),a.totalAmount>1e7&&x.push({id:"amount-check",type:"info",title:"ê³ ì•¡ ë°œì£¼ì„œ",description:"1ì²œë§Œì› ì´ìƒì˜ ë°œì£¼ì„œì…ë‹ˆë‹¤. ê²°ì¬ ìŠ¹ì¸ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",priority:"medium"}),a.vendorName&&a.vendorName.length>2&&["(ì£¼)ABCê±´ì„¤","(ì£¼)ABCì¢…í•©ê±´ì„¤"].length>0&&x.push({id:"similar-vendors",type:"recommendation",title:"ìœ ì‚¬ ê±°ë˜ì²˜ ë°œê²¬",description:`'${a.vendorName}'ì™€ ìœ ì‚¬í•œ ê±°ë˜ì²˜ê°€ ìˆìŠµë‹ˆë‹¤. í™•ì¸í•´ë³´ì„¸ìš”.`,priority:"low"}),y(x.filter(j=>!E.has(j.id))),O(!1)},k=x=>{x.action&&(A(x.action.data),M(x.id))},M=x=>{d(j=>new Set(j).add(x)),y(j=>j.filter(P=>P.id!==x))},L=x=>{switch(x){case"warning":return e.jsx(ue,{className:"w-5 h-5 text-yellow-600"});case"info":return e.jsx(je,{className:"w-5 h-5 text-blue-600"});case"recommendation":return e.jsx(Me,{className:"w-5 h-5 text-green-600"});case"autofill":return e.jsx(fe,{className:"w-5 h-5 text-purple-600"});default:return e.jsx(je,{className:"w-5 h-5 text-gray-600"})}},I=x=>{switch(x){case"warning":return"bg-yellow-50 border-yellow-200";case"info":return"bg-blue-50 border-blue-200";case"recommendation":return"bg-green-50 border-green-200";case"autofill":return"bg-purple-50 border-purple-200";default:return"bg-gray-50 border-gray-200"}};return m.length===0&&!b?null:e.jsxs(ee,{children:[e.jsx(Pe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Fe,{className:"text-lg flex items-center gap-2",children:[e.jsx(fe,{className:"w-5 h-5 text-yellow-500"}),"ìŠ¤ë§ˆíŠ¸ ì–´ì‹œìŠ¤íŠ¸"]}),b&&e.jsx(ze,{className:"w-4 h-4 text-gray-500 animate-spin"})]})}),e.jsxs(se,{className:"space-y-3",children:[m.sort((x,j)=>{const P={high:0,medium:1,low:2};return P[x.priority]-P[j.priority]}).map(x=>e.jsx(oe,{className:`${I(x.type)} border`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[L(x.type),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-medium text-sm",children:x.title}),x.priority==="high"&&e.jsx(V,{variant:"destructive",className:"text-xs",children:"ì¤‘ìš”"})]}),e.jsx(ce,{className:"text-xs",children:x.description}),x.action&&e.jsxs(N,{size:"sm",variant:"outline",className:"mt-2",onClick:()=>k(x),children:[x.action.label,e.jsx($e,{className:"w-3 h-3 ml-1"})]})]}),e.jsx(N,{size:"sm",variant:"ghost",className:"text-gray-400 hover:text-gray-600 h-6 w-6 p-0",onClick:()=>M(x.id),children:"Ã—"})]})},x.id)),m.length===0&&!b&&e.jsxs("div",{className:"text-center py-4 text-sm text-gray-500",children:[e.jsx(te,{className:"w-8 h-8 text-green-500 mx-auto mb-2"}),"ëª¨ë“  í•­ëª©ì´ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤"]})]})]})},Us=()=>{const{toast:a}=Ke(),{user:A,isAuthenticated:m}=Je(),[y,E]=u.useState(null),[d,b]=u.useState({}),[O,p]=u.useState({pdf:"idle",vendor:"idle",email:"idle",order:"idle"}),[k,M]=u.useState(null),[L,I]=u.useState(!1),[x,j]=u.useState(!1),P=u.useCallback(()=>{console.log("ğŸ”„ ë°œì£¼ì„œ ì‘ì„± í˜ì´ì§€ ì´ˆê¸°í™”"),E(null),b({}),p({pdf:"idle",vendor:"idle",email:"idle",order:"idle"}),M(null),I(!1),j(!1),localStorage.removeItem("draftOrder")},[]);u.useEffect(()=>{if(x&&d.orderNumber){const s=setTimeout(()=>{_()},2e3);return()=>clearTimeout(s)}},[d,x]),u.useEffect(()=>{if(d.orderNumber&&d.vendorName&&d.projectName&&d.items?.length>0){const s=setTimeout(()=>{R()},500);return()=>clearTimeout(s)}},[d.orderNumber,d.vendorName,d.projectName,d.items]);const _=async()=>{I(!0);try{localStorage.setItem("draftOrder",JSON.stringify(d)),j(!1)}catch(s){console.error("Auto-save failed:",s)}finally{I(!1)}},R=async()=>{if(d.orderNumber){console.log("ğŸ”µ PDF ìƒì„± ì‹œì‘:",d),p(s=>({...s,pdf:"processing"}));try{const s=d.totalAmount||(d.items||[]).reduce((c,r)=>c+(r.quantity||0)*(r.unitPrice||0),0),t={...d,totalAmount:s};console.log("ğŸ”µ PDF ìƒì„± ìš”ì²­ ë°ì´í„°:",t);const o=await fetch("/api/orders/generate-pdf",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderData:t})});if(o.ok){const c=await o.json();console.log("ğŸ”µ PDF ìƒì„± ì‘ë‹µ:",c);const r=c.pdfUrl.startsWith("http")?c.pdfUrl:`${window.location.origin}${c.pdfUrl}`;console.log("ğŸ”µ PDF URL:",r),M(r),p(l=>({...l,pdf:"completed"})),fetch(r,{method:"HEAD"}).then(l=>{console.log("ğŸ”µ PDF ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸:",l.status,l.headers.get("content-type"))}).catch(l=>{console.error("ğŸ”´ PDF ì ‘ê·¼ ì‹¤íŒ¨:",l)})}else{const c=await o.text();throw console.error("ğŸ”´ PDF ìƒì„± ì‹¤íŒ¨ ì‘ë‹µ:",o.status,c),new Error(`PDF ìƒì„± ì‹¤íŒ¨: ${o.status}`)}}catch(s){p(t=>({...t,pdf:"error"})),console.error("ğŸ”´ PDF generation error:",s)}}},w=s=>{E(s);const t=localStorage.getItem("draftOrder");if(t)try{const o=JSON.parse(t);console.log("ğŸ“‹ ì„ì‹œì €ì¥ ë°ì´í„° ë°œê²¬:",o),window.confirm("ì €ì¥ëœ ì„ì‹œ ì‘ì—…ì´ ìˆìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")?(console.log("âœ… ì‚¬ìš©ì í™•ì¸: ì„ì‹œì €ì¥ ë°ì´í„° ë¡œë“œ ì‹œì‘"),b(c=>(console.log("ğŸ”„ ì´ì „ orderData:",c),console.log("ğŸ”„ ìƒˆë¡œìš´ orderData:",o),{...o})),j(!1),a({title:"ì„ì‹œì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ",description:`ë°œì£¼ë²ˆí˜¸ ${o.orderNumber||"ë¯¸ì •"}ì˜ ì„ì‹œ ì‘ì—…ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`})):(console.log("âŒ ì‚¬ìš©ì ì·¨ì†Œ: ì„ì‹œì €ì¥ ë°ì´í„° ë¡œë“œ ì·¨ì†Œ"),localStorage.removeItem("draftOrder"))}catch(o){console.error("âŒ ì„ì‹œì €ì¥ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:",o),localStorage.removeItem("draftOrder"),a({title:"ì„ì‹œì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨",description:"ì €ì¥ëœ ë°ì´í„°ê°€ ì†ìƒë˜ì–´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}else console.log("ğŸ“‹ ì„ì‹œì €ì¥ ë°ì´í„° ì—†ìŒ")},z=u.useCallback(s=>{b(t=>Object.keys(s).some(c=>JSON.stringify(s[c])!==JSON.stringify(t[c]))?{...t,...s}:t),j(!0),s.vendorName&&s.vendorName!==d.vendorName&&g(s.vendorName)},[d.vendorName]),K=s=>{b(t=>({...t,processedExcelUrl:s.url,originalFileName:s.name}))},g=async s=>{p(t=>({...t,vendor:"processing"}));try{const t=await fetch("/api/vendors/validate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({vendorName:s})});if(t.ok){const o=await t.json();o.isValid?(p(c=>({...c,vendor:"completed"})),o.vendorEmail&&b(c=>({...c,vendorEmail:o.vendorEmail}))):p(c=>({...c,vendor:"error"}))}}catch{p(o=>({...o,vendor:"error"}))}},B=async()=>{if(!d.orderNumber||!d.vendorName||!d.projectName||!d.items?.length){a({title:"ìƒì„± ë¶ˆê°€",description:"í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.",variant:"destructive"});return}if(p(s=>({...s,order:"processing"})),!m||!A){console.error("ğŸ”´ ì¸ì¦ ì‹¤íŒ¨ - ë¡œê·¸ì¸ í•„ìš”"),a({title:"ì¸ì¦ í•„ìš”",description:"ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.",variant:"destructive"}),p(s=>({...s,order:"error"})),setTimeout(()=>{window.location.href="/login"},2e3);return}console.log("ğŸ” í˜„ì¬ ì‚¬ìš©ì:",A);try{console.log("ğŸŸ¢ ë°œì£¼ì„œ ìƒì„± ì‹œì‘:",d);const s=new FormData;s.append("projectId","1"),s.append("vendorId","1"),s.append("orderDate",d.orderDate||new Date().toISOString()),s.append("deliveryDate",d.deliveryDate||new Date().toISOString()),s.append("notes",d.notes||`ë°œì£¼ì„œ ì‘ì„±ìœ¼ë¡œ ìƒì„±ëœ ë°œì£¼ì„œ - ${d.orderNumber}`);const t=(d.items||[]).map(c=>({itemName:c.name||c.itemName||"",specification:c.specification||"",unit:c.unit||"EA",quantity:parseFloat(c.quantity||"0"),unitPrice:parseFloat(c.unitPrice||"0"),totalAmount:parseFloat(c.quantity||"0")*parseFloat(c.unitPrice||"0"),majorCategory:c.majorCategory||"",middleCategory:c.middleCategory||"",minorCategory:c.minorCategory||"",notes:c.notes||""}));s.append("items",JSON.stringify(t)),console.log("ğŸŸ¢ ë°œì£¼ì„œ ìƒì„± ìš”ì²­ ë°ì´í„°:",{projectId:"1",vendorId:"1",orderDate:d.orderDate||new Date().toISOString(),deliveryDate:d.deliveryDate||new Date().toISOString(),notes:d.notes||`ë°œì£¼ì„œ ì‘ì„±ìœ¼ë¡œ ìƒì„±ëœ ë°œì£¼ì„œ - ${d.orderNumber}`,items:t});const o=await fetch("/api/orders",{method:"POST",body:s});if(console.log("ğŸŸ¢ ë°œì£¼ì„œ ìƒì„± ì‘ë‹µ ìƒíƒœ:",o.status),o.ok){const c=await o.json();console.log("ğŸŸ¢ ìƒì„±ëœ ë°œì£¼ì„œ:",c),p(r=>({...r,order:"completed"})),a({title:"ìƒì„± ì™„ë£Œ",description:`ë°œì£¼ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (${c.orderNumber||d.orderNumber}) ê³„ì†í•´ì„œ ë‹¤ë¥¸ í’ˆëª©ìœ¼ë¡œ ë°œì£¼ì„œë¥¼ ìƒì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,duration:5e3})}else{const c=await o.text();console.error("ğŸ”´ ë°œì£¼ì„œ ìƒì„± ì‹¤íŒ¨ ì‘ë‹µ:",o.status,c);let r="ë°œì£¼ì„œ ìƒì„± ì‹¤íŒ¨";try{r=JSON.parse(c).message||r}catch{r=`HTTP ${o.status}: ${c}`}throw new Error(r)}}catch(s){p(t=>({...t,order:"error"})),a({title:"ìƒì„± ì‹¤íŒ¨",description:s instanceof Error?s.message:"ë°œì£¼ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}},U=async s=>{if(console.log("ğŸ“§ ë°œì£¼ì„œ ìƒì„± ë° ì´ë©”ì¼ ë°œì†¡ ì‹œì‘:",{orderData:d,emailSettings:s}),!d.orderNumber||!d.vendorName||!d.projectName||!d.items?.length){a({title:"ìƒì„± ë¶ˆê°€",description:"í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.",variant:"destructive"});return}p(t=>({...t,order:"processing",email:"processing"}));try{console.log("ğŸŸ¢ Step 1: ë°œì£¼ì„œ ìƒì„±");const t=new FormData;t.append("projectId","1"),t.append("vendorId","1"),t.append("orderDate",d.orderDate||new Date().toISOString()),t.append("deliveryDate",d.deliveryDate||new Date().toISOString()),t.append("notes",d.notes||`ë°œì£¼ì„œ ì‘ì„±ìœ¼ë¡œ ìƒì„±ëœ ë°œì£¼ì„œ - ${d.orderNumber}`);const o=(d.items||[]).map(l=>({itemName:l.name||l.itemName||"",specification:l.specification||"",unit:l.unit||"EA",quantity:parseFloat(l.quantity||"0"),unitPrice:parseFloat(l.unitPrice||"0"),totalAmount:parseFloat(l.quantity||"0")*parseFloat(l.unitPrice||"0"),majorCategory:l.majorCategory||"",middleCategory:l.middleCategory||"",minorCategory:l.minorCategory||"",notes:l.notes||""}));t.append("items",JSON.stringify(o));const c=await fetch("/api/orders",{method:"POST",body:t});if(!c.ok)throw new Error("ë°œì£¼ì„œ ìƒì„± ì‹¤íŒ¨");const r=await c.json();if(console.log("ğŸŸ¢ ë°œì£¼ì„œ ìƒì„± ì™„ë£Œ:",r),p(l=>({...l,order:"completed"})),console.log("ğŸ“§ Step 2: ì´ë©”ì¼ ë°œì†¡"),console.log("ğŸ” processedExcelUrl í™•ì¸:",d.processedExcelUrl),console.log("ğŸ” ì´ë©”ì¼ ì„¤ì • í™•ì¸:",s),d.processedExcelUrl)try{console.log("ğŸ“¤ Excel ì´ë©”ì¼ ìš”ì²­ ì‹œì‘...");const l=await fetch("/api/orders/send-email-with-excel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({emailSettings:{to:s.to,cc:s.cc||"",subject:s.subject,message:s.message,orderNumber:d.orderNumber,vendorName:d.vendorName,totalAmount:d.totalAmount},excelFilePath:d.processedExcelUrl,orderData:d})});if(l.ok)console.log("ğŸ“§ ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ"),p(h=>({...h,email:"completed"})),a({title:"ìƒì„± ë° ë°œì†¡ ì™„ë£Œ",description:`ë°œì£¼ì„œê°€ ìƒì„±ë˜ê³  ì´ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. (${r.orderNumber||d.orderNumber}) ê³„ì†í•´ì„œ ë‹¤ë¥¸ í’ˆëª©ìœ¼ë¡œ ë°œì£¼ì„œë¥¼ ìƒì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,duration:5e3});else{const h=await l.text();throw console.error("ğŸ“§ Excel ì´ë©”ì¼ ë°œì†¡ HTTP ì˜¤ë¥˜:",l.status,h),new Error(`Excel ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ (${l.status}): ${h}`)}}catch(l){console.error("ğŸ“§ Excel ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ ìƒì„¸:",{error:l,message:l instanceof Error?l.message:"Unknown error",stack:l instanceof Error?l.stack:"No stack"}),p(h=>({...h,email:"error"})),a({title:"ë¶€ë¶„ ì™„ë£Œ",description:"ë°œì£¼ì„œëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}else try{console.log("ğŸ“¤ PDF ì´ë©”ì¼ ìš”ì²­ ì‹œì‘...");const l=await fetch("/api/orders/send-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderData:{...d,vendorEmail:s.to},pdfUrl:k,recipients:s.to,emailSettings:{subject:s.subject,message:s.message,cc:s.cc}})});if(l.ok)console.log("ğŸ“§ PDF ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ"),p(h=>({...h,email:"completed"})),a({title:"ìƒì„± ë° ë°œì†¡ ì™„ë£Œ",description:"ë°œì£¼ì„œê°€ ìƒì„±ë˜ê³  PDF ì´ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì†í•´ì„œ ë‹¤ë¥¸ í’ˆëª©ìœ¼ë¡œ ë°œì£¼ì„œë¥¼ ìƒì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",duration:5e3});else{const h=await l.text();throw console.error("ğŸ“§ PDF ì´ë©”ì¼ ë°œì†¡ HTTP ì˜¤ë¥˜:",l.status,h),new Error(`PDF ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ (${l.status}): ${h}`)}}catch(l){console.error("ğŸ“§ PDF ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ ìƒì„¸:",{error:l,message:l instanceof Error?l.message:"Unknown error",stack:l instanceof Error?l.stack:"No stack"}),p(h=>({...h,email:"error"})),a({title:"ë¶€ë¶„ ì™„ë£Œ",description:"ë°œì£¼ì„œëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}}catch(t){console.error("ğŸ”´ ë°œì£¼ì„œ ìƒì„± ë° ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:",t),p(o=>({...o,order:"error",email:"error"})),a({title:"ì‹¤íŒ¨",description:t instanceof Error?t.message:"ë°œì£¼ì„œ ìƒì„± ë° ì´ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}},q=async()=>{if(!d.vendorEmail){a({title:"ë°œì†¡ ë¶ˆê°€",description:"ìˆ˜ì‹ ì ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.",variant:"destructive"});return}p(s=>({...s,email:"processing"}));try{if((await fetch("/api/orders/send-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderData:d,pdfUrl:k||null,recipients:[d.vendorEmail]})})).ok)p(t=>({...t,email:"completed"})),a({title:"ë°œì†¡ ì™„ë£Œ",description:"ë°œì£¼ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì†í•´ì„œ ë‹¤ë¥¸ í’ˆëª©ìœ¼ë¡œ ë°œì£¼ì„œë¥¼ ìƒì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",duration:5e3});else throw new Error("ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨")}catch{p(t=>({...t,email:"error"})),a({title:"ë°œì†¡ ì‹¤íŒ¨",description:"ì´ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}},i=()=>{const s=Object.values(O);return s.filter(o=>o==="completed").length/s.length*100};return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("div",{className:"bg-background border-b border-border sticky top-0 z-40",children:e.jsx("div",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"ë°œì£¼ì„œ ì‘ì„±"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"í•œ í™”ë©´ì—ì„œ ëª¨ë“  ì‘ì—…ì„ ì™„ë£Œí•˜ì„¸ìš”"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[y&&e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>{window.confirm("í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ìƒˆë¡œ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")&&(P(),a({title:"ìƒˆë¡œ ì‘ì„±",description:"ë°œì£¼ì„œ ì‘ì„± í™”ë©´ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."}))},className:"text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800 hover:bg-blue-50 dark:hover:bg-blue-950",children:[e.jsx(le,{className:"w-4 h-4 mr-1"}),"ìƒˆë¡œ ì‘ì„±"]}),L&&e.jsxs(V,{variant:"secondary",className:"animate-pulse",children:[e.jsx(G,{className:"w-3 h-3 mr-1 animate-spin"}),"ìë™ ì €ì¥ ì¤‘..."]}),!L&&!x&&d.orderNumber&&e.jsxs(V,{variant:"secondary",className:"bg-green-50 text-green-700",children:[e.jsx(te,{className:"w-3 h-3 mr-1"}),"ì €ì¥ë¨"]}),e.jsx(He,{value:i(),className:"w-32 h-2"})]})]})})}),e.jsxs("div",{className:"container mx-auto px-6 py-6",style:{paddingBottom:"120px"},children:[!y&&e.jsx("div",{className:"mb-8",children:e.jsxs(oe,{className:"mb-6 max-w-4xl mx-auto",children:[e.jsx(je,{className:"h-4 w-4"}),e.jsx(ce,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-medium",children:"ğŸ“‹ ì‚¬ìš©íŒ"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-blue-600 dark:text-blue-400",children:"ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ:"})," ëŒ€ëŸ‰ ë°œì£¼ì„œ, ë°˜ë³µ ì—…ë¬´, ìë™í™” ì²˜ë¦¬ì— ì í•© (50ê±´+ ê¶Œì¥)"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-green-600 dark:text-green-400",children:"ì§ì ‘ ì…ë ¥:"})," ì†ŒëŸ‰ ë°œì£¼ì„œ, ì„¸ë°€í•œ ì¡°ì •, ì¦‰ì‹œ ì²˜ë¦¬ì— ì í•© (10ê±´ ì´í•˜ ê¶Œì¥)"]})]}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs(N,{variant:"outline",size:"sm",className:"text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800 hover:bg-blue-50 dark:hover:bg-blue-950",onClick:async()=>{try{const s=await fetch("/PO_Excel_Template.xlsx");if(s.ok){const t=await s.blob(),o=URL.createObjectURL(t),c=document.createElement("a");c.href=o,c.download="PO_Excel_Template.xlsx",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(o)}else throw new Error("íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")}catch(s){console.error("ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:",s),a({title:"ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨",description:"ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}},children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ"]})})]})})]})}),!y&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 max-w-4xl mx-auto",children:[e.jsx(ee,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-500 dark:hover:border-blue-400",onClick:()=>w("excel"),children:e.jsxs(se,{className:"p-8 text-center",children:[e.jsx(Ne,{className:"w-16 h-16 mx-auto mb-4 text-blue-600 dark:text-blue-400"}),e.jsx("h3",{className:"text-xl font-semibold mb-2 text-foreground",children:"ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"ê¸°ì¡´ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë¹ ë¥´ê²Œ ì‘ì„±"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("div",{children:"âœ… ëŒ€ëŸ‰ ì²˜ë¦¬ (50ê±´+)"}),e.jsx("div",{children:"âœ… ìë™í™” ì›Œí¬í”Œë¡œìš°"}),e.jsx("div",{children:"âœ… ê±°ë˜ì²˜ ìë™ ë§¤ì¹­"}),e.jsx("div",{children:"âœ… ì´ë©”ì¼ ìë™ ë°œì†¡"})]})]})}),e.jsx(ee,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-green-500 dark:hover:border-green-400 bg-card",onClick:()=>w("direct"),children:e.jsxs(se,{className:"p-8 text-center",children:[e.jsx(re,{className:"w-16 h-16 mx-auto mb-4 text-green-600 dark:text-green-400"}),e.jsx("h3",{className:"text-xl font-semibold mb-2 text-foreground",children:"ì§ì ‘ ì…ë ¥"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"í¼ì„ í†µí•´ ì§ì ‘ ì •ë³´ ì…ë ¥"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("div",{children:"âœ… ì†ŒëŸ‰ ì²˜ë¦¬ (10ê±´ ì´í•˜)"}),e.jsx("div",{children:"âœ… ì¦‰ì‹œ ì²˜ë¦¬"}),e.jsx("div",{children:"âœ… ì‹¤ì‹œê°„ ê²€ì¦"}),e.jsx("div",{children:"âœ… ì„¸ë°€í•œ ì¡°ì •"})]})]})})]}),y&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx(ee,{children:e.jsxs(se,{className:"p-6",children:[y==="excel"&&e.jsx(ts,{onDataExtracted:z,onProcessedFileReady:K}),y==="direct"&&e.jsx(rs,{initialData:d,onChange:z})]})}),e.jsx(ns,{orderData:d,onSuggestionApply:z})]}),e.jsx("div",{className:"space-y-6",children:e.jsx(as,{orderData:d,pdfUrl:k,processingStatus:O})})]}),y&&d.orderNumber&&e.jsx(ls,{orderData:d,pdfUrl:k,processingStatus:O,onSave:_,onSend:q,onCreateOrder:B,onCreateOrderWithEmail:U,onDownload:()=>{k&&window.open(`${k}?download=true`,"_blank")}})]})]})};export{Us as default};
