import{j as e}from"./chunk-D67rGsji.js";import{r as m}from"./chunk-BgLp_VvL.js";import{k as W,C as x,h,i as p,s as q,g,B as c}from"./chunk-DV-F1ehd.js";import{P as H,A as y,a as f}from"./chunk-CqlOx_RX.js";import{B as L}from"./chunk-Bw5QEQRA.js";import{W as Z,I as R,O,Z as b,v as G}from"./chunk-CVirgo2y.js";import"./chunk-CZez8RVl.js";import"./chunk-CFxRDIMf.js";import"./chunk-bdHBeqB0.js";function le(){W();const[j,w]=m.useState(null),[$,P]=m.useState(!1),[S,u]=m.useState(!1),[o,v]=m.useState(null),[F,i]=m.useState("none"),[l,B]=m.useState(null);m.useState([]);const[r,J]=m.useState(null),[C,k]=m.useState([{id:"upload",title:"파일 업로드",description:"엑셀 파일을 서버로 업로드",status:"pending"},{id:"parse",title:"Input 시트 파싱",description:"엑셀 파일의 Input 시트 데이터 분석",status:"pending"},{id:"save",title:"데이터베이스 저장",description:"발주서 정보를 데이터베이스에 저장",status:"pending"},{id:"extract",title:"갑지/을지 추출",description:"갑지/을지 시트를 별도 파일로 추출",status:"pending"}]),D=s=>{s.preventDefault(),s.stopPropagation(),s.type==="dragenter"||s.type==="dragover"?P(!0):s.type==="dragleave"&&P(!1)},K=s=>{if(s.preventDefault(),s.stopPropagation(),P(!1),s.dataTransfer.files&&s.dataTransfer.files[0]){const t=s.dataTransfer.files[0];t.type.includes("excel")||t.type.includes("spreadsheet")||t.name.endsWith(".xlsx")?(w(t),v(null),V()):alert("엑셀 파일(.xlsx)만 업로드 가능합니다.")}},U=s=>{s.target.files&&s.target.files[0]&&(w(s.target.files[0]),v(null),V())},V=()=>{k(s=>s.map(t=>({...t,status:"pending",message:void 0})))},d=(s,t,a)=>{k(n=>n.map(N=>N.id===s?{...N,status:t,message:a}:N))},M=async()=>{if(j){u(!0);try{d("upload","processing");const s=new FormData;s.append("file",j);const t=await fetch("/api/po-template/upload",{method:"POST",body:s}),a=await t.json();if(!t.ok){d("upload","error",a.error||"파일 업로드 실패"),u(!1);return}d("upload","completed",`${a.data.fileName} 업로드 완료`),d("parse","completed",`발주서 ${a.data.totalOrders}개, 아이템 ${a.data.totalItems}개 파싱 완료`),d("save","processing");const n=await fetch("/api/po-template/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orders:a.data.orders})}),N=await n.json();if(!n.ok){d("save","error",N.error||"데이터베이스 저장 실패"),u(!1);return}d("save","completed",`발주서 ${N.data.savedOrders}개 저장 완료`),d("extract","processing");const E=await fetch("/api/po-template/extract-sheets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:a.data.filePath})}),A=await E.json();E.ok?d("extract","completed",`${A.data.extractedSheets.join(", ")} 시트 추출 완료`):d("extract","error",A.error||"시트 추출 실패"),v(a),setTimeout(()=>{console.log("자동 거래처 확인 시작, filePath:",a.data?.filePath),a.data?.filePath?z(a.data.filePath):console.error("파일 경로가 없어서 거래처 확인을 시작할 수 없습니다.")},500)}catch(s){console.error("Processing error:",s),d("upload","error","처리 중 오류가 발생했습니다.")}finally{u(!1)}}},I=()=>C.filter(t=>t.status==="completed").length/C.length*100,z=async s=>{i("vendor-validation"),u(!0);try{console.log("거래처 검증 API 호출 시작, filePath:",s);const a=await(await fetch("/api/excel-automation/validate-vendors",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:s})})).json();if(console.log("거래처 검증 API 응답:",a),a.success)B(a.data.vendorValidation),a.data.vendorValidation.needsUserAction?i("vendor-validation"):(i("email-preview"),await T(a.data.vendorValidation.validVendors));else throw new Error(a.error)}catch(t){console.error("거래처 검증 오류:",t),alert("거래처 검증 중 오류가 발생했습니다."),i("none")}finally{u(!1)}},T=async s=>{if(o?.data?.filePath)try{const a=await(await fetch("/api/excel-automation/update-email-preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:o.data.filePath,selectedVendors:s.map(n=>({originalName:n.vendorName,selectedVendorId:n.vendorId,selectedVendorEmail:n.email}))})})).json();if(a.success)J(a.data.emailPreview),i("email-preview");else throw new Error(a.error)}catch(t){console.error("이메일 미리보기 생성 오류:",t),alert("이메일 미리보기 생성 중 오류가 발생했습니다.")}};return e.jsxs("div",{className:"container mx-auto p-6 max-w-4xl",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"엑셀 발주서 처리"}),e.jsx("p",{className:"text-gray-600",children:"엑셀 파일을 업로드하여 발주서를 생성하세요."})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(x,{children:[e.jsxs(h,{children:[e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"w-5 h-5"}),"엑셀 발주서 업로드"]}),e.jsx(q,{children:"PO Template 엑셀 파일을 업로드하면 Input 시트의 데이터가 자동으로 파싱되어 발주서가 생성됩니다."})]}),e.jsxs(g,{children:[e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${$?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}`,onDragEnter:D,onDragLeave:D,onDragOver:D,onDrop:K,children:[e.jsx(R,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),j?e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:j.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(j.size/1024/1024).toFixed(2)," MB"]}),e.jsx(L,{variant:"secondary",className:"mt-2",children:"파일 준비 완료"})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-lg text-gray-600 mb-2",children:"엑셀 파일을 드래그하거나 클릭하여 업로드하세요"}),e.jsx("p",{className:"text-sm text-gray-500",children:"지원 형식: .xlsx (Excel 파일)"})]}),e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:U,className:"hidden",id:"file-upload"}),e.jsx("label",{htmlFor:"file-upload",className:"inline-block mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer transition-colors font-medium",children:"파일 선택"})]}),j&&e.jsxs("div",{className:"mt-6 flex gap-3",children:[e.jsx(c,{onClick:M,disabled:S,className:"flex-1 h-12",size:"lg",children:S?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"처리 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-4 h-4 mr-2"}),"업로드 및 처리 시작"]})}),e.jsx(c,{variant:"outline",onClick:()=>{w(null),v(null),V()},className:"h-12",size:"lg",children:"취소"})]}),S&&e.jsxs("div",{className:"mt-6 p-4 bg-blue-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-sm font-medium text-blue-900",children:"처리 진행 상황"}),e.jsxs("span",{className:"text-sm text-blue-700",children:[Math.round(I()),"%"]})]}),e.jsx(H,{value:I(),className:"h-2 mb-3"}),e.jsx("div",{className:"text-sm text-blue-700",children:C.find(s=>s.status==="processing")?.title||"처리 중..."})]})]})]}),o&&o.data?.orders&&e.jsxs(x,{className:"mt-6",children:[e.jsx(h,{children:e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"w-5 h-5 text-blue-600"}),"발주서 데이터 미리보기"]})}),e.jsx(g,{children:e.jsx("div",{className:"space-y-6",children:o.data.orders.map((s,t)=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:s.orderNumber}),e.jsxs("p",{className:"text-sm text-gray-600",children:["거래처: ",s.vendorName," | 납품처: ",s.deliveryName||s.vendorName]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["현장: ",s.siteName," | 발주일: ",s.orderDate," | 납기일: ",s.dueDate]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xl font-bold text-blue-600",children:new Intl.NumberFormat("ko-KR",{style:"currency",currency:"KRW",minimumFractionDigits:0,maximumFractionDigits:0}).format(s.totalAmount)}),e.jsxs("div",{className:"text-sm text-gray-600",children:[s.items.length,"개 품목"]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm border-collapse border border-gray-300",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50",children:[e.jsx("th",{className:"border border-gray-300 px-2 py-1 text-left",children:"품목명"}),e.jsx("th",{className:"border border-gray-300 px-2 py-1 text-left",children:"규격"}),e.jsx("th",{className:"border border-gray-300 px-2 py-1 text-right",children:"수량"}),e.jsx("th",{className:"border border-gray-300 px-2 py-1 text-right",children:"단가"}),e.jsx("th",{className:"border border-gray-300 px-2 py-1 text-right",children:"금액"}),e.jsx("th",{className:"border border-gray-300 px-2 py-1 text-left",children:"거래처명"}),e.jsx("th",{className:"border border-gray-300 px-2 py-1 text-left",children:"납품처명"})]})}),e.jsx("tbody",{children:s.items.map((a,n)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border border-gray-300 px-2 py-1",children:a.itemName}),e.jsx("td",{className:"border border-gray-300 px-2 py-1",children:a.specification}),e.jsx("td",{className:"border border-gray-300 px-2 py-1 text-right",children:new Intl.NumberFormat("ko-KR",{minimumFractionDigits:0,maximumFractionDigits:0}).format(a.quantity)}),e.jsxs("td",{className:"border border-gray-300 px-2 py-1 text-right",children:[new Intl.NumberFormat("ko-KR",{minimumFractionDigits:0,maximumFractionDigits:0}).format(a.unitPrice),"원"]}),e.jsxs("td",{className:"border border-gray-300 px-2 py-1 text-right",children:[new Intl.NumberFormat("ko-KR",{minimumFractionDigits:0,maximumFractionDigits:0}).format(a.totalAmount),"원"]}),e.jsx("td",{className:"border border-gray-300 px-2 py-1",children:a.vendorName||"-"}),e.jsx("td",{className:"border border-gray-300 px-2 py-1",children:a.deliveryName||a.vendorName||"-"})]},n))})]})})]},t))})})]}),o&&e.jsxs(x,{className:"mt-6",children:[e.jsx(h,{children:e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"w-5 h-5 text-green-600"}),"처리 결과"]})}),e.jsxs(g,{children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"text-center p-4 bg-blue-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:o.data?.totalOrders||0}),e.jsx("div",{className:"text-sm text-gray-600",children:"생성된 발주서"})]}),e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:o.data?.totalItems||0}),e.jsx("div",{className:"text-sm text-gray-600",children:"처리된 아이템"})]}),e.jsxs("div",{className:"text-center p-4 bg-purple-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:"2"}),e.jsx("div",{className:"text-sm text-gray-600",children:"추출된 시트"})]}),l&&e.jsxs("div",{className:"text-center p-4 bg-orange-50 rounded-lg",children:[e.jsxs("div",{className:"text-2xl font-bold text-orange-600",children:[l.validVendors.length,"/",l.validVendors.length+l.invalidVendors.length]}),e.jsx("div",{className:"text-sm text-gray-600",children:"등록된 거래처"})]})]}),l?e.jsx(y,{className:l.invalidVendors.length>0?"border-orange-200 bg-orange-50":"border-green-200 bg-green-50",children:l.invalidVendors.length>0?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"h-4 w-4 text-orange-600"}),e.jsxs(f,{className:"text-orange-800",children:[e.jsx("strong",{children:"거래처 확인 완료:"})," ",l.invalidVendors.length,"개의 미등록 거래처가 발견되었습니다. 시스템 관리자나 본사 관리자에게 거래처 등록을 요청해 주세요."]})]}):e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"h-4 w-4 text-green-600"}),e.jsxs(f,{className:"text-green-800",children:[e.jsx("strong",{children:"거래처 확인 완료:"})," 모든 거래처가 등록되어 있습니다. 이메일 발송을 진행할 수 있습니다."]})]})}):e.jsxs(y,{children:[e.jsx(b,{className:"h-4 w-4"}),e.jsx(f,{children:"엑셀 발주서가 성공적으로 처리되었습니다. 거래처 확인을 자동으로 진행하고 있습니다."})]}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[l&&l.invalidVendors.length===0&&r&&e.jsxs(c,{onClick:async()=>{if(!r.canProceed){alert("이메일을 발송할 수 없습니다. 수신자를 확인해주세요.");return}i("sending");try{const t=await(await fetch("/api/excel-automation/send-emails",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({processedFilePath:`uploads/${r.attachmentInfo.processedFile}`,recipients:r.recipients,emailOptions:{subject:r.subject,orderNumber:o?.data?.orders?.[0]?.orderNumber||"AUTO",additionalMessage:"자동화 시스템을 통해 발송된 발주서입니다."}})})).json();if(t.success)i("completed"),alert(`이메일 발송 완료! (성공: ${t.data.sentEmails}개)`);else throw new Error(t.error)}catch(s){console.error("이메일 발송 오류:",s),alert("이메일 발송 중 오류가 발생했습니다."),i("email-preview")}},disabled:!r?.canProceed||r?.recipients.length===0,className:"bg-blue-600 hover:bg-blue-700",children:["이메일 발송 (",r?.recipients.length||0,"명)"]}),e.jsx(c,{onClick:()=>window.location.href="/orders",children:"발주서 관리로 이동"}),e.jsx(c,{variant:"outline",onClick:()=>window.location.href="/create-order/excel",children:"새 파일 업로드"})]})]})]}),F==="vendor-validation"&&l&&e.jsxs(x,{className:"mt-6",children:[e.jsx(h,{children:e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"w-5 h-5 text-orange-600"}),"거래처 확인 필요"]})}),e.jsx(g,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:l.validVendors.length}),e.jsx("div",{className:"text-sm text-green-600",children:"등록된 거래처"})]}),e.jsxs("div",{className:"text-center p-4 bg-orange-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:l.invalidVendors.length}),e.jsx("div",{className:"text-sm text-orange-600",children:"확인 필요한 거래처"})]})]}),l.invalidVendors.length>0&&e.jsxs(y,{className:"border-orange-200 bg-orange-50",children:[e.jsx(O,{className:"h-4 w-4 text-orange-600"}),e.jsx(f,{className:"text-orange-800",children:e.jsx("strong",{children:"등록되지 않은 거래처는 시스템 관리자나 본사 관리자에게 거래처 등록을 요청해 주세요."})})]}),l.invalidVendors.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-3",children:"확인이 필요한 거래처"}),e.jsx("div",{className:"space-y-3",children:l.invalidVendors.map((s,t)=>e.jsxs("div",{className:"border rounded-lg p-4 bg-gray-50",children:[e.jsxs("div",{className:"font-medium text-red-600 mb-2",children:['"',s.vendorName,'" - 등록되지 않은 거래처']}),s.suggestions.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"유사한 거래처 추천:"}),e.jsx("div",{className:"space-y-1",children:s.suggestions.slice(0,3).map((a,n)=>e.jsxs("div",{className:"text-sm p-2 bg-white rounded border",children:[a.name," (",a.email,") - 유사도: ",(a.similarity*100).toFixed(0),"%"]},n))})]})]},t))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{onClick:()=>{T(l.validVendors)},disabled:l.validVendors.length===0,children:"등록된 거래처만으로 이메일 발송 진행"}),e.jsx(c,{variant:"outline",onClick:()=>i("none"),children:"취소"})]})]})})]}),F==="email-preview"&&r&&e.jsxs(x,{className:"mt-6",children:[e.jsx(h,{children:e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"w-5 h-5 text-blue-600"}),"이메일 발송 미리보기"]})}),e.jsx(g,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-sm font-medium",children:["수신자 (",r.recipients.length,"명)"]}),e.jsx("div",{className:"mt-1 p-3 bg-gray-50 rounded border min-h-[60px]",children:r.recipients.length>0?e.jsx("div",{className:"flex flex-wrap gap-2",children:r.recipients.map((s,t)=>e.jsx("span",{className:"inline-flex items-center px-2 py-1 bg-blue-100 text-blue-800 text-sm rounded",children:s},t))}):e.jsx("p",{className:"text-gray-500 text-sm",children:"이메일 수신자가 없습니다."})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"제목"}),e.jsx("div",{className:"mt-1 p-2 bg-gray-50 rounded border",children:r.subject})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"첨부파일"}),e.jsxs("div",{className:"mt-1 p-2 bg-gray-50 rounded border",children:[r.attachmentInfo.processedFile," (",Math.round(r.attachmentInfo.fileSize/1024),"KB)"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{onClick:async()=>{if(!r.canProceed){alert("이메일을 발송할 수 없습니다. 수신자를 확인해주세요.");return}i("sending");try{const t=await(await fetch("/api/excel-automation/send-emails",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({processedFilePath:`uploads/${r.attachmentInfo.processedFile}`,recipients:r.recipients,emailOptions:{subject:r.subject,orderNumber:o?.data?.orders?.[0]?.orderNumber||"AUTO",additionalMessage:"자동화 시스템을 통해 발송된 발주서입니다."}})})).json();if(t.success)i("completed"),alert(`이메일 발송 완료! (성공: ${t.data.sentEmails}개)`);else throw new Error(t.error)}catch(s){console.error("이메일 발송 오류:",s),alert("이메일 발송 중 오류가 발생했습니다."),i("email-preview")}},disabled:!r.canProceed||r.recipients.length===0,className:"bg-blue-600 hover:bg-blue-700",children:["이메일 발송 (",r.recipients.length,"명)"]}),e.jsx(c,{variant:"outline",onClick:()=>i("none"),children:"취소"})]})]})})]}),F==="completed"&&e.jsxs(x,{className:"mt-6",children:[e.jsx(h,{children:e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"w-5 h-5 text-green-600"}),"이메일 발송 완료"]})}),e.jsxs(g,{children:[e.jsxs(y,{children:[e.jsx(b,{className:"h-4 w-4"}),e.jsx(f,{children:"모든 과정이 성공적으로 완료되었습니다. 발주서가 저장되고 이메일이 발송되었습니다."})]}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx(c,{onClick:()=>window.location.href="/orders",children:"발주서 관리로 이동"}),e.jsx(c,{variant:"outline",onClick:()=>window.location.reload(),children:"새 파일 처리"})]})]})]}),e.jsxs(x,{className:"mt-6",children:[e.jsx(h,{children:e.jsx(p,{children:"사용법 안내"})}),e.jsx(g,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"1. 엑셀 파일 업로드"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Input 시트가 포함된 발주서 엑셀 파일을 업로드하세요."})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"2. 발주서 데이터 확인"}),e.jsx("p",{className:"text-sm text-gray-600",children:"파싱된 발주서 데이터를 미리보기로 확인하세요."})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"3. 거래처 확인 및 이메일 발송"}),e.jsx("p",{className:"text-sm text-gray-600",children:"거래처를 확인하고 이메일 수신자를 검토한 후 발송하세요."})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"4. 완료"}),e.jsx("p",{className:"text-sm text-gray-600",children:"'발주서 관리' 화면으로 이동하여 발주서가 정상 등록된 것을 확인 후, '이메일 아이콘'을 클릭하여 발송하는 것을 권장드립니다."})]})]})})]})]})]})}export{le as default};
