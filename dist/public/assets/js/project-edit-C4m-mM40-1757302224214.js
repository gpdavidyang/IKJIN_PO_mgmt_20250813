import{V as E,u as $,e as L,d as Q,r as N,q as h,aQ as H,s as R,j as e,B as p,a0 as W,w as z,L as G,N as U,x as _,aR as X,aS as l,aT as t,aU as c,aV as o,y as m,aW as d,S,z as w,A as D,D as M,G as f,a_ as J,a$ as Y,o as I,b0 as Z,Q as ee,al as se,X as B,f as ae,b1 as re,k as ne,K as F}from"./index-CKeMv8xn-1757302224214.js";import{T as te}from"./textarea-DSKdAs2V-1757302224214.js";import{C as ce}from"./checkbox-CGu4qrAu-1757302224214.js";import{P as oe}from"./page-header-DELBfEtA-1757302224214.js";import{C as le,a as de,b as ie,c as je,d as xe}from"./command-CvarEBNM-1757302224214.js";import{C as me}from"./chevrons-up-down-D4-lnrJY-1757302224214.js";import{S as he}from"./save-3tr-xYmH-1757302224214.js";import"./index-Bicaj9QN-1757302224214.js";import"./dialog-IGJFA5yH-1757302224214.js";import"./search-jNCzbwy0-1757302224214.js";function we(){const{id:j}=E(),[,C]=$(),{toast:T}=L();Q();const[x,u]=N.useState([]),[q,P]=N.useState(!1),{data:r,isLoading:K}=h({queryKey:["/api/projects",j],queryFn:()=>fetch(`/api/projects/${j}`).then(s=>s.json()),enabled:!!j}),{data:k=[]}=h({queryKey:["/api/project-statuses"]}),{data:A=[]}=h({queryKey:["/api/project-types"]}),{data:g=[]}=h({queryKey:["/api/users"]}),{data:v=[]}=h({queryKey:["/api/project-members",{projectId:j}],queryFn:()=>fetch(`/api/project-members?projectId=${j}`).then(s=>s.json()),enabled:!!j}),n=H({defaultValues:{projectName:"",projectCode:"",clientName:"",projectType:"",location:"",status:"active",projectManagerId:"",orderManagerId:"",description:"",startDate:"",endDate:"",totalBudget:"",isActive:!0}});N.useEffect(()=>{r&&n.reset({projectName:r.projectName,projectCode:r.projectCode||"",clientName:r.clientName||"",projectType:r.projectType||"",location:r.location||"",status:r.status,projectManagerId:r.projectManagerId||"none",orderManagerId:r.orderManagerId||"none",description:r.description||"",startDate:r.startDate?new Date(r.startDate).toISOString().split("T")[0]:"",endDate:r.endDate?new Date(r.endDate).toISOString().split("T")[0]:"",totalBudget:r.totalBudget||"",isActive:r.isActive??!0})},[r,n]),N.useEffect(()=>{if(v&&v.length>0){const s=v.filter(a=>a.role==="order_manager").map(a=>a.userId);u(s)}},[v]);const y=R({mutationFn:async s=>ne("PATCH",`/api/projects/${j}`,s),onSuccess:()=>{F.invalidateQueries({queryKey:["/api/projects"]}),F.invalidateQueries({queryKey:["/api/projects",j]}),T({description:"현장이 성공적으로 수정되었습니다."}),C(`/projects/${j}`)},onError:s=>{T({variant:"destructive",description:s.message||"현장 수정 중 오류가 발생했습니다."})}}),O=async s=>{const a={...s,totalBudget:s.totalBudget?parseFloat(s.totalBudget.toString().replace(/[^\d.]/g,"")):null,startDate:s.startDate?new Date(s.startDate):null,endDate:s.endDate?new Date(s.endDate):null,projectManagerId:s.projectManagerId==="none"?null:s.projectManagerId,orderManagerId:s.orderManagerId==="none"?null:s.orderManagerId,orderManagers:x};y.mutate(a)},V=()=>{C(`/projects/${j}`)};return K?e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/3 mb-6"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),e.jsx("div",{className:"h-10 bg-gray-200 rounded"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),e.jsx("div",{className:"h-10 bg-gray-200 rounded"})]})]})}):r?e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-[1366px] mx-auto p-6 space-y-6",children:[e.jsx(oe,{title:"현장 수정",description:`${r.projectName} 현장 정보를 수정합니다`}),e.jsxs(z,{className:"max-w-4xl shadow-sm",children:[e.jsx(G,{children:e.jsx(U,{className:"text-lg font-semibold",children:"현장 정보"})}),e.jsx(_,{children:e.jsx(X,{...n,children:e.jsxs("form",{onSubmit:n.handleSubmit(O),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(l,{control:n.control,name:"projectName",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"현장명 *"}),e.jsx(o,{children:e.jsx(m,{placeholder:"현장명을 입력하세요",...s})}),e.jsx(d,{})]})}),e.jsx(l,{control:n.control,name:"projectCode",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"현장 코드"}),e.jsx(o,{children:e.jsx(m,{placeholder:"현장 코드를 입력하세요",...s})}),e.jsx(d,{})]})}),e.jsx(l,{control:n.control,name:"clientName",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"클라이언트명"}),e.jsx(o,{children:e.jsx(m,{placeholder:"클라이언트명을 입력하세요",...s})}),e.jsx(d,{})]})}),e.jsx(l,{control:n.control,name:"projectType",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"현장 유형"}),e.jsxs(S,{onValueChange:s.onChange,value:s.value,children:[e.jsx(o,{children:e.jsx(w,{children:e.jsx(D,{placeholder:"현장 유형을 선택하세요"})})}),e.jsx(M,{children:A.map(a=>e.jsx(f,{value:a.id,children:a.name},a.id))})]}),e.jsx(d,{})]})}),e.jsx(l,{control:n.control,name:"location",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"위치"}),e.jsx(o,{children:e.jsx(m,{placeholder:"현장 위치를 입력하세요",...s})}),e.jsx(d,{})]})}),e.jsx(l,{control:n.control,name:"status",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"상태"}),e.jsxs(S,{onValueChange:s.onChange,value:s.value,children:[e.jsx(o,{children:e.jsx(w,{children:e.jsx(D,{placeholder:"상태를 선택하세요"})})}),e.jsx(M,{children:k.map(a=>e.jsx(f,{value:a.id,children:a.name},a.id))})]}),e.jsx(d,{})]})}),e.jsx(l,{control:n.control,name:"projectManagerId",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"현장 관리자"}),e.jsxs(S,{onValueChange:s.onChange,value:s.value,children:[e.jsx(o,{children:e.jsx(w,{children:e.jsx(D,{placeholder:"현장 관리자를 선택하세요"})})}),e.jsxs(M,{children:[e.jsx(f,{value:"none",children:"선택 안함"}),g.map(a=>e.jsx(f,{value:a.id,children:a.name},a.id))]})]}),e.jsx(d,{})]})}),e.jsxs(t,{children:[e.jsx(c,{children:"발주 담당자"}),e.jsx(o,{children:e.jsxs(J,{open:q,onOpenChange:P,children:[e.jsx(Y,{asChild:!0,children:e.jsxs(p,{variant:"outline",role:"combobox","aria-expanded":q,className:"w-full justify-between",children:[x.length===0?"발주 담당자를 선택하세요":e.jsxs("div",{className:"flex flex-wrap gap-1",children:[x.slice(0,2).map(s=>{const a=g.find(i=>i.id===s);return e.jsx(I,{variant:"secondary",className:"text-xs",children:a?.name||s},s)}),x.length>2&&e.jsxs(I,{variant:"secondary",className:"text-xs",children:["+",x.length-2,"명 더"]})]}),e.jsx(me,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(Z,{className:"w-full p-0",children:e.jsxs(le,{children:[e.jsx(de,{placeholder:"담당자 검색..."}),e.jsx(ie,{children:"담당자를 찾을 수 없습니다."}),e.jsx(je,{children:g.map(s=>e.jsxs(xe,{onSelect:()=>{const a=x.includes(s.id);u(a?i=>i.filter(b=>b!==s.id):i=>[...i,s.id])},children:[e.jsx(ee,{className:se("mr-2 h-4 w-4",x.includes(s.id)?"opacity-100":"opacity-0")}),s.name]},s.id))})]})})]})}),e.jsx(d,{}),x.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"선택된 발주 담당자:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:x.map(s=>{const a=g.find(i=>i.id===s);return e.jsxs(I,{variant:"default",className:"text-xs",children:[a?.name||s,e.jsx(p,{type:"button",variant:"ghost",size:"sm",className:"ml-1 h-3 w-3 p-0 hover:bg-destructive hover:text-destructive-foreground",onClick:()=>{u(i=>i.filter(b=>b!==s))},children:e.jsx(B,{className:"h-2 w-2"})})]},s)})})]})]}),e.jsx(l,{control:n.control,name:"startDate",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"시작일"}),e.jsx(o,{children:e.jsx(m,{type:"date",...s})}),e.jsx(d,{})]})}),e.jsx(l,{control:n.control,name:"endDate",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"종료일"}),e.jsx(o,{children:e.jsx(m,{type:"date",...s})}),e.jsx(d,{})]})}),e.jsx(l,{control:n.control,name:"totalBudget",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"총 예산"}),e.jsx(o,{children:e.jsx(m,{type:"text",placeholder:"₩0",value:s.value?ae(s.value):"",onChange:a=>{const i=re(a.target.value);s.onChange(i.toString())},onBlur:s.onBlur,name:s.name,ref:s.ref})}),e.jsx(d,{})]})}),e.jsx(l,{control:n.control,name:"isActive",render:({field:s})=>e.jsxs(t,{className:"flex flex-row items-start space-x-3 space-y-0",children:[e.jsx(o,{children:e.jsx(ce,{checked:s.value,onCheckedChange:s.onChange})}),e.jsx("div",{className:"space-y-1 leading-none",children:e.jsx(c,{children:"활성 상태"})})]})})]}),e.jsx(l,{control:n.control,name:"description",render:({field:s})=>e.jsxs(t,{children:[e.jsx(c,{children:"설명"}),e.jsx(o,{children:e.jsx(te,{placeholder:"현장 설명을 입력하세요",className:"min-h-[100px]",...s})}),e.jsx(d,{})]})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsxs(p,{type:"button",variant:"outline",onClick:V,disabled:y.isPending,children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"취소"]}),e.jsxs(p,{type:"submit",disabled:y.isPending,children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),y.isPending?"저장 중...":"저장"]})]})]})})})]})]})}):e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-2",children:"현장을 찾을 수 없습니다"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"요청하신 현장이 존재하지 않거나 삭제되었습니다."}),e.jsxs(p,{onClick:()=>C("/projects"),children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"목록으로"]})]})})}export{we as default};
