import{r,j as e,w as P,L as T,N as I,aj as U,x as $,B as f,ac as v,b as B,ad as y,H as E}from"./index-CPgkrsSy-1757309990072.js";import{V as z}from"./vendor-validation-modal-CSP5ghm4-1757309990072.js";import{U as H}from"./upload-BAYQ7HEV-1757309990072.js";import{S as J}from"./search-BuzGqAoV-1757309990072.js";import"./dialog-BepQJSc--1757309990072.js";import"./index-BFG_m_Vk-1757309990072.js";import"./circle-check-Bl3nDSpC-1757309990072.js";function X({onDataConfirmed:x}){const[g,l]=r.useState(!1),[a,o]=r.useState("idle"),[w,t]=r.useState(""),[N,V]=r.useState([]),[c,D]=r.useState(null),[S,n]=r.useState(!1),C=r.useRef(null),R=async i=>{if(i){l(!0),o("idle"),t("");try{const s=new FormData;s.append("excel",i);const h=await fetch("/api/excel-automation/parse-input-sheet",{method:"POST",body:s});if(!h.ok)throw new Error("파일 파싱에 실패했습니다.");const p=await h.json();if(!p.success)throw new Error(p.error||"파일 파싱에 실패했습니다.");const d=p.data.rows;V(d),o("parsed"),t(`${d.length}개의 행을 파싱했습니다. 거래처 검증을 진행합니다...`);const O=d.map(j=>({vendorName:j.vendorName,deliveryName:j.deliveryName,email:j.vendorEmail})),b=await fetch("/api/excel-automation/validate-vendors",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({vendorData:O})});if(!b.ok)throw new Error("거래처 검증에 실패했습니다.");const u=await b.json();if(!u.success)throw new Error(u.error||"거래처 검증에 실패했습니다.");const m=u.data;D(m),o("validated"),m.summary.needsAction?(t(`거래처 검증 완료. ${m.summary.unregisteredVendors+m.summary.unregisteredDeliveries}개의 미등록 업체가 발견되었습니다.`),n(!0)):(t("모든 거래처가 확인되었습니다. 데이터를 사용할 수 있습니다."),x(d))}catch(s){o("error"),t(s instanceof Error?s.message:"파일 처리 중 오류가 발생했습니다.")}finally{l(!1)}}},k=i=>{const s=i.target.files?.[0];s&&R(s)},F=()=>{C.current?.click()},A=async i=>{try{l(!0),t("신규 업체를 등록하고 데이터를 처리하는 중...");for(const s of i)s.action==="create_new"&&s.newVendorData&&((await fetch("/api/vendors",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...s.newVendorData,type:s.type})})).ok||console.error(`Failed to create vendor: ${s.newVendorData.name}`));t("처리가 완료되었습니다."),x(N),n(!1)}catch(s){t(s instanceof Error?s.message:"업체 등록 중 오류가 발생했습니다.")}finally{l(!1)}},M=()=>{x(N),n(!1)};return e.jsxs(e.Fragment,{children:[e.jsxs(P,{className:"w-full",children:[e.jsx(T,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-5 w-5"}),"Excel 발주서 업로드"]})}),e.jsx($,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"border-2 border-dashed rounded-lg p-6 text-center border-gray-300 hover:border-gray-400",children:[e.jsx("input",{ref:C,type:"file",accept:".xlsx,.xlsm,.xls",onChange:k,className:"hidden"}),e.jsx(H,{className:"h-8 w-8 text-gray-400 mx-auto mb-3"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium text-gray-700",children:"Excel 발주서 파일을 업로드하여 자동 처리"}),e.jsx("p",{className:"text-sm text-gray-500",children:".xlsx, .xlsm, .xls 파일을 지원합니다. Input 시트의 A:M 열 데이터를 자동으로 파싱합니다."})]}),e.jsx(f,{onClick:F,disabled:g,className:"mt-3",variant:"outline",children:g?"처리 중...":"파일 선택"})]}),a!=="idle"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{children:"진행 상태"}),e.jsxs("span",{children:[a==="parsed"&&"1/2 파싱 완료",a==="validated"&&"2/2 검증 완료",a==="error"&&"오류 발생"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:`h-2 rounded-full transition-all duration-300 ${a==="error"?"bg-red-500":"bg-blue-500"}`,style:{width:a==="parsed"?"50%":a==="validated"||a==="error"?"100%":"0%"}})})]}),a==="validated"&&c&&e.jsxs(v,{children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx(y,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{children:w}),c.summary.needsAction&&e.jsxs("div",{className:"flex space-x-2 mt-2",children:[e.jsxs(f,{size:"sm",onClick:()=>n(!0),className:"flex items-center gap-1",children:[e.jsx(J,{className:"h-3 w-3"}),"업체 검증 및 등록"]}),e.jsx(f,{size:"sm",variant:"outline",onClick:M,children:"검증 없이 진행"})]})]})})]}),a==="error"&&e.jsxs(v,{variant:"destructive",children:[e.jsx(E,{className:"h-4 w-4"}),e.jsx(y,{children:w})]}),e.jsxs(v,{children:[e.jsx(E,{className:"h-4 w-4"}),e.jsxs(y,{children:[e.jsx("strong",{children:"업로드 프로세스:"}),e.jsxs("ol",{className:"list-decimal list-inside mt-2 space-y-1 text-sm",children:[e.jsx("li",{children:"Excel 파일의 Input 시트에서 발주 데이터를 파싱합니다"}),e.jsx("li",{children:"거래처명과 납품처명이 시스템에 등록되어 있는지 확인합니다"}),e.jsx("li",{children:"미등록 업체는 유사 업체 추천 또는 신규 등록을 진행합니다"}),e.jsx("li",{children:"검증 완료 후 발주서 데이터를 시스템에 등록합니다"})]})]})]})]})})]}),S&&c&&e.jsx(z,{isOpen:S,onClose:()=>n(!1),validationData:c,onConfirm:A})]})}export{X as ExcelUploadWithValidation};
