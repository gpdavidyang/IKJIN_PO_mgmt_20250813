import{c as Be,r as u,j as e,L as Z,b as te,s as ee,t as se,n as V,M as Y,B as v,X as ae,N as qe,z as ue,p as me,J as N,I as H,Q as be,R as we,x as Ce,T as Se,P as le,G as Fe,H as Te,E as ke,F as re,as as Ve,e as Je,d as Ke}from"./index-BE2444o0-1757210537008.js";import{A as ne,a as ie}from"./alert-D1nuQdGq-1757210537008.js";import{P as He}from"./progress-bqVJq0kS-1757210537008.js";import{D as Oe,a as Ae,b as De,c as Le,e as Me}from"./dialog-1Gd9x-z8-1757210537008.js";import{S as G,a as X,b as Q,c as W,d as O}from"./select-6uSRIfuf-1757210537008.js";import{T as Ze}from"./target-0ULKfZE4-1757210537008.js";import{T as oe}from"./triangle-alert-CMbD--an-1757210537008.js";import{T as Re}from"./trending-up-BTOqT544-1757210537008.js";import{A as $e}from"./arrow-right-3zXnAUQR-1757210537008.js";import{S as Ge}from"./search-CgCJtd6F-1757210537008.js";import{U as Ne}from"./upload-ThDJ-7Y7-1757210537008.js";import{T as de}from"./textarea-DxzJ7OCB-1757210537008.js";import{C as Ee}from"./calendar-MA2F8Gks-1757210537008.js";import{C as Ie}from"./calendar--V0_Jv-k-1757210537008.js";import{T as ze}from"./trash-2-CAnCbkZ2-1757210537008.js";import{f as Pe}from"./format-DtokscR1-1757210537008.js";import{T as Xe,a as Qe,b as xe,c as he}from"./tabs-QlThG8s3-1757210537008.js";import{C as ce}from"./checkbox-BhgHmGcq-1757210537008.js";import{M as ge}from"./mail-Cwa0pRly-1757210537008.js";import{R as Ue}from"./refresh-cw-B134e1UF-1757210537008.js";import{D as ve}from"./download-TiW_MVN8-1757210537008.js";import{P as pe}from"./paperclip-D8tDVsdk-1757210537008.js";import{S as We}from"./save-F-Hg-7JL-1757210537008.js";import{S as Ye}from"./send-BcZ8y3hD-1757210537008.js";import{L as es}from"./list-Cp-CjmC7-1757210537008.js";import{I as je}from"./info-CH01k-l_-1757210537008.js";import"./index-Cyhoz9Bg-1757210537008.js";import"./index-CqvkDEJc-1757210537008.js";import"./chevron-down-CBeDqd3L-1757210537008.js";import"./chevron-up-CQfQhCpG-1757210537008.js";import"./chevron-left-B1MTY8JU-1757210537008.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=Be("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]),ss=({isOpen:l,onClose:A,mappingItems:x,onApplyMappings:y})=>{const[E,d]=u.useState([]),[b,D]=u.useState(0),[j,k]=u.useState(!1),[R,M]=u.useState([]),[I,h]=u.useState([]),[f,P]=u.useState([]),[U,$]=u.useState([]),[C,z]=u.useState(!1);u.useEffect(()=>{d([...x]),D(0)},[x]),u.useEffect(()=>{l&&R.length===0&&K()},[l]);const K=async()=>{z(!0);try{const n=await fetch("/api/categories",{credentials:"include"});if(n.ok){const L=(await n.json()).flatCategories||[];M(L),h(L.filter(T=>T.categoryType==="major")),P(L.filter(T=>T.categoryType==="middle")),$(L.filter(T=>T.categoryType==="minor")),console.log("📋 전체 분류 로드 완료:",{total:L.length,major:L.filter(T=>T.categoryType==="major").length,middle:L.filter(T=>T.categoryType==="middle").length,minor:L.filter(T=>T.categoryType==="minor").length})}else console.error("❌ 분류 데이터 로드 실패:",n.status)}catch(n){console.error("❌ 분류 데이터 로드 오류:",n)}finally{z(!1)}},g=E[b];console.log("🔍 Current item data:",g),console.log("🔍 Mapping result DB data:",g?.mappingResult?.db);const q={total:E.length,resolved:E.filter(n=>n.userSelection||n.mappingResult.status==="exact_match").length,needsAttention:E.filter(n=>!n.userSelection&&n.mappingResult.status!=="exact_match").length},_=(n,w)=>{const L=[...E],T=L[b];T.userSelection||(T.userSelection={}),T.userSelection[`${n}Id`]=w,n==="major"?(T.userSelection.middleId=void 0,T.userSelection.minorId=void 0):n==="middle"&&(T.userSelection.minorId=void 0),d(L)},B=()=>{const n=g?.userSelection?.majorId,w=g?.mappingResult?.db?.majorId;return console.log("🔍 getCurrentMajorId:",{userMajorId:n,autoMajorId:w,result:n||w}),n||w},i=()=>{const n=g?.userSelection?.middleId,w=g?.mappingResult?.db?.middleId;return console.log("🔍 getCurrentMiddleId:",{userMiddleId:n,autoMiddleId:w,result:n||w}),n||w},s=n=>n?f.filter(w=>w.parentId===n):[],t=n=>n?U.filter(w=>w.parentId===n):[],o=(n,w)=>{const L=g?.mappingResult?.suggestions?.filter(J=>J.type===n)||[];let T=[];if(n==="major")T=I;else if(n==="middle")T=s(w);else if(n==="minor"){if(!w)return console.log("🔍 소분류: parentId 없음, suggestions만 표시:",L),L.map(J=>({...J,isSuggestion:!0}));T=t(w)}const _e=L.map(J=>J.id),ye=T.filter(J=>!_e.includes(J.id));return console.log("🔍 getCombinedOptions:",{type:n,parentId:w,suggestionsCount:L.length,allOptionsCount:T.length,otherOptionsCount:ye.length}),[...L.map(J=>({...J,isSuggestion:!0})),...ye.map(J=>({...J,name:J.categoryName,type:J.categoryType,similarity:0,isSuggestion:!1}))]},c=()=>{b<E.length-1?D(b+1):m()},r=()=>{b<E.length-1?D(b+1):m()},a=()=>{b>0&&D(b-1)},m=async()=>{k(!0);try{await y(E),A()}catch(n){console.error("매핑 적용 실패:",n)}finally{k(!1)}},p=n=>{switch(n){case"exact_match":return e.jsx(te,{className:"w-4 h-4 text-green-600"});case"partial_match":return e.jsx(oe,{className:"w-4 h-4 text-yellow-600"});case"no_match":return e.jsx(ae,{className:"w-4 h-4 text-red-600"});default:return e.jsx(Ge,{className:"w-4 h-4 text-gray-600"})}},F=n=>{switch(n){case"exact_match":return"bg-green-100 text-green-800 border-green-200";case"partial_match":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"no_match":return"bg-red-100 text-red-800 border-red-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},S=n=>n>=80?"text-green-600":n>=60?"text-yellow-600":"text-red-600";return!g&&!C?null:e.jsx(Oe,{open:l,onOpenChange:A,children:e.jsxs(Ae,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(De,{children:e.jsxs(Le,{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"w-5 h-5 text-blue-600"}),"분류 매핑 검증 및 수정",C&&e.jsx(Z,{className:"w-4 h-4 animate-spin text-blue-600"})]})}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["진행률: ",b+1," / ",E.length]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"w-3 h-3 text-green-600"}),e.jsxs("span",{children:["해결됨: ",q.resolved]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(oe,{className:"w-3 h-3 text-yellow-600"}),e.jsxs("span",{children:["검토 필요: ",q.needsAttention]})]})]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${(b+1)/E.length*100}%`}})})]}),C&&!g?e.jsx(ee,{className:"mb-6",children:e.jsx(se,{className:"p-4",children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Z,{className:"w-8 h-8 mx-auto mb-2 animate-spin text-blue-600"}),e.jsx("p",{className:"text-sm text-gray-600",children:"분류 데이터를 불러오는 중..."})]})})})}):g?e.jsx(ee,{className:"mb-6",children:e.jsxs(se,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-900",children:g.itemName}),e.jsxs("div",{className:"flex items-center gap-2",children:[p(g.mappingResult.status),e.jsxs(V,{className:F(g.mappingResult.status),children:[g.mappingResult.status==="exact_match"&&"완전 매칭",g.mappingResult.status==="partial_match"&&"부분 매칭",g.mappingResult.status==="no_match"&&"매칭 없음",g.mappingResult.status==="invalid_hierarchy"&&"계층 오류"]}),e.jsxs(V,{variant:"outline",className:Y("text-xs",S(g.mappingResult.confidence)),children:[e.jsx(Re,{className:"w-3 h-3 mr-1"}),"신뢰도: ",g.mappingResult.confidence,"%"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"엑셀 대분류"}),e.jsx("div",{className:"p-2 bg-blue-50 rounded text-sm text-blue-800 min-h-[32px] flex items-center",children:g.originalCategories.major||"없음"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"엑셀 중분류"}),e.jsx("div",{className:"p-2 bg-blue-50 rounded text-sm text-blue-800 min-h-[32px] flex items-center",children:g.originalCategories.middle||"없음"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"엑셀 소분류"}),e.jsx("div",{className:"p-2 bg-blue-50 rounded text-sm text-blue-800 min-h-[32px] flex items-center",children:g.originalCategories.minor||"없음"})]})]}),e.jsx("div",{className:"flex items-center justify-center py-2",children:e.jsx($e,{className:"w-5 h-5 text-gray-400"})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"시스템 대분류"}),e.jsxs(G,{value:g.userSelection?.majorId?.toString()||g.mappingResult.db.majorId?.toString()||"",onValueChange:n=>_("major",parseInt(n)),disabled:C,children:[e.jsx(X,{className:"h-8",children:e.jsx(Q,{placeholder:C?"로딩 중...":"대분류 선택"})}),e.jsx(W,{children:o("major").map(n=>e.jsx(O,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:n.isSuggestion?"font-medium text-blue-600":"",children:n.name}),n.isSuggestion&&n.similarity>0&&e.jsxs(V,{variant:"outline",className:"ml-2 text-xs bg-blue-50 text-blue-600 border-blue-200",children:[n.similarity,"%"]})]})},n.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"시스템 중분류"}),e.jsxs(G,{value:g.userSelection?.middleId?.toString()||g.mappingResult.db.middleId?.toString()||"",onValueChange:n=>_("middle",parseInt(n)),disabled:C||!B(),children:[e.jsx(X,{className:"h-8",children:e.jsx(Q,{placeholder:C?"로딩 중...":B()?"중분류 선택":"먼저 대분류를 선택하세요"})}),e.jsx(W,{children:o("middle",B()).map(n=>e.jsx(O,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:n.isSuggestion?"font-medium text-blue-600":"",children:n.name}),n.isSuggestion&&n.similarity>0&&e.jsxs(V,{variant:"outline",className:"ml-2 text-xs bg-blue-50 text-blue-600 border-blue-200",children:[n.similarity,"%"]})]})},n.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"시스템 소분류"}),e.jsxs(G,{value:g.userSelection?.minorId?.toString()||g.mappingResult.db.minorId?.toString()||"",onValueChange:n=>_("minor",parseInt(n)),disabled:C||!i(),children:[e.jsx(X,{className:"h-8",children:e.jsx(Q,{placeholder:C?"로딩 중...":i()?"소분류 선택":"먼저 중분류를 선택하세요"})}),e.jsx(W,{children:o("minor",i()).map(n=>e.jsx(O,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:n.isSuggestion?"font-medium text-blue-600":"",children:n.name}),n.isSuggestion&&n.similarity>0&&e.jsxs(V,{variant:"outline",className:"ml-2 text-xs bg-blue-50 text-blue-600 border-blue-200",children:[n.similarity,"%"]})]})},n.id))})]})]})]})]})}):null,g&&g.mappingResult.suggestions.length>0&&e.jsxs(ne,{className:"mb-6",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsxs(ie,{children:[e.jsx("div",{className:"font-medium mb-2",children:"💡 추천 매핑:"}),e.jsx("div",{className:"text-sm space-y-1",children:g.mappingResult.suggestions.slice(0,3).map((n,w)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{children:[n.type==="major"&&"대분류: ",n.type==="middle"&&"중분류: ",n.type==="minor"&&"소분류: ",n.name]}),e.jsxs(V,{variant:"outline",className:"text-xs",children:["유사도 ",n.similarity,"%"]})]},w))})]})]}),g&&(g.mappingResult.status==="no_match"||g.mappingResult.status==="partial_match")&&e.jsxs(ne,{className:"mb-6 border-orange-200 bg-orange-50",children:[e.jsx(oe,{className:"h-4 w-4 text-orange-600"}),e.jsxs(ie,{children:[e.jsx("div",{className:"font-medium mb-2 text-orange-800",children:"📋 분류 매핑 안내"}),e.jsxs("div",{className:"text-sm text-orange-700 space-y-2",children:[e.jsx("p",{children:"엑셀 파일의 분류가 시스템 분류와 정확히 일치하지 않습니다."}),e.jsxs("div",{className:"bg-orange-100 p-3 rounded-lg",children:[e.jsx("p",{className:"font-medium mb-1",children:"📞 분류 등록 요청 방법:"}),e.jsxs("ul",{className:"text-xs space-y-1 ml-4",children:[e.jsx("li",{children:"• 시스템 관리자에게 새로운 분류 등록을 요청하세요"}),e.jsxs("li",{children:["• 엑셀 분류명: ",g.originalCategories.major," ",">"," ",g.originalCategories.middle," ",">"," ",g.originalCategories.minor]}),e.jsx("li",{children:"• 임시로 유사한 기존 분류를 선택하여 진행할 수 있습니다"})]})]})]})]})]}),e.jsxs(Me,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{variant:"outline",onClick:a,disabled:b===0||C,size:"sm",children:"이전"}),e.jsx(v,{variant:"outline",onClick:c,disabled:C,size:"sm",children:"건너뛰기"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{variant:"outline",onClick:A,disabled:j,children:"취소"}),!C&&g&&(b<E.length-1?e.jsx(v,{onClick:r,disabled:j,children:"다음"}):e.jsx(v,{onClick:m,disabled:j,className:"bg-blue-600 hover:bg-blue-700",children:j?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"w-4 h-4 mr-2 animate-spin"}),"적용 중..."]}):"매핑 적용"}))]})]})]})})},ts=({onDataExtracted:l,onProcessedFileReady:A})=>{const[x,y]=u.useState(!1),[E,d]=u.useState(!1),[b,D]=u.useState(null),[j,k]=u.useState("idle"),[R,M]=u.useState(""),[I,h]=u.useState([]),[f,P]=u.useState(0),[U,$]=u.useState(!1),[C,z]=u.useState([]),[K,g]=u.useState(null),q=u.useCallback(r=>{r.preventDefault(),y(!0)},[]),_=u.useCallback(r=>{r.preventDefault(),y(!1)},[]),B=u.useCallback(r=>{r.preventDefault(),y(!1);const a=Array.from(r.dataTransfer.files);console.log("🎯 [클라이언트] 드래그 드롭 파일:",{filesCount:a.length,fileDetails:a.map(p=>({name:p.name,type:p.type,size:p.size})),component:"ExcelUploadZone"});const m=a.find(p=>p.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||p.name.endsWith(".xlsx"));m?(console.log("✅ [클라이언트] Excel 파일 감지됨:",{fileName:m.name}),s(m)):(console.error("❌ [클라이언트] Excel 파일이 아님:",{files:a.map(p=>p.name)}),M("엑셀 파일(.xlsx)만 업로드 가능합니다."),k("error"))},[]),i=r=>{const a=r.target.files?.[0];console.log("📁 [클라이언트] 파일 선택:",{hasFile:!!a,fileName:a?.name,fileSize:a?.size,fileType:a?.type,component:"ExcelUploadZone"}),a&&s(a)},s=async r=>{D(r),d(!0),k("processing"),M(""),console.log("📤 [클라이언트] 파일 업로드 시작:",{fileName:r.name,fileSize:r.size,fileType:r.type,lastModified:new Date(r.lastModified).toISOString(),component:"ExcelUploadZone"});const a=new FormData;a.append("file",r);try{const m=await fetch("/api/po-template/upload",{method:"POST",credentials:"include",body:a});if(console.log("📥 [클라이언트] 서버 응답 수신:",{status:m.status,statusText:m.statusText,ok:m.ok,url:m.url,headers:Object.fromEntries(m.headers.entries())}),!m.ok)throw console.error("❌ [클라이언트] HTTP 에러:",{status:m.status,statusText:m.statusText,component:"ExcelUploadZone"}),new Error("파일 업로드 실패");const p=await m.json();if(console.log("📋 [클라이언트] 응답 데이터 처리:",{success:p.success,ordersCount:p.data?.orders?.length||0,hasError:!!p.error,errorMessage:p.error,component:"ExcelUploadZone"}),p.success&&p.data.orders.length>0){h(p.data.orders),k("success");try{const F=await fetch("/api/po-template/extract-sheets",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({filePath:p.data.filePath,sheetNames:["갑지","을지"]})});if(F.ok){const S=await F.json();if(S.success&&S.data.extractedPath){const w=`/uploads/${S.data.extractedPath.split("/").pop()}`,L=`${r.name.replace(".xlsx","")}_Input제거.xlsx`;console.log("🔷 처리된 Excel 파일 정보:",{processedFileUrl:w,processedFileName:L}),A?.({url:w,name:L})}}else{console.warn("⚠️ Extract sheets API 실패, 기본값 사용");const n=`/uploads/extracted-${Date.now()}.xlsx`,w=`${r.name.replace(".xlsx","")}_Input제거.xlsx`;A?.({url:n,name:w})}}catch(F){console.error("Extract sheets 호출 실패:",F);const n=`/uploads/extracted-${Date.now()}.xlsx`,w=`${r.name.replace(".xlsx","")}_Input제거.xlsx`;A?.({url:n,name:w})}if(p.data.orders.length===1){const F=p.data.orders[0],S={...F,projectName:F.siteName||F.projectName,orderDate:F.orderDate,deliveryDate:F.dueDate||F.deliveryDate,items:(F.items||[]).map(n=>({...n,name:n.itemName||n.name,unit:n.unit||"EA"}))};await t(S)}}else throw new Error(p.error||"데이터 추출 실패")}catch(m){console.error("💥 [클라이언트] 파일 처리 오류:",{errorMessage:m.message,errorStack:m.stack,errorName:m.name,component:"ExcelUploadZone"}),M(m.message||"파일 처리 중 오류가 발생했습니다."),k("error")}finally{console.log("🏁 [클라이언트] 파일 처리 완료:",{component:"ExcelUploadZone",finalStatus:j}),d(!1)}},t=async r=>{if(console.log("🔍 분류 매핑 검증 시작:",r),console.log("🔍 첫 번째 아이템 상세:",r.items?.[0]),!r.items||r.items.length===0){l(r);return}try{console.log("🔍 DEBUG: 전체 발주서 데이터:",r),console.log("🔍 DEBUG: 첫 번째 아이템의 모든 필드:",Object.keys(r.items[0])),console.log("🔍 DEBUG: 첫 번째 아이템 분류 관련 필드들:",{majorCategory:r.items[0].majorCategory,middleCategory:r.items[0].middleCategory,minorCategory:r.items[0].minorCategory,categoryLv1:r.items[0].categoryLv1,categoryLv2:r.items[0].categoryLv2,categoryLv3:r.items[0].categoryLv3,대분류:r.items[0].대분류,중분류:r.items[0].중분류,소분류:r.items[0].소분류});const a=r.items.map(S=>({majorCategory:S.majorCategory||S.categoryLv1||S.대분류,middleCategory:S.middleCategory||S.categoryLv2||S.중분류,minorCategory:S.minorCategory||S.categoryLv3||S.소분류}));console.log("🔍 분류 검증 요청 데이터:",a);const m=await fetch("/api/categories/validate-mapping-batch",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({categories:a})});if(!m.ok)throw new Error("분류 검증 API 호출 실패");const p=await m.json();console.log("🔍 분류 검증 결과:",p);const F=p.results.filter(S=>S.status==="no_match"||S.status==="partial_match"||S.status==="invalid_hierarchy");if(F.length>0){console.log(`⚠️ ${F.length}개 품목에 분류 매핑 문제 발견`);const S=[];p.results.forEach((n,w)=>{if(n.status==="no_match"||n.status==="partial_match"||n.status==="invalid_hierarchy"){const L=r.items[w];S.push({itemName:L.itemName||L.name||`품목 ${w+1}`,rowIndex:w,originalCategories:{major:n.excel.major,middle:n.excel.middle,minor:n.excel.minor},mappingResult:n})}}),g(r),z(S),$(!0)}else{console.log("✅ 모든 분류가 성공적으로 매핑됨");const S={...r};S.items=r.items.map(n=>({...n,majorCategory:n.majorCategory||n.categoryLv1||n.대분류||"",middleCategory:n.middleCategory||n.categoryLv2||n.중분류||"",minorCategory:n.minorCategory||n.categoryLv3||n.소분류||""})),console.log("🔧 카테고리 필드 매핑 완료:",S.items[0]),l(S)}}catch(a){console.error("❌ 분류 검증 실패:",a),console.warn("분류 검증에 실패했지만 계속 진행합니다.");const m={...r};m.items=r.items.map(p=>({...p,majorCategory:p.majorCategory||p.categoryLv1||p.대분류||"",middleCategory:p.middleCategory||p.categoryLv2||p.중분류||"",minorCategory:p.minorCategory||p.categoryLv3||p.소분류||""})),console.log("🔧 카테고리 필드 매핑 완료 (검증 실패 시):",m.items[0]),l(m)}},o=async r=>{if(console.log("🔧 사용자 분류 매핑 적용:",r),!K){console.error("❌ 대기 중인 발주서 데이터가 없습니다.");return}const a={...K};r.forEach(m=>{const p=a.items.findIndex(F=>(F.itemName||F.name)===m.itemName);if(p!==-1&&m.userSelection){const F=a.items[p];m.userSelection.majorId&&(F.majorCategoryId=m.userSelection.majorId),m.userSelection.middleId&&(F.middleCategoryId=m.userSelection.middleId),m.userSelection.minorId&&(F.minorCategoryId=m.userSelection.minorId)}}),$(!1),z([]),g(null),console.log("✅ 분류 매핑이 적용된 발주서 데이터:",a),l(a)},c=async()=>{if(I[f]&&b){const r=I[f],a={...r,projectName:r.siteName||r.projectName,orderDate:r.orderDate,deliveryDate:r.dueDate||r.deliveryDate,items:(r.items||[]).map(m=>({...m,name:m.itemName||m.name,unit:m.unit||"EA"}))};await t(a)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{onDragOver:q,onDragLeave:_,onDrop:B,className:`
          border-2 border-dashed rounded-lg ${j==="success"?"p-4":"p-8"} text-center transition-all
          ${x?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}
          ${E?"opacity-50 pointer-events-none":""}
        `,children:E?e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"w-8 h-8 mx-auto text-blue-600 animate-spin"}),e.jsx("p",{className:"text-sm text-gray-600",children:"파일을 처리하고 있습니다..."})]}):j==="success"?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(te,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-green-700",children:b?.name}),e.jsxs("p",{className:"text-xs text-gray-600",children:[I.length,"개의 발주서 감지됨"]})]})]}),e.jsx(v,{variant:"outline",size:"sm",onClick:()=>{k("idle"),h([]),D(null)},children:"다시 업로드"})]}):e.jsxs(e.Fragment,{children:[e.jsx(qe,{className:"w-12 h-12 mx-auto text-gray-400 mb-4"}),e.jsx("p",{className:"text-lg font-medium text-gray-700 mb-2",children:"엑셀 파일을 드래그하여 놓으세요"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"또는"}),e.jsx("input",{type:"file",accept:".xlsx",onChange:i,className:"hidden",id:"excel-upload"}),e.jsx("label",{htmlFor:"excel-upload",children:e.jsx(v,{variant:"outline",asChild:!0,children:e.jsxs("span",{className:"cursor-pointer",children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"파일 선택"]})})})]})}),j==="error"&&R&&e.jsxs(ne,{variant:"destructive",children:[e.jsx(ue,{className:"h-4 w-4"}),e.jsx(ie,{children:R})]}),I.length>1&&j==="success"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:"발주서를 선택하세요:"}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto border rounded-lg p-2 bg-gray-50",children:I.map((r,a)=>e.jsx("div",{onClick:()=>P(a),className:`
                  p-3 border rounded-lg cursor-pointer transition-colors
                  ${f===a?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300 bg-white"}
                `,children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:r.orderNumber}),e.jsxs("p",{className:"text-xs text-gray-600",children:[r.vendorName," | ",r.projectName]})]}),e.jsxs(V,{variant:"secondary",children:[r.items?.length||0,"개 품목"]})]}),r.items&&r.items.length>0&&e.jsxs("div",{className:"pt-2 border-t border-gray-200",children:[e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-gray-500",children:[e.jsx("th",{className:"text-left font-normal",children:"품목"}),e.jsx("th",{className:"text-right font-normal",children:"수량"}),e.jsx("th",{className:"text-right font-normal",children:"단가"}),e.jsx("th",{className:"text-right font-normal",children:"금액"})]})}),e.jsx("tbody",{children:r.items.slice(0,2).map((m,p)=>e.jsxs("tr",{children:[e.jsx("td",{className:"text-gray-600 truncate max-w-[150px] pr-2",children:m.itemName}),e.jsx("td",{className:"text-right text-gray-700",children:Math.floor(m.quantity||0).toLocaleString()}),e.jsx("td",{className:"text-right text-gray-700",children:Math.floor(m.unitPrice||0).toLocaleString()}),e.jsx("td",{className:"text-right font-medium",children:Math.floor(m.totalAmount||0).toLocaleString()})]},p))})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[r.items.length>2&&e.jsxs("p",{className:"text-xs text-gray-500 italic",children:["외 ",r.items.length-2,"개"]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-xs text-gray-600 mr-2",children:"총액"}),e.jsxs("span",{className:"text-sm font-semibold text-blue-600",children:[Math.floor(r.totalAmount||r.items.reduce((m,p)=>m+(p.totalAmount||0),0)).toLocaleString(),"원"]})]})]})]})]})},a))}),e.jsx(v,{onClick:c,className:"w-full",size:"sm",children:"선택한 발주서 사용"})]}),e.jsx(ss,{isOpen:U,onClose:()=>{$(!1),z([]),g(null)},mappingItems:C,onApplyMappings:o})]})},rs=({initialData:l={},onChange:A})=>{const[x,y]=u.useState({orderNumber:l.orderNumber||`PO-${new Date().getTime()}`,orderDate:l.orderDate||new Date,deliveryDate:l.deliveryDate||new Date(Date.now()+6048e5),projectId:l.projectId||"",projectName:l.projectName||"",vendorId:l.vendorId||"",vendorName:l.vendorName||"",vendorEmail:l.vendorEmail||"",items:l.items||[{itemName:"",specification:"",unit:"EA",quantity:1,unitPrice:0,totalAmount:0,majorCategory:"",middleCategory:"",minorCategory:"",notes:""}],notes:l.notes||"",totalAmount:l.totalAmount||0}),{data:E,isLoading:d,error:b}=me({queryKey:["projects"],queryFn:async()=>{console.log("🔍 프로젝트 목록 조회 시작");const i=await fetch("/api/projects",{credentials:"include"});if(!i.ok)throw new Error("프로젝트 목록 조회 실패");const s=await i.json();return console.log("✅ 프로젝트 목록 조회 성공:",s.length,"개"),s}}),{data:D,isLoading:j,error:k}=me({queryKey:["vendors"],queryFn:async()=>{console.log("🔍 거래처 목록 조회 시작");const i=await fetch("/api/vendors",{credentials:"include"});if(!i.ok)throw new Error("거래처 목록 조회 실패");const s=await i.json();return console.log("✅ 거래처 목록 조회 성공:",s.length,"개"),s}}),{data:R,isLoading:M,error:I}=me({queryKey:["categories"],queryFn:async()=>{console.log("🔍 카테고리 목록 조회 시작");const i=await fetch("/api/item-categories",{credentials:"include"});if(!i.ok)throw new Error("카테고리 목록 조회 실패");const s=await i.json();return console.log("✅ 카테고리 목록 조회 성공:",s?.length,"개"),{categories:s}}}),h=u.useRef({}),f=u.useRef(!0);u.useEffect(()=>{if(l&&Object.keys(l).length>0){const i=h.current;(f.current||l.orderNumber!==i.orderNumber||l.projectName!==i.projectName||l.vendorName!==i.vendorName||l.items?.length!==i.items?.length)&&(console.log("📝 DirectInputForm: initialData 유의미한 변경 감지",{isInitialLoad:f.current,orderNumber:l.orderNumber}),y({orderNumber:l.orderNumber||`PO-${new Date().getTime()}`,orderDate:l.orderDate?new Date(l.orderDate):new Date,deliveryDate:l.deliveryDate?new Date(l.deliveryDate):new Date(Date.now()+7*24*60*60*1e3),projectId:l.projectId||"",projectName:l.projectName||"",vendorId:l.vendorId||"",vendorName:l.vendorName||"",vendorEmail:l.vendorEmail||"",items:l.items||[{itemName:"",specification:"",unit:"EA",quantity:1,unitPrice:0,totalAmount:0,majorCategory:"",middleCategory:"",minorCategory:"",notes:""}],notes:l.notes||"",totalAmount:l.totalAmount||0}),h.current=l,f.current=!1)}},[l]),u.useEffect(()=>{const i=x.items.reduce((s,t)=>s+(t.totalAmount||0),0);i!==x.totalAmount&&y(s=>({...s,totalAmount:i}))},[x.items]),u.useEffect(()=>{const i=setTimeout(()=>{A(x)},100);return()=>clearTimeout(i)},[x.orderNumber,x.projectName,x.vendorName,x.vendorEmail,x.totalAmount,x.items.length]);const P=(i,s)=>{y(t=>({...t,[i]:s}))},U=i=>{const s=E?.find(t=>t.id.toString()===i);s&&y(t=>({...t,projectId:i,projectName:s.projectName}))},$=i=>{const s=D?.find(t=>t.id.toString()===i);s&&y(t=>({...t,vendorId:i,vendorName:s.name,vendorEmail:s.email||""}))},C=(i,s,t)=>{const o=[...x.items];o[i]={...o[i],[s]:t},(s==="quantity"||s==="unitPrice")&&(o[i].totalAmount=o[i].quantity*o[i].unitPrice),y(c=>({...c,items:o}))},z=()=>{y(i=>({...i,items:[...i.items,{itemName:"",specification:"",unit:"EA",quantity:1,unitPrice:0,totalAmount:0,majorCategory:"",middleCategory:"",minorCategory:"",notes:""}]}))},K=i=>{if(x.items.length>1){const s=x.items.filter((t,o)=>o!==i);y(t=>({...t,items:s}))}},g=()=>R?.categories?.filter(i=>i.categoryType==="major")||[],q=i=>{const s=R?.categories?.find(t=>t.categoryType==="major"&&t.categoryName===i);return s?R?.categories?.filter(t=>t.categoryType==="middle"&&t.parentId===s.id)||[]:[]},_=i=>{const s=R?.categories?.find(t=>t.categoryType==="middle"&&t.categoryName===i);return s?R?.categories?.filter(t=>t.categoryType==="minor"&&t.parentId===s.id)||[]:[]},B=(i,s,t)=>{const o=[...x.items],c=o[i];if(s==="major"){const r=g().find(a=>a.id.toString()===t);c.majorCategory=r?.categoryName||"",c.middleCategory="",c.minorCategory=""}else if(s==="middle"){const r=q(c.majorCategory).find(a=>a.id.toString()===t);c.middleCategory=r?.categoryName||"",c.minorCategory=""}else if(s==="minor"){const r=_(c.middleCategory).find(a=>a.id.toString()===t);c.minorCategory=r?.categoryName||""}y(r=>({...r,items:o}))};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"기본 정보"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"orderNumber",children:"발주번호"}),e.jsx(H,{id:"orderNumber",value:x.orderNumber,onChange:i=>P("orderNumber",i.target.value),placeholder:"PO-20240101-001"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"발주일"}),e.jsxs(be,{children:[e.jsx(we,{asChild:!0,children:e.jsxs(v,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(Ie,{className:"mr-2 h-4 w-4"}),Pe(x.orderDate,"PPP",{locale:Ce})]})}),e.jsx(Se,{className:"w-auto p-0",children:e.jsx(Ee,{mode:"single",selected:x.orderDate,onSelect:i=>i&&P("orderDate",i),initialFocus:!0})})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"현장"}),e.jsxs(G,{value:x.projectId,onValueChange:U,children:[e.jsx(X,{children:e.jsx(Q,{placeholder:d?"로딩 중...":b?"로딩 실패":"현장 선택"})}),e.jsxs(W,{children:[d&&e.jsx(O,{value:"loading",disabled:!0,children:"로딩 중..."}),b&&e.jsx(O,{value:"error",disabled:!0,children:"데이터 로딩 실패"}),E?.map(i=>e.jsx(O,{value:i.id.toString(),children:i.projectName},i.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"납기일"}),e.jsxs(be,{children:[e.jsx(we,{asChild:!0,children:e.jsxs(v,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(Ie,{className:"mr-2 h-4 w-4"}),Pe(x.deliveryDate,"PPP",{locale:Ce})]})}),e.jsx(Se,{className:"w-auto p-0",children:e.jsx(Ee,{mode:"single",selected:x.deliveryDate,onSelect:i=>i&&P("deliveryDate",i),initialFocus:!0})})]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"거래처 정보"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"거래처"}),e.jsxs(G,{value:x.vendorId,onValueChange:$,children:[e.jsx(X,{children:e.jsx(Q,{placeholder:j?"로딩 중...":k?"로딩 실패":"거래처 선택"})}),e.jsxs(W,{children:[j&&e.jsx(O,{value:"loading",disabled:!0,children:"로딩 중..."}),k&&e.jsx(O,{value:"error",disabled:!0,children:"데이터 로딩 실패"}),D?.map(i=>e.jsx(O,{value:i.id.toString(),children:i.name},i.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"vendorEmail",children:"이메일"}),e.jsx(H,{id:"vendorEmail",type:"email",value:x.vendorEmail,onChange:i=>P("vendorEmail",i.target.value),placeholder:"vendor@example.com"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"품목 정보"}),e.jsxs(v,{onClick:z,size:"sm",variant:"outline",children:[e.jsx(le,{className:"w-4 h-4 mr-1"}),"품목 추가"]})]}),e.jsx("div",{className:"space-y-4",children:x.items.map((i,s)=>e.jsxs("div",{className:"p-4 border rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"품목명"}),e.jsx(H,{value:i.itemName,onChange:t=>C(s,"itemName",t.target.value),placeholder:"품목명을 입력하세요"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"규격"}),e.jsx(H,{value:i.specification,onChange:t=>C(s,"specification",t.target.value),placeholder:"규격을 입력하세요"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"단위"}),e.jsxs(G,{value:i.unit,onValueChange:t=>C(s,"unit",t),children:[e.jsx(X,{children:e.jsx(Q,{placeholder:"단위 선택"})}),e.jsxs(W,{children:[e.jsx(O,{value:"EA",children:"EA"}),e.jsx(O,{value:"M",children:"M"}),e.jsx(O,{value:"M2",children:"M²"}),e.jsx(O,{value:"M3",children:"M³"}),e.jsx(O,{value:"KG",children:"KG"}),e.jsx(O,{value:"TON",children:"TON"}),e.jsx(O,{value:"SET",children:"SET"}),e.jsx(O,{value:"BOX",children:"BOX"}),e.jsx(O,{value:"ROLL",children:"ROLL"}),e.jsx(O,{value:"L",children:"L"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"대분류"}),e.jsxs(G,{value:i.majorCategory?g().find(t=>t.categoryName===i.majorCategory)?.id.toString():"",onValueChange:t=>B(s,"major",t),children:[e.jsx(X,{children:e.jsx(Q,{placeholder:M?"로딩 중...":I?"로딩 실패":"대분류 선택"})}),e.jsxs(W,{children:[M&&e.jsx(O,{value:"loading",disabled:!0,children:"로딩 중..."}),I&&e.jsx(O,{value:"error",disabled:!0,children:"데이터 로딩 실패"}),g().map(t=>e.jsx(O,{value:t.id.toString(),children:t.categoryName},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"중분류"}),e.jsxs(G,{value:i.middleCategory?q(i.majorCategory).find(t=>t.categoryName===i.middleCategory)?.id.toString():"",onValueChange:t=>B(s,"middle",t),disabled:!i.majorCategory,children:[e.jsx(X,{children:e.jsx(Q,{placeholder:i.majorCategory?"중분류 선택":"대분류를 먼저 선택하세요"})}),e.jsx(W,{children:q(i.majorCategory).map(t=>e.jsx(O,{value:t.id.toString(),children:t.categoryName},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"소분류"}),e.jsxs(G,{value:i.minorCategory?_(i.middleCategory).find(t=>t.categoryName===i.minorCategory)?.id.toString():"",onValueChange:t=>B(s,"minor",t),disabled:!i.middleCategory,children:[e.jsx(X,{children:e.jsx(Q,{placeholder:i.middleCategory?"소분류 선택":"중분류를 먼저 선택하세요"})}),e.jsx(W,{children:_(i.middleCategory).map(t=>e.jsx(O,{value:t.id.toString(),children:t.categoryName},t.id))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"수량"}),e.jsx(H,{type:"number",value:i.quantity,onChange:t=>C(s,"quantity",Number(t.target.value)),min:"1",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"단가"}),e.jsx(H,{type:"number",value:i.unitPrice,onChange:t=>C(s,"unitPrice",Number(t.target.value)),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"금액"}),e.jsxs("div",{className:"px-3 py-2 bg-muted border rounded-md text-sm font-medium text-foreground",children:[i.totalAmount.toLocaleString(),"원"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"작업"}),e.jsxs(v,{onClick:()=>K(s),size:"sm",variant:"outline",className:"w-full text-red-600 border-red-200 hover:bg-red-50",disabled:x.items.length===1,children:[e.jsx(ze,{className:"w-4 h-4 mr-1"}),"삭제"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"품목 비고"}),e.jsx(de,{value:i.notes,onChange:t=>C(s,"notes",t.target.value),placeholder:"이 품목에 대한 특별 요청사항이나 참고사항을 입력하세요",rows:2})]})]},s))}),e.jsx("div",{className:"flex justify-end p-3 bg-muted rounded-lg",children:e.jsxs("div",{className:"text-lg font-semibold text-foreground",children:["총액: ",x.totalAmount.toLocaleString(),"원"]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"notes",children:"비고"}),e.jsx(de,{id:"notes",value:x.notes,onChange:i=>P("notes",i.target.value),placeholder:"추가 요청사항이나 특이사항을 입력하세요",rows:3})]})]})},as=({orderData:l,pdfUrl:A,processingStatus:x})=>{const[y,E]=u.useState([l.vendorEmail||""]),[d,b]=u.useState([]),[D,j]=u.useState(`발주서 - ${l.orderNumber||""}`),[k,R]=u.useState("info");u.useState(!1);const[M,I]=u.useState([]),[h,f]=u.useState([]),[P,U]=u.useState(()=>`안녕하세요,

${l.vendorName||"거래처"} 담당자님

발주서를 첨부하여 보내드립니다.

발주번호: ${l.orderNumber||"-"}
프로젝트: ${l.projectName||"-"}
납기일: ${l.deliveryDate?new Date(l.deliveryDate).toLocaleDateString("ko-KR"):"-"}

확인 후 회신 부탁드립니다.

감사합니다.`);u.useEffect(()=>{U(`안녕하세요,

${l.vendorName||"거래처"} 담당자님

발주서를 첨부하여 보내드립니다.

발주번호: ${l.orderNumber||"-"}
프로젝트: ${l.projectName||"-"}
납기일: ${l.deliveryDate?new Date(l.deliveryDate).toLocaleDateString("ko-KR"):"-"}

확인 후 회신 부탁드립니다.

감사합니다.`)},[l.vendorName,l.orderNumber,l.projectName,l.deliveryDate]),u.useEffect(()=>{const s=[];l.processedExcelUrl&&s.push({id:"processed-excel",name:l.originalFileName||"처리된_Excel_파일.xlsx",size:0,type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",url:l.processedExcelUrl,isDefault:!0,isSelected:!0}),A&&x.pdf==="completed"&&s.push({id:"generated-pdf",name:`발주서_${l.orderNumber||"generated"}.pdf`,size:0,type:"application/pdf",url:A,isDefault:!0,isSelected:!0}),I(t=>{const o=t.filter(c=>!c.isDefault);return[...s,...o]})},[l.processedExcelUrl,A,x.pdf,l.orderNumber]);const $=s=>{s==="to"?E([...y,""]):b([...d,""])},C=(s,t)=>{s==="to"&&y.length>1?E(y.filter((o,c)=>c!==t)):s==="cc"&&b(d.filter((o,c)=>c!==t))},z=(s,t,o)=>{if(s==="to"){const c=[...y];c[t]=o,E(c)}else{const c=[...d];c[t]=o,b(c)}},K=async s=>{const t=Array.from(s);for(const o of t){const c=`custom-${Date.now()}-${Math.random()}`;f(r=>[...r,c]);try{const r={id:c,name:o.name,size:o.size,type:o.type,file:o,isDefault:!1,isSelected:!0};I(a=>[...a,r])}catch(r){console.error("파일 업로드 실패:",r)}finally{f(r=>r.filter(a=>a!==c))}}},g=s=>{I(t=>t.map(o=>o.id===s?{...o,isSelected:!o.isSelected}:o))},q=s=>{I(t=>t.filter(o=>o.id!==s))},_=s=>{if(s===0)return"0 Bytes";const t=1024,o=["Bytes","KB","MB","GB"],c=Math.floor(Math.log(s)/Math.log(t));return parseFloat((s/Math.pow(t,c)).toFixed(2))+" "+o[c]},B=s=>s.includes("pdf")?e.jsx(re,{className:"w-4 h-4 text-red-600"}):s.includes("spreadsheet")||s.includes("excel")?e.jsx(re,{className:"w-4 h-4 text-green-600"}):e.jsx(pe,{className:"w-4 h-4 text-gray-600"}),i=s=>{switch(s){case"completed":return e.jsx(te,{className:"w-4 h-4 text-green-600"});case"processing":return e.jsx(Z,{className:"w-4 h-4 text-blue-600 animate-spin"});case"error":return e.jsx(ue,{className:"w-4 h-4 text-red-600"});default:return null}};return e.jsxs(ee,{className:"h-full",children:[e.jsx(Fe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Te,{children:"실시간 미리보기"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(V,{variant:x.pdf==="completed"?"success":"secondary",children:[i(x.pdf),e.jsx("span",{className:"ml-1",children:"PDF"})]}),e.jsxs(V,{variant:x.vendor==="completed"?"success":"secondary",children:[i(x.vendor),e.jsx("span",{className:"ml-1",children:"거래처"})]}),e.jsxs(V,{variant:x.email==="completed"?"success":"secondary",children:[i(x.email),e.jsx("span",{className:"ml-1",children:"이메일"})]})]})]})}),e.jsx(se,{className:"h-[calc(100%-5rem)]",children:e.jsxs(Xe,{value:k,onValueChange:R,className:"h-full",children:[e.jsxs(Qe,{className:"grid w-full grid-cols-3",children:[e.jsxs(xe,{value:"info",children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"발주서 정보"]}),e.jsxs(xe,{value:"pdf",children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"PDF 미리보기"]}),e.jsxs(xe,{value:"email",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"이메일 설정"]})]}),e.jsx(he,{value:"pdf",className:"h-[calc(100%-3rem)]",children:x.pdf==="processing"?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(Z,{className:"w-12 h-12 mx-auto text-blue-600 animate-spin"}),e.jsx("p",{className:"text-sm text-gray-600",children:"PDF를 생성하고 있습니다..."})]})}):x.pdf==="error"?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(ue,{className:"w-12 h-12 mx-auto text-red-600"}),e.jsx("p",{className:"text-sm text-red-600",children:"PDF 생성 실패"}),e.jsxs(v,{variant:"outline",size:"sm",children:[e.jsx(Ue,{className:"w-4 h-4 mr-2"}),"다시 시도"]})]})}):A&&x.pdf==="completed"?e.jsx("div",{className:"w-full h-full flex flex-col",children:e.jsx("div",{className:"flex-1 bg-gray-50 rounded-lg p-8 flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(te,{className:"w-16 h-16 mx-auto text-green-600"}),e.jsx("h3",{className:"text-lg font-medium",children:"PDF가 생성되었습니다"}),e.jsx("p",{className:"text-sm text-gray-600",children:"아래 버튼을 클릭하여 PDF를 확인하세요"}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-6",children:[e.jsxs(v,{variant:"default",onClick:()=>window.open(A,"_blank"),children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"PDF 미리보기"]}),e.jsxs(v,{variant:"outline",onClick:()=>window.open(`${A}?download=true`,"_blank"),children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"PDF 다운로드"]})]})]})})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(re,{className:"w-12 h-12 mx-auto text-gray-400"}),e.jsx("p",{className:"text-sm text-gray-600",children:"발주서 정보가 완성되면 PDF가 자동으로 생성됩니다"}),e.jsx("p",{className:"text-xs text-gray-500",children:"먼저 '발주서 정보' 탭에서 내용을 확인해주세요"})]})})}),e.jsxs(he,{value:"info",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-gray-600",children:"발주번호"}),e.jsx("p",{className:"font-medium",children:l.orderNumber||"-"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-gray-600",children:"발주일"}),e.jsx("p",{className:"font-medium",children:l.orderDate?new Date(l.orderDate).toLocaleDateString("ko-KR"):"-"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-gray-600",children:"프로젝트"}),e.jsx("p",{className:"font-medium",children:l.projectName||"-"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-gray-600",children:"거래처"}),e.jsx("p",{className:"font-medium",children:l.vendorName||"-"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-gray-600",children:"납기일"}),e.jsx("p",{className:"font-medium",children:l.deliveryDate?new Date(l.deliveryDate).toLocaleDateString("ko-KR"):"-"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-gray-600",children:"총액"}),e.jsx("p",{className:"font-medium text-lg text-blue-600",children:l.totalAmount?`${Math.floor(l.totalAmount).toLocaleString()}원`:"-"})]})]}),l.items&&l.items.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{className:"text-xs text-gray-600",children:"품목 목록"}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left p-2",children:"품목명"}),e.jsx("th",{className:"text-right p-2",children:"수량"}),e.jsx("th",{className:"text-right p-2",children:"단가"}),e.jsx("th",{className:"text-right p-2",children:"금액"})]})}),e.jsx("tbody",{children:l.items.map((s,t)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:s.itemName||s.name}),e.jsx("td",{className:"text-right p-2",children:Math.floor(s.quantity||0).toLocaleString()}),e.jsxs("td",{className:"text-right p-2",children:[Math.floor(s.unitPrice||0).toLocaleString(),"원"]}),e.jsxs("td",{className:"text-right p-2",children:[Math.floor(s.totalAmount||s.quantity*s.unitPrice||0).toLocaleString(),"원"]})]},t))})]})})]})]}),e.jsx(he,{value:"email",className:"space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(N,{children:"받는 사람"}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>$("to"),children:e.jsx(le,{className:"w-4 h-4"})})]}),y.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(H,{type:"email",value:s,onChange:o=>z("to",t,o.target.value),placeholder:"email@example.com"}),y.length>1&&e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>C("to",t),children:e.jsx(ae,{className:"w-4 h-4"})})]},t))]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(N,{children:"참조 (CC)"}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>$("cc"),children:e.jsx(le,{className:"w-4 h-4"})})]}),d.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(H,{type:"email",value:s,onChange:o=>z("cc",t,o.target.value),placeholder:"cc@example.com"}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>C("cc",t),children:e.jsx(ae,{className:"w-4 h-4"})})]},t))]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"제목"}),e.jsx(H,{value:D,onChange:s=>j(s.target.value),placeholder:"이메일 제목"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"메일 본문"}),e.jsx(de,{value:P,onChange:s=>U(s.target.value),placeholder:"이메일 본문을 입력하세요",className:"min-h-[200px] font-mono text-sm",rows:10})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(N,{children:"첨부파일"}),e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept=".pdf,.xlsx,.xls,.doc,.docx,.txt",s.onchange=t=>{const o=t.target;o.files&&o.files.length>0&&K(o.files)},s.click()},children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"파일 추가"]})]}),e.jsx("div",{className:"space-y-3",children:M.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-center py-4",children:"첨부할 파일이 없습니다"}):M.map(s=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg bg-gray-50",children:[e.jsx(ce,{checked:s.isSelected,onCheckedChange:()=>g(s.id)}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[B(s.type),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsx("span",{children:_(s.size)}),s.isDefault&&e.jsx(V,{variant:"secondary",className:"text-xs",children:"기본파일"})]})]})]}),h.includes(s.id)&&e.jsx(Z,{className:"w-4 h-4 animate-spin text-blue-600"}),!s.isDefault&&!h.includes(s.id)&&e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>q(s.id),children:e.jsx(ze,{className:"w-4 h-4 text-red-600"})})]},s.id))}),M.length>0&&e.jsx("div",{className:"p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:["선택된 파일: ",M.filter(s=>s.isSelected).length,"/",M.length,"개"]})})]})]})})]})})]})},ls=({orderData:l,pdfUrl:A,processingStatus:x,onSave:y,onSend:E,onDownload:d,onCreateOrder:b,onCreateOrderWithEmail:D})=>{const{isCollapsed:j}=Ve(),[k,R]=u.useState(!0),[M,I]=u.useState(!1),[h,f]=u.useState({to:[l.vendorEmail||""].filter(Boolean),cc:[],subject:`발주서 - ${l.orderNumber||""} (${new Date().toLocaleDateString("ko-KR")})`,message:`안녕하세요,

첨부된 발주서를 확인해 주시기 바랍니다.

감사합니다.`,attachments:{includeExcel:!0,includePdf:!0,additionalFiles:[]}}),[P,U]=u.useState(""),[$,C]=u.useState("");u.useEffect(()=>{const r=l.vendorEmail||"",a=r?[r]:[];console.log("🔍 orderData 변경 감지:",{vendorEmail:r,newToEmails:a}),f(m=>({...m,to:a,subject:`발주서 - ${l.orderNumber||""} (${new Date().toLocaleDateString("ko-KR")})`}))},[l.vendorEmail,l.orderNumber]);const z=()=>{P.trim()&&!h.to.includes(P.trim())&&(f(r=>({...r,to:[...r.to,P.trim()]})),U(""))},K=r=>{f(a=>({...a,to:a.to.filter(m=>m!==r)}))},g=()=>{$.trim()&&!h.cc.includes($.trim())&&(f(r=>({...r,cc:[...r.cc,$.trim()]})),C(""))},q=r=>{f(a=>({...a,cc:a.cc.filter(m=>m!==r)}))},_=r=>{const a=Array.from(r.target.files||[]);f(m=>({...m,attachments:{...m.attachments,additionalFiles:[...m.attachments.additionalFiles,...a]}}))},B=r=>{f(a=>({...a,attachments:{...a.attachments,additionalFiles:a.attachments.additionalFiles.filter((m,p)=>p!==r)}}))},i=x.pdf==="completed"&&x.vendor==="completed"&&h.to.length>0,s=l.orderNumber&&l.vendorName&&l.projectName&&l.items?.length>0,t=Object.values(x).some(r=>r==="processing"),o=()=>{k&&D?I(!0):b()},c=()=>{I(!1),D&&D(h)};return e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 bg-background border-t border-border shadow-lg z-30",children:[e.jsxs("div",{className:Y("container mx-auto px-6 py-4 transition-all duration-300",j?"xl:ml-16":"xl:ml-64"),children:[e.jsxs("div",{className:"flex flex-col gap-3 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-muted rounded-lg text-sm",children:[e.jsx(ce,{id:"send-email",checked:k,onCheckedChange:r=>R(!!r),className:"h-4 w-4"}),e.jsx("label",{htmlFor:"send-email",className:"font-medium cursor-pointer text-foreground whitespace-nowrap text-xs",children:"발주서 생성 후 이메일 자동 발송"}),t&&e.jsxs("div",{className:"flex items-center gap-1 ml-2 text-xs text-muted-foreground",children:[e.jsx(Z,{className:"w-3 h-3 animate-spin"}),"처리 중"]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[e.jsxs(v,{variant:"outline",onClick:y,disabled:t,size:"sm",className:"text-xs px-3 py-2 h-8",children:[e.jsx(We,{className:"w-3 h-3 mr-1"}),"임시저장"]}),e.jsxs(v,{variant:"outline",onClick:d,disabled:!A||x.pdf!=="completed",size:"sm",className:"text-xs px-3 py-2 h-8",children:[e.jsx(ve,{className:"w-3 h-3 mr-1"}),"다운로드"]}),!k&&e.jsx(v,{onClick:E,disabled:!i||x.email==="processing",size:"sm",className:Y("text-xs px-3 py-2 h-8",i?"bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700":""),children:x.email==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"w-3 h-3 mr-1 animate-spin"}),"발송중"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"w-3 h-3 mr-1"}),"이메일 발송"]})}),e.jsx(v,{variant:"default",onClick:o,disabled:!s||x.order==="processing",size:"sm",className:Y("text-xs px-4 py-2 h-8 font-medium",s?k?"bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700":"bg-green-600 hover:bg-green-700 dark:bg-green-600 dark:hover:bg-green-700":""),children:x.order==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"w-3 h-3 mr-1 animate-spin"}),k?"생성 및 발송 중":"생성 중"]}):e.jsx(e.Fragment,{children:k?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-3 h-3 mr-1"}),"발주서 생성 및 발송"]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-3 h-3 mr-1"}),"발주서 생성"]})})}),e.jsxs(v,{variant:"ghost",onClick:()=>window.location.href="/orders",disabled:t,size:"sm",className:"text-xs px-3 py-2 h-8 text-muted-foreground hover:text-foreground",children:[e.jsx(es,{className:"w-3 h-3 mr-1"}),"발주서 관리"]})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-center gap-6 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",x.pdf==="completed"?"bg-green-500":x.pdf==="processing"?"bg-blue-500 animate-pulse":x.pdf==="error"?"bg-red-500":"bg-muted-foreground")}),"PDF 생성"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",x.vendor==="completed"?"bg-green-500":x.vendor==="processing"?"bg-blue-500 animate-pulse":x.vendor==="error"?"bg-red-500":"bg-muted-foreground")}),"거래처 확인"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",x.order==="completed"?"bg-green-500":x.order==="processing"?"bg-blue-500 animate-pulse":x.order==="error"?"bg-red-500":"bg-muted-foreground")}),"발주서 생성"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",x.email==="completed"?"bg-green-500":x.email==="processing"?"bg-blue-500 animate-pulse":x.email==="error"?"bg-red-500":"bg-muted-foreground")}),"이메일 준비"]})]})]}),e.jsx(Oe,{open:M,onOpenChange:I,children:e.jsxs(Ae,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(De,{children:e.jsx(Le,{children:"이메일 발송 설정"})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(N,{className:"text-sm font-medium",children:"받는 사람 *"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[h.to.map((r,a)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx("span",{className:"flex-1 text-sm text-foreground",children:r}),e.jsx(v,{type:"button",variant:"ghost",size:"sm",onClick:()=>K(r),className:"h-6 w-6 p-0 hover:bg-red-100 dark:hover:bg-red-900",children:e.jsx(ae,{className:"h-3 w-3"})})]},a)),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(H,{value:P,onChange:r=>U(r.target.value),placeholder:"example@company.com",onKeyPress:r=>r.key==="Enter"&&z(),className:"flex-1"}),e.jsx(v,{type:"button",variant:"outline",size:"sm",onClick:z,disabled:!P.trim(),children:e.jsx(le,{className:"h-4 w-4"})})]})]})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-sm font-medium",children:"참조 (CC)"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[h.cc.map((r,a)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx("span",{className:"flex-1 text-sm text-foreground",children:r}),e.jsx(v,{type:"button",variant:"ghost",size:"sm",onClick:()=>q(r),className:"h-6 w-6 p-0 hover:bg-red-100 dark:hover:bg-red-900",children:e.jsx(ae,{className:"h-3 w-3"})})]},a)),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(H,{value:$,onChange:r=>C(r.target.value),placeholder:"manager@company.com (선택사항)",onKeyPress:r=>r.key==="Enter"&&g(),className:"flex-1"}),e.jsx(v,{type:"button",variant:"outline",size:"sm",onClick:g,disabled:!$.trim(),children:e.jsx(le,{className:"h-4 w-4"})})]})]})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"email-subject",className:"text-sm font-medium",children:"제목 *"}),e.jsx(H,{id:"email-subject",value:h.subject,onChange:r=>f(a=>({...a,subject:r.target.value})),className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"email-message",className:"text-sm font-medium",children:"메시지"}),e.jsx(de,{id:"email-message",value:h.message,onChange:r=>f(a=>({...a,message:r.target.value})),rows:4,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-sm font-medium",children:"첨부파일"}),e.jsxs("div",{className:"mt-2 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ce,{id:"include-excel",checked:h.attachments.includeExcel,onCheckedChange:r=>f(a=>({...a,attachments:{...a.attachments,includeExcel:!!r}}))}),e.jsx(N,{htmlFor:"include-excel",className:"text-sm",children:"Excel 파일 첨부"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ce,{id:"include-pdf",checked:h.attachments.includePdf,onCheckedChange:r=>f(a=>({...a,attachments:{...a.attachments,includePdf:!!r}}))}),e.jsx(N,{htmlFor:"include-pdf",className:"text-sm",children:"PDF 파일 첨부"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(N,{className:"text-sm",children:"추가 파일"}),e.jsxs(v,{type:"button",variant:"outline",size:"sm",onClick:()=>document.getElementById("additional-files")?.click(),className:"h-8",children:[e.jsx(pe,{className:"h-3 w-3 mr-1"}),"파일 선택"]})]}),e.jsx("input",{id:"additional-files",type:"file",multiple:!0,onChange:_,className:"hidden"}),h.attachments.additionalFiles.length>0&&e.jsx("div",{className:"space-y-1",children:h.attachments.additionalFiles.map((r,a)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx(pe,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{className:"flex-1 text-sm text-foreground",children:r.name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[(r.size/1024).toFixed(1)," KB"]}),e.jsx(v,{type:"button",variant:"ghost",size:"sm",onClick:()=>B(a),className:"h-6 w-6 p-0 hover:bg-red-100 dark:hover:bg-red-900",children:e.jsx(ae,{className:"h-3 w-3"})})]},a))})]})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground bg-blue-50 dark:bg-blue-950 p-2 rounded",children:"📎 선택한 첨부파일이 이메일과 함께 발송됩니다."})]}),e.jsxs(Me,{className:"mt-6",children:[e.jsx(v,{variant:"outline",onClick:()=>I(!1),children:"취소"}),e.jsxs(v,{onClick:c,disabled:h.to.length===0||!h.subject,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"발주서 생성"]})]}),e.jsxs("div",{className:"mt-2 p-2 bg-gray-100 text-xs text-gray-600 rounded",children:["🔍 Debug: to.length=",h.to.length,', subject="',h.subject,'", disabled=',h.to.length===0||!h.subject]})]})})]})},ns=({orderData:l,onSuggestionApply:A})=>{const[x,y]=u.useState([]),[E,d]=u.useState(new Set),[b,D]=u.useState(!1);u.useEffect(()=>{j()},[l]);const j=()=>{D(!0);const h=[];if(l.vendorName&&!l.vendorEmail&&h.push({id:"vendor-email",type:"autofill",title:"거래처 이메일 자동 완성",description:"등록된 거래처 정보에서 이메일을 가져올 수 있습니다.",action:{label:"이메일 자동 입력",data:{vendorEmail:"vendor@example.com"}},priority:"high"}),l.deliveryDate){const f=new Date(l.deliveryDate),P=new Date,U=Math.ceil((f.getTime()-P.getTime())/(1e3*60*60*24));U<3&&h.push({id:"delivery-urgent",type:"warning",title:"긴급 납기",description:`납기일이 ${U}일 남았습니다. 긴급 처리가 필요합니다.`,priority:"high"})}l.projectName&&!l.notes&&h.push({id:"project-defaults",type:"recommendation",title:"프로젝트 기본 설정",description:"이전 발주서를 참고하여 자주 사용하는 설정을 적용할 수 있습니다.",action:{label:"기본값 적용",data:{notes:"상차 후 연락 요망",deliveryLocation:"현장 직납"}},priority:"medium"}),l.totalAmount>1e7&&h.push({id:"amount-check",type:"info",title:"고액 발주서",description:"1천만원 이상의 발주서입니다. 결재 승인이 필요할 수 있습니다.",priority:"medium"}),l.vendorName&&l.vendorName.length>2&&["(주)ABC건설","(주)ABC종합건설"].length>0&&h.push({id:"similar-vendors",type:"recommendation",title:"유사 거래처 발견",description:`'${l.vendorName}'와 유사한 거래처가 있습니다. 확인해보세요.`,priority:"low"}),y(h.filter(f=>!E.has(f.id))),D(!1)},k=h=>{h.action&&(A(h.action.data),R(h.id))},R=h=>{d(f=>new Set(f).add(h)),y(f=>f.filter(P=>P.id!==h))},M=h=>{switch(h){case"warning":return e.jsx(oe,{className:"w-5 h-5 text-yellow-600"});case"info":return e.jsx(je,{className:"w-5 h-5 text-blue-600"});case"recommendation":return e.jsx(Re,{className:"w-5 h-5 text-green-600"});case"autofill":return e.jsx(fe,{className:"w-5 h-5 text-purple-600"});default:return e.jsx(je,{className:"w-5 h-5 text-gray-600"})}},I=h=>{switch(h){case"warning":return"bg-yellow-50 border-yellow-200";case"info":return"bg-blue-50 border-blue-200";case"recommendation":return"bg-green-50 border-green-200";case"autofill":return"bg-purple-50 border-purple-200";default:return"bg-gray-50 border-gray-200"}};return x.length===0&&!b?null:e.jsxs(ee,{children:[e.jsx(Fe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Te,{className:"text-lg flex items-center gap-2",children:[e.jsx(fe,{className:"w-5 h-5 text-yellow-500"}),"스마트 어시스트"]}),b&&e.jsx(Ue,{className:"w-4 h-4 text-gray-500 animate-spin"})]})}),e.jsxs(se,{className:"space-y-3",children:[x.sort((h,f)=>{const P={high:0,medium:1,low:2};return P[h.priority]-P[f.priority]}).map(h=>e.jsx(ne,{className:`${I(h.type)} border`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[M(h.type),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-medium text-sm",children:h.title}),h.priority==="high"&&e.jsx(V,{variant:"destructive",className:"text-xs",children:"중요"})]}),e.jsx(ie,{className:"text-xs",children:h.description}),h.action&&e.jsxs(v,{size:"sm",variant:"outline",className:"mt-2",onClick:()=>k(h),children:[h.action.label,e.jsx($e,{className:"w-3 h-3 ml-1"})]})]}),e.jsx(v,{size:"sm",variant:"ghost",className:"text-gray-400 hover:text-gray-600 h-6 w-6 p-0",onClick:()=>R(h.id),children:"×"})]})},h.id)),x.length===0&&!b&&e.jsxs("div",{className:"text-center py-4 text-sm text-gray-500",children:[e.jsx(te,{className:"w-8 h-8 text-green-500 mx-auto mb-2"}),"모든 항목이 올바르게 입력되었습니다"]})]})]})},$s=()=>{const{toast:l}=Je(),{user:A,isAuthenticated:x}=Ke(),[y,E]=u.useState(null),[d,b]=u.useState({}),[D,j]=u.useState({pdf:"idle",vendor:"idle",email:"idle",order:"idle"}),[k,R]=u.useState(null),[M,I]=u.useState(!1),[h,f]=u.useState(!1),P=u.useCallback(()=>{console.log("🔄 발주서 작성 페이지 초기화"),E(null),b({}),j({pdf:"idle",vendor:"idle",email:"idle",order:"idle"}),R(null),I(!1),f(!1),localStorage.removeItem("draftOrder")},[]);u.useEffect(()=>{if(h&&d.orderNumber){const s=setTimeout(()=>{U()},2e3);return()=>clearTimeout(s)}},[d,h]),u.useEffect(()=>{if(d.orderNumber&&d.vendorName&&d.projectName&&d.items?.length>0){const s=setTimeout(()=>{$()},500);return()=>clearTimeout(s)}},[d.orderNumber,d.vendorName,d.projectName,d.items]);const U=async()=>{I(!0);try{localStorage.setItem("draftOrder",JSON.stringify(d)),f(!1)}catch(s){console.error("Auto-save failed:",s)}finally{I(!1)}},$=async()=>{if(d.orderNumber){console.log("🔵 PDF 생성 시작:",d),j(s=>({...s,pdf:"processing"}));try{const s=d.totalAmount||(d.items||[]).reduce((c,r)=>c+(r.quantity||0)*(r.unitPrice||0),0),t={...d,totalAmount:s};console.log("🔵 PDF 생성 요청 데이터:",t);const o=await fetch("/api/orders/generate-pdf",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({orderData:t})});if(o.ok){const c=await o.json();console.log("🔵 PDF 생성 응답:",c);const r=c.pdfUrl.startsWith("http")?c.pdfUrl:`${window.location.origin}${c.pdfUrl}`;console.log("🔵 PDF URL:",r),R(r),j(a=>({...a,pdf:"completed"})),fetch(r,{method:"HEAD"}).then(a=>{console.log("🔵 PDF 접근성 테스트:",a.status,a.headers.get("content-type"))}).catch(a=>{console.error("🔴 PDF 접근 실패:",a)})}else{const c=await o.text();throw console.error("🔴 PDF 생성 실패 응답:",o.status,c),new Error(`PDF 생성 실패: ${o.status}`)}}catch(s){j(t=>({...t,pdf:"error"})),console.error("🔴 PDF generation error:",s)}}},C=s=>{E(s);const t=localStorage.getItem("draftOrder");if(t)try{const o=JSON.parse(t);console.log("📋 임시저장 데이터 발견:",o),window.confirm("저장된 임시 작업이 있습니다. 불러오시겠습니까?")?(console.log("✅ 사용자 확인: 임시저장 데이터 로드 시작"),b(c=>(console.log("🔄 이전 orderData:",c),console.log("🔄 새로운 orderData:",o),{...o})),f(!1),l({title:"임시저장 불러오기 완료",description:`발주번호 ${o.orderNumber||"미정"}의 임시 작업을 불러왔습니다.`})):(console.log("❌ 사용자 취소: 임시저장 데이터 로드 취소"),localStorage.removeItem("draftOrder"))}catch(o){console.error("❌ 임시저장 데이터 파싱 오류:",o),localStorage.removeItem("draftOrder"),l({title:"임시저장 불러오기 실패",description:"저장된 데이터가 손상되어 삭제되었습니다.",variant:"destructive"})}else console.log("📋 임시저장 데이터 없음")},z=u.useCallback(s=>{b(t=>Object.keys(s).some(c=>JSON.stringify(s[c])!==JSON.stringify(t[c]))?{...t,...s}:t),f(!0),s.vendorName&&s.vendorName!==d.vendorName&&g(s.vendorName)},[d.vendorName]),K=s=>{b(t=>({...t,processedExcelUrl:s.url,originalFileName:s.name}))},g=async s=>{j(t=>({...t,vendor:"processing"}));try{const t=await fetch("/api/vendors/validate",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({vendorName:s})});if(t.ok){const o=await t.json();o.isValid?(j(c=>({...c,vendor:"completed"})),o.vendorEmail&&b(c=>({...c,vendorEmail:o.vendorEmail}))):j(c=>({...c,vendor:"error"}))}}catch{j(o=>({...o,vendor:"error"}))}},q=async()=>{if(!d.orderNumber||!d.vendorName||!d.projectName||!d.items?.length){l({title:"생성 불가",description:"필수 정보를 모두 입력해주세요.",variant:"destructive"});return}if(j(s=>({...s,order:"processing"})),!x||!A){console.error("🔴 인증 실패 - 로그인 필요"),l({title:"인증 필요",description:"로그인이 필요합니다. 로그인 페이지로 이동합니다.",variant:"destructive"}),j(s=>({...s,order:"error"})),setTimeout(()=>{window.location.href="/login"},2e3);return}console.log("🔐 현재 사용자:",A);try{console.log("🟢 발주서 생성 시작:",d);const s=new FormData;s.append("projectId","1"),s.append("vendorId","1"),s.append("orderDate",d.orderDate||new Date().toISOString()),s.append("deliveryDate",d.deliveryDate||new Date().toISOString()),s.append("notes",d.notes||`발주서 작성으로 생성된 발주서 - ${d.orderNumber}`);const t=(d.items||[]).map(c=>({itemName:c.name||c.itemName||"",specification:c.specification||"",unit:c.unit||"EA",quantity:parseFloat(c.quantity||"0"),unitPrice:parseFloat(c.unitPrice||"0"),totalAmount:parseFloat(c.quantity||"0")*parseFloat(c.unitPrice||"0"),majorCategory:c.majorCategory||"",middleCategory:c.middleCategory||"",minorCategory:c.minorCategory||"",notes:c.notes||""}));s.append("items",JSON.stringify(t)),console.log("🟢 발주서 생성 요청 데이터:",{projectId:"1",vendorId:"1",orderDate:d.orderDate||new Date().toISOString(),deliveryDate:d.deliveryDate||new Date().toISOString(),notes:d.notes||`발주서 작성으로 생성된 발주서 - ${d.orderNumber}`,items:t});const o=await fetch("/api/orders",{method:"POST",credentials:"include",body:s});if(console.log("🟢 발주서 생성 응답 상태:",o.status),o.ok){const c=await o.json();console.log("🟢 생성된 발주서:",c),j(r=>({...r,order:"completed"})),l({title:"생성 완료",description:`발주서가 성공적으로 생성되었습니다. (${c.orderNumber||d.orderNumber}) 계속해서 다른 품목으로 발주서를 생성하실 수 있습니다.`,duration:5e3})}else{const c=await o.text();console.error("🔴 발주서 생성 실패 응답:",o.status,c);let r="발주서 생성 실패";try{r=JSON.parse(c).message||r}catch{r=`HTTP ${o.status}: ${c}`}throw new Error(r)}}catch(s){j(t=>({...t,order:"error"})),l({title:"생성 실패",description:s instanceof Error?s.message:"발주서 생성 중 오류가 발생했습니다.",variant:"destructive"})}},_=async s=>{if(console.log("📧 발주서 생성 및 이메일 발송 시작:",{orderData:d,emailSettings:s}),!d.orderNumber||!d.vendorName||!d.projectName||!d.items?.length){l({title:"생성 불가",description:"필수 정보를 모두 입력해주세요.",variant:"destructive"});return}j(t=>({...t,order:"processing",email:"processing"}));try{console.log("🟢 Step 1: 발주서 생성");const t=new FormData;t.append("projectId","1"),t.append("vendorId","1"),t.append("orderDate",d.orderDate||new Date().toISOString()),t.append("deliveryDate",d.deliveryDate||new Date().toISOString()),t.append("notes",d.notes||`발주서 작성으로 생성된 발주서 - ${d.orderNumber}`);const o=(d.items||[]).map(a=>({itemName:a.name||a.itemName||"",specification:a.specification||"",unit:a.unit||"EA",quantity:parseFloat(a.quantity||"0"),unitPrice:parseFloat(a.unitPrice||"0"),totalAmount:parseFloat(a.quantity||"0")*parseFloat(a.unitPrice||"0"),majorCategory:a.majorCategory||"",middleCategory:a.middleCategory||"",minorCategory:a.minorCategory||"",notes:a.notes||""}));t.append("items",JSON.stringify(o));const c=await fetch("/api/orders",{method:"POST",credentials:"include",body:t});if(!c.ok)throw new Error("발주서 생성 실패");const r=await c.json();if(console.log("🟢 발주서 생성 완료:",r),j(a=>({...a,order:"completed"})),console.log("📧 Step 2: 이메일 발송"),console.log("🔍 processedExcelUrl 확인:",d.processedExcelUrl),console.log("🔍 이메일 설정 확인:",s),d.processedExcelUrl)try{console.log("📤 Excel 이메일 요청 시작...");const a=await fetch("/api/orders/send-email-with-excel",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({emailSettings:{to:s.to,cc:s.cc||"",subject:s.subject,message:s.message,orderNumber:d.orderNumber,vendorName:d.vendorName,totalAmount:d.totalAmount},excelFilePath:d.processedExcelUrl,orderData:d})});if(a.ok)console.log("📧 이메일 발송 성공"),j(m=>({...m,email:"completed"})),l({title:"생성 및 발송 완료",description:`발주서가 생성되고 이메일이 발송되었습니다. (${r.orderNumber||d.orderNumber}) 계속해서 다른 품목으로 발주서를 생성하실 수 있습니다.`,duration:5e3});else{const m=await a.text();throw console.error("📧 Excel 이메일 발송 HTTP 오류:",a.status,m),new Error(`Excel 이메일 발송 실패 (${a.status}): ${m}`)}}catch(a){console.error("📧 Excel 이메일 발송 실패 상세:",{error:a,message:a instanceof Error?a.message:"Unknown error",stack:a instanceof Error?a.stack:"No stack"}),j(m=>({...m,email:"error"})),l({title:"부분 완료",description:"발주서는 생성되었으나 이메일 발송에 실패했습니다.",variant:"destructive"})}else try{console.log("📤 PDF 이메일 요청 시작...");const a=await fetch("/api/orders/send-email",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({orderData:{...d,vendorEmail:s.to},pdfUrl:k,recipients:s.to,emailSettings:{subject:s.subject,message:s.message,cc:s.cc}})});if(a.ok)console.log("📧 PDF 이메일 발송 성공"),j(m=>({...m,email:"completed"})),l({title:"생성 및 발송 완료",description:"발주서가 생성되고 PDF 이메일이 발송되었습니다. 계속해서 다른 품목으로 발주서를 생성하실 수 있습니다.",duration:5e3});else{const m=await a.text();throw console.error("📧 PDF 이메일 발송 HTTP 오류:",a.status,m),new Error(`PDF 이메일 발송 실패 (${a.status}): ${m}`)}}catch(a){console.error("📧 PDF 이메일 발송 실패 상세:",{error:a,message:a instanceof Error?a.message:"Unknown error",stack:a instanceof Error?a.stack:"No stack"}),j(m=>({...m,email:"error"})),l({title:"부분 완료",description:"발주서는 생성되었으나 이메일 발송에 실패했습니다.",variant:"destructive"})}}catch(t){console.error("🔴 발주서 생성 및 이메일 발송 실패:",t),j(o=>({...o,order:"error",email:"error"})),l({title:"실패",description:t instanceof Error?t.message:"발주서 생성 및 이메일 발송 중 오류가 발생했습니다.",variant:"destructive"})}},B=async()=>{if(!d.vendorEmail){l({title:"발송 불가",description:"수신자 이메일을 입력해주세요.",variant:"destructive"});return}j(s=>({...s,email:"processing"}));try{if((await fetch("/api/orders/send-email",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({orderData:d,pdfUrl:k||null,recipients:[d.vendorEmail]})})).ok)j(t=>({...t,email:"completed"})),l({title:"발송 완료",description:"발주서가 성공적으로 발송되었습니다. 계속해서 다른 품목으로 발주서를 생성하실 수 있습니다.",duration:5e3});else throw new Error("이메일 발송 실패")}catch{j(t=>({...t,email:"error"})),l({title:"발송 실패",description:"이메일 발송 중 오류가 발생했습니다.",variant:"destructive"})}},i=()=>{const s=Object.values(D);return s.filter(o=>o==="completed").length/s.length*100};return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("div",{className:"bg-background border-b border-border sticky top-0 z-40",children:e.jsx("div",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"발주서 작성"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"한 화면에서 모든 작업을 완료하세요"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[y&&e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>{window.confirm("현재 작업 중인 내용이 모두 삭제됩니다. 새로 작성하시겠습니까?")&&(P(),l({title:"새로 작성",description:"발주서 작성 화면이 초기화되었습니다."}))},className:"text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800 hover:bg-blue-50 dark:hover:bg-blue-950",children:[e.jsx(le,{className:"w-4 h-4 mr-1"}),"새로 작성"]}),M&&e.jsxs(V,{variant:"secondary",className:"animate-pulse",children:[e.jsx(Z,{className:"w-3 h-3 mr-1 animate-spin"}),"자동 저장 중..."]}),!M&&!h&&d.orderNumber&&e.jsxs(V,{variant:"secondary",className:"bg-green-50 text-green-700",children:[e.jsx(te,{className:"w-3 h-3 mr-1"}),"저장됨"]}),e.jsx(He,{value:i(),className:"w-32 h-2"})]})]})})}),e.jsxs("div",{className:"container mx-auto px-6 py-6",style:{paddingBottom:"120px"},children:[!y&&e.jsx("div",{className:"mb-8",children:e.jsxs(ne,{className:"mb-6 max-w-4xl mx-auto",children:[e.jsx(je,{className:"h-4 w-4"}),e.jsx(ie,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-medium",children:"📋 사용팁"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-blue-600 dark:text-blue-400",children:"엑셀 파일 업로드:"})," 대량 발주서, 반복 업무, 자동화 처리에 적합 (50건+ 권장)"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-green-600 dark:text-green-400",children:"직접 입력:"})," 소량 발주서, 세밀한 조정, 즉시 처리에 적합 (10건 이하 권장)"]})]}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs(v,{variant:"outline",size:"sm",className:"text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800 hover:bg-blue-50 dark:hover:bg-blue-950",onClick:async()=>{try{const s=await fetch("/PO_Excel_Template.xlsx");if(s.ok){const t=await s.blob(),o=URL.createObjectURL(t),c=document.createElement("a");c.href=o,c.download="PO_Excel_Template.xlsx",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(o)}else throw new Error("파일을 찾을 수 없습니다")}catch(s){console.error("엑셀 템플릿 다운로드 실패:",s),l({title:"다운로드 실패",description:"엑셀 템플릿 다운로드에 실패했습니다.",variant:"destructive"})}},children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"엑셀 템플릿 다운로드"]})})]})})]})}),!y&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 max-w-4xl mx-auto",children:[e.jsx(ee,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-500 dark:hover:border-blue-400",onClick:()=>C("excel"),children:e.jsxs(se,{className:"p-8 text-center",children:[e.jsx(Ne,{className:"w-16 h-16 mx-auto mb-4 text-blue-600 dark:text-blue-400"}),e.jsx("h3",{className:"text-xl font-semibold mb-2 text-foreground",children:"엑셀 파일 업로드"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"기존 엑셀 파일을 업로드하여 빠르게 작성"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("div",{children:"✅ 대량 처리 (50건+)"}),e.jsx("div",{children:"✅ 자동화 워크플로우"}),e.jsx("div",{children:"✅ 거래처 자동 매칭"}),e.jsx("div",{children:"✅ 이메일 자동 발송"})]})]})}),e.jsx(ee,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-green-500 dark:hover:border-green-400 bg-card",onClick:()=>C("direct"),children:e.jsxs(se,{className:"p-8 text-center",children:[e.jsx(re,{className:"w-16 h-16 mx-auto mb-4 text-green-600 dark:text-green-400"}),e.jsx("h3",{className:"text-xl font-semibold mb-2 text-foreground",children:"직접 입력"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"폼을 통해 직접 정보 입력"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("div",{children:"✅ 소량 처리 (10건 이하)"}),e.jsx("div",{children:"✅ 즉시 처리"}),e.jsx("div",{children:"✅ 실시간 검증"}),e.jsx("div",{children:"✅ 세밀한 조정"})]})]})})]}),y&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx(ee,{children:e.jsxs(se,{className:"p-6",children:[y==="excel"&&e.jsx(ts,{onDataExtracted:z,onProcessedFileReady:K}),y==="direct"&&e.jsx(rs,{initialData:d,onChange:z})]})}),e.jsx(ns,{orderData:d,onSuggestionApply:z})]}),e.jsx("div",{className:"space-y-6",children:e.jsx(as,{orderData:d,pdfUrl:k,processingStatus:D})})]}),y&&d.orderNumber&&e.jsx(ls,{orderData:d,pdfUrl:k,processingStatus:D,onSave:U,onSend:B,onCreateOrder:q,onCreateOrderWithEmail:_,onDownload:()=>{k&&window.open(`${k}?download=true`,"_blank")}})]})]})};export{$s as default};
