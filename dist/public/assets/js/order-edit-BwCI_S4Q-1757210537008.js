import{d as se,e as re,u as ae,y as te,r as O,p as I,q as le,j as e,B as j,s as P,t as A,G as V,H as K,J as D,I as f,P as ne,k as b,w as G}from"./index-BE2444o0-1757210537008.js";import{T as ie}from"./textarea-DxzJ7OCB-1757210537008.js";import{S as g,a as p,b as v,c as y,d as t}from"./select-6uSRIfuf-1757210537008.js";import{T as de,a as oe,b as z,c,d as ce,e as m}from"./table-2dg2sd3I-1757210537008.js";import{i as me}from"./authUtils-CcDzk6i0-1757210537008.js";import{A as ue}from"./arrow-left-Chzm51P2-1757210537008.js";import{S as xe}from"./square-pen-Gugm1f68-1757210537008.js";import{T as he}from"./trash-2-CAnCbkZ2-1757210537008.js";import{S as je}from"./save-F-Hg-7JL-1757210537008.js";import"./index-CqvkDEJc-1757210537008.js";import"./chevron-down-CBeDqd3L-1757210537008.js";import"./chevron-up-CQfQhCpG-1757210537008.js";function Te(){se();const{toast:S}=re(),[ge,N]=ae(),F=te(),d=F.id;console.log("OrderEdit params:",F),console.log("OrderEdit orderId:",d,typeof d);const[i,o]=O.useState({projectId:"",vendorId:"",orderDate:"",deliveryDate:"",notes:"",templateId:"",items:[]}),{data:n,isLoading:L,error:w}=I({queryKey:[`/api/orders/${d}`],queryFn:()=>b("GET",`/api/orders/${d}`),enabled:!!d});console.log("OrderEdit Debug:",{orderId:d,order:n,orderLoading:L,orderError:w,enabled:!!d});const{data:H}=I({queryKey:["/api/vendors"],queryFn:()=>b("GET","/api/vendors")}),{data:R}=I({queryKey:["/api/projects"],queryFn:()=>b("GET","/api/projects")}),{data:T}=I({queryKey:["/api/categories"],queryFn:()=>b("GET","/api/categories")}),U=T?.categories||[],C=T?.flatCategories||[];console.log("Categories data:",T),console.log("Categories (hierarchical):",U),console.log("Flat categories:",C);const{data:B}=I({queryKey:["/api/items"],queryFn:()=>b("GET","/api/items")}),h=B?.items||[];O.useEffect(()=>{if(n&&h.length>0){const s=(n.items||[]).map(a=>{let r=null;return r=h.find(l=>l.name===a.itemName),r||(r=h.find(l=>l.name.includes(a.itemName)||a.itemName.includes(l.name))),!r&&a.itemId&&(r=h.find(l=>l.id===a.itemId)),{itemId:r?.id||null,itemName:a.itemName||"",quantity:parseFloat(a.quantity)||1,unitPrice:parseFloat(a.unitPrice)||0,specification:a.specification||"",notes:a.notes||"",unit:a.unit||"EA",majorCategory:a.majorCategory||"",middleCategory:a.middleCategory||"",minorCategory:a.minorCategory||""}});o({projectId:n.projectId?.toString()||"",vendorId:n.vendorId?.toString()||"",orderDate:n.orderDate?new Date(n.orderDate).toISOString().split("T")[0]:"",deliveryDate:n.deliveryDate?new Date(n.deliveryDate).toISOString().split("T")[0]:"",notes:n.notes||"",templateId:n.templateId?.toString()||"",items:s})}else n&&h.length===0&&o({projectId:n.projectId?.toString()||"",vendorId:n.vendorId?.toString()||"",orderDate:n.orderDate?new Date(n.orderDate).toISOString().split("T")[0]:"",deliveryDate:n.deliveryDate?new Date(n.deliveryDate).toISOString().split("T")[0]:"",notes:n.notes||"",templateId:n.templateId?.toString()||"",items:n.items||[]})},[n,h]);const $=le({mutationFn:async s=>await b("PATCH",`/api/orders/${d}`,s),onSuccess:()=>{S({title:"성공",description:"발주서가 수정되었습니다."}),G.invalidateQueries({queryKey:[`/api/orders/${d}`]}),G.invalidateQueries({queryKey:["/api/orders"]}),N(`/orders/${d}`)},onError:s=>{if(me(s)){S({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{N("/login")},500);return}S({title:"오류",description:"발주서 수정에 실패했습니다.",variant:"destructive"})}}),Q=s=>{if(s.preventDefault(),!i.vendorId||!i.orderDate||i.items.length===0){S({title:"오류",description:"모든 필수 필드를 입력해주세요.",variant:"destructive"});return}const a={projectId:i.projectId?parseInt(i.projectId):null,vendorId:parseInt(i.vendorId),orderDate:new Date(i.orderDate),deliveryDate:i.deliveryDate?new Date(i.deliveryDate):null,notes:i.notes,templateId:i.templateId?parseInt(i.templateId):null,items:i.items.map(r=>({itemId:r.itemId,itemName:r.itemName,quantity:Number(r.quantity),unitPrice:Number(r.unitPrice),specification:r.specification||"",notes:r.notes||"",unit:r.unit||"EA",majorCategory:r.majorCategory||"",middleCategory:r.middleCategory||"",minorCategory:r.minorCategory||""}))};$.mutate(a)},J=()=>{o(s=>({...s,items:[...s.items,{itemId:null,itemName:"",quantity:1,unitPrice:0,specification:"",notes:"",unit:"EA",majorCategory:"",middleCategory:"",minorCategory:""}]}))},Y=s=>{o(a=>({...a,items:a.items.filter((r,l)=>l!==s)}))},u=(s,a,r)=>{o(l=>({...l,items:l.items.map((x,q)=>q===s?{...x,[a]:r}:x)}))},_=(s,a)=>{const r=h.find(l=>l.id.toString()===a);r&&(u(s,"itemId",r.id),u(s,"itemName",r.name),u(s,"unitPrice",r.unitPrice||0),u(s,"specification",r.specification||""))},W=()=>{const s=C.filter(a=>a.categoryType==="major");return console.log("getMajorCategories result:",s),s},X=s=>{if(!s||s==="none")return[];const a=C.find(l=>l.categoryType==="major"&&l.categoryName===s);if(!a)return console.log(`Major category not found: ${s}`),[];const r=C.filter(l=>l.categoryType==="middle"&&l.parentId===a.id);return console.log(`Middle categories for ${s}:`,r),r},Z=s=>{if(!s||s==="none")return[];const a=C.find(l=>l.categoryType==="middle"&&l.categoryName===s);if(!a)return console.log(`Middle category not found: ${s}`),[];const r=C.filter(l=>l.categoryType==="minor"&&l.parentId===a.id);return console.log(`Minor categories for ${s}:`,r),r},E=(s,a,r)=>{console.log(`Category change: index=${s}, type=${a}, value=${r}`);const l={},x=r==="none"?"":r;console.log(`Actual value after conversion: ${x}`),a==="major"?(l.majorCategory=x,l.middleCategory="",l.minorCategory=""):a==="middle"?(l.middleCategory=x,l.minorCategory=""):a==="minor"&&(l.minorCategory=x),console.log("Updates to apply:",l),o(q=>{const M=q.items.map((k,ee)=>ee===s?{...k,...l}:k);return console.log(`Updated item ${s}:`,M[s]),{...q,items:M}})};return L?e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/4 mb-6"}),e.jsx("div",{className:"h-96 bg-gray-200 rounded"})]})}):w?e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"발주서 로드 중 오류가 발생했습니다"}),e.jsx("p",{className:"mb-4 text-red-600",children:w.message}),e.jsx(j,{onClick:()=>N("/orders"),children:"발주서 목록으로 돌아가기"})]})}):n?e.jsxs("div",{className:"max-w-[1366px] mx-auto p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(j,{variant:"ghost",size:"sm",onClick:()=>N(`/orders/${d}`),children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"돌아가기"]}),e.jsx(xe,{className:"h-6 w-6 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"발주서 수정"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"발주서 정보를 수정합니다"})]})]})})}),e.jsxs("form",{onSubmit:Q,children:[n&&e.jsx(P,{className:"mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsx(A,{className:"p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-blue-600",children:"발주서 번호"}),e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:n.orderNumber||"N/A"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-blue-600",children:"현재 상태"}),e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:n.status||"N/A"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-blue-600",children:"생성일시"}),e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:n.createdAt?new Date(n.createdAt).toLocaleString("ko-KR"):"N/A"})]})]})})}),e.jsxs(P,{className:"mb-6",children:[e.jsx(V,{children:e.jsx(K,{children:"기본 정보"})}),e.jsxs(A,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"project",children:"프로젝트"}),e.jsxs(g,{value:i.projectId,onValueChange:s=>o(a=>({...a,projectId:s})),children:[e.jsx(p,{children:e.jsx(v,{placeholder:"프로젝트를 선택하세요"})}),e.jsx(y,{children:R?.map(s=>e.jsx(t,{value:s.id.toString(),children:s.projectName},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"vendor",children:"거래처 *"}),e.jsxs(g,{value:i.vendorId,onValueChange:s=>o(a=>({...a,vendorId:s})),children:[e.jsx(p,{children:e.jsx(v,{placeholder:"거래처를 선택하세요"})}),e.jsx(y,{children:H?.map(s=>e.jsx(t,{value:s.id.toString(),children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"orderDate",children:"발주일자 *"}),e.jsx(f,{id:"orderDate",type:"date",value:i.orderDate,onChange:s=>o(a=>({...a,orderDate:s.target.value})),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"deliveryDate",children:"납품희망일"}),e.jsx(f,{id:"deliveryDate",type:"date",value:i.deliveryDate,onChange:s=>o(a=>({...a,deliveryDate:s.target.value}))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{htmlFor:"notes",children:"비고"}),e.jsx(ie,{id:"notes",placeholder:"추가 정보나 요청사항을 입력하세요",value:i.notes,onChange:s=>o(a=>({...a,notes:s.target.value})),rows:3})]})]})]}),e.jsxs(P,{className:"mb-6",children:[e.jsx(V,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(K,{children:"발주 품목"}),e.jsxs(j,{type:"button",onClick:J,children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"품목 추가"]})]})}),e.jsxs(A,{children:[i.items.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"발주할 품목을 추가해주세요"}):e.jsxs(de,{children:[e.jsx(oe,{children:e.jsxs(z,{children:[e.jsx(c,{children:"품목명 *"}),e.jsx(c,{children:"대분류"}),e.jsx(c,{children:"중분류"}),e.jsx(c,{children:"소분류"}),e.jsx(c,{children:"수량 *"}),e.jsx(c,{children:"단위"}),e.jsx(c,{children:"단가"}),e.jsx(c,{children:"규격"}),e.jsx(c,{children:"비고"}),e.jsx(c,{children:"총액"}),e.jsx(c,{className:"w-[100px]",children:"작업"})]})}),e.jsx(ce,{children:i.items.map((s,a)=>e.jsxs(z,{children:[e.jsx(m,{children:e.jsxs(g,{value:s.itemId?.toString()||"",onValueChange:r=>_(a,r),children:[e.jsx(p,{children:e.jsx(v,{placeholder:s.itemName||"품목 선택"})}),e.jsx(y,{children:h.map(r=>e.jsx(t,{value:r.id.toString(),children:r.name},r.id))})]})}),e.jsx(m,{children:e.jsxs(g,{value:s.majorCategory||"none",onValueChange:r=>{console.log(`Major category selected: ${r}`),E(a,"major",r)},children:[e.jsx(p,{className:"min-w-[120px]",children:e.jsx(v,{placeholder:"대분류 선택",children:s.majorCategory&&s.majorCategory!=="none"?s.majorCategory:"대분류 선택"})}),e.jsxs(y,{children:[e.jsx(t,{value:"none",children:"선택 해제"}),W().map(r=>e.jsx(t,{value:r.categoryName,children:r.categoryName},`major-${r.id}`))]})]})}),e.jsx(m,{children:e.jsxs(g,{value:s.middleCategory||"none",onValueChange:r=>{console.log(`Middle category selected: ${r}`),E(a,"middle",r)},disabled:!s.majorCategory||s.majorCategory==="none",children:[e.jsx(p,{className:"min-w-[120px]",children:e.jsx(v,{placeholder:s.majorCategory&&s.majorCategory!=="none"?"중분류 선택":"대분류 먼저 선택",children:s.middleCategory&&s.middleCategory!=="none"?s.middleCategory:s.majorCategory&&s.majorCategory!=="none"?"중분류 선택":"대분류 먼저 선택"})}),e.jsxs(y,{children:[e.jsx(t,{value:"none",children:"선택 해제"}),X(s.majorCategory||"").map(r=>e.jsx(t,{value:r.categoryName,children:r.categoryName},`middle-${r.id}`))]})]})}),e.jsx(m,{children:e.jsxs(g,{value:s.minorCategory||"none",onValueChange:r=>{console.log(`Minor category selected: ${r}`),E(a,"minor",r)},disabled:!s.middleCategory||s.middleCategory==="none",children:[e.jsx(p,{className:"min-w-[120px]",children:e.jsx(v,{placeholder:s.middleCategory&&s.middleCategory!=="none"?"소분류 선택":"중분류 먼저 선택",children:s.minorCategory&&s.minorCategory!=="none"?s.minorCategory:s.middleCategory&&s.middleCategory!=="none"?"소분류 선택":"중분류 먼저 선택"})}),e.jsxs(y,{children:[e.jsx(t,{value:"none",children:"선택 해제"}),Z(s.middleCategory||"").map(r=>e.jsx(t,{value:r.categoryName,children:r.categoryName},`minor-${r.id}`))]})]})}),e.jsx(m,{children:e.jsx(f,{type:"number",value:s.quantity,onChange:r=>{const l=r.target.value,x=l===""?0:Number(l);console.log(`Quantity changed: ${l} -> ${x}`),u(a,"quantity",x)},onBlur:r=>{Number(r.target.value)<1&&u(a,"quantity",1)},min:"0.01",step:"0.01",required:!0,className:"w-24"})}),e.jsx(m,{children:e.jsxs(g,{value:s.unit||"EA",onValueChange:r=>{console.log(`Unit selected: ${r}`),u(a,"unit",r)},children:[e.jsx(p,{className:"w-24",children:e.jsx(v,{placeholder:"단위 선택"})}),e.jsxs(y,{children:[e.jsx(t,{value:"EA",children:"EA"}),e.jsx(t,{value:"개",children:"개"}),e.jsx(t,{value:"박스",children:"박스"}),e.jsx(t,{value:"세트",children:"세트"}),e.jsx(t,{value:"kg",children:"kg"}),e.jsx(t,{value:"g",children:"g"}),e.jsx(t,{value:"L",children:"L"}),e.jsx(t,{value:"mL",children:"mL"}),e.jsx(t,{value:"m",children:"m"}),e.jsx(t,{value:"cm",children:"cm"}),e.jsx(t,{value:"mm",children:"mm"}),e.jsx(t,{value:"㎡",children:"㎡"}),e.jsx(t,{value:"㎥",children:"㎥"}),e.jsx(t,{value:"매",children:"매"}),e.jsx(t,{value:"장",children:"장"}),e.jsx(t,{value:"권",children:"권"}),e.jsx(t,{value:"부",children:"부"}),e.jsx(t,{value:"대",children:"대"}),e.jsx(t,{value:"식",children:"식"}),e.jsx(t,{value:"조",children:"조"}),e.jsx(t,{value:"타",children:"타"}),e.jsx(t,{value:"켤레",children:"켤레"}),e.jsx(t,{value:"통",children:"통"}),e.jsx(t,{value:"병",children:"병"}),e.jsx(t,{value:"캔",children:"캔"}),e.jsx(t,{value:"포",children:"포"}),e.jsx(t,{value:"봉",children:"봉"}),e.jsx(t,{value:"팩",children:"팩"}),e.jsx(t,{value:"롤",children:"롤"}),e.jsx(t,{value:"쌍",children:"쌍"}),e.jsx(t,{value:"톤",children:"톤"}),e.jsx(t,{value:"되",children:"되"}),e.jsx(t,{value:"말",children:"말"}),e.jsx(t,{value:"자루",children:"자루"}),e.jsx(t,{value:"마리",children:"마리"}),e.jsx(t,{value:"모",children:"모"}),e.jsx(t,{value:"평",children:"평"}),e.jsx(t,{value:"보루",children:"보루"}),e.jsx(t,{value:"묶음",children:"묶음"}),e.jsx(t,{value:"다스",children:"다스"}),e.jsx(t,{value:"갑",children:"갑"}),e.jsx(t,{value:"곽",children:"곽"}),e.jsx(t,{value:"판",children:"판"}),e.jsx(t,{value:"그루",children:"그루"}),e.jsx(t,{value:"주",children:"주"}),e.jsx(t,{value:"본",children:"본"}),e.jsx(t,{value:"줄",children:"줄"})]})]})}),e.jsx(m,{children:e.jsx(f,{type:"number",value:s.unitPrice,onChange:r=>u(a,"unitPrice",Number(r.target.value)),min:"0"})}),e.jsx(m,{children:e.jsx(f,{value:s.specification,onChange:r=>u(a,"specification",r.target.value),placeholder:"규격 입력"})}),e.jsx(m,{children:e.jsx(f,{value:s.notes,onChange:r=>u(a,"notes",r.target.value),placeholder:"비고 입력"})}),e.jsxs(m,{children:["₩",(Number(s.quantity)*Number(s.unitPrice)).toLocaleString("ko-KR")]}),e.jsx(m,{children:e.jsx(j,{type:"button",variant:"ghost",size:"sm",onClick:()=>Y(a),children:e.jsx(he,{className:"h-4 w-4 text-red-500"})})})]},a))})]}),i.items.length>0&&e.jsx("div",{className:"mt-6 space-y-4",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-blue-600 mb-1",children:"총 품목 수"}),e.jsxs("div",{className:"text-xl font-bold text-blue-700",children:[i.items.length,"개"]})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-green-600 mb-1",children:"총 수량"}),e.jsx("div",{className:"text-xl font-bold text-green-700",children:i.items.reduce((s,a)=>s+(Number(a.quantity)||0),0)})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-purple-600 mb-1",children:"대분류 수"}),e.jsxs("div",{className:"text-xl font-bold text-purple-700",children:[new Set(i.items.map(s=>s.majorCategory).filter(s=>s)).size,"개"]})]}),e.jsxs("div",{className:"bg-orange-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-orange-600 mb-1",children:"총 합계 금액"}),e.jsxs("div",{className:"text-xl font-bold text-orange-700",children:["₩",i.items.reduce((s,a)=>{const r=(Number(a.quantity)||0)*(Number(a.unitPrice)||0);return s+r},0).toLocaleString()]})]})]})})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(j,{type:"button",variant:"outline",onClick:()=>N(`/orders/${d}`),children:"취소"}),e.jsxs(j,{type:"submit",disabled:$.isPending,children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),$.isPending?"저장 중...":"저장"]})]})]})]}):e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"발주서를 찾을 수 없습니다"}),e.jsxs("p",{className:"mb-4 text-gray-600",children:["OrderID: ",d]}),e.jsx(j,{onClick:()=>N("/orders"),children:"발주서 목록으로 돌아가기"})]})})}export{Te as default};
