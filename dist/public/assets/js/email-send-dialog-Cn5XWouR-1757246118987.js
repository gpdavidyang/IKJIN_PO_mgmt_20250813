import{n as J,e as Q,r as c,k as Y,j as s,M as _,a8 as T,I as O,a9 as k,ah as o,y as b,B as f,o as L,ak as $,a7 as D,F as z}from"./index-JoMow1S--1757246118987.js";import{D as ee,a as se,b as te,c as ae,d as le,e as ie}from"./dialog-DXJFtIgk-1757246118987.js";import{T as re}from"./textarea-BECW8XhD-1757246118987.js";import{C as ce}from"./checkbox-cTpcpj96-1757246118987.js";import{T as ne}from"./triangle-alert-DjA3dngJ-1757246118987.js";import{S as oe}from"./send-Cmp-ym_D-1757246118987.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=J("File",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]]);function ge({open:g,onOpenChange:j,orderData:i,onSendEmail:M,attachments:h}){const{toast:P}=Q(),[l,n]=c.useState({to:i.vendorEmail?[i.vendorEmail]:[""],cc:[],subject:`발주서 전송 - ${i.orderNumber}`,message:"",selectedAttachmentIds:[]}),[p,y]=c.useState(!1),[w,x]=c.useState([]),[d,S]=c.useState(""),[m,C]=c.useState(""),[N,v]=c.useState([]),[W,E]=c.useState(!1);c.useEffect(()=>{g&&(h?(console.log("📎 Using provided attachments:",h.length),v(h.map(e=>({...e,isSelected:!1})))):i.orderId&&(console.log("📎 No provided attachments, fetching from API for order:",i.orderId),B()))},[g,i.orderId,h]);const B=async()=>{if(i.orderId){E(!0);try{console.log("📎 Fetching attachments for order:",i.orderId);const e=await Y("GET",`/api/orders/${i.orderId}/attachments`);if(Array.isArray(e)){const t=e.map(a=>({id:a.id,originalName:a.originalName,filePath:a.filePath,fileSize:a.fileSize,mimeType:a.mimeType,isSelected:!1}));v(t);const r=t.filter(a=>a.mimeType?.includes("pdf")||a.originalName?.toLowerCase().endsWith(".pdf")||a.mimeType?.includes("excel")||a.mimeType?.includes("spreadsheet")||a.originalName?.toLowerCase().endsWith(".xlsx")||a.originalName?.toLowerCase().endsWith(".xls")).map(a=>a.id);n(a=>({...a,selectedAttachmentIds:r})),console.log("📎 Loaded attachments:",{total:t.length,autoSelected:r.length})}else v([]),console.log("📎 No attachments found for order:",i.orderId)}catch(e){console.error("❌ Failed to fetch attachments:",e),P({title:"첨부파일 조회 실패",description:"첨부파일 정보를 불러오는데 실패했습니다.",variant:"destructive"})}finally{E(!1)}}},u=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),I=()=>{d&&u(d)?l.to.includes(d)||(n(e=>({...e,to:[...e.to.filter(t=>t!==""),d]})),S(""),x(e=>e.filter(t=>!t.includes("수신자")))):x(e=>[...e,"올바른 이메일 주소를 입력하세요."])},A=()=>{m&&u(m)&&(l.cc?.includes(m)||(n(e=>({...e,cc:[...e.cc||[],m]})),C("")))},F=(e,t)=>{n(r=>({...r,[t]:r[t]?.filter(a=>a!==e)||[]}))},R=e=>{n(t=>{const r=t.selectedAttachmentIds,G=r.includes(e)?r.filter(Z=>Z!==e):[...r,e];return{...t,selectedAttachmentIds:G}})},q=e=>{if(!e)return"";const t=e/(1024*1024);return t>1?`${t.toFixed(1)}MB`:`${Math.round(e/1024)}KB`},K=(e,t)=>e?.includes("pdf")||t?.toLowerCase().endsWith(".pdf")?s.jsx(z,{className:"h-4 w-4 text-red-500"}):e?.includes("excel")||e?.includes("spreadsheet")||t?.toLowerCase().endsWith(".xlsx")||t?.toLowerCase().endsWith(".xls")?s.jsx(X,{className:"h-4 w-4 text-green-600"}):s.jsx(X,{className:"h-4 w-4 text-gray-500"}),H=()=>{const e=[];return(!l.to.length||l.to.every(a=>!a.trim()))&&e.push("최소 하나의 수신자 이메일을 입력하세요."),l.to.filter(a=>a&&!u(a)).length>0&&e.push("수신자 이메일 주소가 올바르지 않습니다."),(l.cc?.filter(a=>a&&!u(a))||[]).length>0&&e.push("참조 이메일 주소가 올바르지 않습니다."),l.subject.trim()||e.push("제목을 입력하세요."),x(e),e.length===0},U=async()=>{if(H()){y(!0);try{console.log("📧 Sending email with data:",{to:l.to,cc:l.cc,subject:l.subject,message:l.message,selectedAttachmentIds:l.selectedAttachmentIds}),await M(l),j(!1)}catch{x(["이메일 발송 중 오류가 발생했습니다."])}finally{y(!1)}}},V=`안녕하세요.

${i.vendorName} 담당자님께 발주서를 전송드립니다.

■ 발주 정보
- 발주번호: ${i.orderNumber}
- 발주일자: ${i.orderDate}
- 현장명: ${i.siteName||"N/A"}
- 발주금액: ${i.totalAmount.toLocaleString()}원

첨부된 발주서를 확인하시고, 납기일정에 맞춰 진행 부탁드립니다.

감사합니다.`;return s.jsx(ee,{open:g,onOpenChange:j,children:s.jsxs(se,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[s.jsxs(te,{children:[s.jsxs(ae,{className:"flex items-center gap-2",children:[s.jsx(_,{className:"h-5 w-5"}),"발주서 이메일 발송"]}),s.jsxs(le,{children:[i.vendorName,"에게 발주서 ",i.orderNumber,"를 이메일로 전송합니다."]})]}),s.jsxs(T,{className:"border-blue-200 bg-blue-50",children:[s.jsx(O,{className:"h-4 w-4 text-blue-600"}),s.jsxs(k,{className:"text-blue-800",children:[s.jsx("strong",{children:"📧 안내:"})," 발주생성이 되었더라도 발주 이메일 전송 버튼이 클릭되어야 '발주완료' 상태로 변경됩니다."]})]}),s.jsxs("div",{className:"space-y-4",children:[w.length>0&&s.jsxs(T,{variant:"destructive",children:[s.jsx(ne,{className:"h-4 w-4"}),s.jsx(k,{children:s.jsx("ul",{className:"list-disc list-inside",children:w.map((e,t)=>s.jsx("li",{children:e},t))})})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{htmlFor:"to-email",children:"수신자 *"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(b,{id:"to-email",type:"email",placeholder:"example@company.com",value:d,onChange:e=>S(e.target.value),onKeyPress:e=>e.key==="Enter"&&I()}),s.jsx(f,{type:"button",onClick:I,variant:"outline",size:"sm",children:"추가"})]}),s.jsx("div",{className:"flex flex-wrap gap-2",children:l.to.filter(e=>e.trim()).map((e,t)=>s.jsxs(L,{variant:"secondary",className:"flex items-center gap-1",children:[e,s.jsx($,{className:"h-3 w-3 cursor-pointer hover:text-red-500",onClick:()=>F(e,"to")})]},t))})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{htmlFor:"cc-email",children:"참조 (선택)"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(b,{id:"cc-email",type:"email",placeholder:"cc@company.com",value:m,onChange:e=>C(e.target.value),onKeyPress:e=>e.key==="Enter"&&A()}),s.jsx(f,{type:"button",onClick:A,variant:"outline",size:"sm",children:"추가"})]}),s.jsx("div",{className:"flex flex-wrap gap-2",children:l.cc?.map((e,t)=>s.jsxs(L,{variant:"outline",className:"flex items-center gap-1",children:[e,s.jsx($,{className:"h-3 w-3 cursor-pointer hover:text-red-500",onClick:()=>F(e,"cc")})]},t))})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{htmlFor:"subject",children:"제목 *"}),s.jsx(b,{id:"subject",value:l.subject,onChange:e=>n(t=>({...t,subject:e.target.value})),placeholder:"발주서 전송 - PO-XXXX-XXX"})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsx(o,{className:"text-base font-medium",children:"첨부파일"}),W?s.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[s.jsx(D,{className:"h-4 w-4 animate-spin"}),"첨부파일 정보를 불러오는 중..."]}):N.length===0?s.jsxs("div",{className:"text-sm text-muted-foreground p-4 border border-dashed rounded-lg text-center",children:[s.jsx(z,{className:"h-8 w-8 mx-auto mb-2 text-gray-400"}),"이 발주서에 첨부된 파일이 없습니다."]}):s.jsxs("div",{className:"space-y-2 max-h-64 overflow-y-auto border rounded-lg p-3",children:[s.jsxs("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:["총 ",N.length,"개의 파일이 첨부되어 있습니다"]}),N.map(e=>{const t=l.selectedAttachmentIds.includes(e.id);return s.jsxs("div",{className:`flex items-center space-x-3 p-2 rounded-md hover:bg-gray-50 transition-colors ${t?"bg-blue-50 border border-blue-200":"border border-gray-200"}`,children:[s.jsx(ce,{id:`attach-${e.id}`,checked:t,onCheckedChange:()=>R(e.id)}),s.jsxs("div",{className:"flex items-center space-x-2 flex-1 min-w-0",children:[K(e.mimeType,e.originalName),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx(o,{htmlFor:`attach-${e.id}`,className:"text-sm font-medium cursor-pointer block truncate",title:e.originalName,children:e.originalName}),e.fileSize&&s.jsxs("div",{className:"text-xs text-muted-foreground",children:[q(e.fileSize),e.mimeType&&s.jsxs("span",{className:"ml-2",children:["• ",e.mimeType.split("/")[1]?.toUpperCase()]})]})]})]})]},e.id)}),l.selectedAttachmentIds.length>0&&s.jsx("div",{className:"pt-2 border-t border-gray-200",children:s.jsxs("div",{className:"text-xs text-blue-600 font-medium",children:["✓ ",l.selectedAttachmentIds.length,"개 파일이 선택되었습니다"]})})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{htmlFor:"message",children:"메시지 (선택)"}),s.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"이 메시지는 이메일 본문에 포함되어 수신자에게 전달됩니다."}),s.jsx(re,{id:"message",value:l.message||V,onChange:e=>n(t=>({...t,message:e.target.value})),placeholder:"추가 메시지를 입력하세요...",rows:8,className:"resize-none"})]})]}),s.jsxs(ie,{children:[s.jsx(f,{variant:"outline",onClick:()=>j(!1),disabled:p,children:"취소"}),s.jsx(f,{onClick:U,disabled:p,children:p?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"발송 중..."]}):s.jsxs(s.Fragment,{children:[s.jsx(oe,{className:"h-4 w-4 mr-2"}),"이메일 발송"]})})]})]})})}export{ge as E};
