import{a as M,c as z,b as B,r as f,k as p,j as e,n as R,F as T,o as k,x as J,q as S,L as j,I as y,m as b,P as U,af as _}from"./index-CKOkJa8a.js";import{T as G}from"./textarea-C8421qec.js";import{S as m,a as x,b as h,c as g,d as u}from"./select-DmFFwEDq.js";import{C as H}from"./checkbox-CLetaLPZ.js";import{g as W}from"./order-utils-C4eLdozv.js";import{A as X}from"./arrow-left-BWU8ue7L.js";import{C as Y}from"./calendar-BSZTCtl4.js";import{P as Z}from"./package-DVdn3byl.js";import{T as ee}from"./trash-2-CvqwPzWA.js";import{S as te}from"./save-Cr1utZ58.js";import"./index-CAd-gX2w.js";import"./chevron-down-DecYLFH6.js";import"./chevron-up-BJNKxpa8.js";function ue(){const{toast:d}=M();z();const[,v]=B(),[C,P]=f.useState(!1),[I]=f.useState(W()),[i,n]=f.useState({site:"",deliveryDate:"",isNegotiable:!1,receiver:"",manager:"",notes:"",items:[{name:"",category:"",majorCategory:"",middleCategory:"",minorCategory:"",quantity:0,unit:"",unitPrice:0,totalPrice:0,specs:"",remarks:""}]}),Q=()=>i.items.reduce((t,a)=>t+(a.totalPrice||0),0),{data:A=[]}=p({queryKey:["/api/projects"],select:t=>t?.filter(a=>a.isActive)||[]}),{data:L}=p({queryKey:["/api/auth/user"]}),{data:D=[]}=p({queryKey:["/api/users"],select:t=>t?.filter(a=>a.isActive)||[]}),{data:N=[]}=p({queryKey:["/api/item-categories/major"],queryFn:()=>fetch("/api/item-categories/major").then(t=>t.json())}),[o,q]=f.useState({middleQueries:{},minorQueries:{}}),V=async t=>{if(o.middleQueries[t])return o.middleQueries[t];try{const s=await(await fetch(`/api/item-categories/middle?majorId=${t}`)).json();return q(r=>({...r,middleQueries:{...r.middleQueries,[t]:s}})),s}catch(a){return console.error("Error fetching middle categories:",a),[]}},$=async t=>{if(o.minorQueries[t])return o.minorQueries[t];try{const s=await(await fetch(`/api/item-categories/minor?middleId=${t}`)).json();return q(r=>({...r,minorQueries:{...r.minorQueries,[t]:s}})),s}catch(a){return console.error("Error fetching minor categories:",a),[]}},F=t=>{if(!t.majorCategory)return[];const a=N.find(s=>s.categoryName===t.majorCategory);return a?o.middleQueries[a.id]||[]:[]},E=t=>{if(!t.middleCategory||!t.majorCategory)return[];const a=N.find(l=>l.categoryName===t.majorCategory);if(!a)return[];const r=(o.middleQueries[a.id]||[]).find(l=>l.categoryName===t.middleCategory);return r?o.minorQueries[r.id]||[]:[]};p({queryKey:["/api/vendors"],select:t=>t?.filter(a=>a.isActive)||[]});const K=async t=>{if(t.preventDefault(),!i.site){d({title:"필수 정보 누락",description:"현장을 선택해주세요.",variant:"destructive"});return}if(!i.receiver){d({title:"필수 정보 누락",description:"자재 인수자를 선택해주세요.",variant:"destructive"});return}const a=i.items.filter(s=>s.name.trim());if(a.length===0){d({title:"필수 정보 누락",description:"최소 하나의 품목을 입력해주세요.",variant:"destructive"});return}try{P(!0);const s={orderNumber:I,projectId:parseInt(i.site),userId:L?.id,orderDate:new Date,deliveryDate:i.deliveryDate?new Date(i.deliveryDate):void 0,totalAmount:Q(),notes:i.notes||void 0,status:"pending",items:a.map(c=>({itemName:c.name,quantity:c.quantity||0,unitPrice:c.unitPrice||0,totalAmount:c.totalPrice||0,specification:c.specs||void 0,notes:c.remarks||void 0}))},r=await fetch("/api/orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!r.ok)throw new Error("Failed to create order");const l=await r.json();d({title:"발주서 생성 완료",description:"발주서가 성공적으로 생성되었습니다."}),l?.id&&v(`/orders/${l.id}`)}catch(s){console.error("Order creation error:",s),d({title:"저장 실패",description:"발주서 저장 중 오류가 발생했습니다.",variant:"destructive"})}finally{P(!1)}},O=()=>{if(i.items.length>=10){d({title:"품목 추가 제한",description:"최대 10개까지 추가 가능합니다.",variant:"destructive"});return}n(t=>({...t,items:[...t.items,{name:"",category:"",majorCategory:"",middleCategory:"",minorCategory:"",quantity:0,unit:"",unitPrice:0,totalPrice:0,specs:"",remarks:""}]}))};return e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-[1366px] mx-auto p-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("button",{onClick:()=>v("/orders"),className:"inline-flex items-center text-sm text-gray-600 hover:text-gray-900 mb-4",children:[e.jsx(X,{className:"h-4 w-4 mr-1"}),"발주서 목록으로"]}),e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"표준 발주서 작성"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"새로운 발주서를 작성하고 관리하세요"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(R,{variant:"outline",className:"text-sm px-3 py-1",children:[e.jsx(T,{className:"h-4 w-4 mr-1"}),I]})})]})]}),e.jsxs("form",{onSubmit:K,className:"space-y-6",children:[e.jsxs(k,{className:"shadow-sm bg-white",children:[e.jsx("div",{className:"p-6 border-b border-blue-200 bg-blue-50/30",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-5 w-5 text-gray-600"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"발주 정보"})]})}),e.jsx(S,{className:"p-6 bg-white",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs(j,{htmlFor:"site",className:"text-sm font-medium text-gray-700 mb-2 block",children:["현장 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs(m,{value:i.site,onValueChange:t=>n(a=>({...a,site:t})),children:[e.jsx(x,{id:"site",className:"h-11",children:e.jsx(h,{placeholder:"현장을 선택하세요"})}),e.jsx(g,{children:A.map(t=>e.jsx(u,{value:t.id.toString(),children:t.projectName},t.id))})]})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"deliveryDate",className:"text-sm font-medium text-gray-700 mb-2 block",children:"납기일"}),e.jsxs("div",{className:"relative",children:[e.jsx(Y,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-5 w-5 pointer-events-none"}),e.jsx(y,{id:"deliveryDate",type:"date",value:i.deliveryDate,onChange:t=>n(a=>({...a,deliveryDate:t.target.value})),className:"pl-10 h-11"})]}),e.jsx("div",{className:"mt-2",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(H,{checked:i.isNegotiable,onCheckedChange:t=>n(a=>({...a,isNegotiable:t}))}),"협의 가능"]})})]}),e.jsxs("div",{children:[e.jsxs(j,{htmlFor:"receiver",className:"text-sm font-medium text-gray-700 mb-2 block",children:["자재 인수자 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs(m,{value:i.receiver,onValueChange:t=>n(a=>({...a,receiver:t})),children:[e.jsx(x,{id:"receiver",className:"h-11",children:e.jsx(h,{placeholder:"인수자를 선택하세요"})}),e.jsx(g,{children:D.map(t=>e.jsx(u,{value:t.id,children:t.firstName&&t.lastName?`${t.lastName}${t.firstName}`:t.email},t.id))})]})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"manager",className:"text-sm font-medium text-gray-700 mb-2 block",children:"현장 책임자"}),e.jsxs(m,{value:i.manager,onValueChange:t=>n(a=>({...a,manager:t})),children:[e.jsx(x,{id:"manager",className:"h-11",children:e.jsx(h,{placeholder:"책임자를 선택하세요"})}),e.jsx(g,{children:D.map(t=>e.jsx(u,{value:t.id,children:t.firstName&&t.lastName?`${t.lastName}${t.firstName}`:t.email},t.id))})]})]})]})})]}),e.jsxs(k,{className:"shadow-sm bg-white",children:[e.jsx("div",{className:"p-6 border-b border-blue-200 bg-blue-50/30",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5 text-gray-600"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"품목 정보"}),e.jsxs("span",{className:"text-sm text-gray-500",children:[i.items.filter(t=>t.name).length," / 10 품목"]})]}),e.jsxs(b,{type:"button",variant:"outline",size:"sm",onClick:O,disabled:i.items.length>=10,className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4"}),"품목 추가"]})]})}),e.jsx(S,{className:"p-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-blue-50 border-b border-blue-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"품목명"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"대분류"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"중분류"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"소분류"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:"수량"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:"단위"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"단가"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"금액"}),e.jsx("th",{className:"px-4 py-3"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:i.items.map((t,a)=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx(y,{value:t.name,onChange:s=>{const r=[...i.items];r[a]={...t,name:s.target.value},n(l=>({...l,items:r}))},placeholder:"품목명",className:"h-9 border-gray-200"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs(m,{value:t.majorCategory,onValueChange:async s=>{const r=N.find(c=>c.categoryName===s),l=[...i.items];l[a]={...t,majorCategory:s,middleCategory:"",minorCategory:""},n(c=>({...c,items:l})),r&&await V(r.id)},children:[e.jsx(x,{className:"h-9 border-gray-200",children:e.jsx(h,{placeholder:"대분류"})}),e.jsx(g,{children:N.map(s=>e.jsx(u,{value:s.categoryName,children:s.categoryName},s.id))})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs(m,{value:t.middleCategory,onValueChange:async s=>{const l=F(t).find(w=>w.categoryName===s),c=[...i.items];c[a]={...t,middleCategory:s,minorCategory:""},n(w=>({...w,items:c})),l&&await $(l.id)},disabled:!t.majorCategory,children:[e.jsx(x,{className:"h-9 border-gray-200",children:e.jsx(h,{placeholder:t.majorCategory?"중분류":"대분류 먼저"})}),e.jsx(g,{children:F(t).map(s=>e.jsx(u,{value:s.categoryName,children:s.categoryName},s.id))})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs(m,{value:t.minorCategory,onValueChange:s=>{const r=[...i.items];r[a]={...t,minorCategory:s},n(l=>({...l,items:r}))},disabled:!t.middleCategory,children:[e.jsx(x,{className:"h-9 border-gray-200",children:e.jsx(h,{placeholder:t.middleCategory?"소분류":"중분류 먼저"})}),e.jsx(g,{children:E(t).map(s=>e.jsx(u,{value:s.categoryName,children:s.categoryName},s.id))})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx(y,{type:"number",value:t.quantity||"",onChange:s=>{const r=[...i.items];r[a]={...t,quantity:parseInt(s.target.value)||0,totalPrice:(parseInt(s.target.value)||0)*(t.unitPrice||0)},n(l=>({...l,items:r}))},placeholder:"0",className:"h-9 text-center w-20 border-gray-200"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx(y,{value:t.unit||"",onChange:s=>{const r=[...i.items];r[a]={...t,unit:s.target.value},n(l=>({...l,items:r}))},placeholder:"개",className:"h-9 text-center w-16 border-gray-200"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx(y,{type:"number",value:t.unitPrice||"",onChange:s=>{const r=[...i.items];r[a]={...t,unitPrice:parseInt(s.target.value)||0,totalPrice:(t.quantity||0)*(parseInt(s.target.value)||0)},n(l=>({...l,items:r}))},placeholder:"0",className:"h-9 text-right border-gray-200"})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs("span",{className:"font-semibold text-blue-600",children:[(t.totalPrice||0).toLocaleString(),"원"]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx(b,{type:"button",variant:"ghost",size:"icon",onClick:()=>{const s=i.items.filter((r,l)=>l!==a);n(r=>({...r,items:s}))},className:"h-8 w-8 text-gray-400 hover:text-red-600",children:e.jsx(ee,{className:"h-4 w-4"})})})]},a))}),e.jsx("tfoot",{className:"bg-blue-50",children:e.jsxs("tr",{children:[e.jsx("td",{colSpan:7,className:"px-4 py-4 text-right text-sm font-medium text-gray-900",children:"총 발주금액"}),e.jsx("td",{className:"px-4 py-4 text-right",children:e.jsxs("span",{className:"text-lg font-bold text-blue-600",children:[Q().toLocaleString(),"원"]})}),e.jsx("td",{})]})})]})})})]}),e.jsxs(k,{className:"shadow-sm bg-white",children:[e.jsx("div",{className:"p-6 border-b border-blue-200 bg-blue-50/30",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-5 w-5 text-gray-600"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"추가 정보"})]})}),e.jsx(S,{className:"p-6 bg-white",children:e.jsxs("div",{children:[e.jsx(j,{htmlFor:"notes",className:"text-sm font-medium text-gray-700 mb-2 block",children:"비고사항"}),e.jsx(G,{id:"notes",value:i.notes,onChange:t=>n(a=>({...a,notes:t.target.value})),placeholder:"추가 요청사항이나 특이사항을 입력하세요...",className:"min-h-[100px] resize-none"})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(b,{type:"button",variant:"outline",onClick:()=>v("/orders"),disabled:C,children:"취소"}),e.jsx(b,{type:"submit",disabled:C,className:"bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-2",children:C?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"h-4 w-4 animate-spin"}),"저장 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"h-4 w-4"}),"발주서 저장"]})})]})]})]})})}export{ue as default};
