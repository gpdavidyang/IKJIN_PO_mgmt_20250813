import{n as de,e as me,r as o,k as xe,j as s,M as he,ad as _,I as ue,ae as Q,O as x,y as F,B as h,o as j,X as Z,ac as ge,F as J,T as pe,Q as fe}from"./index-Cq_ZAPR7-1757341513746.js";import{D as je,a as Ne,b as ve,c as be,d as ye,e as we}from"./dialog-COOX7BSF-1757341513746.js";import{T as Ee}from"./textarea-BDgSBidU-1757341513746.js";import{C as Y}from"./checkbox-B6B_4npa-1757341513746.js";import{T as Ce}from"./triangle-alert-CcjknMPN-1757341513746.js";import{P as Ae}from"./paperclip-bqosqdZV-1757341513746.js";import{U as $}from"./upload-DkVK7XNf-1757341513746.js";import{S as Ie}from"./send-TtLJfoAS-1757341513746.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const E=de("File",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]]);function Ue({open:C,onOpenChange:A,orderData:c,onSendEmail:ee,attachments:N}){const{toast:v}=me(),b=o.useRef(null),se=`안녕하세요.

${c.vendorName} 담당자님께 발주서를 전송드립니다.

■ 발주 정보
- 발주번호: ${c.orderNumber}
- 발주일자: ${c.orderDate}
- 현장명: ${c.siteName||"N/A"}
- 발주금액: ${c.totalAmount.toLocaleString()}원

첨부된 발주서를 확인하시고, 납기일정에 맞춰 진행 부탁드립니다.

감사합니다.`,[i,d]=o.useState({to:c.vendorEmail?[c.vendorEmail]:[""],cc:[],subject:`발주서 전송 - ${c.orderNumber}`,message:se,selectedAttachmentIds:[],customFiles:[]}),[I,k]=o.useState(!1),[L,u]=o.useState([]),[g,D]=o.useState(""),[p,z]=o.useState(""),[y,S]=o.useState([]),[te,U]=o.useState(!1),[m,M]=o.useState([]),[f,T]=o.useState(!1);o.useEffect(()=>{C&&(N?(console.log("📎 Using provided attachments:",N.length),S(N.map(e=>({...e,isSelected:!1})))):c.orderId&&(console.log("📎 No provided attachments, fetching from API for order:",c.orderId),le()))},[C,c.orderId,N]);const le=async()=>{if(c.orderId){U(!0);try{console.log("📎 Fetching attachments for order:",c.orderId);const e=await xe("GET",`/api/orders/${c.orderId}/attachments`);if(Array.isArray(e)){const t=e.map(a=>({id:a.id,originalName:a.originalName,filePath:a.filePath,fileSize:a.fileSize,mimeType:a.mimeType,isSelected:!1}));S(t);const l=t.filter(a=>a.mimeType?.includes("pdf")||a.originalName?.toLowerCase().endsWith(".pdf")||a.mimeType?.includes("excel")||a.mimeType?.includes("spreadsheet")||a.originalName?.toLowerCase().endsWith(".xlsx")||a.originalName?.toLowerCase().endsWith(".xls")).map(a=>a.id);d(a=>({...a,selectedAttachmentIds:l})),console.log("📎 Loaded attachments:",{total:t.length,autoSelected:l.length})}else S([]),console.log("📎 No attachments found for order:",c.orderId)}catch(e){console.error("❌ Failed to fetch attachments:",e),v({title:"첨부파일 조회 실패",description:"첨부파일 정보를 불러오는데 실패했습니다.",variant:"destructive"})}finally{U(!1)}}},w=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),P=()=>{g&&w(g)?i.to.includes(g)||(d(e=>({...e,to:[...e.to.filter(t=>t!==""),g]})),D(""),u(e=>e.filter(t=>!t.includes("수신자")))):u(e=>[...e,"올바른 이메일 주소를 입력하세요."])},R=()=>{p&&w(p)&&(i.cc?.includes(p)||(d(e=>({...e,cc:[...e.cc||[],p]})),z("")))},W=(e,t)=>{d(l=>({...l,[t]:l[t]?.filter(a=>a!==e)||[]}))},B=e=>{d(t=>{const l=t.selectedAttachmentIds,r=l.includes(e)?l.filter(n=>n!==e):[...l,e];return{...t,selectedAttachmentIds:r}})},O=e=>{if(!e)return"";const t=e/(1024*1024);return t>1?`${t.toFixed(1)}MB`:`${Math.round(e/1024)}KB`},X=(e,t)=>e?.includes("pdf")||t?.toLowerCase().endsWith(".pdf")?s.jsx(J,{className:"h-4 w-4 text-red-500"}):e?.includes("excel")||e?.includes("spreadsheet")||t?.toLowerCase().endsWith(".xlsx")||t?.toLowerCase().endsWith(".xls")?s.jsx(E,{className:"h-4 w-4 text-green-600"}):e?.includes("image")?s.jsx(E,{className:"h-4 w-4 text-purple-500"}):e?.includes("word")||t?.toLowerCase().endsWith(".docx")||t?.toLowerCase().endsWith(".doc")?s.jsx(E,{className:"h-4 w-4 text-blue-500"}):s.jsx(E,{className:"h-4 w-4 text-gray-500"}),G=e=>{const t=[],l=[],r=[];Array.from(e).forEach(n=>{if(n.size>10485760){r.push(`${n.name}: 파일 크기가 10MB를 초과합니다.`);return}if(m.some(oe=>oe.originalName===n.name)){r.push(`${n.name}: 이미 추가된 파일입니다.`);return}const ne=-Date.now()-Math.random();t.push({id:ne,originalName:n.name,filePath:"",fileSize:n.size,mimeType:n.type,isSelected:!0,isCustom:!0,file:n}),l.push(n)}),r.length>0&&v({title:"파일 업로드 경고",description:r.join(`
`),variant:"destructive"}),t.length>0&&(M(n=>[...n,...t]),d(n=>({...n,customFiles:[...n.customFiles||[],...l],selectedAttachmentIds:[...n.selectedAttachmentIds,...t.map(V=>V.id)]})),v({title:"파일 추가 완료",description:`${t.length}개의 파일이 추가되었습니다.`}))},ae=e=>{const t=e.target.files;!t||t.length===0||(G(t),b.current&&(b.current.value=""))},K=e=>{e.preventDefault(),e.stopPropagation(),T(!0)},q=e=>{e.preventDefault(),e.stopPropagation(),T(!1)},H=e=>{e.preventDefault(),e.stopPropagation(),T(!1);const t=e.dataTransfer.files;t&&t.length>0&&G(t)},ie=e=>{M(t=>t.filter(l=>l.id!==e)),d(t=>({...t,customFiles:t.customFiles?.filter((l,a)=>m[a]?.id!==e),selectedAttachmentIds:t.selectedAttachmentIds.filter(l=>l!==e)}))},re=()=>{const e=[];return(!i.to.length||i.to.every(a=>!a.trim()))&&e.push("최소 하나의 수신자 이메일을 입력하세요."),i.to.filter(a=>a&&!w(a)).length>0&&e.push("수신자 이메일 주소가 올바르지 않습니다."),(i.cc?.filter(a=>a&&!w(a))||[]).length>0&&e.push("참조 이메일 주소가 올바르지 않습니다."),i.subject.trim()||e.push("제목을 입력하세요."),u(e),e.length===0},ce=async()=>{if(re()){k(!0),u([]);try{console.log("📧 [UI DEBUG] 이메일 발송 시작:"),console.log("  ├─ to:",i.to),console.log("  ├─ cc:",i.cc),console.log("  ├─ subject:",i.subject),console.log("  ├─ message 길이:",i.message?.length||0),console.log("  ├─ selectedAttachmentIds:",i.selectedAttachmentIds),console.log("  ├─ selectedAttachmentIds 길이:",i.selectedAttachmentIds?.length||0),console.log("  ├─ customFiles 개수:",i.customFiles?.length||0),console.log("📎 [UI DEBUG] 선택된 첨부파일 분석:"),i.selectedAttachmentIds&&i.selectedAttachmentIds.length>0?i.selectedAttachmentIds.forEach((e,t)=>{const l=y.find(r=>r.id===e),a=m.find(r=>r.id===e);if(l){const r=l.mimeType?.includes("excel")||l.mimeType?.includes("spreadsheet")||l.originalName?.toLowerCase().endsWith(".xlsx")||l.originalName?.toLowerCase().endsWith(".xls");console.log(`  ├─ [${t}] 서버파일: ${l.originalName} (ID: ${e}, Excel: ${r})`)}else if(a){const r=a.mimeType?.includes("excel")||a.mimeType?.includes("spreadsheet")||a.originalName?.toLowerCase().endsWith(".xlsx")||a.originalName?.toLowerCase().endsWith(".xls");console.log(`  ├─ [${t}] 커스텀파일: ${a.originalName} (ID: ${e}, Excel: ${r})`)}else console.warn(`  ├─ [${t}] ⚠️ 첨부파일 ID ${e}를 찾을 수 없음!`)}):console.warn("  └─ ⚠️ 선택된 첨부파일이 없음!"),console.log("📧 [UI DEBUG] 기존 로그와 함께 전송:",{to:i.to,cc:i.cc,subject:i.subject,message:i.message,selectedAttachmentIds:i.selectedAttachmentIds}),await ee(i),A(!1)}catch(e){console.error("❌ Email sending error:",e);let t="이메일 발송 중 오류가 발생했습니다.",l=[];if(e?.response?.data){const r=e.response.data;if(r.message&&(t=r.message),r.errors&&Array.isArray(r.errors)?l=r.errors:r.details&&(l=[r.details]),r.code)switch(r.code){case"EAUTH":l.push("이메일 계정 인증에 실패했습니다. 관리자에게 문의하세요.");break;case"ECONNECTION":case"ETIMEDOUT":l.push("이메일 서버에 연결할 수 없습니다. 네트워크 상태를 확인하세요.");break;case"EMESSAGE":l.push("이메일 내용에 오류가 있습니다. 입력 내용을 확인하세요.");break;case"EENVELOPE":l.push("수신자 또는 발신자 이메일 주소에 오류가 있습니다.");break;default:r.code&&l.push(`이메일 서버 오류: ${r.code}`)}(t.includes("attachment")||t.includes("첨부"))&&l.push("첨부파일 처리 중 문제가 발생했습니다. 파일 크기나 형식을 확인하세요."),t.includes("invalid")&&t.includes("email")&&l.push("유효하지 않은 이메일 주소가 포함되어 있습니다.")}else e?.message&&(t=e.message);(e?.code==="NETWORK_ERROR"||e?.name==="NetworkError")&&(t="네트워크 연결에 문제가 있습니다.",l.push("인터넷 연결을 확인하고 다시 시도하세요.")),(e?.code==="TIMEOUT_ERROR"||e?.message?.includes("timeout"))&&(t="이메일 발송 시간이 초과되었습니다.",l.push("서버가 응답하지 않습니다. 잠시 후 다시 시도하세요."));const a=[t,...l].filter(Boolean);u(a),v({title:"이메일 발송 실패",description:l.length>0?l[0]:t,variant:"destructive"})}finally{k(!1)}}};return s.jsx(je,{open:C,onOpenChange:A,children:s.jsxs(Ne,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[s.jsxs(ve,{children:[s.jsxs(be,{className:"flex items-center gap-2",children:[s.jsx(he,{className:"h-5 w-5"}),"발주서 이메일 발송"]}),s.jsxs(ye,{children:[c.vendorName,"에게 발주서 ",c.orderNumber,"를 이메일로 전송합니다."]})]}),s.jsxs(_,{className:"border-blue-200 bg-blue-50",children:[s.jsx(ue,{className:"h-4 w-4 text-blue-600"}),s.jsxs(Q,{className:"text-blue-800",children:[s.jsx("strong",{children:"📧 안내:"})," 발주생성이 되었더라도 발주 이메일 전송 버튼이 클릭되어야 '발주완료' 상태로 변경됩니다."]})]}),s.jsxs("div",{className:"space-y-4",children:[L.length>0&&s.jsxs(_,{variant:"destructive",className:"border-red-200 bg-red-50",children:[s.jsx(Ce,{className:"h-4 w-4 text-red-600"}),s.jsx(Q,{className:"text-red-800",children:s.jsxs("div",{className:"space-y-1",children:[s.jsx("div",{className:"font-semibold text-sm",children:"⚠️ 이메일 발송 실패"}),s.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm",children:L.map((e,t)=>s.jsx("li",{className:"break-words",children:e},t))}),s.jsx("div",{className:"text-xs text-red-600 mt-2 pt-1 border-t border-red-200",children:"💡 문제가 지속되면 관리자에게 문의하세요."})]})})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(x,{htmlFor:"to-email",children:"수신자 *"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(F,{id:"to-email",type:"email",placeholder:"example@company.com",value:g,onChange:e=>D(e.target.value),onKeyPress:e=>e.key==="Enter"&&P()}),s.jsx(h,{type:"button",onClick:P,variant:"outline",size:"sm",children:"추가"})]}),s.jsx("div",{className:"flex flex-wrap gap-2",children:i.to.filter(e=>e.trim()).map((e,t)=>s.jsxs(j,{variant:"secondary",className:"flex items-center gap-1",children:[e,s.jsx(Z,{className:"h-3 w-3 cursor-pointer hover:text-red-500",onClick:()=>W(e,"to")})]},t))})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(x,{htmlFor:"cc-email",children:"참조 (선택)"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(F,{id:"cc-email",type:"email",placeholder:"cc@company.com",value:p,onChange:e=>z(e.target.value),onKeyPress:e=>e.key==="Enter"&&R()}),s.jsx(h,{type:"button",onClick:R,variant:"outline",size:"sm",children:"추가"})]}),s.jsx("div",{className:"flex flex-wrap gap-2",children:i.cc?.map((e,t)=>s.jsxs(j,{variant:"outline",className:"flex items-center gap-1",children:[e,s.jsx(Z,{className:"h-3 w-3 cursor-pointer hover:text-red-500",onClick:()=>W(e,"cc")})]},t))})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(x,{htmlFor:"subject",children:"제목 *"}),s.jsx(F,{id:"subject",value:i.subject,onChange:e=>d(t=>({...t,subject:e.target.value})),placeholder:"발주서 전송 - PO-XXXX-XXX"})]}),s.jsxs("div",{className:"space-y-3",children:[s.jsx(x,{className:"text-base font-medium",children:"첨부파일"}),s.jsxs("div",{className:"border rounded-lg",children:[s.jsx("div",{className:"border-b p-3 bg-gray-50",children:s.jsx("div",{className:"flex items-center justify-between",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Ae,{className:"h-4 w-4 text-gray-600"}),s.jsx("span",{className:"text-sm font-medium",children:"발주서 첨부파일"}),s.jsxs(j,{variant:"secondary",className:"text-xs",children:[y.length,"개"]})]})})}),te?s.jsxs("div",{className:"p-4 flex items-center gap-2 text-sm text-muted-foreground",children:[s.jsx(ge,{className:"h-4 w-4 animate-spin"}),"첨부파일 정보를 불러오는 중..."]}):y.length===0?s.jsxs("div",{className:"p-4 text-sm text-muted-foreground text-center",children:[s.jsx(J,{className:"h-8 w-8 mx-auto mb-2 text-gray-400"}),"발주서에 첨부된 파일이 없습니다."]}):s.jsx("div",{className:"max-h-48 overflow-y-auto p-3 space-y-2",children:y.map(e=>{const t=i.selectedAttachmentIds.includes(e.id);return s.jsxs("div",{className:`flex items-center space-x-3 p-2 rounded-md hover:bg-gray-50 transition-colors ${t?"bg-blue-50 border border-blue-200":"border border-gray-200"}`,children:[s.jsx(Y,{id:`attach-${e.id}`,checked:t,onCheckedChange:()=>B(e.id)}),s.jsxs("div",{className:"flex items-center space-x-2 flex-1 min-w-0",children:[X(e.mimeType,e.originalName),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx(x,{htmlFor:`attach-${e.id}`,className:"text-sm font-medium cursor-pointer block truncate",title:e.originalName,children:e.originalName}),e.fileSize&&s.jsxs("div",{className:"text-xs text-muted-foreground",children:[O(e.fileSize),e.mimeType&&s.jsxs("span",{className:"ml-2",children:["• ",e.mimeType.split("/")[1]?.toUpperCase()]})]})]})]})]},e.id)})}),s.jsxs("div",{className:"border-t",onDragOver:K,onDragLeave:q,onDrop:H,children:[s.jsx("div",{className:"p-3 bg-gray-50",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx($,{className:"h-4 w-4 text-gray-600"}),s.jsx("span",{className:"text-sm font-medium",children:"추가 파일 첨부"}),m.length>0&&s.jsxs(j,{variant:"secondary",className:"text-xs",children:[m.length,"개"]})]}),s.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:()=>b.current?.click(),className:"text-xs",children:[s.jsx($,{className:"h-3 w-3 mr-1"}),"파일 선택"]})]})}),s.jsx("input",{ref:b,type:"file",multiple:!0,onChange:ae,className:"hidden",accept:".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.txt,.zip,.rar"}),m.length>0?s.jsx("div",{className:"max-h-48 overflow-y-auto p-3 space-y-2",children:m.map(e=>{const t=i.selectedAttachmentIds.includes(e.id);return s.jsxs("div",{className:`flex items-center space-x-3 p-2 rounded-md hover:bg-gray-50 transition-colors ${t?"bg-green-50 border border-green-200":"border border-gray-200"}`,children:[s.jsx(Y,{id:`custom-${e.id}`,checked:t,onCheckedChange:()=>B(e.id)}),s.jsxs("div",{className:"flex items-center space-x-2 flex-1 min-w-0",children:[X(e.mimeType,e.originalName),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs(x,{htmlFor:`custom-${e.id}`,className:"text-sm font-medium cursor-pointer block truncate",title:e.originalName,children:[e.originalName,s.jsx(j,{variant:"outline",className:"ml-2 text-xs",children:"새 파일"})]}),e.fileSize&&s.jsxs("div",{className:"text-xs text-muted-foreground",children:[O(e.fileSize),e.mimeType&&s.jsxs("span",{className:"ml-2",children:["• ",e.mimeType.split("/")[1]?.toUpperCase()]})]})]}),s.jsx(h,{type:"button",variant:"ghost",size:"sm",onClick:()=>ie(e.id),className:"h-6 w-6 p-0 hover:bg-red-100",children:s.jsx(pe,{className:"h-3 w-3 text-red-500"})})]})]},e.id)})}):s.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",onDragOver:K,onDragLeave:q,onDrop:H,children:s.jsxs("div",{className:`border-2 border-dashed rounded-lg p-4 transition-colors ${f?"border-blue-400 bg-blue-50":"border-gray-300 hover:border-gray-400"}`,children:[s.jsx($,{className:`h-8 w-8 mx-auto mb-2 ${f?"text-blue-500":"text-gray-400"}`}),s.jsx("p",{className:f?"text-blue-600 font-medium":"",children:f?"파일을 놓으세요":"추가로 첨부할 파일을 선택하세요"}),s.jsx("p",{className:"text-xs mt-1",children:f?"여기에 파일을 드롭하세요":"드래그 앤 드롭 또는 클릭하여 파일 선택"}),s.jsx("p",{className:"text-xs mt-1 text-gray-500",children:"최대 10MB, 여러 파일 선택 가능"})]})})]}),i.selectedAttachmentIds.length>0&&s.jsx("div",{className:"p-3 bg-blue-50 border-t border-blue-200",children:s.jsxs("div",{className:"text-sm text-blue-700 font-medium flex items-center gap-2",children:[s.jsx(fe,{className:"h-4 w-4"}),"총 ",i.selectedAttachmentIds.length,"개 파일이 선택되었습니다"]})})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(x,{htmlFor:"message",children:"메시지 (선택)"}),s.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"이 메시지는 이메일 본문에 포함되어 수신자에게 전달됩니다."}),s.jsx(Ee,{id:"message",value:i.message,onChange:e=>d(t=>({...t,message:e.target.value})),placeholder:"추가 메시지를 입력하세요...",rows:8,className:"resize-none"})]})]}),s.jsxs(we,{children:[s.jsx(h,{variant:"outline",onClick:()=>A(!1),disabled:I,children:"취소"}),s.jsx(h,{onClick:ce,disabled:I,children:I?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"발송 중..."]}):s.jsxs(s.Fragment,{children:[s.jsx(Ie,{className:"h-4 w-4 mr-2"}),"이메일 발송"]})})]})]})})}export{Ue as E};
