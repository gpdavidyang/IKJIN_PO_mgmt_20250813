import{d as X,e as Z,u as ee,x as se,r as L,p as C,q as re,j as e,B as h,s as S,t as E,G as M,H as O,J as d,I as N,P as te,n as ae,k as f,w as V}from"./index-BTNCGX0c-1757215568215.js";import{T as le}from"./textarea-D30Adj33-1757215568215.js";import{S as j,a as g,b as v,c as p,d as a}from"./select-IeP3AaA7-1757215568215.js";import{i as ne}from"./authUtils-CcDzk6i0-1757215568215.js";import{A as ie}from"./arrow-left-CozOM1qJ-1757215568215.js";import{S as de}from"./square-pen-Ijqz9i2Y-1757215568215.js";import{T as oe}from"./trash-2-BACzvait-1757215568215.js";import{S as ce}from"./save-CUoUq5Z3-1757215568215.js";import"./index-CRn1n32W-1757215568215.js";import"./chevron-down-BCqfPkAu-1757215568215.js";import"./chevron-up-C2C6A-f4-1757215568215.js";function Ce(){X();const{toast:I}=Z(),[me,y]=ee(),T=se(),o=T.id;console.log("OrderEdit params:",T),console.log("OrderEdit orderId:",o,typeof o);const[i,c]=L.useState({projectId:"",vendorId:"",orderDate:"",deliveryDate:"",notes:"",templateId:"",items:[]}),{data:n,isLoading:P,error:q}=C({queryKey:[`/api/orders/${o}`],queryFn:()=>f("GET",`/api/orders/${o}`),enabled:!!o});console.log("OrderEdit Debug:",{orderId:o,order:n,orderLoading:P,orderError:q,enabled:!!o});const{data:K}=C({queryKey:["/api/vendors"],queryFn:()=>f("GET","/api/vendors")}),{data:G}=C({queryKey:["/api/projects"],queryFn:()=>f("GET","/api/projects")}),{data:w}=C({queryKey:["/api/categories"],queryFn:()=>f("GET","/api/categories")}),z=w?.categories||[],b=w?.flatCategories||[];console.log("Categories data:",w),console.log("Categories (hierarchical):",z),console.log("Flat categories:",b);const{data:U}=C({queryKey:["/api/items"],queryFn:()=>f("GET","/api/items")}),u=U?.items||[];L.useEffect(()=>{if(n&&u.length>0){const s=(n.items||[]).map(t=>{let r=null;return r=u.find(l=>l.name===t.itemName),r||(r=u.find(l=>l.name.includes(t.itemName)||t.itemName.includes(l.name))),!r&&t.itemId&&(r=u.find(l=>l.id===t.itemId)),{itemId:r?.id||null,itemName:t.itemName||"",quantity:parseFloat(t.quantity)||1,unitPrice:parseFloat(t.unitPrice)||0,specification:t.specification||"",notes:t.notes||"",unit:t.unit||"EA",majorCategory:t.majorCategory||"",middleCategory:t.middleCategory||"",minorCategory:t.minorCategory||""}});c({projectId:n.projectId?.toString()||"",vendorId:n.vendorId?.toString()||"",orderDate:n.orderDate?new Date(n.orderDate).toISOString().split("T")[0]:"",deliveryDate:n.deliveryDate?new Date(n.deliveryDate).toISOString().split("T")[0]:"",notes:n.notes||"",templateId:n.templateId?.toString()||"",items:s})}else n&&u.length===0&&c({projectId:n.projectId?.toString()||"",vendorId:n.vendorId?.toString()||"",orderDate:n.orderDate?new Date(n.orderDate).toISOString().split("T")[0]:"",deliveryDate:n.deliveryDate?new Date(n.deliveryDate).toISOString().split("T")[0]:"",notes:n.notes||"",templateId:n.templateId?.toString()||"",items:n.items||[]})},[n,u]);const $=re({mutationFn:async s=>await f("PATCH",`/api/orders/${o}`,s),onSuccess:()=>{I({title:"성공",description:"발주서가 수정되었습니다."}),V.invalidateQueries({queryKey:[`/api/orders/${o}`]}),V.invalidateQueries({queryKey:["/api/orders"]}),y(`/orders/${o}`)},onError:s=>{if(ne(s)){I({title:"Unauthorized",description:"You are logged out. Logging in again...",variant:"destructive"}),setTimeout(()=>{y("/login")},500);return}I({title:"오류",description:"발주서 수정에 실패했습니다.",variant:"destructive"})}}),B=s=>{if(s.preventDefault(),!i.vendorId||!i.orderDate||i.items.length===0){I({title:"오류",description:"모든 필수 필드를 입력해주세요.",variant:"destructive"});return}const t={projectId:i.projectId?parseInt(i.projectId):null,vendorId:parseInt(i.vendorId),orderDate:new Date(i.orderDate),deliveryDate:i.deliveryDate?new Date(i.deliveryDate):null,notes:i.notes,templateId:i.templateId?parseInt(i.templateId):null,items:i.items.map(r=>({itemId:r.itemId,itemName:r.itemName,quantity:Number(r.quantity),unitPrice:Number(r.unitPrice),specification:r.specification||"",notes:r.notes||"",unit:r.unit||"EA",majorCategory:r.majorCategory||"",middleCategory:r.middleCategory||"",minorCategory:r.minorCategory||""}))};$.mutate(t)},Q=()=>{c(s=>({...s,items:[...s.items,{itemId:null,itemName:"",quantity:1,unitPrice:0,specification:"",notes:"",unit:"EA",majorCategory:"",middleCategory:"",minorCategory:""}]}))},R=s=>{c(t=>({...t,items:t.items.filter((r,l)=>l!==s)}))},m=(s,t,r)=>{c(l=>({...l,items:l.items.map((x,D)=>D===s?{...x,[t]:r}:x)}))},H=(s,t)=>{const r=u.find(l=>l.id.toString()===t);r&&(m(s,"itemId",r.id),m(s,"itemName",r.name),m(s,"unitPrice",r.unitPrice||0),m(s,"specification",r.specification||""))},J=()=>{const s=b.filter(t=>t.categoryType==="major");return console.log("getMajorCategories result:",s),s},Y=s=>{if(!s||s==="none")return[];const t=b.find(l=>l.categoryType==="major"&&l.categoryName===s);if(!t)return console.log(`Major category not found: ${s}`),[];const r=b.filter(l=>l.categoryType==="middle"&&l.parentId===t.id);return console.log(`Middle categories for ${s}:`,r),r},_=s=>{if(!s||s==="none")return[];const t=b.find(l=>l.categoryType==="middle"&&l.categoryName===s);if(!t)return console.log(`Middle category not found: ${s}`),[];const r=b.filter(l=>l.categoryType==="minor"&&l.parentId===t.id);return console.log(`Minor categories for ${s}:`,r),r},k=(s,t,r)=>{console.log(`Category change: index=${s}, type=${t}, value=${r}`);const l={},x=r==="none"?"":r;console.log(`Actual value after conversion: ${x}`),t==="major"?(l.majorCategory=x,l.middleCategory="",l.minorCategory=""):t==="middle"?(l.middleCategory=x,l.minorCategory=""):t==="minor"&&(l.minorCategory=x),console.log("Updates to apply:",l),c(D=>{const A=D.items.map((F,W)=>W===s?{...F,...l}:F);return console.log(`Updated item ${s}:`,A[s]),{...D,items:A}})};return P?e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/4 mb-6"}),e.jsx("div",{className:"h-96 bg-gray-200 rounded"})]})}):q?e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"발주서 로드 중 오류가 발생했습니다"}),e.jsx("p",{className:"mb-4 text-red-600",children:q.message}),e.jsx(h,{onClick:()=>y("/orders"),children:"발주서 목록으로 돌아가기"})]})}):n?e.jsxs("div",{className:"max-w-[1366px] mx-auto p-6",children:[e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>y(`/orders/${o}`),children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"돌아가기"]}),e.jsx(de,{className:"h-6 w-6 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"발주서 수정"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"발주서 정보를 수정합니다"})]})]})})}),e.jsxs("form",{onSubmit:B,children:[n&&e.jsx(S,{className:"mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsx(E,{className:"p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-blue-600",children:"발주서 번호"}),e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:n.orderNumber||"N/A"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-blue-600",children:"현재 상태"}),e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:n.status||"N/A"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-blue-600",children:"생성일시"}),e.jsx("p",{className:"text-lg font-semibold text-blue-900",children:n.createdAt?new Date(n.createdAt).toLocaleString("ko-KR"):"N/A"})]})]})})}),e.jsxs(S,{className:"mb-6",children:[e.jsx(M,{children:e.jsx(O,{children:"기본 정보"})}),e.jsxs(E,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"project",children:"프로젝트"}),e.jsxs(j,{value:i.projectId,onValueChange:s=>c(t=>({...t,projectId:s})),children:[e.jsx(g,{children:e.jsx(v,{placeholder:"프로젝트를 선택하세요"})}),e.jsx(p,{children:G?.map(s=>e.jsx(a,{value:s.id.toString(),children:s.projectName},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"vendor",children:"거래처 *"}),e.jsxs(j,{value:i.vendorId,onValueChange:s=>c(t=>({...t,vendorId:s})),children:[e.jsx(g,{children:e.jsx(v,{placeholder:"거래처를 선택하세요"})}),e.jsx(p,{children:K?.map(s=>e.jsx(a,{value:s.id.toString(),children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"orderDate",children:"발주일자 *"}),e.jsx(N,{id:"orderDate",type:"date",value:i.orderDate,onChange:s=>c(t=>({...t,orderDate:s.target.value})),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"deliveryDate",children:"납품희망일"}),e.jsx(N,{id:"deliveryDate",type:"date",value:i.deliveryDate,onChange:s=>c(t=>({...t,deliveryDate:s.target.value}))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"notes",children:"비고"}),e.jsx(le,{id:"notes",placeholder:"추가 정보나 요청사항을 입력하세요",value:i.notes,onChange:s=>c(t=>({...t,notes:s.target.value})),rows:3})]})]})]}),e.jsxs(S,{className:"mb-6",children:[e.jsx(M,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(O,{children:"발주 품목"}),e.jsxs(h,{type:"button",onClick:Q,children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"품목 추가"]})]})}),e.jsxs(E,{children:[i.items.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"발주할 품목을 추가해주세요"}):e.jsx("div",{className:"space-y-4",children:i.items.map((s,t)=>e.jsxs(S,{className:"p-4 border bg-gradient-to-br from-gray-50 to-white hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(ae,{variant:"outline",className:"text-sm bg-blue-50 text-blue-700 border-blue-200",children:["품목 #",t+1]}),e.jsx("span",{className:"text-xs text-gray-500",children:s.itemName?`• ${s.itemName}`:""})]}),e.jsx(h,{type:"button",variant:"ghost",size:"icon",onClick:()=>R(t),className:"h-8 w-8 text-gray-400 hover:text-red-600 hover:bg-red-50",children:e.jsx(oe,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 mb-3",children:[e.jsxs("div",{className:"col-span-2 sm:col-span-3 md:col-span-2",children:[e.jsx(d,{className:"text-xs font-medium text-gray-700 mb-1 block",children:"품목명 *"}),e.jsxs(j,{value:s.itemId?.toString()||"",onValueChange:r=>H(t,r),children:[e.jsx(g,{children:e.jsx(v,{placeholder:s.itemName||"품목 선택"})}),e.jsx(p,{children:u.map(r=>e.jsx(a,{value:r.id.toString(),children:r.name},r.id))})]})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-xs font-medium text-gray-700 mb-1 block",children:"수량 *"}),e.jsx(N,{type:"number",value:s.quantity,onChange:r=>{const l=r.target.value,x=l===""?0:Number(l);console.log(`Quantity changed: ${l} -> ${x}`),m(t,"quantity",x)},onBlur:r=>{Number(r.target.value)<1&&m(t,"quantity",1)},min:"0.01",step:"0.01",required:!0})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-xs font-medium text-gray-700 mb-1 block",children:"단위"}),e.jsxs(j,{value:s.unit||"EA",onValueChange:r=>{console.log(`Unit selected: ${r}`),m(t,"unit",r)},children:[e.jsx(g,{children:e.jsx(v,{placeholder:"단위 선택"})}),e.jsxs(p,{children:[e.jsx(a,{value:"EA",children:"EA"}),e.jsx(a,{value:"개",children:"개"}),e.jsx(a,{value:"박스",children:"박스"}),e.jsx(a,{value:"세트",children:"세트"}),e.jsx(a,{value:"kg",children:"kg"}),e.jsx(a,{value:"g",children:"g"}),e.jsx(a,{value:"L",children:"L"}),e.jsx(a,{value:"mL",children:"mL"}),e.jsx(a,{value:"m",children:"m"}),e.jsx(a,{value:"cm",children:"cm"}),e.jsx(a,{value:"mm",children:"mm"}),e.jsx(a,{value:"㎡",children:"㎡"}),e.jsx(a,{value:"㎥",children:"㎥"}),e.jsx(a,{value:"매",children:"매"}),e.jsx(a,{value:"장",children:"장"}),e.jsx(a,{value:"권",children:"권"}),e.jsx(a,{value:"부",children:"부"}),e.jsx(a,{value:"대",children:"대"}),e.jsx(a,{value:"식",children:"식"}),e.jsx(a,{value:"조",children:"조"}),e.jsx(a,{value:"타",children:"타"}),e.jsx(a,{value:"켤레",children:"켤레"}),e.jsx(a,{value:"통",children:"통"}),e.jsx(a,{value:"병",children:"병"}),e.jsx(a,{value:"캔",children:"캔"}),e.jsx(a,{value:"포",children:"포"}),e.jsx(a,{value:"봉",children:"봉"}),e.jsx(a,{value:"팩",children:"팩"}),e.jsx(a,{value:"롤",children:"롤"}),e.jsx(a,{value:"쌍",children:"쌍"}),e.jsx(a,{value:"톤",children:"톤"}),e.jsx(a,{value:"되",children:"되"}),e.jsx(a,{value:"말",children:"말"}),e.jsx(a,{value:"자루",children:"자루"}),e.jsx(a,{value:"마리",children:"마리"}),e.jsx(a,{value:"모",children:"모"}),e.jsx(a,{value:"평",children:"평"}),e.jsx(a,{value:"보루",children:"보루"}),e.jsx(a,{value:"묶음",children:"묶음"}),e.jsx(a,{value:"다스",children:"다스"}),e.jsx(a,{value:"갑",children:"갑"}),e.jsx(a,{value:"곽",children:"곽"}),e.jsx(a,{value:"판",children:"판"}),e.jsx(a,{value:"그루",children:"그루"}),e.jsx(a,{value:"주",children:"주"}),e.jsx(a,{value:"본",children:"본"}),e.jsx(a,{value:"줄",children:"줄"})]})]})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-xs font-medium text-gray-700 mb-1 block",children:"단가"}),e.jsx(N,{type:"number",value:s.unitPrice,onChange:r=>m(t,"unitPrice",Number(r.target.value)),min:"0"})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-xs font-medium text-gray-700 mb-1 block",children:"총액"}),e.jsxs("div",{className:"h-10 px-3 py-2 border rounded-md bg-blue-50 border-blue-200 flex items-center font-semibold text-blue-700",children:["₩",(Number(s.quantity)*Number(s.unitPrice)).toLocaleString("ko-KR")]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 border-t border-gray-200 pt-3 mt-3",children:[e.jsxs("div",{children:[e.jsx(d,{className:"text-xs font-medium text-gray-700 mb-1 block",children:"대분류"}),e.jsxs(j,{value:s.majorCategory||"none",onValueChange:r=>{console.log(`Major category selected: ${r}`),k(t,"major",r)},children:[e.jsx(g,{children:e.jsx(v,{placeholder:"대분류 선택",children:s.majorCategory&&s.majorCategory!=="none"?s.majorCategory:"대분류 선택"})}),e.jsxs(p,{children:[e.jsx(a,{value:"none",children:"선택 해제"}),J().map(r=>e.jsx(a,{value:r.categoryName,children:r.categoryName},`major-${r.id}`))]})]})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-xs font-medium text-gray-700 mb-1 block",children:"중분류"}),e.jsxs(j,{value:s.middleCategory||"none",onValueChange:r=>{console.log(`Middle category selected: ${r}`),k(t,"middle",r)},disabled:!s.majorCategory||s.majorCategory==="none",children:[e.jsx(g,{children:e.jsx(v,{placeholder:s.majorCategory&&s.majorCategory!=="none"?"중분류 선택":"대분류 먼저 선택",children:s.middleCategory&&s.middleCategory!=="none"?s.middleCategory:s.majorCategory&&s.majorCategory!=="none"?"중분류 선택":"대분류 먼저 선택"})}),e.jsxs(p,{children:[e.jsx(a,{value:"none",children:"선택 해제"}),Y(s.majorCategory||"").map(r=>e.jsx(a,{value:r.categoryName,children:r.categoryName},`middle-${r.id}`))]})]})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-xs font-medium text-gray-700 mb-1 block",children:"소분류"}),e.jsxs(j,{value:s.minorCategory||"none",onValueChange:r=>{console.log(`Minor category selected: ${r}`),k(t,"minor",r)},disabled:!s.middleCategory||s.middleCategory==="none",children:[e.jsx(g,{children:e.jsx(v,{placeholder:s.middleCategory&&s.middleCategory!=="none"?"소분류 선택":"중분류 먼저 선택",children:s.minorCategory&&s.minorCategory!=="none"?s.minorCategory:s.middleCategory&&s.middleCategory!=="none"?"소분류 선택":"중분류 먼저 선택"})}),e.jsxs(p,{children:[e.jsx(a,{value:"none",children:"선택 해제"}),_(s.middleCategory||"").map(r=>e.jsx(a,{value:r.categoryName,children:r.categoryName},`minor-${r.id}`))]})]})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-xs font-medium text-gray-700 mb-1 block",children:"규격"}),e.jsx(N,{value:s.specification,onChange:r=>m(t,"specification",r.target.value),placeholder:"규격 입력"})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-xs font-medium text-gray-700 mb-1 block",children:"비고"}),e.jsx(N,{value:s.notes,onChange:r=>m(t,"notes",r.target.value),placeholder:"비고 입력"})]})]})]},t))}),i.items.length>0&&e.jsx("div",{className:"mt-6 space-y-4",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-blue-600 mb-1",children:"총 품목 수"}),e.jsxs("div",{className:"text-xl font-bold text-blue-700",children:[i.items.length,"개"]})]}),e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-green-600 mb-1",children:"총 수량"}),e.jsx("div",{className:"text-xl font-bold text-green-700",children:i.items.reduce((s,t)=>s+(Number(t.quantity)||0),0)})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-purple-600 mb-1",children:"대분류 수"}),e.jsxs("div",{className:"text-xl font-bold text-purple-700",children:[new Set(i.items.map(s=>s.majorCategory).filter(s=>s)).size,"개"]})]}),e.jsxs("div",{className:"bg-orange-50 p-4 rounded-lg",children:[e.jsx("div",{className:"text-sm text-orange-600 mb-1",children:"총 합계 금액"}),e.jsxs("div",{className:"text-xl font-bold text-orange-700",children:["₩",i.items.reduce((s,t)=>{const r=(Number(t.quantity)||0)*(Number(t.unitPrice)||0);return s+r},0).toLocaleString()]})]})]})})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>y(`/orders/${o}`),children:"취소"}),e.jsxs(h,{type:"submit",disabled:$.isPending,children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),$.isPending?"저장 중...":"저장"]})]})]})]}):e.jsx("div",{className:"container mx-auto py-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"발주서를 찾을 수 없습니다"}),e.jsxs("p",{className:"mb-4 text-gray-600",children:["OrderID: ",o]}),e.jsx(h,{onClick:()=>y("/orders"),children:"발주서 목록으로 돌아가기"})]})})}export{Ce as default};
