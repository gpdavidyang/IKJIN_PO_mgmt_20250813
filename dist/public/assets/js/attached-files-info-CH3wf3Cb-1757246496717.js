import{d as T,e as A,h as C,r as j,j as e,al as N,o as v,F as p,Z as L,B as f,T as k,I as E,k as M,K as b}from"./index-F0V4iaOu-1757246496717.js";import{A as R,f as U,a as B,b as P,c as S,d as z,e as I,g as O,h as W}from"./alert-dialog-Cmn9oN8L-1757246496717.js";import{C as q}from"./calendar-C6guIs9S-1757246496717.js";import{D as K}from"./download-IRpE6z47-1757246496717.js";import{f as H}from"./format-Wwhs3QHM-1757246496717.js";const Q=async(n,i,g)=>{console.log(`🔽 Starting download for attachment ${n}, filename: ${i}, mimeType: ${g}`);try{const a=`/api/attachments/${n}/download?download=true`;console.log("📎 Download URL:",a);const m=g?.toLowerCase().includes("pdf")||i.toLowerCase().endsWith(".pdf"),s=await fetch(a,{method:"GET",credentials:"include",headers:{Accept:m?"application/pdf":"*/*"}});if(!s.ok){const t=await s.text();throw console.error("Download response error:",t),new Error(`다운로드 실패: ${s.status}`)}const h=await s.blob(),l=window.URL.createObjectURL(h);if(m)console.log("📄 File is PDF - opening in new tab and downloading"),window.open(l,"_blank"),console.log("✅ Opened PDF in new tab for viewing"),setTimeout(()=>{const t=document.createElement("a");t.href=l,t.download=i,t.style.display="none",document.body.appendChild(t),t.click(),setTimeout(()=>{document.body.removeChild(t),window.URL.revokeObjectURL(l)},100),console.log("✅ PDF download triggered")},500);else{console.log("📁 File download - triggering download");const t=document.createElement("a");t.href=l,t.download=i,t.style.display="none",document.body.appendChild(t),t.click(),setTimeout(()=>{document.body.removeChild(t),window.URL.revokeObjectURL(l)},100),console.log("✅ File download triggered")}return!0}catch(a){throw console.error("❌ Download error:",a),a}},G=(n,i,g)=>{const a=g?.toLowerCase().includes("pdf")||n.toLowerCase().endsWith(".pdf");i(a?{title:"다운로드 및 미리보기",description:`${n} 파일이 새 탭에서 열리고 다운로드 폴더에 저장됩니다.`}:{title:"다운로드 완료",description:`${n} 파일이 다운로드 폴더에 저장됩니다.`})};function Y({attachments:n,orderId:i}){const{user:g}=T(),{toast:a}=A(),{theme:m}=C(),s=m==="dark",[h,l]=j.useState(null),[t,u]=j.useState(null),w=g?.role==="admin";console.log("🔍 AttachedFilesInfo - COMPONENT CALLED!",{attachments:n,orderId:i}),console.log("🔍 AttachedFilesInfo - received attachments:",n);const x=n.map(r=>{const o=r.mimeType?.toLowerCase()||"",d=r.originalName?.toLowerCase()||"";let c="other",y=p;return o.includes("excel")||o.includes("spreadsheet")||d.endsWith(".xlsx")||d.endsWith(".xls")||d.endsWith(".xlsm")?(c="excel",y=N):(o.includes("pdf")||d.endsWith(".pdf"))&&(c="pdf",y=p),console.log("🔍 Processing attachment:",{originalName:r.originalName,mimeType:r.mimeType,fileName:d,fileType:c}),{...r,fileType:c,icon:y}});if(console.log("📊 AttachedFilesInfo - attached files:",x),x.length===0)return console.log("⚠️ AttachedFilesInfo - No attached files found, component will not render"),null;console.log("✅ AttachedFilesInfo - Rendering component with",x.length,"attached files");const D=async r=>{l(r.id);try{await Q(r.id,r.originalName,r.mimeType),G(r.originalName,a,r.mimeType)}catch(o){console.error("Download error:",o),a({title:"다운로드 실패",description:o instanceof Error?o.message:"알 수 없는 오류가 발생했습니다.",variant:"destructive"})}finally{l(null)}},$=async r=>{if(!w){a({title:"권한 없음",description:"관리자만 파일을 삭제할 수 있습니다.",variant:"destructive"});return}u(r.id);try{await M("DELETE",`/api/attachments/${r.id}`),await b.invalidateQueries({queryKey:[`/api/orders/${i}`]}),await b.invalidateQueries({queryKey:["orders-optimized"]}),await b.invalidateQueries({queryKey:["/api/orders"]}),a({title:"파일 삭제 완료",description:`${r.originalName} 파일이 삭제되었습니다.`})}catch(o){console.error("Delete error:",o),a({title:"파일 삭제 실패",description:o instanceof Error?o.message:"알 수 없는 오류가 발생했습니다.",variant:"destructive"})}finally{u(null)}},F=r=>{if(r===0)return"0 B";const o=1024,d=["B","KB","MB","GB"],c=Math.floor(Math.log(r)/Math.log(o));return parseFloat((r/Math.pow(o,c)).toFixed(2))+" "+d[c]};return e.jsxs("div",{className:`shadow-sm rounded-lg border transition-colors ${s?"bg-gray-800 border-gray-700":"bg-white border-gray-200"}`,children:[e.jsx("div",{className:`p-6 border-b transition-colors ${s?"border-gray-700":"border-gray-200"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`p-2 rounded-lg mr-3 transition-colors ${s?"bg-green-900/20":"bg-green-50"}`,children:e.jsx(N,{className:`h-5 w-5 transition-colors ${s?"text-green-400":"text-green-600"}`})}),e.jsxs("div",{children:[e.jsx("h3",{className:`text-lg font-semibold transition-colors ${s?"text-white":"text-gray-900"}`,children:"첨부 된 파일"}),e.jsxs("span",{className:`text-sm transition-colors ${s?"text-gray-400":"text-gray-500"}`,children:["발주서와 관련된 첨부 파일 (",x.length,"개)"]})]})]}),e.jsxs(v,{variant:"outline",className:`transition-colors ${s?"border-blue-600 text-blue-400":"border-blue-200 text-blue-700 bg-blue-50"}`,children:[e.jsx(p,{className:"h-3 w-3 mr-1"}),"첨부파일"]})]})}),e.jsxs("div",{className:"p-6 space-y-4",children:[x.map(r=>e.jsx("div",{className:`border rounded-lg p-4 transition-all hover:shadow-md ${s?"border-gray-600 hover:border-gray-500 bg-gray-750":"border-gray-200 hover:border-gray-300 bg-gray-50/50"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0 flex-1",children:[e.jsx("div",{className:`p-2 rounded-lg transition-colors ${r.fileType==="excel"?s?"bg-green-900/30":"bg-green-100":r.fileType==="pdf"?s?"bg-red-900/30":"bg-red-100":s?"bg-gray-900/30":"bg-gray-100"}`,children:e.jsx(r.icon,{className:`h-5 w-5 transition-colors ${r.fileType==="excel"?s?"text-green-400":"text-green-600":r.fileType==="pdf"?s?"text-red-400":"text-red-600":s?"text-gray-400":"text-gray-600"}`})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:`font-medium text-sm truncate transition-colors ${s?"text-gray-200":"text-gray-900"}`,title:r.originalName,children:r.originalName}),e.jsx(v,{variant:"secondary",className:"text-xs",children:r.fileType==="excel"?"Excel":r.fileType==="pdf"?"PDF":"파일"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(p,{className:`h-3 w-3 transition-colors ${s?"text-gray-500":"text-gray-400"}`}),e.jsx("span",{className:`transition-colors ${s?"text-gray-400":"text-gray-600"}`,children:F(r.fileSize)})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{className:`h-3 w-3 transition-colors ${s?"text-gray-500":"text-gray-400"}`}),e.jsx("span",{className:`transition-colors ${s?"text-gray-400":"text-gray-600"}`,children:r.uploadedBy||"알 수 없음"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(q,{className:`h-3 w-3 transition-colors ${s?"text-gray-500":"text-gray-400"}`}),e.jsx("span",{className:`transition-colors ${s?"text-gray-400":"text-gray-600"}`,children:H(new Date(r.uploadedAt),"yyyy.MM.dd HH:mm")})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-4",children:[e.jsx(f,{variant:"outline",size:"sm",onClick:()=>D(r),disabled:h===r.id,className:`h-8 px-3 text-xs transition-colors ${s?"border-gray-600 text-gray-300 hover:bg-gray-700 hover:border-green-500 hover:text-green-400":"border-gray-300 text-gray-700 hover:bg-green-50 hover:border-green-300 hover:text-green-700"}`,children:h===r.id?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-current mr-1"}),"다운로드 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-3 w-3 mr-1"}),"다운로드"]})}),w&&e.jsxs(R,{children:[e.jsx(U,{asChild:!0,children:e.jsx(f,{variant:"outline",size:"sm",disabled:t===r.id,className:`h-8 px-3 text-xs transition-colors ${s?"border-red-600 text-red-400 hover:bg-red-900/20 hover:border-red-500":"border-red-300 text-red-700 hover:bg-red-50 hover:border-red-400"}`,children:t===r.id?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-current mr-1"}),"삭제 중..."]}):e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"h-3 w-3 mr-1"}),"삭제"]})})}),e.jsxs(B,{className:s?"bg-gray-800 border-gray-700":"",children:[e.jsxs(P,{children:[e.jsx(S,{className:s?"text-white":"",children:"파일 삭제 확인"}),e.jsxs(z,{className:s?"text-gray-400":"",children:[e.jsx("strong",{children:r.originalName})," 파일을 삭제하시겠습니까?",e.jsx("br",{}),"이 작업은 되돌릴 수 없으며, 파일이 영구적으로 삭제됩니다."]})]}),e.jsxs(I,{children:[e.jsx(O,{className:s?"border-gray-600 text-gray-300 hover:bg-gray-700":"",children:"취소"}),e.jsx(W,{onClick:()=>$(r),className:"bg-red-600 hover:bg-red-700 text-white",children:"삭제"})]})]})]})]})]})},r.id)),e.jsx("div",{className:`mt-4 p-3 rounded-lg border border-dashed transition-colors ${s?"border-gray-600 bg-gray-750":"border-gray-300 bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(E,{className:`h-4 w-4 mt-0.5 flex-shrink-0 transition-colors ${s?"text-blue-400":"text-blue-600"}`}),e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsx("p",{className:`font-medium transition-colors ${s?"text-blue-400":"text-blue-600"}`,children:"첨부 파일 정보"}),e.jsx("p",{className:`transition-colors ${s?"text-gray-400":"text-gray-600"}`,children:"이 섹션에는 발주서와 관련된 모든 첨부 파일이 표시됩니다. Excel 파일, PDF 문서 등 다양한 형태의 파일을 다운로드하여 사용할 수 있습니다."})]})]})})]})]})}export{Y as A,Q as d,G as s};
