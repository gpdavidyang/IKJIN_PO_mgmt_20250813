import{r as j,j as e,N as X,o as z,V as te,s as F,b as ae,i as M,B as A,Z,O as G,k as W,I as re,c as ie,u as le,d as ne,H as ce,a1 as _,a0 as oe}from"./index-RVun1A9P.js";import{A as V,a as K}from"./alert-CFP4lIJ9.js";import{P as de}from"./progress-DmgTdOo7.js";import{r as me,u as he}from"./xlsx-ocdEQCFM.js";import{T as ue}from"./textarea-Bl7ptpdm.js";import{P as H}from"./package-da8KhTiX.js";import{M as Q}from"./mail-D9I17uPJ.js";import{C as pe}from"./calendar-CD1p8P1m.js";import{H as ge}from"./hash-Dn6rOdsU.js";import{D as J}from"./dollar-sign-C7C9R2Y3.js";import{P as xe}from"./pen-line-jBNWnIK7.js";import{S as fe}from"./send-DUMKAN0M.js";import{S as je}from"./save-DrNTBitj.js";function Ne({orders:E,onOrderUpdate:N,onOrderRemove:O}){const[u,S]=j.useState(null),[C,b]=j.useState(""),U=(a,s)=>{S(a),b(s||"")},P=(a,s,i)=>{const n={...E[a]},x=s.split(".");let f=n;for(let d=0;d<x.length-1;d++){const w=x[d];if(w==="items"){const $=parseInt(x[d+1]);f=n.items[$],d++}else f=f[w]}const p=x[x.length-1];if(["quantity","unitPrice","totalAmount"].includes(p)?f[p]=parseFloat(i)||0:f[p]=i,p==="quantity"||p==="unitPrice"){const d=f;d.quantity&&d.unitPrice&&(d.totalAmount=d.quantity*d.unitPrice)}n.errors=[],n.projectName||n.errors.push("í”„ë¡œì íŠ¸ëª… í•„ìˆ˜"),n.vendorName||n.errors.push("ê±°ë˜ì²˜ëª… í•„ìˆ˜"),n.vendorEmail||n.errors.push("ê±°ë˜ì²˜ ì´ë©”ì¼ í•„ìˆ˜"),n.items.length===0&&n.errors.push("í’ˆëª© í•„ìˆ˜"),n.isValid=n.errors.length===0,N(a,n),S(null)},T=()=>{S(null),b("")},D=(a,s,i)=>{a.key==="Enter"&&!a.shiftKey?(a.preventDefault(),P(s,i,C)):a.key==="Escape"&&T()},m=({fieldId:a,value:s,orderIndex:i,fieldPath:l,placeholder:n,type:x="text",multiline:f=!1,icon:p,className:d=""})=>{if(u===a){const $=f?ue:re;return e.jsxs("div",{className:"flex items-start gap-2",children:[p&&e.jsx("div",{className:"mt-2 text-gray-400",children:p}),e.jsx($,{type:x,value:C,onChange:k=>b(k.target.value),onKeyDown:k=>D(k,i,l),onBlur:()=>P(i,l,C),placeholder:n,className:z("flex-1",d),autoFocus:!0})]})}return e.jsxs("div",{className:z("flex items-start gap-2 p-2 rounded cursor-pointer hover:bg-gray-50 transition-colors group",!s&&"text-gray-400"),onClick:()=>U(a,s),children:[p&&e.jsx("div",{className:"text-gray-400 group-hover:text-gray-600",children:p}),e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:z(!s&&"italic"),children:s||n})}),e.jsx(xe,{className:"h-3 w-3 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"})]})};return e.jsxs("div",{className:"space-y-6",children:[E.map((a,s)=>e.jsxs(X,{className:z("relative transition-all",a.isValid===!1&&"border-red-300 bg-red-50"),children:[e.jsx(te,{className:"pb-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(F,{variant:"outline",children:["#",s+1]}),e.jsx(F,{variant:a.isValid?"default":"destructive",children:a.isValid?e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"h-3 w-3 mr-1"}),"ìœ íš¨"]}):e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"h-3 w-3 mr-1"}),"ê²€ì¦ í•„ìš”"]})}),a.items.length>0&&e.jsxs(F,{variant:"secondary",children:[e.jsx(H,{className:"h-3 w-3 mr-1"}),a.items.length,"ê°œ í’ˆëª©"]})]}),a.errors&&a.errors.length>0&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:a.errors.join(", ")})]}),e.jsx(A,{variant:"ghost",size:"icon",onClick:()=>O(s),className:"text-gray-400 hover:text-red-600",children:e.jsx(Z,{className:"h-4 w-4"})})]})}),e.jsxs(G,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(m,{fieldId:`order-${s}-project`,value:a.projectName,orderIndex:s,fieldPath:"projectName",placeholder:"í”„ë¡œì íŠ¸ëª… ì…ë ¥",icon:e.jsx(W,{className:"h-4 w-4"})}),e.jsx(m,{fieldId:`order-${s}-vendor`,value:a.vendorName,orderIndex:s,fieldPath:"vendorName",placeholder:"ê±°ë˜ì²˜ëª… ì…ë ¥",icon:e.jsx(W,{className:"h-4 w-4"})}),e.jsx(m,{fieldId:`order-${s}-email`,value:a.vendorEmail,orderIndex:s,fieldPath:"vendorEmail",placeholder:"ê±°ë˜ì²˜ ì´ë©”ì¼ ì…ë ¥",type:"email",icon:e.jsx(Q,{className:"h-4 w-4"})}),e.jsx(m,{fieldId:`order-${s}-delivery`,value:a.deliveryDate,orderIndex:s,fieldPath:"deliveryDate",placeholder:"ë‚©ê¸°ì¼ ì…ë ¥",icon:e.jsx(pe,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[e.jsx(H,{className:"h-4 w-4"}),"í’ˆëª© ì •ë³´"]}),a.items.map((i,l)=>e.jsxs("div",{className:"border rounded-lg p-3 space-y-3 bg-gray-50",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(m,{fieldId:`order-${s}-item-${l}-name`,value:i.itemName,orderIndex:s,fieldPath:`items.${l}.itemName`,placeholder:"í’ˆëª©ëª…"}),e.jsx(m,{fieldId:`order-${s}-item-${l}-spec`,value:i.specification,orderIndex:s,fieldPath:`items.${l}.specification`,placeholder:"ê·œê²©"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsx(m,{fieldId:`order-${s}-item-${l}-unit`,value:i.unit,orderIndex:s,fieldPath:`items.${l}.unit`,placeholder:"ë‹¨ìœ„"}),e.jsx(m,{fieldId:`order-${s}-item-${l}-qty`,value:i.quantity,orderIndex:s,fieldPath:`items.${l}.quantity`,placeholder:"ìˆ˜ëŸ‰",type:"number",icon:e.jsx(ge,{className:"h-4 w-4"})}),e.jsx(m,{fieldId:`order-${s}-item-${l}-price`,value:i.unitPrice,orderIndex:s,fieldPath:`items.${l}.unitPrice`,placeholder:"ë‹¨ê°€",type:"number",icon:e.jsx(J,{className:"h-4 w-4"})}),e.jsx("div",{className:"p-2 bg-white rounded border",children:e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(J,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"font-medium",children:((i.quantity||0)*(i.unitPrice||0)).toLocaleString()})]})})]}),i.remarks&&e.jsx(m,{fieldId:`order-${s}-item-${l}-remarks`,value:i.remarks,orderIndex:s,fieldPath:`items.${l}.remarks`,placeholder:"ë¹„ê³ ",multiline:!0})]},l))]}),a.notes&&e.jsx(m,{fieldId:`order-${s}-notes`,value:a.notes,orderIndex:s,fieldPath:"notes",placeholder:"ì „ì²´ ë¹„ê³ ",multiline:!0,className:"min-h-[60px]"})]})]},s)),E.length===0&&e.jsx("div",{className:"text-center py-12 text-gray-500",children:"ì—…ë¡œë“œëœ ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤."})]})}function De(){ie();const[,E]=le(),{toast:N}=ne(),O=j.useRef(null),[u,S]=j.useState(null),[C,b]=j.useState(!1),[U,P]=j.useState([]),[T,D]=j.useState(!1),[m,a]=j.useState(0),[s,i]=j.useState([]),[l,n]=j.useState(!1),x=t=>{t.preventDefault(),t.stopPropagation(),t.type==="dragenter"||t.type==="dragover"?b(!0):t.type==="dragleave"&&b(!1)},f=t=>{if(t.preventDefault(),t.stopPropagation(),b(!1),t.dataTransfer.files&&t.dataTransfer.files[0]){const r=t.dataTransfer.files[0];d(r)}},p=t=>{t.target.files&&t.target.files[0]&&d(t.target.files[0])},d=t=>{const r=t.name.toLowerCase();if(!r.endsWith(".xlsx")&&!r.endsWith(".xls")&&!r.endsWith(".xlsm")){N({title:"íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜",description:"ì—‘ì…€ íŒŒì¼(.xlsx, .xls, .xlsm)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.",variant:"destructive"});return}S(t),w(t)},w=async t=>{D(!0),a(20);try{const r=await t.arrayBuffer();a(40);const o=me(r,{type:"array"});a(60);const v=o.SheetNames[0],h=o.Sheets[v],g=he.sheet_to_json(h,{header:1});a(80);const y=g.slice(1).filter(c=>c&&c.some(R=>R)).map((c,R)=>({rowIndex:R+2,vendorName:c[0]?.toString().trim(),projectName:c[1]?.toString().trim(),orderDate:c[2]?.toString().trim(),deliveryDate:c[3]?.toString().trim(),orderNumber:c[4]?.toString().trim(),vendorEmail:void 0,items:[{itemName:c[5]?.toString().trim(),specification:c[6]?.toString().trim(),quantity:parseFloat(c[7])||0,unit:c[8]?.toString().trim(),unitPrice:parseFloat(c[9])||0,totalAmount:parseFloat(c[10])||0,category:c[13]?.toString().trim(),subCategory1:c[14]?.toString().trim(),subCategory2:c[15]?.toString().trim(),remarks:c[16]?.toString().trim()}],notes:c[16]?.toString().trim(),isValid:!0,errors:[]})),B=$(y);P(B),i(B),a(100),N({title:"ì—‘ì…€ íŒŒì¼ ë¡œë”© ì™„ë£Œ",description:`ë°œì£¼ì„œ ìƒì„±ì„ ìœ„í•´ ${B.length}ê°œì˜ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ê° í•­ëª©ì„ í™•ì¸í•˜ê³  ìˆ˜ì •í•œ í›„ 'ëª¨ë‘ ì €ì¥' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`})}catch(r){console.error("Excel parsing error:",r),N({title:"íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨",description:"ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}finally{D(!1),setTimeout(()=>a(0),1e3)}},$=t=>{const r=new Map;return t.forEach(o=>{const v=`${o.projectName}-${o.vendorName}`;r.has(v)?r.get(v).items.push(...o.items):r.set(v,{...o})}),Array.from(r.values())},k=(t,r)=>{const o=[...s];o[t]=r,i(o)},Y=(t,r=!1)=>{const o=s.filter((v,h)=>h!==t);i(o),r||N({title:"í•­ëª© ì œê±°",description:"ì„ íƒí•œ í•­ëª©ì´ ëª©ë¡ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤."})},L=ce({mutationFn:async t=>{console.log("ğŸš€ CLIENT: Starting saveBulkOrders mutation"),console.log("ğŸ“ CLIENT: Orders to save:",t.length),console.log("ğŸ“ CLIENT: File object:",u?{name:u.name,size:u.size,type:u.type}:null);const r=new FormData;u?(console.log("ğŸ“ CLIENT: Appending file to FormData:",u.name),r.append("excelFile",u)):console.log("âš ï¸ CLIENT: No file to append");try{const h=t.map(q=>({...q,items:q.items?.map(y=>({itemName:y.itemName||"",specification:y.specification||"",unit:y.unit||"",quantity:Number(y.quantity)||0,unitPrice:Number(y.unitPrice)||0,totalAmount:Number(y.totalAmount)||0,remarks:y.remarks||""}))||[]}));console.log("ğŸ” CLIENT: Serializing orders data:",h.length,"orders");const g=JSON.stringify(h);console.log("âœ… CLIENT: Orders serialization successful, length:",g.length),console.log("ğŸ“¦ CLIENT: Sample serialized data (first 200 chars):",g.substring(0,200)),r.append("orders",g)}catch(h){throw console.error("âŒ CLIENT: Orders serialization failed:",h),console.error("âŒ CLIENT: Original orders data:",t),new Error("Failed to serialize orders data")}r.append("sendEmail",String(l)),r.append("isDraft","true"),console.log("ğŸ“¦ CLIENT: FormData entries:");for(const[h,g]of r.entries())g instanceof File?console.log(`  ${h}: File(${g.name}, ${g.size} bytes, ${g.type})`):console.log(`  ${h}: ${typeof g} (length: ${String(g).length})`);console.log("ğŸŒ CLIENT: Sending request to /api/orders/bulk-create-simple");const o=await fetch("/api/orders/bulk-create-simple",{method:"POST",credentials:"include",body:r});if(console.log("ğŸ“¨ CLIENT: Response status:",o.status,o.statusText),!o.ok){const h=await o.text();throw console.error("âŒ CLIENT: Request failed:",h),new Error(h||"Failed to save orders")}const v=await o.json();return console.log("âœ… CLIENT: Request successful:",v),v},onSuccess:t=>{const r=t.emailsSent>0?` (${t.emailsSent}ê°œ ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ)`:"";N({title:"ì €ì¥ ì™„ë£Œ",description:`${t.savedCount}ê°œì˜ ë°œì£¼ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤${r}.`}),setTimeout(()=>E("/orders"),1500)},onError:t=>{N({title:"ì €ì¥ ì‹¤íŒ¨",description:t.message||"ë°œì£¼ì„œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}}),I=()=>{const t=s.filter(r=>r.isValid!==!1);if(t.length===0){N({title:"ì €ì¥í•  ìˆ˜ ì—†ìŒ",description:"ìœ íš¨í•œ ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤.",variant:"destructive"});return}L.mutate(t)},ee=()=>{S(null),P([]),i([]),a(0)},se=()=>{O.current?.click()};return e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-7xl mx-auto p-6 space-y-6 pb-20",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(_,{className:"h-6 w-6 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ì—‘ì…€ ì‹¬í”Œ ì—…ë¡œë“œ"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"ê²€ì¦ ì—†ì´ ì—‘ì…€ ë°ì´í„°ë¥¼ ë°”ë¡œ í¸ì§‘ ê°€ëŠ¥í•œ ë°œì£¼ì„œë¡œ ë³€í™˜í•©ë‹ˆë‹¤"})]})]}),s.length>0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(F,{variant:"secondary",className:"px-3 py-1",children:[e.jsx(H,{className:"h-3 w-3 mr-1"}),s.length,"ê°œ ë°œì£¼ì„œ"]}),e.jsxs(F,{variant:"outline",className:"px-3 py-1",children:[s.reduce((t,r)=>t+r.items.length,0),"ê°œ í’ˆëª©"]})]})]})}),s.length===0&&e.jsx(X,{children:e.jsxs(G,{className:"p-8",children:[e.jsxs(V,{className:"mb-6 border-blue-200 bg-blue-50",children:[e.jsx(M,{className:"h-4 w-4 text-blue-600"}),e.jsxs(K,{className:"text-sm text-blue-900",children:[e.jsx("strong",{children:"ì§ì ‘ìŠ¹ì¸ ì²˜ë¦¬ ì•ˆë‚´"}),e.jsxs("div",{className:"mt-2 space-y-1",children:[e.jsxs("p",{children:["â€¢ ì—‘ì…€ ì—…ë¡œë“œë¡œ ìƒì„±ë˜ëŠ” ëª¨ë“  ë°œì£¼ì„œëŠ” ",e.jsx("strong",{children:"ì§ì ‘ìŠ¹ì¸"})," ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤."]}),e.jsx("p",{children:"â€¢ ë³„ë„ì˜ ìŠ¹ì¸ ì ˆì°¨ ì—†ì´ ë°”ë¡œ ë°œì£¼ì„œê°€ ìƒì„±ë˜ë©°, ì¦‰ì‹œ ë°œì†¡ ê°€ëŠ¥í•œ ìƒíƒœê°€ ë©ë‹ˆë‹¤."}),e.jsx("p",{children:"â€¢ ëŒ€ëŸ‰ ë°œì£¼ ì²˜ë¦¬ë¥¼ ìœ„í•´ ìŠ¹ì¸ ë‹¨ê³„ë¥¼ ìƒëµí•˜ê³  ì‹ ì†í•˜ê²Œ ì²˜ë¦¬ë©ë‹ˆë‹¤."})]})]})]}),e.jsx("input",{ref:O,type:"file",accept:".xlsx,.xls,.xlsm",onChange:p,className:"hidden"}),e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-12 text-center transition-colors ${C?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}`,onDragEnter:x,onDragLeave:x,onDragOver:x,onDrop:f,children:[e.jsx(oe,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-lg font-medium text-gray-700",children:"ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ"}),e.jsx("p",{className:"text-sm text-gray-500",children:".xlsx, .xls, .xlsm íŒŒì¼ ì§€ì›"})]}),e.jsx(A,{onClick:se,disabled:T,className:"mt-6",size:"lg",children:T?"ì²˜ë¦¬ ì¤‘...":"íŒŒì¼ ì„ íƒ"})]}),m>0&&e.jsxs("div",{className:"mt-6 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm text-gray-600",children:[e.jsx("span",{children:"íŒŒì¼ ì²˜ë¦¬ ì¤‘..."}),e.jsxs("span",{children:[m,"%"]})]}),e.jsx(de,{value:m,className:"h-2"})]}),u&&e.jsxs(V,{className:"mt-6",children:[e.jsx(_,{className:"h-4 w-4"}),e.jsxs(K,{children:[e.jsx("strong",{children:u.name})," (",(u.size/1024).toFixed(1)," KB)"]})]})]})}),s.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sticky top-0 z-10 bg-white border rounded-lg shadow-sm p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 border rounded-lg px-3 py-2 bg-gray-50",children:[e.jsx("input",{type:"checkbox",id:"sendEmail",checked:l,onChange:t=>n(t.target.checked),className:"h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"}),e.jsxs("label",{htmlFor:"sendEmail",className:"flex items-center gap-1 text-sm text-gray-700 cursor-pointer",children:[e.jsx(Q,{className:"h-4 w-4"}),"ì´ë©”ì¼ ë°œì†¡"]})]}),e.jsx(A,{onClick:I,disabled:L.isPending,size:"lg",className:"bg-blue-600 hover:bg-blue-700",children:l?e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),L.isPending?"ì €ì¥ ë° ë°œì†¡ ì¤‘...":"ì €ì¥ ë° ë°œì†¡"]}):e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),L.isPending?"ì €ì¥ ì¤‘...":"ì €ì¥"]})}),e.jsxs(A,{onClick:ee,variant:"outline",size:"lg",children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"ì´ˆê¸°í™”"]})]}),e.jsxs(V,{className:"max-w-md",children:[e.jsx(M,{className:"h-4 w-4"}),e.jsx(K,{className:"text-xs",children:"ê° ì¹´ë“œì˜ í•„ë“œë¥¼ í´ë¦­í•˜ì—¬ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ìˆ˜ì •ì´ ì™„ë£Œë˜ë©´ 'ëª¨ë‘ ì €ì¥'ì„ í´ë¦­í•˜ì„¸ìš”."})]})]})}),e.jsx(Ne,{orders:s,onOrderUpdate:k,onOrderRemove:Y})]})]})})}export{De as default};
