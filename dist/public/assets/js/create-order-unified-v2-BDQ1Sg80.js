import{v as qe,r as u,j as e,ah as Z,a as te,p as ee,s as se,w as V,a8 as Y,B as v,X as ae,G as Be,h as he,m as de,L as N,I as J,P as le,A as Pe,D as Fe,E as ye,F as re,ak as Ve,c as Ke,b as Je}from"./index-BUw3hMUu.js";import{A as oe,a as ce}from"./alert-DwqmITSX.js";import{P as He}from"./progress-CEjk6_OL.js";import{D as Te,a as Ae,b as Oe,c as De,e as Me}from"./dialog-Bf60d9sl.js";import{S as G,a as X,b as W,c as Q,d as T}from"./select-BkkIjgpn.js";import{T as Ze}from"./target-CAWZ__vz.js";import{T as ue}from"./triangle-alert-D6-Ipduz.js";import{T as Le}from"./trending-up-DPFcS1bl.js";import{A as $e}from"./arrow-right-CWrHlww-.js";import{S as Ge}from"./search-CBVHZ41g.js";import{U as Ne}from"./upload-tMIRiBvp.js";import{T as ie}from"./textarea-D9jUoxnG.js";import{C as be}from"./calendar-CQNozZ0E.js";import{P as we,a as Ce,b as Se}from"./popover-CHImx2_G.js";import{C as ke}from"./calendar-B30Rzgil.js";import{T as Re}from"./trash-2-DXrtl5jn.js";import{f as Ee}from"./format-BqlaHE6C.js";import{k as Ie}from"./ko-DHTEdlBI.js";import{T as Xe,a as We,b as me,c as xe}from"./tabs-ChTUYA4Q.js";import{C as ne}from"./checkbox-UQiSXcUi.js";import{M as ge}from"./mail-BRfU35sq.js";import{R as ze}from"./refresh-cw-BuLFTthD.js";import{D as ve}from"./download-Bpxz8J6M.js";import{P as pe}from"./paperclip-PrGvDcc4.js";import{S as Qe}from"./save-D6DErD6w.js";import{S as Ye}from"./send-ine-CfK_.js";import{L as es}from"./list-C61iRuB4.js";import{I as je}from"./info-CQjPSDQm.js";import"./index-Dd0_pytC.js";import"./index-BdQq_4o_.js";import"./index-Ck6SuC6g.js";import"./chevron-down-hAfjdAl7.js";import"./chevron-up-BZtovOXM.js";import"./chevron-left-DT9hEQdt.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=qe("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]),ss=({isOpen:l,onClose:A,mappingItems:x,onApplyMappings:y})=>{const[E,d]=u.useState([]),[b,O]=u.useState(0),[j,k]=u.useState(!1),[L,M]=u.useState([]),[I,h]=u.useState([]),[f,P]=u.useState([]),[U,R]=u.useState([]),[w,z]=u.useState(!1);u.useEffect(()=>{d([...x]),O(0)},[x]),u.useEffect(()=>{l&&L.length===0&&K()},[l]);const K=async()=>{z(!0);try{const n=await fetch("/api/categories",{credentials:"include"});if(n.ok){const $=(await n.json()).flatCategories||[];M($),h($.filter(D=>D.categoryType==="major")),P($.filter(D=>D.categoryType==="middle")),R($.filter(D=>D.categoryType==="minor")),console.log("ğŸ“‹ ì „ì²´ ë¶„ë¥˜ ë¡œë“œ ì™„ë£Œ:",{total:$.length,major:$.filter(D=>D.categoryType==="major").length,middle:$.filter(D=>D.categoryType==="middle").length,minor:$.filter(D=>D.categoryType==="minor").length})}else console.error("âŒ ë¶„ë¥˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:",n.status)}catch(n){console.error("âŒ ë¶„ë¥˜ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:",n)}finally{z(!1)}},g=E[b];console.log("ğŸ” Current item data:",g),console.log("ğŸ” Mapping result DB data:",g?.mappingResult?.db);const B={total:E.length,resolved:E.filter(n=>n.userSelection||n.mappingResult.status==="exact_match").length,needsAttention:E.filter(n=>!n.userSelection&&n.mappingResult.status!=="exact_match").length},_=(n,S)=>{const $=[...E],D=$[b];D.userSelection||(D.userSelection={}),D.userSelection[`${n}Id`]=S,n==="major"?(D.userSelection.middleId=void 0,D.userSelection.minorId=void 0):n==="middle"&&(D.userSelection.minorId=void 0),d($)},q=()=>{const n=g?.userSelection?.majorId,S=g?.mappingResult?.db?.majorId;return console.log("ğŸ” getCurrentMajorId:",{userMajorId:n,autoMajorId:S,result:n||S}),n||S},i=()=>{const n=g?.userSelection?.middleId,S=g?.mappingResult?.db?.middleId;return console.log("ğŸ” getCurrentMiddleId:",{userMiddleId:n,autoMiddleId:S,result:n||S}),n||S},s=n=>n?f.filter(S=>S.parentId===n):[],t=n=>n?U.filter(S=>S.parentId===n):[],o=(n,S)=>{const $=g?.mappingResult?.suggestions?.filter(H=>H.type===n)||[];let D=[];n==="major"?D=I:n==="middle"?D=s(S):n==="minor"&&(D=t(S));const Ue=$.map(H=>H.id),_e=D.filter(H=>!Ue.includes(H.id));return[...$.map(H=>({...H,isSuggestion:!0})),..._e.map(H=>({...H,name:H.categoryName,type:H.categoryType,similarity:0,isSuggestion:!1}))]},c=()=>{b<E.length-1?O(b+1):m()},r=()=>{b<E.length-1?O(b+1):m()},a=()=>{b>0&&O(b-1)},m=async()=>{k(!0);try{await y(E),A()}catch(n){console.error("ë§¤í•‘ ì ìš© ì‹¤íŒ¨:",n)}finally{k(!1)}},p=n=>{switch(n){case"exact_match":return e.jsx(te,{className:"w-4 h-4 text-green-600"});case"partial_match":return e.jsx(ue,{className:"w-4 h-4 text-yellow-600"});case"no_match":return e.jsx(ae,{className:"w-4 h-4 text-red-600"});default:return e.jsx(Ge,{className:"w-4 h-4 text-gray-600"})}},F=n=>{switch(n){case"exact_match":return"bg-green-100 text-green-800 border-green-200";case"partial_match":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"no_match":return"bg-red-100 text-red-800 border-red-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},C=n=>n>=80?"text-green-600":n>=60?"text-yellow-600":"text-red-600";return!g&&!w?null:e.jsx(Te,{open:l,onOpenChange:A,children:e.jsxs(Ae,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Oe,{children:e.jsxs(De,{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"w-5 h-5 text-blue-600"}),"ë¶„ë¥˜ ë§¤í•‘ ê²€ì¦ ë° ìˆ˜ì •",w&&e.jsx(Z,{className:"w-4 h-4 animate-spin text-blue-600"})]})}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["ì§„í–‰ë¥ : ",b+1," / ",E.length]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"w-3 h-3 text-green-600"}),e.jsxs("span",{children:["í•´ê²°ë¨: ",B.resolved]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ue,{className:"w-3 h-3 text-yellow-600"}),e.jsxs("span",{children:["ê²€í†  í•„ìš”: ",B.needsAttention]})]})]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${(b+1)/E.length*100}%`}})})]}),w&&!g?e.jsx(ee,{className:"mb-6",children:e.jsx(se,{className:"p-4",children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Z,{className:"w-8 h-8 mx-auto mb-2 animate-spin text-blue-600"}),e.jsx("p",{className:"text-sm text-gray-600",children:"ë¶„ë¥˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."})]})})})}):g?e.jsx(ee,{className:"mb-6",children:e.jsxs(se,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-900",children:g.itemName}),e.jsxs("div",{className:"flex items-center gap-2",children:[p(g.mappingResult.status),e.jsxs(V,{className:F(g.mappingResult.status),children:[g.mappingResult.status==="exact_match"&&"ì™„ì „ ë§¤ì¹­",g.mappingResult.status==="partial_match"&&"ë¶€ë¶„ ë§¤ì¹­",g.mappingResult.status==="no_match"&&"ë§¤ì¹­ ì—†ìŒ",g.mappingResult.status==="invalid_hierarchy"&&"ê³„ì¸µ ì˜¤ë¥˜"]}),e.jsxs(V,{variant:"outline",className:Y("text-xs",C(g.mappingResult.confidence)),children:[e.jsx(Le,{className:"w-3 h-3 mr-1"}),"ì‹ ë¢°ë„: ",g.mappingResult.confidence,"%"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"ì—‘ì…€ ëŒ€ë¶„ë¥˜"}),e.jsx("div",{className:"p-2 bg-blue-50 rounded text-sm text-blue-800 min-h-[32px] flex items-center",children:g.originalCategories.major||"ì—†ìŒ"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"ì—‘ì…€ ì¤‘ë¶„ë¥˜"}),e.jsx("div",{className:"p-2 bg-blue-50 rounded text-sm text-blue-800 min-h-[32px] flex items-center",children:g.originalCategories.middle||"ì—†ìŒ"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"ì—‘ì…€ ì†Œë¶„ë¥˜"}),e.jsx("div",{className:"p-2 bg-blue-50 rounded text-sm text-blue-800 min-h-[32px] flex items-center",children:g.originalCategories.minor||"ì—†ìŒ"})]})]}),e.jsx("div",{className:"flex items-center justify-center py-2",children:e.jsx($e,{className:"w-5 h-5 text-gray-400"})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"ì‹œìŠ¤í…œ ëŒ€ë¶„ë¥˜"}),e.jsxs(G,{value:g.userSelection?.majorId?.toString()||g.mappingResult.db.majorId?.toString()||"",onValueChange:n=>_("major",parseInt(n)),disabled:w,children:[e.jsx(X,{className:"h-8",children:e.jsx(W,{placeholder:w?"ë¡œë”© ì¤‘...":"ëŒ€ë¶„ë¥˜ ì„ íƒ"})}),e.jsx(Q,{children:o("major").map(n=>e.jsx(T,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:n.isSuggestion?"font-medium text-blue-600":"",children:n.name}),n.isSuggestion&&n.similarity>0&&e.jsxs(V,{variant:"outline",className:"ml-2 text-xs bg-blue-50 text-blue-600 border-blue-200",children:[n.similarity,"%"]})]})},n.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"ì‹œìŠ¤í…œ ì¤‘ë¶„ë¥˜"}),e.jsxs(G,{value:g.userSelection?.middleId?.toString()||g.mappingResult.db.middleId?.toString()||"",onValueChange:n=>_("middle",parseInt(n)),disabled:w||!q(),children:[e.jsx(X,{className:"h-8",children:e.jsx(W,{placeholder:w?"ë¡œë”© ì¤‘...":q()?"ì¤‘ë¶„ë¥˜ ì„ íƒ":"ë¨¼ì € ëŒ€ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”"})}),e.jsx(Q,{children:o("middle",q()).map(n=>e.jsx(T,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:n.isSuggestion?"font-medium text-blue-600":"",children:n.name}),n.isSuggestion&&n.similarity>0&&e.jsxs(V,{variant:"outline",className:"ml-2 text-xs bg-blue-50 text-blue-600 border-blue-200",children:[n.similarity,"%"]})]})},n.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-500 mb-1 block",children:"ì‹œìŠ¤í…œ ì†Œë¶„ë¥˜"}),e.jsxs(G,{value:g.userSelection?.minorId?.toString()||g.mappingResult.db.minorId?.toString()||"",onValueChange:n=>_("minor",parseInt(n)),disabled:w||!i(),children:[e.jsx(X,{className:"h-8",children:e.jsx(W,{placeholder:w?"ë¡œë”© ì¤‘...":i()?"ì†Œë¶„ë¥˜ ì„ íƒ":"ë¨¼ì € ì¤‘ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”"})}),e.jsx(Q,{children:o("minor",i()).map(n=>e.jsx(T,{value:n.id.toString(),children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{className:n.isSuggestion?"font-medium text-blue-600":"",children:n.name}),n.isSuggestion&&n.similarity>0&&e.jsxs(V,{variant:"outline",className:"ml-2 text-xs bg-blue-50 text-blue-600 border-blue-200",children:[n.similarity,"%"]})]})},n.id))})]})]})]})]})}):null,g&&g.mappingResult.suggestions.length>0&&e.jsxs(oe,{className:"mb-6",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsxs(ce,{children:[e.jsx("div",{className:"font-medium mb-2",children:"ğŸ’¡ ì¶”ì²œ ë§¤í•‘:"}),e.jsx("div",{className:"text-sm space-y-1",children:g.mappingResult.suggestions.slice(0,3).map((n,S)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{children:[n.type==="major"&&"ëŒ€ë¶„ë¥˜: ",n.type==="middle"&&"ì¤‘ë¶„ë¥˜: ",n.type==="minor"&&"ì†Œë¶„ë¥˜: ",n.name]}),e.jsxs(V,{variant:"outline",className:"text-xs",children:["ìœ ì‚¬ë„ ",n.similarity,"%"]})]},S))})]})]}),e.jsxs(Me,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{variant:"outline",onClick:a,disabled:b===0||w,size:"sm",children:"ì´ì „"}),e.jsx(v,{variant:"outline",onClick:c,disabled:w,size:"sm",children:"ê±´ë„ˆë›°ê¸°"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{variant:"outline",onClick:A,disabled:j,children:"ì·¨ì†Œ"}),!w&&g&&(b<E.length-1?e.jsx(v,{onClick:r,disabled:j,children:"ë‹¤ìŒ"}):e.jsx(v,{onClick:m,disabled:j,className:"bg-blue-600 hover:bg-blue-700",children:j?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"w-4 h-4 mr-2 animate-spin"}),"ì ìš© ì¤‘..."]}):"ë§¤í•‘ ì ìš©"}))]})]})]})})},ts=({onDataExtracted:l,onProcessedFileReady:A})=>{const[x,y]=u.useState(!1),[E,d]=u.useState(!1),[b,O]=u.useState(null),[j,k]=u.useState("idle"),[L,M]=u.useState(""),[I,h]=u.useState([]),[f,P]=u.useState(0),[U,R]=u.useState(!1),[w,z]=u.useState([]),[K,g]=u.useState(null),B=u.useCallback(r=>{r.preventDefault(),y(!0)},[]),_=u.useCallback(r=>{r.preventDefault(),y(!1)},[]),q=u.useCallback(r=>{r.preventDefault(),y(!1);const a=Array.from(r.dataTransfer.files);console.log("ğŸ¯ [í´ë¼ì´ì–¸íŠ¸] ë“œë˜ê·¸ ë“œë¡­ íŒŒì¼:",{filesCount:a.length,fileDetails:a.map(p=>({name:p.name,type:p.type,size:p.size})),component:"ExcelUploadZone"});const m=a.find(p=>p.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||p.name.endsWith(".xlsx"));m?(console.log("âœ… [í´ë¼ì´ì–¸íŠ¸] Excel íŒŒì¼ ê°ì§€ë¨:",{fileName:m.name}),s(m)):(console.error("âŒ [í´ë¼ì´ì–¸íŠ¸] Excel íŒŒì¼ì´ ì•„ë‹˜:",{files:a.map(p=>p.name)}),M("ì—‘ì…€ íŒŒì¼(.xlsx)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤."),k("error"))},[]),i=r=>{const a=r.target.files?.[0];console.log("ğŸ“ [í´ë¼ì´ì–¸íŠ¸] íŒŒì¼ ì„ íƒ:",{hasFile:!!a,fileName:a?.name,fileSize:a?.size,fileType:a?.type,component:"ExcelUploadZone"}),a&&s(a)},s=async r=>{O(r),d(!0),k("processing"),M(""),console.log("ğŸ“¤ [í´ë¼ì´ì–¸íŠ¸] íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:",{fileName:r.name,fileSize:r.size,fileType:r.type,lastModified:new Date(r.lastModified).toISOString(),component:"ExcelUploadZone"});const a=new FormData;a.append("file",r);try{const m=await fetch("/api/po-template/upload",{method:"POST",credentials:"include",body:a});if(console.log("ğŸ“¥ [í´ë¼ì´ì–¸íŠ¸] ì„œë²„ ì‘ë‹µ ìˆ˜ì‹ :",{status:m.status,statusText:m.statusText,ok:m.ok,url:m.url,headers:Object.fromEntries(m.headers.entries())}),!m.ok)throw console.error("âŒ [í´ë¼ì´ì–¸íŠ¸] HTTP ì—ëŸ¬:",{status:m.status,statusText:m.statusText,component:"ExcelUploadZone"}),new Error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");const p=await m.json();if(console.log("ğŸ“‹ [í´ë¼ì´ì–¸íŠ¸] ì‘ë‹µ ë°ì´í„° ì²˜ë¦¬:",{success:p.success,ordersCount:p.data?.orders?.length||0,hasError:!!p.error,errorMessage:p.error,component:"ExcelUploadZone"}),p.success&&p.data.orders.length>0){h(p.data.orders),k("success");try{const F=await fetch("/api/po-template/extract-sheets",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({filePath:p.data.filePath,sheetNames:["ê°‘ì§€","ì„ì§€"]})});if(F.ok){const C=await F.json();if(C.success&&C.data.extractedPath){const S=`/uploads/${C.data.extractedPath.split("/").pop()}`,$=`${r.name.replace(".xlsx","")}_Inputì œê±°.xlsx`;console.log("ğŸ”· ì²˜ë¦¬ëœ Excel íŒŒì¼ ì •ë³´:",{processedFileUrl:S,processedFileName:$}),A?.({url:S,name:$})}}else{console.warn("âš ï¸ Extract sheets API ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©");const n=`/uploads/extracted-${Date.now()}.xlsx`,S=`${r.name.replace(".xlsx","")}_Inputì œê±°.xlsx`;A?.({url:n,name:S})}}catch(F){console.error("Extract sheets í˜¸ì¶œ ì‹¤íŒ¨:",F);const n=`/uploads/extracted-${Date.now()}.xlsx`,S=`${r.name.replace(".xlsx","")}_Inputì œê±°.xlsx`;A?.({url:n,name:S})}if(p.data.orders.length===1){const F=p.data.orders[0],C={...F,projectName:F.siteName||F.projectName,orderDate:F.orderDate,deliveryDate:F.dueDate||F.deliveryDate,items:(F.items||[]).map(n=>({...n,name:n.itemName||n.name,unit:n.unit||"EA"}))};await t(C)}}else throw new Error(p.error||"ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨")}catch(m){console.error("ğŸ’¥ [í´ë¼ì´ì–¸íŠ¸] íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:",{errorMessage:m.message,errorStack:m.stack,errorName:m.name,component:"ExcelUploadZone"}),M(m.message||"íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."),k("error")}finally{console.log("ğŸ [í´ë¼ì´ì–¸íŠ¸] íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ:",{component:"ExcelUploadZone",finalStatus:j}),d(!1)}},t=async r=>{if(console.log("ğŸ” ë¶„ë¥˜ ë§¤í•‘ ê²€ì¦ ì‹œì‘:",r),console.log("ğŸ” ì²« ë²ˆì§¸ ì•„ì´í…œ ìƒì„¸:",r.items?.[0]),!r.items||r.items.length===0){l(r);return}try{const a=r.items.map(C=>({majorCategory:C.majorCategory||C.categoryLv1||C.ëŒ€ë¶„ë¥˜,middleCategory:C.middleCategory||C.categoryLv2||C.ì¤‘ë¶„ë¥˜,minorCategory:C.minorCategory||C.categoryLv3||C.ì†Œë¶„ë¥˜}));console.log("ğŸ” ë¶„ë¥˜ ê²€ì¦ ìš”ì²­ ë°ì´í„°:",a);const m=await fetch("/api/categories/validate-mapping-batch",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({categories:a})});if(!m.ok)throw new Error("ë¶„ë¥˜ ê²€ì¦ API í˜¸ì¶œ ì‹¤íŒ¨");const p=await m.json();console.log("ğŸ” ë¶„ë¥˜ ê²€ì¦ ê²°ê³¼:",p);const F=p.results.filter(C=>C.status==="no_match"||C.status==="partial_match"||C.status==="invalid_hierarchy");if(F.length>0){console.log(`âš ï¸ ${F.length}ê°œ í’ˆëª©ì— ë¶„ë¥˜ ë§¤í•‘ ë¬¸ì œ ë°œê²¬`);const C=[];p.results.forEach((n,S)=>{if(n.status==="no_match"||n.status==="partial_match"||n.status==="invalid_hierarchy"){const $=r.items[S];C.push({itemName:$.itemName||$.name||`í’ˆëª© ${S+1}`,rowIndex:S,originalCategories:{major:n.excel.major,middle:n.excel.middle,minor:n.excel.minor},mappingResult:n})}}),g(r),z(C),R(!0)}else{console.log("âœ… ëª¨ë“  ë¶„ë¥˜ê°€ ì„±ê³µì ìœ¼ë¡œ ë§¤í•‘ë¨");const C={...r};C.items=r.items.map(n=>({...n,majorCategory:n.majorCategory||n.categoryLv1||n.ëŒ€ë¶„ë¥˜||"",middleCategory:n.middleCategory||n.categoryLv2||n.ì¤‘ë¶„ë¥˜||"",minorCategory:n.minorCategory||n.categoryLv3||n.ì†Œë¶„ë¥˜||""})),console.log("ğŸ”§ ì¹´í…Œê³ ë¦¬ í•„ë“œ ë§¤í•‘ ì™„ë£Œ:",C.items[0]),l(C)}}catch(a){console.error("âŒ ë¶„ë¥˜ ê²€ì¦ ì‹¤íŒ¨:",a),console.warn("ë¶„ë¥˜ ê²€ì¦ì— ì‹¤íŒ¨í–ˆì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.");const m={...r};m.items=r.items.map(p=>({...p,majorCategory:p.majorCategory||p.categoryLv1||p.ëŒ€ë¶„ë¥˜||"",middleCategory:p.middleCategory||p.categoryLv2||p.ì¤‘ë¶„ë¥˜||"",minorCategory:p.minorCategory||p.categoryLv3||p.ì†Œë¶„ë¥˜||""})),console.log("ğŸ”§ ì¹´í…Œê³ ë¦¬ í•„ë“œ ë§¤í•‘ ì™„ë£Œ (ê²€ì¦ ì‹¤íŒ¨ ì‹œ):",m.items[0]),l(m)}},o=async r=>{if(console.log("ğŸ”§ ì‚¬ìš©ì ë¶„ë¥˜ ë§¤í•‘ ì ìš©:",r),!K){console.error("âŒ ëŒ€ê¸° ì¤‘ì¸ ë°œì£¼ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");return}const a={...K};r.forEach(m=>{const p=a.items.findIndex(F=>(F.itemName||F.name)===m.itemName);if(p!==-1&&m.userSelection){const F=a.items[p];m.userSelection.majorId&&(F.majorCategoryId=m.userSelection.majorId),m.userSelection.middleId&&(F.middleCategoryId=m.userSelection.middleId),m.userSelection.minorId&&(F.minorCategoryId=m.userSelection.minorId)}}),R(!1),z([]),g(null),console.log("âœ… ë¶„ë¥˜ ë§¤í•‘ì´ ì ìš©ëœ ë°œì£¼ì„œ ë°ì´í„°:",a),l(a)},c=async()=>{if(I[f]&&b){const r=I[f],a={...r,projectName:r.siteName||r.projectName,orderDate:r.orderDate,deliveryDate:r.dueDate||r.deliveryDate,items:(r.items||[]).map(m=>({...m,name:m.itemName||m.name,unit:m.unit||"EA"}))};await t(a)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{onDragOver:B,onDragLeave:_,onDrop:q,className:`
          border-2 border-dashed rounded-lg ${j==="success"?"p-4":"p-8"} text-center transition-all
          ${x?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}
          ${E?"opacity-50 pointer-events-none":""}
        `,children:E?e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"w-8 h-8 mx-auto text-blue-600 animate-spin"}),e.jsx("p",{className:"text-sm text-gray-600",children:"íŒŒì¼ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤..."})]}):j==="success"?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(te,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-medium text-green-700",children:b?.name}),e.jsxs("p",{className:"text-xs text-gray-600",children:[I.length,"ê°œì˜ ë°œì£¼ì„œ ê°ì§€ë¨"]})]})]}),e.jsx(v,{variant:"outline",size:"sm",onClick:()=>{k("idle"),h([]),O(null)},children:"ë‹¤ì‹œ ì—…ë¡œë“œ"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Be,{className:"w-12 h-12 mx-auto text-gray-400 mb-4"}),e.jsx("p",{className:"text-lg font-medium text-gray-700 mb-2",children:"ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ë†“ìœ¼ì„¸ìš”"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"ë˜ëŠ”"}),e.jsx("input",{type:"file",accept:".xlsx",onChange:i,className:"hidden",id:"excel-upload"}),e.jsx("label",{htmlFor:"excel-upload",children:e.jsx(v,{variant:"outline",asChild:!0,children:e.jsxs("span",{className:"cursor-pointer",children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"íŒŒì¼ ì„ íƒ"]})})})]})}),j==="error"&&L&&e.jsxs(oe,{variant:"destructive",children:[e.jsx(he,{className:"h-4 w-4"}),e.jsx(ce,{children:L})]}),I.length>1&&j==="success"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700",children:"ë°œì£¼ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”:"}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto border rounded-lg p-2 bg-gray-50",children:I.map((r,a)=>e.jsx("div",{onClick:()=>P(a),className:`
                  p-3 border rounded-lg cursor-pointer transition-colors
                  ${f===a?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300 bg-white"}
                `,children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:r.orderNumber}),e.jsxs("p",{className:"text-xs text-gray-600",children:[r.vendorName," | ",r.projectName]})]}),e.jsxs(V,{variant:"secondary",children:[r.items?.length||0,"ê°œ í’ˆëª©"]})]}),r.items&&r.items.length>0&&e.jsxs("div",{className:"pt-2 border-t border-gray-200",children:[e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-gray-500",children:[e.jsx("th",{className:"text-left font-normal",children:"í’ˆëª©"}),e.jsx("th",{className:"text-right font-normal",children:"ìˆ˜ëŸ‰"}),e.jsx("th",{className:"text-right font-normal",children:"ë‹¨ê°€"}),e.jsx("th",{className:"text-right font-normal",children:"ê¸ˆì•¡"})]})}),e.jsx("tbody",{children:r.items.slice(0,2).map((m,p)=>e.jsxs("tr",{children:[e.jsx("td",{className:"text-gray-600 truncate max-w-[150px] pr-2",children:m.itemName}),e.jsx("td",{className:"text-right text-gray-700",children:Math.floor(m.quantity||0).toLocaleString()}),e.jsx("td",{className:"text-right text-gray-700",children:Math.floor(m.unitPrice||0).toLocaleString()}),e.jsx("td",{className:"text-right font-medium",children:Math.floor(m.totalAmount||0).toLocaleString()})]},p))})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[r.items.length>2&&e.jsxs("p",{className:"text-xs text-gray-500 italic",children:["ì™¸ ",r.items.length-2,"ê°œ"]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-xs text-gray-600 mr-2",children:"ì´ì•¡"}),e.jsxs("span",{className:"text-sm font-semibold text-blue-600",children:[Math.floor(r.totalAmount||r.items.reduce((m,p)=>m+(p.totalAmount||0),0)).toLocaleString(),"ì›"]})]})]})]})]})},a))}),e.jsx(v,{onClick:c,className:"w-full",size:"sm",children:"ì„ íƒí•œ ë°œì£¼ì„œ ì‚¬ìš©"})]}),e.jsx(ss,{isOpen:U,onClose:()=>{R(!1),z([]),g(null)},mappingItems:w,onApplyMappings:o})]})},rs=({initialData:l={},onChange:A})=>{const[x,y]=u.useState({orderNumber:l.orderNumber||`PO-${new Date().getTime()}`,orderDate:l.orderDate||new Date,deliveryDate:l.deliveryDate||new Date(Date.now()+6048e5),projectId:l.projectId||"",projectName:l.projectName||"",vendorId:l.vendorId||"",vendorName:l.vendorName||"",vendorEmail:l.vendorEmail||"",items:l.items||[{itemName:"",specification:"",unit:"EA",quantity:1,unitPrice:0,totalAmount:0,majorCategory:"",middleCategory:"",minorCategory:"",notes:""}],notes:l.notes||"",totalAmount:l.totalAmount||0}),{data:E,isLoading:d,error:b}=de({queryKey:["projects"],queryFn:async()=>{console.log("ğŸ” í”„ë¡œì íŠ¸ ëª©ë¡ ì¡°íšŒ ì‹œì‘");const i=await fetch("/api/projects",{credentials:"include"});if(!i.ok)throw new Error("í”„ë¡œì íŠ¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨");const s=await i.json();return console.log("âœ… í”„ë¡œì íŠ¸ ëª©ë¡ ì¡°íšŒ ì„±ê³µ:",s.length,"ê°œ"),s}}),{data:O,isLoading:j,error:k}=de({queryKey:["vendors"],queryFn:async()=>{console.log("ğŸ” ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ ì‹œì‘");const i=await fetch("/api/vendors",{credentials:"include"});if(!i.ok)throw new Error("ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨");const s=await i.json();return console.log("âœ… ê±°ë˜ì²˜ ëª©ë¡ ì¡°íšŒ ì„±ê³µ:",s.length,"ê°œ"),s}}),{data:L,isLoading:M,error:I}=de({queryKey:["categories"],queryFn:async()=>{console.log("ğŸ” ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¡°íšŒ ì‹œì‘");const i=await fetch("/api/item-categories",{credentials:"include"});if(!i.ok)throw new Error("ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨");const s=await i.json();return console.log("âœ… ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¡°íšŒ ì„±ê³µ:",s?.length,"ê°œ"),{categories:s}}}),h=u.useRef({}),f=u.useRef(!0);u.useEffect(()=>{if(l&&Object.keys(l).length>0){const i=h.current;(f.current||l.orderNumber!==i.orderNumber||l.projectName!==i.projectName||l.vendorName!==i.vendorName||l.items?.length!==i.items?.length)&&(console.log("ğŸ“ DirectInputForm: initialData ìœ ì˜ë¯¸í•œ ë³€ê²½ ê°ì§€",{isInitialLoad:f.current,orderNumber:l.orderNumber}),y({orderNumber:l.orderNumber||`PO-${new Date().getTime()}`,orderDate:l.orderDate?new Date(l.orderDate):new Date,deliveryDate:l.deliveryDate?new Date(l.deliveryDate):new Date(Date.now()+7*24*60*60*1e3),projectId:l.projectId||"",projectName:l.projectName||"",vendorId:l.vendorId||"",vendorName:l.vendorName||"",vendorEmail:l.vendorEmail||"",items:l.items||[{itemName:"",specification:"",unit:"EA",quantity:1,unitPrice:0,totalAmount:0,majorCategory:"",middleCategory:"",minorCategory:"",notes:""}],notes:l.notes||"",totalAmount:l.totalAmount||0}),h.current=l,f.current=!1)}},[l]),u.useEffect(()=>{const i=x.items.reduce((s,t)=>s+(t.totalAmount||0),0);i!==x.totalAmount&&y(s=>({...s,totalAmount:i}))},[x.items]),u.useEffect(()=>{const i=setTimeout(()=>{A(x)},100);return()=>clearTimeout(i)},[x.orderNumber,x.projectName,x.vendorName,x.vendorEmail,x.totalAmount,x.items.length]);const P=(i,s)=>{y(t=>({...t,[i]:s}))},U=i=>{const s=E?.find(t=>t.id.toString()===i);s&&y(t=>({...t,projectId:i,projectName:s.projectName}))},R=i=>{const s=O?.find(t=>t.id.toString()===i);s&&y(t=>({...t,vendorId:i,vendorName:s.name,vendorEmail:s.email||""}))},w=(i,s,t)=>{const o=[...x.items];o[i]={...o[i],[s]:t},(s==="quantity"||s==="unitPrice")&&(o[i].totalAmount=o[i].quantity*o[i].unitPrice),y(c=>({...c,items:o}))},z=()=>{y(i=>({...i,items:[...i.items,{itemName:"",specification:"",unit:"EA",quantity:1,unitPrice:0,totalAmount:0,majorCategory:"",middleCategory:"",minorCategory:"",notes:""}]}))},K=i=>{if(x.items.length>1){const s=x.items.filter((t,o)=>o!==i);y(t=>({...t,items:s}))}},g=()=>L?.categories?.filter(i=>i.categoryType==="major")||[],B=i=>{const s=L?.categories?.find(t=>t.categoryType==="major"&&t.categoryName===i);return s?L?.categories?.filter(t=>t.categoryType==="middle"&&t.parentId===s.id)||[]:[]},_=i=>{const s=L?.categories?.find(t=>t.categoryType==="middle"&&t.categoryName===i);return s?L?.categories?.filter(t=>t.categoryType==="minor"&&t.parentId===s.id)||[]:[]},q=(i,s,t)=>{const o=[...x.items],c=o[i];if(s==="major"){const r=g().find(a=>a.id.toString()===t);c.majorCategory=r?.categoryName||"",c.middleCategory="",c.minorCategory=""}else if(s==="middle"){const r=B(c.majorCategory).find(a=>a.id.toString()===t);c.middleCategory=r?.categoryName||"",c.minorCategory=""}else if(s==="minor"){const r=_(c.middleCategory).find(a=>a.id.toString()===t);c.minorCategory=r?.categoryName||""}y(r=>({...r,items:o}))};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ê¸°ë³¸ ì •ë³´"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"orderNumber",children:"ë°œì£¼ë²ˆí˜¸"}),e.jsx(J,{id:"orderNumber",value:x.orderNumber,onChange:i=>P("orderNumber",i.target.value),placeholder:"PO-20240101-001"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ë°œì£¼ì¼"}),e.jsxs(we,{children:[e.jsx(Ce,{asChild:!0,children:e.jsxs(v,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),Ee(x.orderDate,"PPP",{locale:Ie})]})}),e.jsx(Se,{className:"w-auto p-0",children:e.jsx(be,{mode:"single",selected:x.orderDate,onSelect:i=>i&&P("orderDate",i),initialFocus:!0})})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"í˜„ì¥"}),e.jsxs(G,{value:x.projectId,onValueChange:U,children:[e.jsx(X,{children:e.jsx(W,{placeholder:d?"ë¡œë”© ì¤‘...":b?"ë¡œë”© ì‹¤íŒ¨":"í˜„ì¥ ì„ íƒ"})}),e.jsxs(Q,{children:[d&&e.jsx(T,{value:"loading",disabled:!0,children:"ë¡œë”© ì¤‘..."}),b&&e.jsx(T,{value:"error",disabled:!0,children:"ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"}),E?.map(i=>e.jsx(T,{value:i.id.toString(),children:i.projectName},i.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ë‚©ê¸°ì¼"}),e.jsxs(we,{children:[e.jsx(Ce,{asChild:!0,children:e.jsxs(v,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),Ee(x.deliveryDate,"PPP",{locale:Ie})]})}),e.jsx(Se,{className:"w-auto p-0",children:e.jsx(be,{mode:"single",selected:x.deliveryDate,onSelect:i=>i&&P("deliveryDate",i),initialFocus:!0})})]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ê±°ë˜ì²˜ ì •ë³´"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ê±°ë˜ì²˜"}),e.jsxs(G,{value:x.vendorId,onValueChange:R,children:[e.jsx(X,{children:e.jsx(W,{placeholder:j?"ë¡œë”© ì¤‘...":k?"ë¡œë”© ì‹¤íŒ¨":"ê±°ë˜ì²˜ ì„ íƒ"})}),e.jsxs(Q,{children:[j&&e.jsx(T,{value:"loading",disabled:!0,children:"ë¡œë”© ì¤‘..."}),k&&e.jsx(T,{value:"error",disabled:!0,children:"ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"}),O?.map(i=>e.jsx(T,{value:i.id.toString(),children:i.name},i.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"vendorEmail",children:"ì´ë©”ì¼"}),e.jsx(J,{id:"vendorEmail",type:"email",value:x.vendorEmail,onChange:i=>P("vendorEmail",i.target.value),placeholder:"vendor@example.com"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"í’ˆëª© ì •ë³´"}),e.jsxs(v,{onClick:z,size:"sm",variant:"outline",children:[e.jsx(le,{className:"w-4 h-4 mr-1"}),"í’ˆëª© ì¶”ê°€"]})]}),e.jsx("div",{className:"space-y-4",children:x.items.map((i,s)=>e.jsxs("div",{className:"p-4 border rounded-lg space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"í’ˆëª©ëª…"}),e.jsx(J,{value:i.itemName,onChange:t=>w(s,"itemName",t.target.value),placeholder:"í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ê·œê²©"}),e.jsx(J,{value:i.specification,onChange:t=>w(s,"specification",t.target.value),placeholder:"ê·œê²©ì„ ì…ë ¥í•˜ì„¸ìš”"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ë‹¨ìœ„"}),e.jsxs(G,{value:i.unit,onValueChange:t=>w(s,"unit",t),children:[e.jsx(X,{children:e.jsx(W,{placeholder:"ë‹¨ìœ„ ì„ íƒ"})}),e.jsxs(Q,{children:[e.jsx(T,{value:"EA",children:"EA"}),e.jsx(T,{value:"M",children:"M"}),e.jsx(T,{value:"M2",children:"MÂ²"}),e.jsx(T,{value:"M3",children:"MÂ³"}),e.jsx(T,{value:"KG",children:"KG"}),e.jsx(T,{value:"TON",children:"TON"}),e.jsx(T,{value:"SET",children:"SET"}),e.jsx(T,{value:"BOX",children:"BOX"}),e.jsx(T,{value:"ROLL",children:"ROLL"}),e.jsx(T,{value:"L",children:"L"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ëŒ€ë¶„ë¥˜"}),e.jsxs(G,{value:i.majorCategory?g().find(t=>t.categoryName===i.majorCategory)?.id.toString():"",onValueChange:t=>q(s,"major",t),children:[e.jsx(X,{children:e.jsx(W,{placeholder:M?"ë¡œë”© ì¤‘...":I?"ë¡œë”© ì‹¤íŒ¨":"ëŒ€ë¶„ë¥˜ ì„ íƒ"})}),e.jsxs(Q,{children:[M&&e.jsx(T,{value:"loading",disabled:!0,children:"ë¡œë”© ì¤‘..."}),I&&e.jsx(T,{value:"error",disabled:!0,children:"ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"}),g().map(t=>e.jsx(T,{value:t.id.toString(),children:t.categoryName},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ì¤‘ë¶„ë¥˜"}),e.jsxs(G,{value:i.middleCategory?B(i.majorCategory).find(t=>t.categoryName===i.middleCategory)?.id.toString():"",onValueChange:t=>q(s,"middle",t),disabled:!i.majorCategory,children:[e.jsx(X,{children:e.jsx(W,{placeholder:i.majorCategory?"ì¤‘ë¶„ë¥˜ ì„ íƒ":"ëŒ€ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"})}),e.jsx(Q,{children:B(i.majorCategory).map(t=>e.jsx(T,{value:t.id.toString(),children:t.categoryName},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ì†Œë¶„ë¥˜"}),e.jsxs(G,{value:i.minorCategory?_(i.middleCategory).find(t=>t.categoryName===i.minorCategory)?.id.toString():"",onValueChange:t=>q(s,"minor",t),disabled:!i.middleCategory,children:[e.jsx(X,{children:e.jsx(W,{placeholder:i.middleCategory?"ì†Œë¶„ë¥˜ ì„ íƒ":"ì¤‘ë¶„ë¥˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"})}),e.jsx(Q,{children:_(i.middleCategory).map(t=>e.jsx(T,{value:t.id.toString(),children:t.categoryName},t.id))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ìˆ˜ëŸ‰"}),e.jsx(J,{type:"number",value:i.quantity,onChange:t=>w(s,"quantity",Number(t.target.value)),min:"1",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ë‹¨ê°€"}),e.jsx(J,{type:"number",value:i.unitPrice,onChange:t=>w(s,"unitPrice",Number(t.target.value)),min:"0",step:"0.01"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ê¸ˆì•¡"}),e.jsxs("div",{className:"px-3 py-2 bg-muted border rounded-md text-sm font-medium text-foreground",children:[i.totalAmount.toLocaleString(),"ì›"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ì‘ì—…"}),e.jsxs(v,{onClick:()=>K(s),size:"sm",variant:"outline",className:"w-full text-red-600 border-red-200 hover:bg-red-50",disabled:x.items.length===1,children:[e.jsx(Re,{className:"w-4 h-4 mr-1"}),"ì‚­ì œ"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"í’ˆëª© ë¹„ê³ "}),e.jsx(ie,{value:i.notes,onChange:t=>w(s,"notes",t.target.value),placeholder:"ì´ í’ˆëª©ì— ëŒ€í•œ íŠ¹ë³„ ìš”ì²­ì‚¬í•­ì´ë‚˜ ì°¸ê³ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”",rows:2})]})]},s))}),e.jsx("div",{className:"flex justify-end p-3 bg-muted rounded-lg",children:e.jsxs("div",{className:"text-lg font-semibold text-foreground",children:["ì´ì•¡: ",x.totalAmount.toLocaleString(),"ì›"]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"notes",children:"ë¹„ê³ "}),e.jsx(ie,{id:"notes",value:x.notes,onChange:i=>P("notes",i.target.value),placeholder:"ì¶”ê°€ ìš”ì²­ì‚¬í•­ì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”",rows:3})]})]})},as=({orderData:l,pdfUrl:A,processingStatus:x})=>{const[y,E]=u.useState([l.vendorEmail||""]),[d,b]=u.useState([]),[O,j]=u.useState(`ë°œì£¼ì„œ - ${l.orderNumber||""}`),[k,L]=u.useState("info");u.useState(!1);const[M,I]=u.useState([]),[h,f]=u.useState([]),[P,U]=u.useState(()=>`ì•ˆë…•í•˜ì„¸ìš”,

${l.vendorName||"ê±°ë˜ì²˜"} ë‹´ë‹¹ìë‹˜

ë°œì£¼ì„œë¥¼ ì²¨ë¶€í•˜ì—¬ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.

ë°œì£¼ë²ˆí˜¸: ${l.orderNumber||"-"}
í”„ë¡œì íŠ¸: ${l.projectName||"-"}
ë‚©ê¸°ì¼: ${l.deliveryDate?new Date(l.deliveryDate).toLocaleDateString("ko-KR"):"-"}

í™•ì¸ í›„ íšŒì‹  ë¶€íƒë“œë¦½ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`);u.useEffect(()=>{U(`ì•ˆë…•í•˜ì„¸ìš”,

${l.vendorName||"ê±°ë˜ì²˜"} ë‹´ë‹¹ìë‹˜

ë°œì£¼ì„œë¥¼ ì²¨ë¶€í•˜ì—¬ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.

ë°œì£¼ë²ˆí˜¸: ${l.orderNumber||"-"}
í”„ë¡œì íŠ¸: ${l.projectName||"-"}
ë‚©ê¸°ì¼: ${l.deliveryDate?new Date(l.deliveryDate).toLocaleDateString("ko-KR"):"-"}

í™•ì¸ í›„ íšŒì‹  ë¶€íƒë“œë¦½ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`)},[l.vendorName,l.orderNumber,l.projectName,l.deliveryDate]),u.useEffect(()=>{const s=[];l.processedExcelUrl&&s.push({id:"processed-excel",name:l.originalFileName||"ì²˜ë¦¬ëœ_Excel_íŒŒì¼.xlsx",size:0,type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",url:l.processedExcelUrl,isDefault:!0,isSelected:!0}),A&&x.pdf==="completed"&&s.push({id:"generated-pdf",name:`ë°œì£¼ì„œ_${l.orderNumber||"generated"}.pdf`,size:0,type:"application/pdf",url:A,isDefault:!0,isSelected:!0}),I(t=>{const o=t.filter(c=>!c.isDefault);return[...s,...o]})},[l.processedExcelUrl,A,x.pdf,l.orderNumber]);const R=s=>{s==="to"?E([...y,""]):b([...d,""])},w=(s,t)=>{s==="to"&&y.length>1?E(y.filter((o,c)=>c!==t)):s==="cc"&&b(d.filter((o,c)=>c!==t))},z=(s,t,o)=>{if(s==="to"){const c=[...y];c[t]=o,E(c)}else{const c=[...d];c[t]=o,b(c)}},K=async s=>{const t=Array.from(s);for(const o of t){const c=`custom-${Date.now()}-${Math.random()}`;f(r=>[...r,c]);try{const r={id:c,name:o.name,size:o.size,type:o.type,file:o,isDefault:!1,isSelected:!0};I(a=>[...a,r])}catch(r){console.error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:",r)}finally{f(r=>r.filter(a=>a!==c))}}},g=s=>{I(t=>t.map(o=>o.id===s?{...o,isSelected:!o.isSelected}:o))},B=s=>{I(t=>t.filter(o=>o.id!==s))},_=s=>{if(s===0)return"0 Bytes";const t=1024,o=["Bytes","KB","MB","GB"],c=Math.floor(Math.log(s)/Math.log(t));return parseFloat((s/Math.pow(t,c)).toFixed(2))+" "+o[c]},q=s=>s.includes("pdf")?e.jsx(re,{className:"w-4 h-4 text-red-600"}):s.includes("spreadsheet")||s.includes("excel")?e.jsx(re,{className:"w-4 h-4 text-green-600"}):e.jsx(pe,{className:"w-4 h-4 text-gray-600"}),i=s=>{switch(s){case"completed":return e.jsx(te,{className:"w-4 h-4 text-green-600"});case"processing":return e.jsx(Z,{className:"w-4 h-4 text-blue-600 animate-spin"});case"error":return e.jsx(he,{className:"w-4 h-4 text-red-600"});default:return null}};return e.jsxs(ee,{className:"h-full",children:[e.jsx(Pe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Fe,{children:"ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(V,{variant:x.pdf==="completed"?"success":"secondary",children:[i(x.pdf),e.jsx("span",{className:"ml-1",children:"PDF"})]}),e.jsxs(V,{variant:x.vendor==="completed"?"success":"secondary",children:[i(x.vendor),e.jsx("span",{className:"ml-1",children:"ê±°ë˜ì²˜"})]}),e.jsxs(V,{variant:x.email==="completed"?"success":"secondary",children:[i(x.email),e.jsx("span",{className:"ml-1",children:"ì´ë©”ì¼"})]})]})]})}),e.jsx(se,{className:"h-[calc(100%-5rem)]",children:e.jsxs(Xe,{value:k,onValueChange:L,className:"h-full",children:[e.jsxs(We,{className:"grid w-full grid-cols-3",children:[e.jsxs(me,{value:"info",children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"ë°œì£¼ì„œ ì •ë³´"]}),e.jsxs(me,{value:"pdf",children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"PDF ë¯¸ë¦¬ë³´ê¸°"]}),e.jsxs(me,{value:"email",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"ì´ë©”ì¼ ì„¤ì •"]})]}),e.jsx(xe,{value:"pdf",className:"h-[calc(100%-3rem)]",children:x.pdf==="processing"?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(Z,{className:"w-12 h-12 mx-auto text-blue-600 animate-spin"}),e.jsx("p",{className:"text-sm text-gray-600",children:"PDFë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."})]})}):x.pdf==="error"?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(he,{className:"w-12 h-12 mx-auto text-red-600"}),e.jsx("p",{className:"text-sm text-red-600",children:"PDF ìƒì„± ì‹¤íŒ¨"}),e.jsxs(v,{variant:"outline",size:"sm",children:[e.jsx(ze,{className:"w-4 h-4 mr-2"}),"ë‹¤ì‹œ ì‹œë„"]})]})}):A&&x.pdf==="completed"?e.jsx("div",{className:"w-full h-full flex flex-col",children:e.jsx("div",{className:"flex-1 bg-gray-50 rounded-lg p-8 flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(te,{className:"w-16 h-16 mx-auto text-green-600"}),e.jsx("h3",{className:"text-lg font-medium",children:"PDFê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"}),e.jsx("p",{className:"text-sm text-gray-600",children:"ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ PDFë¥¼ í™•ì¸í•˜ì„¸ìš”"}),e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-6",children:[e.jsxs(v,{variant:"default",onClick:()=>window.open(A,"_blank"),children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"PDF ë¯¸ë¦¬ë³´ê¸°"]}),e.jsxs(v,{variant:"outline",onClick:()=>window.open(`${A}?download=true`,"_blank"),children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"PDF ë‹¤ìš´ë¡œë“œ"]})]})]})})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx(re,{className:"w-12 h-12 mx-auto text-gray-400"}),e.jsx("p",{className:"text-sm text-gray-600",children:"ë°œì£¼ì„œ ì •ë³´ê°€ ì™„ì„±ë˜ë©´ PDFê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤"}),e.jsx("p",{className:"text-xs text-gray-500",children:"ë¨¼ì € 'ë°œì£¼ì„œ ì •ë³´' íƒ­ì—ì„œ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”"})]})})}),e.jsxs(xe,{value:"info",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-gray-600",children:"ë°œì£¼ë²ˆí˜¸"}),e.jsx("p",{className:"font-medium",children:l.orderNumber||"-"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-gray-600",children:"ë°œì£¼ì¼"}),e.jsx("p",{className:"font-medium",children:l.orderDate?new Date(l.orderDate).toLocaleDateString("ko-KR"):"-"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-gray-600",children:"í”„ë¡œì íŠ¸"}),e.jsx("p",{className:"font-medium",children:l.projectName||"-"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-gray-600",children:"ê±°ë˜ì²˜"}),e.jsx("p",{className:"font-medium",children:l.vendorName||"-"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-gray-600",children:"ë‚©ê¸°ì¼"}),e.jsx("p",{className:"font-medium",children:l.deliveryDate?new Date(l.deliveryDate).toLocaleDateString("ko-KR"):"-"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-gray-600",children:"ì´ì•¡"}),e.jsx("p",{className:"font-medium text-lg text-blue-600",children:l.totalAmount?`${Math.floor(l.totalAmount).toLocaleString()}ì›`:"-"})]})]}),l.items&&l.items.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{className:"text-xs text-gray-600",children:"í’ˆëª© ëª©ë¡"}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left p-2",children:"í’ˆëª©ëª…"}),e.jsx("th",{className:"text-right p-2",children:"ìˆ˜ëŸ‰"}),e.jsx("th",{className:"text-right p-2",children:"ë‹¨ê°€"}),e.jsx("th",{className:"text-right p-2",children:"ê¸ˆì•¡"})]})}),e.jsx("tbody",{children:l.items.map((s,t)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"p-2",children:s.itemName||s.name}),e.jsx("td",{className:"text-right p-2",children:Math.floor(s.quantity||0).toLocaleString()}),e.jsxs("td",{className:"text-right p-2",children:[Math.floor(s.unitPrice||0).toLocaleString(),"ì›"]}),e.jsxs("td",{className:"text-right p-2",children:[Math.floor(s.totalAmount||s.quantity*s.unitPrice||0).toLocaleString(),"ì›"]})]},t))})]})})]})]}),e.jsx(xe,{value:"email",className:"space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(N,{children:"ë°›ëŠ” ì‚¬ëŒ"}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>R("to"),children:e.jsx(le,{className:"w-4 h-4"})})]}),y.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{type:"email",value:s,onChange:o=>z("to",t,o.target.value),placeholder:"email@example.com"}),y.length>1&&e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>w("to",t),children:e.jsx(ae,{className:"w-4 h-4"})})]},t))]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(N,{children:"ì°¸ì¡° (CC)"}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>R("cc"),children:e.jsx(le,{className:"w-4 h-4"})})]}),d.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{type:"email",value:s,onChange:o=>z("cc",t,o.target.value),placeholder:"cc@example.com"}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>w("cc",t),children:e.jsx(ae,{className:"w-4 h-4"})})]},t))]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ì œëª©"}),e.jsx(J,{value:O,onChange:s=>j(s.target.value),placeholder:"ì´ë©”ì¼ ì œëª©"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"ë©”ì¼ ë³¸ë¬¸"}),e.jsx(ie,{value:P,onChange:s=>U(s.target.value),placeholder:"ì´ë©”ì¼ ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”",className:"min-h-[200px] font-mono text-sm",rows:10})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(N,{children:"ì²¨ë¶€íŒŒì¼"}),e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept=".pdf,.xlsx,.xls,.doc,.docx,.txt",s.onchange=t=>{const o=t.target;o.files&&o.files.length>0&&K(o.files)},s.click()},children:[e.jsx(Ne,{className:"w-4 h-4 mr-2"}),"íŒŒì¼ ì¶”ê°€"]})]}),e.jsx("div",{className:"space-y-3",children:M.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-center py-4",children:"ì²¨ë¶€í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"}):M.map(s=>e.jsxs("div",{className:"flex items-center gap-3 p-3 border rounded-lg bg-gray-50",children:[e.jsx(ne,{checked:s.isSelected,onCheckedChange:()=>g(s.id)}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[q(s.type),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsx("span",{children:_(s.size)}),s.isDefault&&e.jsx(V,{variant:"secondary",className:"text-xs",children:"ê¸°ë³¸íŒŒì¼"})]})]})]}),h.includes(s.id)&&e.jsx(Z,{className:"w-4 h-4 animate-spin text-blue-600"}),!s.isDefault&&!h.includes(s.id)&&e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>B(s.id),children:e.jsx(Re,{className:"w-4 h-4 text-red-600"})})]},s.id))}),M.length>0&&e.jsx("div",{className:"p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:["ì„ íƒëœ íŒŒì¼: ",M.filter(s=>s.isSelected).length,"/",M.length,"ê°œ"]})})]})]})})]})})]})},ls=({orderData:l,pdfUrl:A,processingStatus:x,onSave:y,onSend:E,onDownload:d,onCreateOrder:b,onCreateOrderWithEmail:O})=>{const{isCollapsed:j}=Ve(),[k,L]=u.useState(!0),[M,I]=u.useState(!1),[h,f]=u.useState({to:[l.vendorEmail||""].filter(Boolean),cc:[],subject:`ë°œì£¼ì„œ - ${l.orderNumber||""} (${new Date().toLocaleDateString("ko-KR")})`,message:`ì•ˆë…•í•˜ì„¸ìš”,

ì²¨ë¶€ëœ ë°œì£¼ì„œë¥¼ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤.`,attachments:{includeExcel:!0,includePdf:!0,additionalFiles:[]}}),[P,U]=u.useState(""),[R,w]=u.useState("");u.useEffect(()=>{const r=l.vendorEmail||"",a=r?[r]:[];console.log("ğŸ” orderData ë³€ê²½ ê°ì§€:",{vendorEmail:r,newToEmails:a}),f(m=>({...m,to:a,subject:`ë°œì£¼ì„œ - ${l.orderNumber||""} (${new Date().toLocaleDateString("ko-KR")})`}))},[l.vendorEmail,l.orderNumber]);const z=()=>{P.trim()&&!h.to.includes(P.trim())&&(f(r=>({...r,to:[...r.to,P.trim()]})),U(""))},K=r=>{f(a=>({...a,to:a.to.filter(m=>m!==r)}))},g=()=>{R.trim()&&!h.cc.includes(R.trim())&&(f(r=>({...r,cc:[...r.cc,R.trim()]})),w(""))},B=r=>{f(a=>({...a,cc:a.cc.filter(m=>m!==r)}))},_=r=>{const a=Array.from(r.target.files||[]);f(m=>({...m,attachments:{...m.attachments,additionalFiles:[...m.attachments.additionalFiles,...a]}}))},q=r=>{f(a=>({...a,attachments:{...a.attachments,additionalFiles:a.attachments.additionalFiles.filter((m,p)=>p!==r)}}))},i=x.pdf==="completed"&&x.vendor==="completed"&&h.to.length>0,s=l.orderNumber&&l.vendorName&&l.projectName&&l.items?.length>0,t=Object.values(x).some(r=>r==="processing"),o=()=>{k&&O?I(!0):b()},c=()=>{I(!1),O&&O(h)};return e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 bg-background border-t border-border shadow-lg z-30",children:[e.jsxs("div",{className:Y("container mx-auto px-6 py-4 transition-all duration-300",j?"xl:ml-16":"xl:ml-64"),children:[e.jsxs("div",{className:"flex flex-col gap-3 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 bg-muted rounded-lg text-sm",children:[e.jsx(ne,{id:"send-email",checked:k,onCheckedChange:r=>L(!!r),className:"h-4 w-4"}),e.jsx("label",{htmlFor:"send-email",className:"font-medium cursor-pointer text-foreground whitespace-nowrap text-xs",children:"ë°œì£¼ì„œ ìƒì„± í›„ ì´ë©”ì¼ ìë™ ë°œì†¡"}),t&&e.jsxs("div",{className:"flex items-center gap-1 ml-2 text-xs text-muted-foreground",children:[e.jsx(Z,{className:"w-3 h-3 animate-spin"}),"ì²˜ë¦¬ ì¤‘"]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 flex-wrap",children:[e.jsxs(v,{variant:"outline",onClick:y,disabled:t,size:"sm",className:"text-xs px-3 py-2 h-8",children:[e.jsx(Qe,{className:"w-3 h-3 mr-1"}),"ì„ì‹œì €ì¥"]}),e.jsxs(v,{variant:"outline",onClick:d,disabled:!A||x.pdf!=="completed",size:"sm",className:"text-xs px-3 py-2 h-8",children:[e.jsx(ve,{className:"w-3 h-3 mr-1"}),"ë‹¤ìš´ë¡œë“œ"]}),!k&&e.jsx(v,{onClick:E,disabled:!i||x.email==="processing",size:"sm",className:Y("text-xs px-3 py-2 h-8",i?"bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700":""),children:x.email==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"w-3 h-3 mr-1 animate-spin"}),"ë°œì†¡ì¤‘"]}):e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"w-3 h-3 mr-1"}),"ì´ë©”ì¼ ë°œì†¡"]})}),e.jsx(v,{variant:"default",onClick:o,disabled:!s||x.order==="processing",size:"sm",className:Y("text-xs px-4 py-2 h-8 font-medium",s?k?"bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700":"bg-green-600 hover:bg-green-700 dark:bg-green-600 dark:hover:bg-green-700":""),children:x.order==="processing"?e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"w-3 h-3 mr-1 animate-spin"}),k?"ìƒì„± ë° ë°œì†¡ ì¤‘":"ìƒì„± ì¤‘"]}):e.jsx(e.Fragment,{children:k?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-3 h-3 mr-1"}),"ë°œì£¼ì„œ ìƒì„± ë° ë°œì†¡"]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-3 h-3 mr-1"}),"ë°œì£¼ì„œ ìƒì„±"]})})}),e.jsxs(v,{variant:"ghost",onClick:()=>window.location.href="/orders",disabled:t,size:"sm",className:"text-xs px-3 py-2 h-8 text-muted-foreground hover:text-foreground",children:[e.jsx(es,{className:"w-3 h-3 mr-1"}),"ë°œì£¼ì„œ ê´€ë¦¬"]})]})]}),e.jsxs("div",{className:"mt-3 flex items-center justify-center gap-6 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",x.pdf==="completed"?"bg-green-500":x.pdf==="processing"?"bg-blue-500 animate-pulse":x.pdf==="error"?"bg-red-500":"bg-muted-foreground")}),"PDF ìƒì„±"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",x.vendor==="completed"?"bg-green-500":x.vendor==="processing"?"bg-blue-500 animate-pulse":x.vendor==="error"?"bg-red-500":"bg-muted-foreground")}),"ê±°ë˜ì²˜ í™•ì¸"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",x.order==="completed"?"bg-green-500":x.order==="processing"?"bg-blue-500 animate-pulse":x.order==="error"?"bg-red-500":"bg-muted-foreground")}),"ë°œì£¼ì„œ ìƒì„±"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:Y("w-2 h-2 rounded-full",x.email==="completed"?"bg-green-500":x.email==="processing"?"bg-blue-500 animate-pulse":x.email==="error"?"bg-red-500":"bg-muted-foreground")}),"ì´ë©”ì¼ ì¤€ë¹„"]})]})]}),e.jsx(Te,{open:M,onOpenChange:I,children:e.jsxs(Ae,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Oe,{children:e.jsx(De,{children:"ì´ë©”ì¼ ë°œì†¡ ì„¤ì •"})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(N,{className:"text-sm font-medium",children:"ë°›ëŠ” ì‚¬ëŒ *"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[h.to.map((r,a)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx("span",{className:"flex-1 text-sm text-foreground",children:r}),e.jsx(v,{type:"button",variant:"ghost",size:"sm",onClick:()=>K(r),className:"h-6 w-6 p-0 hover:bg-red-100 dark:hover:bg-red-900",children:e.jsx(ae,{className:"h-3 w-3"})})]},a)),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(J,{value:P,onChange:r=>U(r.target.value),placeholder:"example@company.com",onKeyPress:r=>r.key==="Enter"&&z(),className:"flex-1"}),e.jsx(v,{type:"button",variant:"outline",size:"sm",onClick:z,disabled:!P.trim(),children:e.jsx(le,{className:"h-4 w-4"})})]})]})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-sm font-medium",children:"ì°¸ì¡° (CC)"}),e.jsxs("div",{className:"mt-2 space-y-2",children:[h.cc.map((r,a)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx("span",{className:"flex-1 text-sm text-foreground",children:r}),e.jsx(v,{type:"button",variant:"ghost",size:"sm",onClick:()=>B(r),className:"h-6 w-6 p-0 hover:bg-red-100 dark:hover:bg-red-900",children:e.jsx(ae,{className:"h-3 w-3"})})]},a)),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(J,{value:R,onChange:r=>w(r.target.value),placeholder:"manager@company.com (ì„ íƒì‚¬í•­)",onKeyPress:r=>r.key==="Enter"&&g(),className:"flex-1"}),e.jsx(v,{type:"button",variant:"outline",size:"sm",onClick:g,disabled:!R.trim(),children:e.jsx(le,{className:"h-4 w-4"})})]})]})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"email-subject",className:"text-sm font-medium",children:"ì œëª© *"}),e.jsx(J,{id:"email-subject",value:h.subject,onChange:r=>f(a=>({...a,subject:r.target.value})),className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"email-message",className:"text-sm font-medium",children:"ë©”ì‹œì§€"}),e.jsx(ie,{id:"email-message",value:h.message,onChange:r=>f(a=>({...a,message:r.target.value})),rows:4,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-sm font-medium",children:"ì²¨ë¶€íŒŒì¼"}),e.jsxs("div",{className:"mt-2 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ne,{id:"include-excel",checked:h.attachments.includeExcel,onCheckedChange:r=>f(a=>({...a,attachments:{...a.attachments,includeExcel:!!r}}))}),e.jsx(N,{htmlFor:"include-excel",className:"text-sm",children:"Excel íŒŒì¼ ì²¨ë¶€"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ne,{id:"include-pdf",checked:h.attachments.includePdf,onCheckedChange:r=>f(a=>({...a,attachments:{...a.attachments,includePdf:!!r}}))}),e.jsx(N,{htmlFor:"include-pdf",className:"text-sm",children:"PDF íŒŒì¼ ì²¨ë¶€"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(N,{className:"text-sm",children:"ì¶”ê°€ íŒŒì¼"}),e.jsxs(v,{type:"button",variant:"outline",size:"sm",onClick:()=>document.getElementById("additional-files")?.click(),className:"h-8",children:[e.jsx(pe,{className:"h-3 w-3 mr-1"}),"íŒŒì¼ ì„ íƒ"]})]}),e.jsx("input",{id:"additional-files",type:"file",multiple:!0,onChange:_,className:"hidden"}),h.attachments.additionalFiles.length>0&&e.jsx("div",{className:"space-y-1",children:h.attachments.additionalFiles.map((r,a)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-muted rounded-md",children:[e.jsx(pe,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{className:"flex-1 text-sm text-foreground",children:r.name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[(r.size/1024).toFixed(1)," KB"]}),e.jsx(v,{type:"button",variant:"ghost",size:"sm",onClick:()=>q(a),className:"h-6 w-6 p-0 hover:bg-red-100 dark:hover:bg-red-900",children:e.jsx(ae,{className:"h-3 w-3"})})]},a))})]})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground bg-blue-50 dark:bg-blue-950 p-2 rounded",children:"ğŸ“ ì„ íƒí•œ ì²¨ë¶€íŒŒì¼ì´ ì´ë©”ì¼ê³¼ í•¨ê»˜ ë°œì†¡ë©ë‹ˆë‹¤."})]}),e.jsxs(Me,{className:"mt-6",children:[e.jsx(v,{variant:"outline",onClick:()=>I(!1),children:"ì·¨ì†Œ"}),e.jsxs(v,{onClick:c,disabled:h.to.length===0||!h.subject,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(ge,{className:"w-4 h-4 mr-2"}),"ë°œì£¼ì„œ ìƒì„±"]})]}),e.jsxs("div",{className:"mt-2 p-2 bg-gray-100 text-xs text-gray-600 rounded",children:["ğŸ” Debug: to.length=",h.to.length,', subject="',h.subject,'", disabled=',h.to.length===0||!h.subject]})]})})]})},ns=({orderData:l,onSuggestionApply:A})=>{const[x,y]=u.useState([]),[E,d]=u.useState(new Set),[b,O]=u.useState(!1);u.useEffect(()=>{j()},[l]);const j=()=>{O(!0);const h=[];if(l.vendorName&&!l.vendorEmail&&h.push({id:"vendor-email",type:"autofill",title:"ê±°ë˜ì²˜ ì´ë©”ì¼ ìë™ ì™„ì„±",description:"ë“±ë¡ëœ ê±°ë˜ì²˜ ì •ë³´ì—ì„œ ì´ë©”ì¼ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",action:{label:"ì´ë©”ì¼ ìë™ ì…ë ¥",data:{vendorEmail:"vendor@example.com"}},priority:"high"}),l.deliveryDate){const f=new Date(l.deliveryDate),P=new Date,U=Math.ceil((f.getTime()-P.getTime())/(1e3*60*60*24));U<3&&h.push({id:"delivery-urgent",type:"warning",title:"ê¸´ê¸‰ ë‚©ê¸°",description:`ë‚©ê¸°ì¼ì´ ${U}ì¼ ë‚¨ì•˜ìŠµë‹ˆë‹¤. ê¸´ê¸‰ ì²˜ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.`,priority:"high"})}l.projectName&&!l.notes&&h.push({id:"project-defaults",type:"recommendation",title:"í”„ë¡œì íŠ¸ ê¸°ë³¸ ì„¤ì •",description:"ì´ì „ ë°œì£¼ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ìì£¼ ì‚¬ìš©í•˜ëŠ” ì„¤ì •ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",action:{label:"ê¸°ë³¸ê°’ ì ìš©",data:{notes:"ìƒì°¨ í›„ ì—°ë½ ìš”ë§",deliveryLocation:"í˜„ì¥ ì§ë‚©"}},priority:"medium"}),l.totalAmount>1e7&&h.push({id:"amount-check",type:"info",title:"ê³ ì•¡ ë°œì£¼ì„œ",description:"1ì²œë§Œì› ì´ìƒì˜ ë°œì£¼ì„œì…ë‹ˆë‹¤. ê²°ì¬ ìŠ¹ì¸ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",priority:"medium"}),l.vendorName&&l.vendorName.length>2&&["(ì£¼)ABCê±´ì„¤","(ì£¼)ABCì¢…í•©ê±´ì„¤"].length>0&&h.push({id:"similar-vendors",type:"recommendation",title:"ìœ ì‚¬ ê±°ë˜ì²˜ ë°œê²¬",description:`'${l.vendorName}'ì™€ ìœ ì‚¬í•œ ê±°ë˜ì²˜ê°€ ìˆìŠµë‹ˆë‹¤. í™•ì¸í•´ë³´ì„¸ìš”.`,priority:"low"}),y(h.filter(f=>!E.has(f.id))),O(!1)},k=h=>{h.action&&(A(h.action.data),L(h.id))},L=h=>{d(f=>new Set(f).add(h)),y(f=>f.filter(P=>P.id!==h))},M=h=>{switch(h){case"warning":return e.jsx(ue,{className:"w-5 h-5 text-yellow-600"});case"info":return e.jsx(je,{className:"w-5 h-5 text-blue-600"});case"recommendation":return e.jsx(Le,{className:"w-5 h-5 text-green-600"});case"autofill":return e.jsx(fe,{className:"w-5 h-5 text-purple-600"});default:return e.jsx(je,{className:"w-5 h-5 text-gray-600"})}},I=h=>{switch(h){case"warning":return"bg-yellow-50 border-yellow-200";case"info":return"bg-blue-50 border-blue-200";case"recommendation":return"bg-green-50 border-green-200";case"autofill":return"bg-purple-50 border-purple-200";default:return"bg-gray-50 border-gray-200"}};return x.length===0&&!b?null:e.jsxs(ee,{children:[e.jsx(Pe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Fe,{className:"text-lg flex items-center gap-2",children:[e.jsx(fe,{className:"w-5 h-5 text-yellow-500"}),"ìŠ¤ë§ˆíŠ¸ ì–´ì‹œìŠ¤íŠ¸"]}),b&&e.jsx(ze,{className:"w-4 h-4 text-gray-500 animate-spin"})]})}),e.jsxs(se,{className:"space-y-3",children:[x.sort((h,f)=>{const P={high:0,medium:1,low:2};return P[h.priority]-P[f.priority]}).map(h=>e.jsx(oe,{className:`${I(h.type)} border`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[M(h.type),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("p",{className:"font-medium text-sm",children:h.title}),h.priority==="high"&&e.jsx(V,{variant:"destructive",className:"text-xs",children:"ì¤‘ìš”"})]}),e.jsx(ce,{className:"text-xs",children:h.description}),h.action&&e.jsxs(v,{size:"sm",variant:"outline",className:"mt-2",onClick:()=>k(h),children:[h.action.label,e.jsx($e,{className:"w-3 h-3 ml-1"})]})]}),e.jsx(v,{size:"sm",variant:"ghost",className:"text-gray-400 hover:text-gray-600 h-6 w-6 p-0",onClick:()=>L(h.id),children:"Ã—"})]})},h.id)),x.length===0&&!b&&e.jsxs("div",{className:"text-center py-4 text-sm text-gray-500",children:[e.jsx(te,{className:"w-8 h-8 text-green-500 mx-auto mb-2"}),"ëª¨ë“  í•­ëª©ì´ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤"]})]})]})},_s=()=>{const{toast:l}=Ke(),{user:A,isAuthenticated:x}=Je(),[y,E]=u.useState(null),[d,b]=u.useState({}),[O,j]=u.useState({pdf:"idle",vendor:"idle",email:"idle",order:"idle"}),[k,L]=u.useState(null),[M,I]=u.useState(!1),[h,f]=u.useState(!1),P=u.useCallback(()=>{console.log("ğŸ”„ ë°œì£¼ì„œ ì‘ì„± í˜ì´ì§€ ì´ˆê¸°í™”"),E(null),b({}),j({pdf:"idle",vendor:"idle",email:"idle",order:"idle"}),L(null),I(!1),f(!1),localStorage.removeItem("draftOrder")},[]);u.useEffect(()=>{if(h&&d.orderNumber){const s=setTimeout(()=>{U()},2e3);return()=>clearTimeout(s)}},[d,h]),u.useEffect(()=>{if(d.orderNumber&&d.vendorName&&d.projectName&&d.items?.length>0){const s=setTimeout(()=>{R()},500);return()=>clearTimeout(s)}},[d.orderNumber,d.vendorName,d.projectName,d.items]);const U=async()=>{I(!0);try{localStorage.setItem("draftOrder",JSON.stringify(d)),f(!1)}catch(s){console.error("Auto-save failed:",s)}finally{I(!1)}},R=async()=>{if(d.orderNumber){console.log("ğŸ”µ PDF ìƒì„± ì‹œì‘:",d),j(s=>({...s,pdf:"processing"}));try{const s=d.totalAmount||(d.items||[]).reduce((c,r)=>c+(r.quantity||0)*(r.unitPrice||0),0),t={...d,totalAmount:s};console.log("ğŸ”µ PDF ìƒì„± ìš”ì²­ ë°ì´í„°:",t);const o=await fetch("/api/orders/generate-pdf",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({orderData:t})});if(o.ok){const c=await o.json();console.log("ğŸ”µ PDF ìƒì„± ì‘ë‹µ:",c);const r=c.pdfUrl.startsWith("http")?c.pdfUrl:`${window.location.origin}${c.pdfUrl}`;console.log("ğŸ”µ PDF URL:",r),L(r),j(a=>({...a,pdf:"completed"})),fetch(r,{method:"HEAD"}).then(a=>{console.log("ğŸ”µ PDF ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸:",a.status,a.headers.get("content-type"))}).catch(a=>{console.error("ğŸ”´ PDF ì ‘ê·¼ ì‹¤íŒ¨:",a)})}else{const c=await o.text();throw console.error("ğŸ”´ PDF ìƒì„± ì‹¤íŒ¨ ì‘ë‹µ:",o.status,c),new Error(`PDF ìƒì„± ì‹¤íŒ¨: ${o.status}`)}}catch(s){j(t=>({...t,pdf:"error"})),console.error("ğŸ”´ PDF generation error:",s)}}},w=s=>{E(s);const t=localStorage.getItem("draftOrder");if(t)try{const o=JSON.parse(t);console.log("ğŸ“‹ ì„ì‹œì €ì¥ ë°ì´í„° ë°œê²¬:",o),window.confirm("ì €ì¥ëœ ì„ì‹œ ì‘ì—…ì´ ìˆìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?")?(console.log("âœ… ì‚¬ìš©ì í™•ì¸: ì„ì‹œì €ì¥ ë°ì´í„° ë¡œë“œ ì‹œì‘"),b(c=>(console.log("ğŸ”„ ì´ì „ orderData:",c),console.log("ğŸ”„ ìƒˆë¡œìš´ orderData:",o),{...o})),f(!1),l({title:"ì„ì‹œì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ",description:`ë°œì£¼ë²ˆí˜¸ ${o.orderNumber||"ë¯¸ì •"}ì˜ ì„ì‹œ ì‘ì—…ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`})):(console.log("âŒ ì‚¬ìš©ì ì·¨ì†Œ: ì„ì‹œì €ì¥ ë°ì´í„° ë¡œë“œ ì·¨ì†Œ"),localStorage.removeItem("draftOrder"))}catch(o){console.error("âŒ ì„ì‹œì €ì¥ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:",o),localStorage.removeItem("draftOrder"),l({title:"ì„ì‹œì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨",description:"ì €ì¥ëœ ë°ì´í„°ê°€ ì†ìƒë˜ì–´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}else console.log("ğŸ“‹ ì„ì‹œì €ì¥ ë°ì´í„° ì—†ìŒ")},z=u.useCallback(s=>{b(t=>Object.keys(s).some(c=>JSON.stringify(s[c])!==JSON.stringify(t[c]))?{...t,...s}:t),f(!0),s.vendorName&&s.vendorName!==d.vendorName&&g(s.vendorName)},[d.vendorName]),K=s=>{b(t=>({...t,processedExcelUrl:s.url,originalFileName:s.name}))},g=async s=>{j(t=>({...t,vendor:"processing"}));try{const t=await fetch("/api/vendors/validate",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({vendorName:s})});if(t.ok){const o=await t.json();o.isValid?(j(c=>({...c,vendor:"completed"})),o.vendorEmail&&b(c=>({...c,vendorEmail:o.vendorEmail}))):j(c=>({...c,vendor:"error"}))}}catch{j(o=>({...o,vendor:"error"}))}},B=async()=>{if(!d.orderNumber||!d.vendorName||!d.projectName||!d.items?.length){l({title:"ìƒì„± ë¶ˆê°€",description:"í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.",variant:"destructive"});return}if(j(s=>({...s,order:"processing"})),!x||!A){console.error("ğŸ”´ ì¸ì¦ ì‹¤íŒ¨ - ë¡œê·¸ì¸ í•„ìš”"),l({title:"ì¸ì¦ í•„ìš”",description:"ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.",variant:"destructive"}),j(s=>({...s,order:"error"})),setTimeout(()=>{window.location.href="/login"},2e3);return}console.log("ğŸ” í˜„ì¬ ì‚¬ìš©ì:",A);try{console.log("ğŸŸ¢ ë°œì£¼ì„œ ìƒì„± ì‹œì‘:",d);const s=new FormData;s.append("projectId","1"),s.append("vendorId","1"),s.append("orderDate",d.orderDate||new Date().toISOString()),s.append("deliveryDate",d.deliveryDate||new Date().toISOString()),s.append("notes",d.notes||`ë°œì£¼ì„œ ì‘ì„±ìœ¼ë¡œ ìƒì„±ëœ ë°œì£¼ì„œ - ${d.orderNumber}`);const t=(d.items||[]).map(c=>({itemName:c.name||c.itemName||"",specification:c.specification||"",unit:c.unit||"EA",quantity:parseFloat(c.quantity||"0"),unitPrice:parseFloat(c.unitPrice||"0"),totalAmount:parseFloat(c.quantity||"0")*parseFloat(c.unitPrice||"0"),majorCategory:c.majorCategory||"",middleCategory:c.middleCategory||"",minorCategory:c.minorCategory||"",notes:c.notes||""}));s.append("items",JSON.stringify(t)),console.log("ğŸŸ¢ ë°œì£¼ì„œ ìƒì„± ìš”ì²­ ë°ì´í„°:",{projectId:"1",vendorId:"1",orderDate:d.orderDate||new Date().toISOString(),deliveryDate:d.deliveryDate||new Date().toISOString(),notes:d.notes||`ë°œì£¼ì„œ ì‘ì„±ìœ¼ë¡œ ìƒì„±ëœ ë°œì£¼ì„œ - ${d.orderNumber}`,items:t});const o=await fetch("/api/orders",{method:"POST",credentials:"include",body:s});if(console.log("ğŸŸ¢ ë°œì£¼ì„œ ìƒì„± ì‘ë‹µ ìƒíƒœ:",o.status),o.ok){const c=await o.json();console.log("ğŸŸ¢ ìƒì„±ëœ ë°œì£¼ì„œ:",c),j(r=>({...r,order:"completed"})),l({title:"ìƒì„± ì™„ë£Œ",description:`ë°œì£¼ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (${c.orderNumber||d.orderNumber}) ê³„ì†í•´ì„œ ë‹¤ë¥¸ í’ˆëª©ìœ¼ë¡œ ë°œì£¼ì„œë¥¼ ìƒì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,duration:5e3})}else{const c=await o.text();console.error("ğŸ”´ ë°œì£¼ì„œ ìƒì„± ì‹¤íŒ¨ ì‘ë‹µ:",o.status,c);let r="ë°œì£¼ì„œ ìƒì„± ì‹¤íŒ¨";try{r=JSON.parse(c).message||r}catch{r=`HTTP ${o.status}: ${c}`}throw new Error(r)}}catch(s){j(t=>({...t,order:"error"})),l({title:"ìƒì„± ì‹¤íŒ¨",description:s instanceof Error?s.message:"ë°œì£¼ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}},_=async s=>{if(console.log("ğŸ“§ ë°œì£¼ì„œ ìƒì„± ë° ì´ë©”ì¼ ë°œì†¡ ì‹œì‘:",{orderData:d,emailSettings:s}),!d.orderNumber||!d.vendorName||!d.projectName||!d.items?.length){l({title:"ìƒì„± ë¶ˆê°€",description:"í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.",variant:"destructive"});return}j(t=>({...t,order:"processing",email:"processing"}));try{console.log("ğŸŸ¢ Step 1: ë°œì£¼ì„œ ìƒì„±");const t=new FormData;t.append("projectId","1"),t.append("vendorId","1"),t.append("orderDate",d.orderDate||new Date().toISOString()),t.append("deliveryDate",d.deliveryDate||new Date().toISOString()),t.append("notes",d.notes||`ë°œì£¼ì„œ ì‘ì„±ìœ¼ë¡œ ìƒì„±ëœ ë°œì£¼ì„œ - ${d.orderNumber}`);const o=(d.items||[]).map(a=>({itemName:a.name||a.itemName||"",specification:a.specification||"",unit:a.unit||"EA",quantity:parseFloat(a.quantity||"0"),unitPrice:parseFloat(a.unitPrice||"0"),totalAmount:parseFloat(a.quantity||"0")*parseFloat(a.unitPrice||"0"),majorCategory:a.majorCategory||"",middleCategory:a.middleCategory||"",minorCategory:a.minorCategory||"",notes:a.notes||""}));t.append("items",JSON.stringify(o));const c=await fetch("/api/orders",{method:"POST",credentials:"include",body:t});if(!c.ok)throw new Error("ë°œì£¼ì„œ ìƒì„± ì‹¤íŒ¨");const r=await c.json();if(console.log("ğŸŸ¢ ë°œì£¼ì„œ ìƒì„± ì™„ë£Œ:",r),j(a=>({...a,order:"completed"})),console.log("ğŸ“§ Step 2: ì´ë©”ì¼ ë°œì†¡"),console.log("ğŸ” processedExcelUrl í™•ì¸:",d.processedExcelUrl),console.log("ğŸ” ì´ë©”ì¼ ì„¤ì • í™•ì¸:",s),d.processedExcelUrl)try{console.log("ğŸ“¤ Excel ì´ë©”ì¼ ìš”ì²­ ì‹œì‘...");const a=await fetch("/api/orders/send-email-with-excel",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({emailSettings:{to:s.to,cc:s.cc||"",subject:s.subject,message:s.message,orderNumber:d.orderNumber,vendorName:d.vendorName,totalAmount:d.totalAmount},excelFilePath:d.processedExcelUrl,orderData:d})});if(a.ok)console.log("ğŸ“§ ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ"),j(m=>({...m,email:"completed"})),l({title:"ìƒì„± ë° ë°œì†¡ ì™„ë£Œ",description:`ë°œì£¼ì„œê°€ ìƒì„±ë˜ê³  ì´ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. (${r.orderNumber||d.orderNumber}) ê³„ì†í•´ì„œ ë‹¤ë¥¸ í’ˆëª©ìœ¼ë¡œ ë°œì£¼ì„œë¥¼ ìƒì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,duration:5e3});else{const m=await a.text();throw console.error("ğŸ“§ Excel ì´ë©”ì¼ ë°œì†¡ HTTP ì˜¤ë¥˜:",a.status,m),new Error(`Excel ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ (${a.status}): ${m}`)}}catch(a){console.error("ğŸ“§ Excel ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ ìƒì„¸:",{error:a,message:a instanceof Error?a.message:"Unknown error",stack:a instanceof Error?a.stack:"No stack"}),j(m=>({...m,email:"error"})),l({title:"ë¶€ë¶„ ì™„ë£Œ",description:"ë°œì£¼ì„œëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}else try{console.log("ğŸ“¤ PDF ì´ë©”ì¼ ìš”ì²­ ì‹œì‘...");const a=await fetch("/api/orders/send-email",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({orderData:{...d,vendorEmail:s.to},pdfUrl:k,recipients:s.to,emailSettings:{subject:s.subject,message:s.message,cc:s.cc}})});if(a.ok)console.log("ğŸ“§ PDF ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ"),j(m=>({...m,email:"completed"})),l({title:"ìƒì„± ë° ë°œì†¡ ì™„ë£Œ",description:"ë°œì£¼ì„œê°€ ìƒì„±ë˜ê³  PDF ì´ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì†í•´ì„œ ë‹¤ë¥¸ í’ˆëª©ìœ¼ë¡œ ë°œì£¼ì„œë¥¼ ìƒì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",duration:5e3});else{const m=await a.text();throw console.error("ğŸ“§ PDF ì´ë©”ì¼ ë°œì†¡ HTTP ì˜¤ë¥˜:",a.status,m),new Error(`PDF ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ (${a.status}): ${m}`)}}catch(a){console.error("ğŸ“§ PDF ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ ìƒì„¸:",{error:a,message:a instanceof Error?a.message:"Unknown error",stack:a instanceof Error?a.stack:"No stack"}),j(m=>({...m,email:"error"})),l({title:"ë¶€ë¶„ ì™„ë£Œ",description:"ë°œì£¼ì„œëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}}catch(t){console.error("ğŸ”´ ë°œì£¼ì„œ ìƒì„± ë° ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:",t),j(o=>({...o,order:"error",email:"error"})),l({title:"ì‹¤íŒ¨",description:t instanceof Error?t.message:"ë°œì£¼ì„œ ìƒì„± ë° ì´ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}},q=async()=>{if(!d.vendorEmail){l({title:"ë°œì†¡ ë¶ˆê°€",description:"ìˆ˜ì‹ ì ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.",variant:"destructive"});return}j(s=>({...s,email:"processing"}));try{if((await fetch("/api/orders/send-email",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({orderData:d,pdfUrl:k||null,recipients:[d.vendorEmail]})})).ok)j(t=>({...t,email:"completed"})),l({title:"ë°œì†¡ ì™„ë£Œ",description:"ë°œì£¼ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì†í•´ì„œ ë‹¤ë¥¸ í’ˆëª©ìœ¼ë¡œ ë°œì£¼ì„œë¥¼ ìƒì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",duration:5e3});else throw new Error("ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨")}catch{j(t=>({...t,email:"error"})),l({title:"ë°œì†¡ ì‹¤íŒ¨",description:"ì´ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}},i=()=>{const s=Object.values(O);return s.filter(o=>o==="completed").length/s.length*100};return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("div",{className:"bg-background border-b border-border sticky top-0 z-40",children:e.jsx("div",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"ë°œì£¼ì„œ ì‘ì„±"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"í•œ í™”ë©´ì—ì„œ ëª¨ë“  ì‘ì—…ì„ ì™„ë£Œí•˜ì„¸ìš”"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[y&&e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>{window.confirm("í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ìƒˆë¡œ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")&&(P(),l({title:"ìƒˆë¡œ ì‘ì„±",description:"ë°œì£¼ì„œ ì‘ì„± í™”ë©´ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."}))},className:"text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800 hover:bg-blue-50 dark:hover:bg-blue-950",children:[e.jsx(le,{className:"w-4 h-4 mr-1"}),"ìƒˆë¡œ ì‘ì„±"]}),M&&e.jsxs(V,{variant:"secondary",className:"animate-pulse",children:[e.jsx(Z,{className:"w-3 h-3 mr-1 animate-spin"}),"ìë™ ì €ì¥ ì¤‘..."]}),!M&&!h&&d.orderNumber&&e.jsxs(V,{variant:"secondary",className:"bg-green-50 text-green-700",children:[e.jsx(te,{className:"w-3 h-3 mr-1"}),"ì €ì¥ë¨"]}),e.jsx(He,{value:i(),className:"w-32 h-2"})]})]})})}),e.jsxs("div",{className:"container mx-auto px-6 py-6",style:{paddingBottom:"120px"},children:[!y&&e.jsx("div",{className:"mb-8",children:e.jsxs(oe,{className:"mb-6 max-w-4xl mx-auto",children:[e.jsx(je,{className:"h-4 w-4"}),e.jsx(ce,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-medium",children:"ğŸ“‹ ì‚¬ìš©íŒ"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-blue-600 dark:text-blue-400",children:"ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ:"})," ëŒ€ëŸ‰ ë°œì£¼ì„œ, ë°˜ë³µ ì—…ë¬´, ìë™í™” ì²˜ë¦¬ì— ì í•© (50ê±´+ ê¶Œì¥)"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-green-600 dark:text-green-400",children:"ì§ì ‘ ì…ë ¥:"})," ì†ŒëŸ‰ ë°œì£¼ì„œ, ì„¸ë°€í•œ ì¡°ì •, ì¦‰ì‹œ ì²˜ë¦¬ì— ì í•© (10ê±´ ì´í•˜ ê¶Œì¥)"]})]}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs(v,{variant:"outline",size:"sm",className:"text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-800 hover:bg-blue-50 dark:hover:bg-blue-950",onClick:async()=>{try{const s=await fetch("/PO_Excel_Template.xlsx");if(s.ok){const t=await s.blob(),o=URL.createObjectURL(t),c=document.createElement("a");c.href=o,c.download="PO_Excel_Template.xlsx",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(o)}else throw new Error("íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")}catch(s){console.error("ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:",s),l({title:"ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨",description:"ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}},children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ"]})})]})})]})}),!y&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 max-w-4xl mx-auto",children:[e.jsx(ee,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-blue-500 dark:hover:border-blue-400",onClick:()=>w("excel"),children:e.jsxs(se,{className:"p-8 text-center",children:[e.jsx(Ne,{className:"w-16 h-16 mx-auto mb-4 text-blue-600 dark:text-blue-400"}),e.jsx("h3",{className:"text-xl font-semibold mb-2 text-foreground",children:"ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"ê¸°ì¡´ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë¹ ë¥´ê²Œ ì‘ì„±"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("div",{children:"âœ… ëŒ€ëŸ‰ ì²˜ë¦¬ (50ê±´+)"}),e.jsx("div",{children:"âœ… ìë™í™” ì›Œí¬í”Œë¡œìš°"}),e.jsx("div",{children:"âœ… ê±°ë˜ì²˜ ìë™ ë§¤ì¹­"}),e.jsx("div",{children:"âœ… ì´ë©”ì¼ ìë™ ë°œì†¡"})]})]})}),e.jsx(ee,{className:"cursor-pointer hover:shadow-lg transition-shadow border-2 hover:border-green-500 dark:hover:border-green-400 bg-card",onClick:()=>w("direct"),children:e.jsxs(se,{className:"p-8 text-center",children:[e.jsx(re,{className:"w-16 h-16 mx-auto mb-4 text-green-600 dark:text-green-400"}),e.jsx("h3",{className:"text-xl font-semibold mb-2 text-foreground",children:"ì§ì ‘ ì…ë ¥"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"í¼ì„ í†µí•´ ì§ì ‘ ì •ë³´ ì…ë ¥"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("div",{children:"âœ… ì†ŒëŸ‰ ì²˜ë¦¬ (10ê±´ ì´í•˜)"}),e.jsx("div",{children:"âœ… ì¦‰ì‹œ ì²˜ë¦¬"}),e.jsx("div",{children:"âœ… ì‹¤ì‹œê°„ ê²€ì¦"}),e.jsx("div",{children:"âœ… ì„¸ë°€í•œ ì¡°ì •"})]})]})})]}),y&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx(ee,{children:e.jsxs(se,{className:"p-6",children:[y==="excel"&&e.jsx(ts,{onDataExtracted:z,onProcessedFileReady:K}),y==="direct"&&e.jsx(rs,{initialData:d,onChange:z})]})}),e.jsx(ns,{orderData:d,onSuggestionApply:z})]}),e.jsx("div",{className:"space-y-6",children:e.jsx(as,{orderData:d,pdfUrl:k,processingStatus:O})})]}),y&&d.orderNumber&&e.jsx(ls,{orderData:d,pdfUrl:k,processingStatus:O,onSave:U,onSend:q,onCreateOrder:B,onCreateOrderWithEmail:_,onDownload:()=>{k&&window.open(`${k}?download=true`,"_blank")}})]})]})};export{_s as default};
