import{n as ee,e as oe,g as ue,r as k,q as te,s as q,j as e,w as U,a3 as G,a4 as _,F as ae,x as Z,B as o,a9 as c,y as f,S as E,z as K,A as O,D as $,G as b,o as d,O as A,ac as B,k as g,_ as F,bH as ie,P as ye,T as ge,a as fe}from"./index-DoUKJjFS-1757230250541.js";import{T as P}from"./textarea-1lg2QJSl-1757230250541.js";import{D as X,f as Ne,a as Y,b as J,c as W}from"./dialog-BmmGsJWf-1757230250541.js";import{U as be}from"./upload-CCfugzdm-1757230250541.js";import{C as ne}from"./calendar-DCgYIGAp-1757230250541.js";import{D as re}from"./dollar-sign-BOLcCLX7-1757230250541.js";import{f as C}from"./format-CrgaXlVK-1757230250541.js";import{C as ce}from"./checkbox-BWT1TDj8-1757230250541.js";import{P as le}from"./package-BbyBaNSQ-1757230250541.js";import{T as we}from"./triangle-alert-mH415Q-N-1757230250541.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=ee("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=ee("ReceiptText",[["path",{d:"M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z",key:"q3az6g"}],["path",{d:"M14 8H8",key:"1l3xfs"}],["path",{d:"M16 12H8",key:"1fr5h0"}],["path",{d:"M13 16H8",key:"wsln4y"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=ee("Receipt",[["path",{d:"M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z",key:"q3az6g"}],["path",{d:"M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8",key:"1h4pet"}],["path",{d:"M12 17.5v-11",key:"1jc1ny"}]]);function Pe({orderId:m}){const{toast:l}=oe(),u=ue(),[v,Q]=k.useState(!1),[D,y]=k.useState(null),{data:h=[],isLoading:L}=te({queryKey:["/api/invoices",m],queryFn:async()=>await(await g("GET",`/api/invoices?orderId=${m}`)).json()}),{data:S=[]}=te({queryKey:["/api/verification-logs",m],queryFn:async()=>await(await g("GET",`/api/verification-logs?orderId=${m}`)).json()}),j=q({mutationFn:async s=>{const x=await fetch("/api/invoices",{method:"POST",body:s});if(!x.ok)throw new Error("Failed to upload invoice");return x.json()},onSuccess:()=>{u.invalidateQueries({queryKey:["/api/invoices",m]}),u.invalidateQueries({queryKey:["/api/verification-logs",m]}),Q(!1),y(null),l({title:"ì„±ê³µ",description:"ì²­êµ¬ì„œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."})},onError:()=>{l({title:"ì˜¤ë¥˜",description:"ì²­êµ¬ì„œ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}}),T=q({mutationFn:async s=>await(await g("POST",`/api/invoices/${s}/verify`)).json(),onSuccess:()=>{u.invalidateQueries({queryKey:["/api/invoices",m]}),u.invalidateQueries({queryKey:["/api/verification-logs",m]}),l({title:"ì„±ê³µ",description:"ì²­êµ¬ì„œê°€ ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤."})},onError:()=>{l({title:"ì˜¤ë¥˜",description:"ì²­êµ¬ì„œ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}}),N=q({mutationFn:async s=>await(await g("POST",`/api/invoices/${s}/issue-tax`)).json(),onSuccess:()=>{u.invalidateQueries({queryKey:["/api/invoices",m]}),l({title:"ì„±ê³µ",description:"ì„¸ê¸ˆê³„ì‚°ì„œê°€ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤."})},onError:()=>{l({title:"ì˜¤ë¥˜",description:"ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}}),p=q({mutationFn:async s=>await(await g("POST",`/api/invoices/${s}/cancel-tax`)).json(),onSuccess:()=>{u.invalidateQueries({queryKey:["/api/invoices",m]}),l({title:"ì„±ê³µ",description:"ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."})},onError:()=>{l({title:"ì˜¤ë¥˜",description:"ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}}),z=s=>{s.preventDefault();const x=new FormData(s.currentTarget);x.set("orderId",m.toString()),D&&x.set("file",D),j.mutate(x)},I=s=>{switch(s){case"pending":return e.jsx(d,{variant:"secondary",children:"ê²€í† ì¤‘"});case"verified":return e.jsx(d,{variant:"default",children:"ê²€ì¦ì™„ë£Œ"});case"paid":return e.jsx(d,{variant:"outline",children:"ì§€ê¸‰ì™„ë£Œ"});default:return e.jsx(d,{variant:"secondary",children:s})}},M=s=>{switch(s){case"invoice":return e.jsx(d,{variant:"outline",children:"ì²­êµ¬ì„œ"});case"tax_invoice":return e.jsx(d,{variant:"outline",children:"ì„¸ê¸ˆê³„ì‚°ì„œ"});default:return e.jsx(d,{variant:"outline",children:s})}};return L?e.jsxs(U,{children:[e.jsx(G,{children:e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-5 w-5"}),"ì²­êµ¬ì„œ ê´€ë¦¬"]})}),e.jsx(Z,{children:e.jsx("div",{className:"text-center py-4",children:"ë¡œë”© ì¤‘..."})})]}):e.jsxs(U,{children:[e.jsx(G,{className:"pb-2",children:e.jsxs(_,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(ae,{className:"h-4 w-4"}),"ì²­êµ¬ì„œ ê´€ë¦¬"]}),e.jsxs(X,{open:v,onOpenChange:Q,children:[e.jsx(Ne,{asChild:!0,children:e.jsxs(o,{size:"sm",children:[e.jsx(be,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"ì²­êµ¬ì„œ ì—…ë¡œë“œ"})]})}),e.jsxs(Y,{children:[e.jsx(J,{children:e.jsx(W,{children:"ì²­êµ¬ì„œ ì—…ë¡œë“œ"})}),e.jsxs("form",{onSubmit:z,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"invoiceNumber",children:"ì²­êµ¬ì„œ ë²ˆí˜¸"}),e.jsx(f,{id:"invoiceNumber",name:"invoiceNumber",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"invoiceType",children:"ìœ í˜•"}),e.jsxs(E,{name:"invoiceType",defaultValue:"invoice",children:[e.jsx(K,{children:e.jsx(O,{})}),e.jsxs($,{children:[e.jsx(b,{value:"invoice",children:"ì²­êµ¬ì„œ"}),e.jsx(b,{value:"tax_invoice",children:"ì„¸ê¸ˆê³„ì‚°ì„œ"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"issueDate",children:"ë°œí–‰ì¼"}),e.jsx(f,{id:"issueDate",name:"issueDate",type:"date",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"dueDate",children:"ë§ˆê°ì¼"}),e.jsx(f,{id:"dueDate",name:"dueDate",type:"date"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"totalAmount",children:"ì´ê¸ˆì•¡"}),e.jsx(f,{id:"totalAmount",name:"totalAmount",type:"number",step:"0.01",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"vatAmount",children:"ë¶€ê°€ì„¸"}),e.jsx(f,{id:"vatAmount",name:"vatAmount",type:"number",step:"0.01",defaultValue:"0"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"file",children:"ì²¨ë¶€íŒŒì¼"}),e.jsx(f,{id:"file",type:"file",accept:".pdf,.jpg,.jpeg,.png",onChange:s=>y(s.target.files?.[0]||null)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"notes",children:"ë©”ëª¨"}),e.jsx(P,{id:"notes",name:"notes",rows:3})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(o,{type:"button",variant:"outline",onClick:()=>Q(!1),children:"ì·¨ì†Œ"}),e.jsx(o,{type:"submit",disabled:j.isPending,children:j.isPending?"ì—…ë¡œë“œ ì¤‘...":"ì—…ë¡œë“œ"})]})]})]})]})]})}),e.jsxs(Z,{className:"p-3",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"border-2 border-blue-200 rounded-lg p-3 bg-blue-50 dark:bg-blue-900/20",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-semibold text-blue-800 dark:text-blue-200",children:"ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ ê´€ë¦¬"}),h.length===0?e.jsx(d,{variant:"outline",className:"text-xs border-blue-300 text-blue-700",children:"ì²­êµ¬ì„œ ì—…ë¡œë“œ í•„ìš”"}):h.some(s=>s.taxInvoiceIssued)?e.jsxs(d,{variant:"default",className:"text-xs bg-green-600",children:[e.jsx(de,{className:"h-2 w-2 mr-1"}),"ë°œí–‰ì™„ë£Œ"]}):e.jsx(d,{variant:"secondary",className:"text-xs",children:"ë¯¸ë°œí–‰"})]}),e.jsx("div",{className:"text-xs text-blue-600 dark:text-blue-300",children:h.length===0?"ì²­êµ¬ì„œë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ê³  ê²€ì¦í•´ì£¼ì„¸ìš”":h.some(s=>s.status==="verified")?"ë°œí–‰ ì¤€ë¹„ ì™„ë£Œ":"ì²­êµ¬ì„œ ê²€ì¦ í•„ìš”"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-gray-600",children:h.length===0?"ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ ê´€ë¦¬ë¥¼ ìœ„í•´ì„œëŠ” ì²­êµ¬ì„œë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.":h.some(s=>s.taxInvoiceIssued)?"ì„¸ê¸ˆê³„ì‚°ì„œê°€ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤.":"ì„¸ê¸ˆê³„ì‚°ì„œ ë°œí–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."}),e.jsx("div",{className:"flex gap-2",children:h.length>0&&h.some(s=>s.status==="verified")?e.jsx(e.Fragment,{children:h.some(s=>s.taxInvoiceIssued)?e.jsxs(o,{size:"sm",variant:"destructive",onClick:()=>{const s=h.find(x=>x.taxInvoiceIssued);s&&p.mutate(s.id)},disabled:p.isPending,children:[e.jsx(B,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"ë¯¸í™•ì¸"})]}):e.jsxs(o,{size:"sm",variant:"default",onClick:()=>{const s=h.find(x=>x.status==="verified"&&!x.taxInvoiceIssued);s&&N.mutate(s.id)},disabled:N.isPending,children:[e.jsx(A,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"í™•ì¸"})]})}):e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(o,{size:"sm",variant:"outline",disabled:!0,children:[e.jsx(A,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"í™•ì¸"})]}),e.jsxs(o,{size:"sm",variant:"outline",disabled:!0,children:[e.jsx(B,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"ë¯¸í™•ì¸"})]})]})})]})]}),h.length===0?e.jsx("div",{className:"text-center py-4 text-muted-foreground text-xs",children:"ì•„ì§ ì—…ë¡œë“œëœ ì²­êµ¬ì„œê°€ ì—†ìŠµë‹ˆë‹¤."}):e.jsx("div",{className:"space-y-2",children:h.map(s=>e.jsxs("div",{className:"border rounded-lg p-2 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("h4",{className:"font-medium text-xs",children:s.invoiceNumber}),M(s.invoiceType),I(s.status)]}),s.status==="pending"&&e.jsxs(o,{size:"sm",onClick:()=>T.mutate(s.id),disabled:T.isPending,children:[e.jsx(A,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"ê²€ì¦"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ne,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("span",{children:["ë°œí–‰ì¼: ",C(new Date(s.issueDate),"yyyy-MM-dd",{locale:F})]})]}),s.dueDate&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ne,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("span",{children:["ë§ˆê°ì¼: ",C(new Date(s.dueDate),"yyyy-MM-dd",{locale:F})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(re,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("span",{children:["ì´ì•¡: â‚©",Math.round(s.totalAmount||0).toLocaleString("ko-KR")]})]}),s.vatAmount>0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(re,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("span",{children:["ë¶€ê°€ì„¸: â‚©",Math.round(s.vatAmount||0).toLocaleString("ko-KR")]})]})]}),s.notes&&e.jsx("div",{className:"text-xs text-muted-foreground bg-muted p-2 rounded",children:s.notes}),e.jsxs("div",{className:"border-t pt-2 space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(V,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{className:"text-xs font-medium",children:"ì„¸ê¸ˆê³„ì‚°ì„œ"}),s.taxInvoiceIssued?e.jsxs(d,{variant:"default",className:"text-xs",children:[e.jsx(de,{className:"h-2 w-2 mr-1"}),"ë°œí–‰ì™„ë£Œ"]}):e.jsx(d,{variant:"secondary",className:"text-xs",children:"ë¯¸ë°œí–‰"})]}),e.jsxs("div",{className:"flex gap-1",children:[s.status==="verified"&&e.jsx(e.Fragment,{children:s.taxInvoiceIssued?e.jsxs(o,{size:"sm",variant:"destructive",onClick:()=>p.mutate(s.id),disabled:p.isPending,children:[e.jsx(B,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:p.isPending?"ì·¨ì†Œ ì¤‘...":"ë°œí–‰ ì·¨ì†Œ"})]}):e.jsxs(o,{size:"sm",variant:"outline",onClick:()=>N.mutate(s.id),disabled:N.isPending,children:[e.jsx(V,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:N.isPending?"ì²˜ë¦¬ ì¤‘...":"ë°œí–‰ í™•ì¸"})]})}),s.status!=="verified"&&e.jsx("div",{className:"text-xs text-muted-foreground",children:"ì²­êµ¬ì„œ ê²€ì¦ í›„ ë°œí–‰ ê°€ëŠ¥"})]})]}),s.status==="verified"&&s.taxInvoiceIssued&&s.taxInvoiceIssuedDate&&e.jsxs("div",{className:"text-xs text-muted-foreground bg-green-50 dark:bg-green-900/20 p-2 rounded",children:["ë°œí–‰ì¼: ",C(new Date(s.taxInvoiceIssuedDate),"yyyy-MM-dd HH:mm",{locale:F}),s.taxInvoiceIssuedBy&&` | ë°œí–‰ìž: ${s.taxInvoiceIssuedBy}`]})]}),s.verifiedBy&&s.verifiedAt&&e.jsxs("div",{className:"text-xs text-muted-foreground border-t pt-1",children:["ê²€ì¦ìž: ",s.verifiedBy," | ê²€ì¦ì¼: ",C(new Date(s.verifiedAt),"yyyy-MM-dd HH:mm",{locale:F})]})]},s.id))})]}),S.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h4",{className:"font-medium mb-2 text-xs",children:"ê²€ì¦ ë¡œê·¸"}),e.jsx("div",{className:"space-y-1 max-h-32 overflow-y-auto",children:S.map(s=>e.jsxs("div",{className:"text-xs p-2 bg-muted rounded",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("span",{children:s.details}),e.jsx("span",{className:"text-xs text-muted-foreground",children:C(new Date(s.createdAt),"MM-dd HH:mm",{locale:F})})]}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:s.performedBy})]},s.id))})]})]})]})}function Ae({orderItems:m,orderId:l}){const{toast:u}=oe(),v=ue(),[Q,D]=k.useState(!1),[y,h]=k.useState(null),[L,S]=k.useState(!1),[j,T]=k.useState(null),[,N]=k.useState(0),p=ie(["/api/item-receipts",l],{queryFn:async()=>{const t=await g("GET","/api/item-receipts"),a=m.map(n=>n.id);return t.filter(n=>a.includes(n.orderItemId))},cacheType:"DYNAMIC",enabled:m.length>0}),{data:z=[]}=ie(["/api/invoices",l],{queryFn:()=>g("GET",`/api/invoices?orderId=${l}`),cacheType:"MASTER",enabled:!!l}),I=q({mutationFn:async t=>{console.log("Sending receipt data to API:",t);try{const a=await g("POST","/api/item-receipts",t);return console.log("API response:",a),a}catch(a){throw console.error("API request failed:",a),a}},onSuccess:async t=>{console.log("ðŸ’¥ Receipt creation successful, forcing refetch:",t),v.resetQueries({queryKey:["/api/item-receipts",l]}),v.invalidateQueries({queryKey:["/api/item-receipts"]}),await p.refetch(),N(a=>a+1),v.invalidateQueries({queryKey:["/api/verification-logs",l]}),D(!1),h(null),u({title:"ì„±ê³µ",description:"ìˆ˜ë ¹ í™•ì¸ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."})},onError:t=>{console.error("Receipt creation mutation error:",t);const a=t?.message||"ìˆ˜ë ¹ í™•ì¸ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";u({title:"ì˜¤ë¥˜",description:a,variant:"destructive"})}}),M=q({mutationFn:async t=>{const{id:a,...i}=t;return await(await g("PATCH",`/api/item-receipts/${a}`,i)).json()},onSuccess:async t=>{console.log("ðŸ’¥ Receipt update successful:",t),v.resetQueries({queryKey:["/api/item-receipts",l]}),v.invalidateQueries({queryKey:["/api/item-receipts"]}),await p.refetch(),N(a=>a+1),v.invalidateQueries({queryKey:["/api/verification-logs",l]}),S(!1),T(null),u({title:"ìˆ˜ë ¹ ì •ë³´ ìˆ˜ì • ì™„ë£Œ",description:"ìˆ˜ë ¹ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."})},onError:t=>{u({title:"ìˆ˜ì • ì‹¤íŒ¨",description:t.message||"ìˆ˜ë ¹ ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}}),s=q({mutationFn:async t=>await g("DELETE",`/api/item-receipts/${t}`),onSuccess:async()=>{console.log("ðŸ’¥ Receipt deletion successful"),v.resetQueries({queryKey:["/api/item-receipts",l]}),v.invalidateQueries({queryKey:["/api/item-receipts"]}),await p.refetch(),N(t=>t+1),v.invalidateQueries({queryKey:["/api/verification-logs",l]}),u({title:"ìˆ˜ë ¹ ì •ë³´ ì‚­ì œ ì™„ë£Œ",description:"ìˆ˜ë ¹ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."})},onError:t=>{u({title:"ì‚­ì œ ì‹¤íŒ¨",description:t.message||"ìˆ˜ë ¹ ì •ë³´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}}),x=q({mutationFn:async t=>{const a=t.map(i=>g("POST","/api/item-receipts",i));return await Promise.all(a)},onSuccess:()=>{v.invalidateQueries({queryKey:["/api/item-receipts"]}),v.invalidateQueries({queryKey:["/api/verification-logs",l]}),u({title:"ì„±ê³µ",description:"ì¼ê´„ ìˆ˜ë ¹ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."})},onError:()=>{u({title:"ì˜¤ë¥˜",description:"ì¼ê´„ ìˆ˜ë ¹ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",variant:"destructive"})}}),xe=t=>{t.preventDefault();const a=new FormData(t.currentTarget),i={orderItemId:y.id,invoiceId:a.get("invoiceId")?parseInt(a.get("invoiceId")):void 0,receivedQuantity:parseFloat(a.get("receivedQuantity")),receivedDate:a.get("receivedDate"),qualityCheck:a.get("qualityCheck")==="on",qualityNotes:a.get("qualityNotes")||"",status:a.get("status")||"approved",notes:a.get("notes")||""};console.log("Submitting receipt data:",i),I.mutate(i)},me=t=>{if(t.preventDefault(),!j){u({title:"ì˜¤ë¥˜",description:"ì„ íƒëœ ìˆ˜ë ¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.",variant:"destructive"});return}const a=new FormData(t.currentTarget),i={id:j.id,receivedQuantity:parseFloat(a.get("receivedQuantity")),receivedDate:a.get("receivedDate"),qualityCheck:a.get("qualityCheck")==="on",qualityNotes:a.get("qualityNotes")||"",status:a.get("status")||"pending",notes:a.get("notes")||""};console.log("Submitting updated receipt data:",i),M.mutate(i)},he=()=>{const t=new Date().toISOString().split("T")[0],a=m.filter(n=>R(n.id)<n.quantity);if(a.length===0){u({title:"ì•Œë¦¼",description:"ëª¨ë“  í•­ëª©ì´ ì´ë¯¸ ìˆ˜ë ¹ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."});return}const i=a.map(n=>({orderItemId:n.id,receivedQuantity:n.quantity-R(n.id),receivedDate:t,qualityCheck:!0,status:"approved",notes:"ì¼ê´„ ìˆ˜ë ¹ ë“±ë¡"}));x.mutate(i)},se=t=>{if(p.status==="error")return console.log(`âŒ Query in error state for item ${t}, triggering fresh fetch`),p.refetch(),[];const a=p.data||[];console.log(`ðŸ” Looking for receipts for item ${t}`),console.log(`ðŸ” Current query data length: ${a.length}`),console.log(`ðŸ” Query status: ${p.status}, isFetching: ${p.isFetching}`);const i=a.filter(n=>n.orderItemId===t);return console.log(`ðŸ“‹ Found ${i.length} receipts for item ${t}:`,i),i},R=t=>{const i=se(t).reduce((n,w)=>{const r=typeof w.receivedQuantity=="string"?parseFloat(w.receivedQuantity):w.receivedQuantity;return n+(r||0)},0);return console.log(`ðŸ’¯ Total received for item ${t}: ${i}`),i},pe=t=>{const n=(p.data||[]).filter(r=>r.orderItemId===t.id).reduce((r,H)=>{const ve=typeof H.receivedQuantity=="string"?parseFloat(H.receivedQuantity):H.receivedQuantity;return r+(ve||0)},0),w=t.quantity;return n===0?{status:"pending",label:"ë¯¸ìˆ˜ë ¹",icon:fe,color:"secondary"}:n<w?{status:"partial",label:"ë¶€ë¶„ìˆ˜ë ¹",icon:we,color:"warning"}:{status:"complete",label:"ìˆ˜ë ¹ì™„ë£Œ",icon:A,color:"default"}},je=t=>{switch(t){case"pending":return e.jsx(d,{variant:"secondary",children:"ëŒ€ê¸°ì¤‘"});case"approved":return e.jsx(d,{variant:"default",children:"ìŠ¹ì¸ë¨"});case"rejected":return e.jsx(d,{variant:"destructive",children:"ë°˜ë ¤ë¨"});default:return e.jsx(d,{variant:"secondary",children:t})}};return e.jsxs(U,{children:[e.jsx(G,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(_,{className:"flex items-center gap-1 text-sm",children:[e.jsx(le,{className:"h-4 w-4"}),"ìžìž¬ ìˆ˜ë ¹ í™•ì¸"]}),e.jsxs(o,{onClick:he,disabled:x.isPending,className:"bg-blue-600 hover:bg-blue-700",size:"sm",children:[e.jsx(le,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"ì¼ê´„ ìˆ˜ë ¹ ë“±ë¡"})]})]})}),e.jsxs(Z,{className:"p-3",children:[e.jsx("div",{className:"space-y-2",children:m.map(t=>{const a=se(t.id),i=R(t.id),n=pe(t),w=n.icon;return e.jsxs("div",{className:"border rounded-lg p-2 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[e.jsx("h4",{className:"font-medium text-xs",children:t.itemName}),e.jsxs(d,{variant:n.color,className:"flex items-center gap-1 text-xs",children:[e.jsx(w,{className:"h-3 w-3"}),n.label]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-muted-foreground",children:[e.jsxs("div",{children:["ë°œì£¼ìˆ˜ëŸ‰: ",t.quantity.toLocaleString(),t.unit]}),e.jsxs("div",{children:["ìˆ˜ë ¹ìˆ˜ëŸ‰: ",i.toLocaleString(),t.unit]}),e.jsxs("div",{children:["ë¯¸ìˆ˜ë ¹: ",(t.quantity-i).toLocaleString(),t.unit]}),e.jsxs("div",{children:["ë‹¨ê°€: â‚©",Math.round(t.unitPrice||0).toLocaleString("ko-KR")]})]}),t.notes&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:t.notes})]}),e.jsxs(o,{size:"sm",onClick:()=>{h(t),D(!0)},disabled:i>=t.quantity,children:[e.jsx(ye,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs",children:"ìˆ˜ë ¹ë“±ë¡"})]})]}),a.length>0&&e.jsxs("div",{className:"mt-2",children:[e.jsx("h5",{className:"text-xs font-medium mb-1",children:"ìˆ˜ë ¹ ì´ë ¥"}),e.jsx("div",{className:"space-y-1",children:a.map(r=>e.jsx("div",{className:"bg-muted p-2 rounded text-xs",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("span",{className:"font-medium text-xs",children:[(typeof r.receivedQuantity=="string"?parseFloat(r.receivedQuantity):r.receivedQuantity).toLocaleString(),t.unit," ìˆ˜ë ¹"]}),je(r.status),r.qualityCheck&&e.jsxs(d,{variant:"outline",className:"text-xs",children:[e.jsx(A,{className:"h-2 w-2 mr-1"}),"í’ˆì§ˆê²€ì‚¬"]})]}),e.jsxs("div",{className:"text-muted-foreground text-xs",children:["ìˆ˜ë ¹ì¼: ",C(new Date(r.receivedDate),"yyyy-MM-dd",{locale:F})]}),r.qualityNotes&&e.jsxs("div",{className:"text-muted-foreground text-xs",children:["í’ˆì§ˆë©”ëª¨: ",r.qualityNotes]}),r.notes&&e.jsxs("div",{className:"text-muted-foreground text-xs",children:["ë©”ëª¨: ",r.notes]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>{T(r),S(!0)},className:"h-6 w-6 p-0 hover:bg-blue-50",children:e.jsx(qe,{className:"h-3 w-3 text-blue-600"})}),e.jsx(o,{size:"sm",variant:"ghost",onClick:()=>{confirm("ì´ ìˆ˜ë ¹ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")&&s.mutate(r.id)},className:"h-6 w-6 p-0 hover:bg-red-50",disabled:s.isPending,children:e.jsx(ge,{className:"h-3 w-3 text-red-600"})})]}),e.jsxs("div",{className:"text-xs text-muted-foreground text-right",children:[e.jsxs("div",{children:["ë“±ë¡ìž: ",r.verifiedBy]}),e.jsx("div",{children:C(new Date(r.createdAt),"MM-dd HH:mm",{locale:F})})]})]})]})},r.id))})]})]},t.id)})}),e.jsx(X,{open:Q,onOpenChange:D,children:e.jsxs(Y,{children:[e.jsx(J,{children:e.jsx(W,{children:"ìžìž¬ ìˆ˜ë ¹ ë“±ë¡"})}),y&&e.jsxs("form",{onSubmit:xe,className:"space-y-4",children:[e.jsxs("div",{className:"bg-muted p-3 rounded",children:[e.jsx("div",{className:"font-medium",children:y.itemName}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["ë°œì£¼ìˆ˜ëŸ‰: ",y.quantity.toLocaleString(),y.unit," | ìˆ˜ë ¹ê°€ëŠ¥: ",(y.quantity-R(y.id)).toLocaleString(),y.unit]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"receivedQuantity",children:"ìˆ˜ë ¹ ìˆ˜ëŸ‰"}),e.jsx(f,{id:"receivedQuantity",name:"receivedQuantity",type:"number",step:"0.01",max:y.quantity-R(y.id),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"receivedDate",children:"ìˆ˜ë ¹ ì¼ìž"}),e.jsx(f,{id:"receivedDate",name:"receivedDate",type:"date",defaultValue:new Date().toISOString().split("T")[0],required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"invoiceId",children:"ì—°ê²°ëœ ì²­êµ¬ì„œ (ì„ íƒ)"}),e.jsxs(E,{name:"invoiceId",children:[e.jsx(K,{children:e.jsx(O,{placeholder:"ì²­êµ¬ì„œ ì„ íƒ"})}),e.jsx($,{children:z.map(t=>e.jsxs(b,{value:t.id.toString(),children:[t.invoiceNumber," - â‚©",t.totalAmount.toLocaleString()]},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"status",children:"ìƒíƒœ"}),e.jsxs(E,{name:"status",defaultValue:"pending",children:[e.jsx(K,{children:e.jsx(O,{})}),e.jsxs($,{children:[e.jsx(b,{value:"pending",children:"ëŒ€ê¸°ì¤‘"}),e.jsx(b,{value:"approved",children:"ìŠ¹ì¸ë¨"}),e.jsx(b,{value:"rejected",children:"ë°˜ë ¤ë¨"})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ce,{id:"qualityCheck",name:"qualityCheck"}),e.jsx(c,{htmlFor:"qualityCheck",className:"text-sm",children:"í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"qualityNotes",children:"í’ˆì§ˆ ê²€ì‚¬ ë©”ëª¨"}),e.jsx(P,{id:"qualityNotes",name:"qualityNotes",rows:2,placeholder:"í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ìž…ë ¥í•˜ì„¸ìš”"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"notes",children:"ì¶”ê°€ ë©”ëª¨"}),e.jsx(P,{id:"notes",name:"notes",rows:2,placeholder:"ê¸°íƒ€ ë©”ëª¨ì‚¬í•­ì„ ìž…ë ¥í•˜ì„¸ìš”"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(o,{type:"button",variant:"outline",onClick:()=>D(!1),children:"ì·¨ì†Œ"}),e.jsx(o,{type:"submit",disabled:I.isPending,children:I.isPending?"ë“±ë¡ ì¤‘...":"ë“±ë¡"})]})]})]})}),e.jsx(X,{open:L,onOpenChange:S,children:e.jsxs(Y,{children:[e.jsx(J,{children:e.jsx(W,{children:"ìˆ˜ë ¹ ì •ë³´ ìˆ˜ì •"})}),j&&e.jsxs("form",{onSubmit:me,className:"space-y-4",children:[e.jsx("div",{className:"bg-muted p-3 rounded",children:e.jsxs("div",{className:"text-sm text-muted-foreground",children:["ìˆ˜ë ¹ ê¸°ë¡ ID: ",j.id]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"edit-receivedQuantity",children:"ìˆ˜ë ¹ ìˆ˜ëŸ‰"}),e.jsx(f,{id:"edit-receivedQuantity",name:"receivedQuantity",type:"number",step:"0.01",defaultValue:j.receivedQuantity,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"edit-receivedDate",children:"ìˆ˜ë ¹ ì¼ìž"}),e.jsx(f,{id:"edit-receivedDate",name:"receivedDate",type:"date",defaultValue:new Date(j.receivedDate).toISOString().split("T")[0],required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"edit-status",children:"ìƒíƒœ"}),e.jsxs(E,{name:"status",defaultValue:j.status,children:[e.jsx(K,{children:e.jsx(O,{})}),e.jsxs($,{children:[e.jsx(b,{value:"pending",children:"ëŒ€ê¸°ì¤‘"}),e.jsx(b,{value:"approved",children:"ìŠ¹ì¸ë¨"}),e.jsx(b,{value:"rejected",children:"ë°˜ë ¤ë¨"})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ce,{id:"edit-qualityCheck",name:"qualityCheck",defaultChecked:j.qualityCheck}),e.jsx(c,{htmlFor:"edit-qualityCheck",className:"text-sm",children:"í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"edit-qualityNotes",children:"í’ˆì§ˆ ê²€ì‚¬ ë©”ëª¨"}),e.jsx(P,{id:"edit-qualityNotes",name:"qualityNotes",rows:2,defaultValue:j.qualityNotes,placeholder:"í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ìž…ë ¥í•˜ì„¸ìš”"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"edit-notes",children:"ì¶”ê°€ ë©”ëª¨"}),e.jsx(P,{id:"edit-notes",name:"notes",rows:2,defaultValue:j.notes,placeholder:"ê¸°íƒ€ ë©”ëª¨ì‚¬í•­ì„ ìž…ë ¥í•˜ì„¸ìš”"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(o,{type:"button",variant:"outline",onClick:()=>S(!1),children:"ì·¨ì†Œ"}),e.jsx(o,{type:"submit",disabled:M.isPending,children:M.isPending?"ìˆ˜ì • ì¤‘...":"ìˆ˜ì • ì™„ë£Œ"})]})]})]})})]})]})}export{Pe as I,Ae as R};
